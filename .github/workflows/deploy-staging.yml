name: Deploy to Staging

on:
  push:
    branches: [dev]
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://v0agent-staging.up.railway.app
    
    steps:
      - uses: actions/checkout@v4

      - name: Check Railway Token
        id: check-token
        run: |
          if [ -z "${{ secrets.RAILWAY_TOKEN }}" ]; then
            echo "has_token=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ RAILWAY_TOKEN secret not configured"
            echo ""
            echo "To enable automatic deployments, add RAILWAY_TOKEN to GitHub Secrets:"
            echo "1. Go to https://railway.app/account/tokens"
            echo "2. Create a new token"
            echo "3. Add it to GitHub: Settings > Secrets > Actions > New repository secret"
            echo "   Name: RAILWAY_TOKEN"
            echo ""
            echo "Skipping Railway deployment - use Railway's GitHub integration or manual deploy instead."
          else
            echo "has_token=true" >> $GITHUB_OUTPUT
          fi

      - name: Install Railway CLI
        if: steps.check-token.outputs.has_token == 'true'
        run: curl -fsSL https://railway.com/install.sh | sh

      - name: Deploy to Staging
        if: steps.check-token.outputs.has_token == 'true'
        run: |
          railway link c32f6be2-fe5d-4750-9195-00f9995c7c92 --environment staging
          railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Wait for deployment
        if: steps.check-token.outputs.has_token == 'true'
        run: sleep 30

      - name: Health Check
        run: |
          echo "Checking staging health..."
          for i in {1..10}; do
            status=$(curl -s -o /dev/null -w "%{http_code}" https://v0agent-staging.up.railway.app/health || echo "000")
            if [ "$status" = "200" ]; then
              echo "âœ… Staging deployment healthy!"
              exit 0
            fi
            echo "Attempt $i: Status $status, waiting..."
            sleep 10
          done
          echo "âš ï¸ Health check incomplete - deployment may still be in progress"
          echo "Check: https://v0agent-staging.up.railway.app/health"

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-token.outputs.has_token }}" == "true" ]; then
            echo "âœ… Railway deployment triggered via CLI" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Railway CLI deployment skipped (no token)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Railway will auto-deploy if GitHub integration is enabled," >> $GITHUB_STEP_SUMMARY
            echo "or you can trigger manually with \`railway up\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— Staging URL: https://v0agent-staging.up.railway.app" >> $GITHUB_STEP_SUMMARY
