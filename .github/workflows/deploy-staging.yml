name: Deploy to Staging

# DISABLED during Phase 2.8+ refactoring - re-enable when ready for production
# on:
#   push:
#     branches: [dev]
#   workflow_dispatch:  # Allow manual trigger

on:
  workflow_dispatch:  # Manual trigger only during refactoring
    inputs:
      confirm_deploy:
        description: 'Confirm deployment during refactoring phase'
        required: true
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.confirm_deploy == 'true' }}
    environment:
      name: staging
      url: https://v0agent-staging.up.railway.app
    
    steps:
      - uses: actions/checkout@v4

      - name: Check Railway Token
        id: check-token
        run: |
          if [ -z "${{ secrets.RAILWAY_TOKEN_STAGING }}" ]; then
            echo "has_token=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ RAILWAY_TOKEN_STAGING secret not configured"
          else
            echo "has_token=true" >> $GITHUB_OUTPUT
          fi

      - name: Install Railway CLI
        if: steps.check-token.outputs.has_token == 'true'
        run: curl -fsSL https://railway.com/install.sh | sh

      - name: Deploy to Staging
        if: steps.check-token.outputs.has_token == 'true'
        run: |
          railway link c32f6be2-fe5d-4750-9195-00f9995c7c92 --environment staging
          railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_STAGING }}

      - name: Wait for deployment
        if: steps.check-token.outputs.has_token == 'true'
        run: sleep 30

      - name: Health Check
        run: |
          echo "Checking staging health..."
          for i in {1..10}; do
            status=$(curl -s -o /dev/null -w "%{http_code}" https://v0agent-staging.up.railway.app/health || echo "000")
            if [ "$status" = "200" ]; then
              echo "âœ… Staging deployment healthy!"
              exit 0
            fi
            echo "Attempt $i: Status $status, waiting..."
            sleep 10
          done
          echo "âš ï¸ Health check incomplete - deployment may still be in progress"
          echo "Check: https://v0agent-staging.up.railway.app/health"

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-token.outputs.has_token }}" == "true" ]; then
            echo "âœ… Railway deployment triggered via CLI" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Railway CLI deployment skipped (no token)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Railway will auto-deploy if GitHub integration is enabled," >> $GITHUB_STEP_SUMMARY
            echo "or you can trigger manually with \`railway up\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— Staging URL: https://v0agent-staging.up.railway.app" >> $GITHUB_STEP_SUMMARY
