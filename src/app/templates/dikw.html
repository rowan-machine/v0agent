{% extends "base.html" %}
{% block content %}
<style>
  .dikw-container {
    max-width: 100%;
    width: 100%;
    margin: 0 auto;
    padding: 1.5rem;
    padding-right: 80px; /* Space for side panel */
  }
  
  @media (min-width: 1800px) {
    .dikw-container {
      padding: 2rem 3rem;
      padding-right: 100px;
    }
  }

  .dikw-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .dikw-header h1 {
    font-size: 1.75rem;
    color: #1a1a1a;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .dikw-header-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    padding-right: 200px; /* Space for floating mode indicator */
    position: relative;
    z-index: 60; /* Above mode indicator */
  }

  /* Right side tool panel */
  .dikw-tool-panel {
    position: fixed;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    z-index: 55;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding: 0.75rem 0.5rem;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 12px 0 0 12px;
    box-shadow: -2px 0 12px rgba(0,0,0,0.1);
    border: 1px solid #e5e7eb;
    border-right: none;
  }

  .dikw-tool-btn {
    width: 44px;
    height: 44px;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    background: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    transition: all 0.2s;
    position: relative;
  }

  .dikw-tool-btn:hover {
    background: #f3f4f6;
    transform: scale(1.05);
  }

  .dikw-tool-btn:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    right: 54px;
    background: #1f2937;
    color: white;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    font-size: 0.75rem;
    white-space: nowrap;
    z-index: 100;
    animation: tooltipFade 0.2s ease-in-out;
  }

  .dikw-tool-btn:hover::before {
    content: '';
    position: absolute;
    right: 50px;
    border: 6px solid transparent;
    border-left-color: #1f2937;
    animation: tooltipFade 0.2s ease-in-out;
  }

  @keyframes tooltipFade {
    from { opacity: 0; transform: translateX(5px); }
    to { opacity: 1; transform: translateX(0); }
  }

  .dikw-tool-btn.primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
  }

  .dikw-tool-btn.primary:hover {
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }

  .dikw-tool-btn.processing {
    opacity: 0.6;
    pointer-events: none;
  }

  .dikw-tool-btn .spinner-small {
    width: 18px;
    height: 18px;
    border: 2px solid #e5e7eb;
    border-top-color: #667eea;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  .dikw-tool-divider {
    height: 1px;
    background: #e5e7eb;
    margin: 0.25rem 0;
  }

  /* Category-specific colors */
  .dikw-item-type {
    padding: 0.15rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
  }
  .dikw-item-type.decision { background: #dbeafe; color: #1e40af; }
  .dikw-item-type.action_item, .dikw-item-type.action { background: #fef3c7; color: #92400e; }
  .dikw-item-type.blocker { background: #fee2e2; color: #991b1b; }
  .dikw-item-type.risk { background: #fce7f3; color: #9d174d; }
  .dikw-item-type.idea { background: #e0e7ff; color: #4338ca; }
  .dikw-item-type.insight { background: #d1fae5; color: #065f46; }

  .dikw-btn {
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .dikw-btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .dikw-btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }

  .dikw-btn-secondary {
    background: #f3f4f6;
    color: #374151;
    border: 1px solid #e5e7eb;
  }

  .dikw-btn-secondary:hover {
    background: #e5e7eb;
  }

  /* Pyramid Layout */
  .dikw-pyramid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .dikw-level {
    background: white;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    overflow: hidden;
    min-height: 400px;
    display: flex;
    flex-direction: column;
  }

  .dikw-level-header {
    padding: 1rem;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid;
  }

  .dikw-level[data-level="data"] .dikw-level-header {
    background: #fef3c7;
    border-color: #f59e0b;
    color: #92400e;
  }

  .dikw-level[data-level="information"] .dikw-level-header {
    background: #dbeafe;
    border-color: #3b82f6;
    color: #1e40af;
  }

  .dikw-level[data-level="knowledge"] .dikw-level-header {
    background: #d1fae5;
    border-color: #10b981;
    color: #065f46;
  }

  .dikw-level[data-level="wisdom"] .dikw-level-header {
    background: #ede9fe;
    border-color: #8b5cf6;
    color: #5b21b6;
  }

  .dikw-level-count {
    background: rgba(0,0,0,0.1);
    padding: 0.2rem 0.6rem;
    border-radius: 12px;
    font-size: 0.8rem;
  }

  .dikw-level-items {
    flex: 1;
    overflow-y: auto;
    padding: 0.75rem;
  }

  .dikw-item {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
  }

  .dikw-item:hover {
    border-color: #667eea;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }

  .dikw-item.selected {
    border-color: #667eea;
    background: #f0f0ff;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
  }

  .dikw-item-content {
    font-size: 0.85rem;
    color: #374151;
    line-height: 1.5;
    margin-bottom: 0.5rem;
    display: -webkit-box;
    -webkit-line-clamp: 5;
    -webkit-box-orient: vertical;
    overflow: hidden;
    word-break: break-word;
  }

  .dikw-item-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
    margin-top: 0.25rem;
  }

  .dikw-tag {
    padding: 0.1rem 0.35rem;
    background: #f3f4f6;
    color: #4b5563;
    border-radius: 4px;
    font-size: 0.65rem;
    font-weight: 500;
  }

  .dikw-item-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.75rem;
    color: #6b7280;
  }

  .dikw-item-confidence {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .confidence-bar {
    width: 40px;
    height: 4px;
    background: #e5e7eb;
    border-radius: 2px;
    overflow: hidden;
  }

  .confidence-fill {
    height: 100%;
    background: linear-gradient(90deg, #f59e0b, #10b981);
    transition: width 0.3s;
  }

  .dikw-item-type {
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    font-size: 0.65rem;
    text-transform: uppercase;
    font-weight: 600;
  }

  .dikw-item-type.decision { background: #dbeafe; color: #1e40af; }
  .dikw-item-type.action_item { background: #fef3c7; color: #92400e; }
  .dikw-item-type.blocker { background: #fee2e2; color: #991b1b; }
  .dikw-item-type.risk { background: #fce7f3; color: #9d174d; }
  .dikw-item-type.idea { background: #d1fae5; color: #065f46; }

  /* Signals Panel */
  .signals-panel {
    background: white;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    margin-bottom: 1.5rem;
  }

  .signals-panel-header {
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .signals-panel-header h2 {
    font-size: 1.1rem;
    color: #1a1a1a;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
  }

  .signals-filters {
    display: flex;
    gap: 0.5rem;
  }

  .signal-filter {
    padding: 0.4rem 0.8rem;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    background: white;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .signal-filter:hover, .signal-filter.active {
    background: #667eea;
    color: white;
    border-color: #667eea;
  }

  .signals-list {
    max-height: 300px;
    overflow-y: auto;
    padding: 0.75rem;
  }

  .signal-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.75rem;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    transition: all 0.2s;
  }

  .signal-item:hover {
    border-color: #667eea;
    background: #f9fafb;
  }

  .signal-checkbox {
    margin-top: 0.25rem;
  }

  .signal-content {
    flex: 1;
  }

  .signal-text {
    font-size: 0.9rem;
    color: #374151;
    margin-bottom: 0.25rem;
  }

  .signal-source {
    font-size: 0.75rem;
    color: #6b7280;
  }

  .signal-promote-btn {
    padding: 0.4rem 0.8rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .signal-promote-btn:hover {
    transform: scale(1.05);
  }

  /* Editor Modal */
  .dikw-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .dikw-modal.active {
    display: flex;
  }

  .dikw-modal-content {
    background: white;
    border-radius: 16px;
    width: 90%;
    max-width: 700px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .dikw-modal-header {
    padding: 1.25rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .dikw-modal-header h3 {
    margin: 0;
    font-size: 1.2rem;
    color: #1a1a1a;
  }

  .dikw-modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #6b7280;
    cursor: pointer;
  }

  .dikw-modal-body {
    padding: 1.25rem;
    overflow-y: auto;
    flex: 1;
  }

  .dikw-editor-section {
    margin-bottom: 1.5rem;
  }

  .dikw-editor-section label {
    display: block;
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
  }

  .dikw-editor-textarea {
    width: 100%;
    min-height: 100px;
    padding: 0.75rem;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-family: inherit;
    font-size: 0.95rem;
    line-height: 1.6;
    resize: vertical;
  }

  .dikw-editor-textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .dikw-level-select {
    width: 100%;
    padding: 0.6rem;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.95rem;
    background: white;
  }

  .dikw-ai-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: 0.75rem;
  }

  .dikw-ai-btn {
    padding: 0.5rem 1rem;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    background: white;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .dikw-ai-btn:hover {
    background: #f3f4f6;
    border-color: #667eea;
  }

  .dikw-ai-btn.loading {
    opacity: 0.6;
    pointer-events: none;
  }

  .dikw-ai-btn .spinner {
    width: 14px;
    height: 14px;
    border: 2px solid #e5e7eb;
    border-top-color: #667eea;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .dikw-modal-footer {
    padding: 1rem 1.25rem;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    gap: 0.75rem;
  }

  .dikw-modal-footer-left {
    display: flex;
    gap: 0.5rem;
  }

  .dikw-modal-footer-right {
    display: flex;
    gap: 0.5rem;
  }

  .dikw-delete-btn {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fca5a5;
  }

  .dikw-delete-btn:hover {
    background: #fca5a5;
  }

  /* History Timeline */
  .dikw-history-container {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 1rem;
    max-height: 200px;
    overflow-y: auto;
  }

  .dikw-history-loading {
    color: #6b7280;
    text-align: center;
    padding: 1rem;
  }

  .dikw-history-timeline {
    position: relative;
    padding-left: 24px;
  }

  .dikw-history-timeline::before {
    content: '';
    position: absolute;
    left: 8px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(to bottom, #3b82f6, #f59e0b, #10b981, #8b5cf6);
    border-radius: 1px;
  }

  .history-event {
    position: relative;
    padding: 0.5rem 0;
    padding-left: 1rem;
    font-size: 0.85rem;
  }

  .history-event::before {
    content: '';
    position: absolute;
    left: -20px;
    top: 50%;
    transform: translateY(-50%);
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: white;
    border: 2px solid #667eea;
  }

  .history-event.created::before { border-color: #3b82f6; background: #dbeafe; }
  .history-event.promoted::before { border-color: #10b981; background: #d1fae5; }
  .history-event.merged::before { border-color: #f59e0b; background: #fef3c7; }
  .history-event.edited::before { border-color: #8b5cf6; background: #ede9fe; }

  .history-event-title {
    font-weight: 600;
    color: #374151;
  }

  .history-event-meta {
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 0.25rem;
  }

  .history-event-source {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    background: #f3f4f6;
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    font-size: 0.7rem;
  }

  .history-level-badge {
    display: inline-block;
    padding: 0.1rem 0.4rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
  }
  .history-level-badge.data { background: #dbeafe; color: #1e40af; }
  .history-level-badge.information { background: #fef3c7; color: #92400e; }
  .history-level-badge.knowledge { background: #d1fae5; color: #065f46; }
  .history-level-badge.wisdom { background: #ede9fe; color: #5b21b6; }

  /* Toast */
  .dikw-toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #10b981;
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 9999;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    animation: slideIn 0.3s ease;
  }

  .dikw-toast.error {
    background: #ef4444;
  }

  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  /* Empty state */
  .dikw-empty {
    text-align: center;
    padding: 2rem;
    color: #9ca3af;
  }

  .dikw-empty svg {
    width: 48px;
    height: 48px;
    margin-bottom: 0.5rem;
    opacity: 0.5;
  }

  /* Bulk Actions Bar */
  .bulk-actions-bar {
    display: none;
    background: #1e293b;
    color: white;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    align-items: center;
    gap: 1rem;
  }

  .bulk-actions-bar.active {
    display: flex;
  }

  .bulk-count {
    font-weight: 600;
  }

  .bulk-actions {
    display: flex;
    gap: 0.5rem;
    margin-left: auto;
  }

  .bulk-btn {
    padding: 0.4rem 0.8rem;
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 6px;
    background: transparent;
    color: white;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .bulk-btn:hover {
    background: rgba(255,255,255,0.1);
  }

  .bulk-btn.merge {
    background: #8b5cf6;
    border-color: #8b5cf6;
  }

  /* AI Auto-Process Results */
  .auto-process-results {
    padding: 1rem;
    background: #f8fafc;
    border-radius: 8px;
    margin-top: 1rem;
  }

  .auto-process-section {
    margin-bottom: 1.5rem;
  }

  .auto-process-section:last-child {
    margin-bottom: 0;
  }

  .auto-process-section h4 {
    font-size: 0.9rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .auto-process-item {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
  }

  .auto-process-item .item-level {
    font-size: 0.7rem;
    text-transform: uppercase;
    font-weight: 600;
    color: #6b7280;
    margin-bottom: 0.25rem;
  }

  .auto-process-item .item-content {
    color: #374151;
    line-height: 1.5;
  }

  .auto-process-item .item-action {
    display: flex;
    justify-content: flex-end;
    margin-top: 0.5rem;
    gap: 0.5rem;
  }

  .auto-process-item .item-action button {
    padding: 0.3rem 0.6rem;
    font-size: 0.75rem;
    border-radius: 4px;
    cursor: pointer;
    border: 1px solid #e5e7eb;
    background: white;
    transition: all 0.2s;
  }

  .auto-process-item .item-action button.accept {
    background: #10b981;
    color: white;
    border-color: #10b981;
  }

  .auto-process-item .item-action button.accept:hover {
    background: #059669;
  }

  .auto-process-item .item-action button.skip:hover {
    background: #f3f4f6;
  }
  
  .dikw-btn-small {
    padding: 0.4rem 0.8rem;
    font-size: 0.8rem;
  }

  /* ====== DARK MODE STYLES ====== */
  [data-theme="dark"] .dikw-header h1 {
    color: var(--sf-text, #faf6f1) !important;
  }
  
  [data-theme="dark"] .dikw-header-actions button,
  [data-theme="dark"] .dikw-btn-secondary {
    background: #3a3a3a !important;
    border-color: #4a4a4a !important;
    color: #e5e5e5 !important;
  }
  
  [data-theme="dark"] .dikw-sidebar {
    background: #2d2d2d !important;
    border-color: #4a4a4a !important;
  }
  
  [data-theme="dark"] .dikw-level {
    background: #2d2d2d !important;
    border-color: #4a4a4a !important;
  }
  
  [data-theme="dark"] .dikw-level-header h3 {
    color: #faf6f1 !important;
  }
  
  [data-theme="dark"] .dikw-level-count {
    background: #3a3a3a !important;
    color: #a0a0a0 !important;
  }
  
  [data-theme="dark"] .dikw-level-description {
    color: #a0a0a0 !important;
  }
  
  [data-theme="dark"] .dikw-item {
    background: #3a3a3a !important;
    border-color: #4a4a4a !important;
  }
  
  [data-theme="dark"] .dikw-item:hover {
    background: #4a4a4a !important;
  }
  
  [data-theme="dark"] .dikw-item-title {
    color: #faf6f1 !important;
  }
  
  [data-theme="dark"] .dikw-item-content {
    color: #c9b99a !important;
  }
  
  [data-theme="dark"] .dikw-item-meta {
    color: #888 !important;
  }
  
  [data-theme="dark"] .dikw-item-source {
    color: #a0a0a0 !important;
  }
  
  [data-theme="dark"] .dikw-modal-content {
    background: #2d2d2d !important;
    color: #e5e5e5 !important;
  }
  
  [data-theme="dark"] .dikw-modal-header {
    border-bottom-color: #4a4a4a !important;
    color: #faf6f1 !important;
  }
  
  [data-theme="dark"] .dikw-form-group label {
    color: #c9b99a !important;
  }
  
  [data-theme="dark"] .dikw-form-group input,
  [data-theme="dark"] .dikw-form-group textarea,
  [data-theme="dark"] .dikw-form-group select {
    background: #3a3a3a !important;
    border-color: #4a4a4a !important;
    color: #e5e5e5 !important;
  }
  
  [data-theme="dark"] .dikw-tag {
    background: #4a3728 !important;
    color: #daa520 !important;
  }
  
  [data-theme="dark"] .empty-state {
    color: #888 !important;
  }
  
  [data-theme="dark"] .auto-process-item {
    background: #3a3a3a !important;
    border-color: #4a4a4a !important;
  }
  
  [data-theme="dark"] .auto-process-item .item-content,
  [data-theme="dark"] .auto-process-item .item-title {
    color: #e5e5e5 !important;
  }
  
  [data-theme="dark"] .auto-process-item .item-source {
    color: #a0a0a0 !important;
  }
  
  [data-theme="dark"] .auto-process-item .item-action button.skip {
    background: #3a3a3a !important;
    border-color: #4a4a4a !important;
    color: #e5e5e5 !important;
  }
</style>

<div class="dikw-container">
  <div class="dikw-header">
    <h1>üî∫ DIKW Pyramid</h1>
    <div class="dikw-header-actions">
      <!-- Main primary action stays in header -->
    </div>
  </div>

  <!-- Right side tool panel -->
  <div class="dikw-tool-panel">
    <button class="dikw-tool-btn primary" id="addNuggetToolBtn" onclick="openAddModal()" data-tooltip="Add new nugget">
      ‚ûï
    </button>
    <button class="dikw-tool-btn" id="importSignalsToolBtn" onclick="toggleSignalsPanel()" data-tooltip="Import signals from meetings">
      üì°
    </button>
    <div class="dikw-tool-divider"></div>
    <button class="dikw-tool-btn" id="aiAutoProcessToolBtn" onclick="aiAutoProcess()" data-tooltip="AI auto-process: promote items through levels">
      ‚ö°
    </button>
    <button class="dikw-tool-btn" id="aiReviewToolBtn" onclick="aiReviewNuggets()" data-tooltip="AI review: update names and summaries">
      üìã
    </button>
    <div class="dikw-tool-divider"></div>
    <button class="dikw-tool-btn" id="compressDedupeToolBtn" onclick="compressDedupe()" data-tooltip="Compress: merge duplicates, normalize categories">
      üóúÔ∏è
    </button>
    <button class="dikw-tool-btn" id="backfillTagsToolBtn" onclick="backfillTags()" data-tooltip="Backfill missing tags using AI">
      üè∑Ô∏è
    </button>
  </div>

  <!-- Signals Import Panel (collapsible) -->
  <div class="signals-panel" id="signalsPanel" style="display: none;">
    <div class="signals-panel-header">
      <h2>üì° Unprocessed Signals</h2>
      <div class="signals-filters">
        <button class="signal-filter active" data-type="all" onclick="filterSignals('all')">All</button>
        <button class="signal-filter" data-type="decision" onclick="filterSignals('decision')">Decisions</button>
        <button class="signal-filter" data-type="action_item" onclick="filterSignals('action_item')">Actions</button>
        <button class="signal-filter" data-type="blocker" onclick="filterSignals('blocker')">Blockers</button>
        <button class="signal-filter" data-type="risk" onclick="filterSignals('risk')">Risks</button>
        <button class="signal-filter" data-type="idea" onclick="filterSignals('idea')">Ideas</button>
      </div>
    </div>
    <div class="signals-list" id="signalsList">
      <div class="dikw-empty">Loading signals...</div>
    </div>
  </div>

  <!-- Bulk Actions Bar -->
  <div class="bulk-actions-bar" id="bulkActionsBar">
    <span class="bulk-count"><span id="selectedCount">0</span> items selected</span>
    <div class="bulk-actions">
      <button class="bulk-btn merge" onclick="mergeSelected()">
        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
        </svg>
        Merge & Promote
      </button>
      <button class="bulk-btn" onclick="clearSelection()">Clear</button>
    </div>
  </div>

  <!-- DIKW Pyramid Grid -->
  <div class="dikw-pyramid">
    <div class="dikw-level" data-level="data">
      <div class="dikw-level-header">
        <span>üìä Data</span>
        <span class="dikw-level-count" id="dataCount">0</span>
      </div>
      <div class="dikw-level-items" id="dataItems">
        <div class="dikw-empty">No data items</div>
      </div>
    </div>

    <div class="dikw-level" data-level="information">
      <div class="dikw-level-header">
        <span>‚ÑπÔ∏è Information</span>
        <span class="dikw-level-count" id="informationCount">0</span>
      </div>
      <div class="dikw-level-items" id="informationItems">
        <div class="dikw-empty">No information items</div>
      </div>
    </div>

    <div class="dikw-level" data-level="knowledge">
      <div class="dikw-level-header">
        <span>üí° Knowledge</span>
        <span class="dikw-level-count" id="knowledgeCount">0</span>
      </div>
      <div class="dikw-level-items" id="knowledgeItems">
        <div class="dikw-empty">No knowledge items</div>
      </div>
    </div>

    <div class="dikw-level" data-level="wisdom">
      <div class="dikw-level-header">
        <span>üåü Wisdom</span>
        <span class="dikw-level-count" id="wisdomCount">0</span>
      </div>
      <div class="dikw-level-items" id="wisdomItems">
        <div class="dikw-empty">No wisdom items</div>
      </div>
    </div>
  </div>
</div>

<!-- Edit/Add Modal -->
<div class="dikw-modal" id="dikwModal">
  <div class="dikw-modal-content">
    <div class="dikw-modal-header">
      <h3 id="modalTitle">Edit Nugget</h3>
      <button class="dikw-modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="dikw-modal-body">
      <input type="hidden" id="editItemId">
      
      <div class="dikw-editor-section">
        <label>Level</label>
        <select class="dikw-level-select" id="editLevel">
          <option value="data">üìä Data - Raw facts and observations</option>
          <option value="information">‚ÑπÔ∏è Information - Contextualized data</option>
          <option value="knowledge">üí° Knowledge - Actionable insights</option>
          <option value="wisdom">üåü Wisdom - Strategic principles</option>
        </select>
      </div>

      <div class="dikw-editor-section">
        <label>Content (The Nugget)</label>
        <textarea class="dikw-editor-textarea" id="editContent" placeholder="Enter the core content or insight..."></textarea>
        <div class="dikw-ai-actions">
          <button class="dikw-ai-btn" onclick="aiRefine('clarify')">
            <span class="btn-text">‚ú® Clarify</span>
          </button>
          <button class="dikw-ai-btn" onclick="aiRefine('expand')">
            <span class="btn-text">üìù Expand</span>
          </button>
          <button class="dikw-ai-btn" onclick="aiRefine('simplify')">
            <span class="btn-text">üéØ Simplify</span>
          </button>
          <button class="dikw-ai-btn" onclick="aiRefine('actionable')">
            <span class="btn-text">‚ö° Make Actionable</span>
          </button>
        </div>
      </div>

      <div class="dikw-editor-section">
        <label>Summary / Synthesis</label>
        <textarea class="dikw-editor-textarea" id="editSummary" placeholder="AI-generated or manual summary..." style="min-height: 80px;"></textarea>
        <div class="dikw-ai-actions">
          <button class="dikw-ai-btn" onclick="aiGenerateSummary()">
            <span class="btn-text">ü§ñ Generate Summary</span>
          </button>
          <button class="dikw-ai-btn" onclick="aiPromoteLevel()">
            <span class="btn-text">‚¨ÜÔ∏è AI Promote to Next Level</span>
          </button>
        </div>
      </div>

      <div class="dikw-editor-section">
        <label>Tags (comma-separated)</label>
        <input type="text" class="dikw-editor-textarea" id="editTags" placeholder="e.g., architecture, decision, sprint-42" style="min-height: auto; height: 40px;">
        <div class="dikw-ai-actions">
          <button class="dikw-ai-btn" onclick="aiGenerateTags()">
            <span class="btn-text">üè∑Ô∏è Generate Tags</span>
          </button>
        </div>
      </div>
      
      <!-- Evolution History Section -->
      <div class="dikw-editor-section" id="historySection" style="display:none;">
        <label>üìú Evolution History</label>
        <div class="dikw-history-container" id="historyContainer">
          <div class="dikw-history-loading">Loading history...</div>
        </div>
      </div>
    </div>
    <div class="dikw-modal-footer">
      <div class="dikw-modal-footer-left">
        <button class="dikw-btn dikw-delete-btn" id="deleteBtn" onclick="deleteItem()" style="display: none;">
          üóëÔ∏è Delete
        </button>
      </div>
      <div class="dikw-modal-footer-right">
        <button class="dikw-btn dikw-btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="dikw-btn dikw-btn-primary" onclick="saveItem()">üíæ Save</button>
      </div>
    </div>
  </div>
</div>

<script>
let dikwData = { data: [], information: [], knowledge: [], wisdom: [] };
let selectedItems = new Set();
let currentFilter = 'all';

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  loadDIKWItems();
});

// Load DIKW items from API
async function loadDIKWItems() {
  try {
    const response = await fetch('/api/dikw', { credentials: 'same-origin' });
    const data = await response.json();
    dikwData = data.pyramid;
    
    renderPyramid();
  } catch (err) {
    console.error('Failed to load DIKW items:', err);
    showToast('Failed to load items', true);
  }
}

// Render the pyramid
function renderPyramid() {
  const levels = ['data', 'information', 'knowledge', 'wisdom'];
  
  // Category icons for visual distinction
  const categoryIcons = {
    'decision': '‚öñÔ∏è',
    'action_item': '‚úÖ',
    'action': '‚úÖ',
    'blocker': 'üöß',
    'risk': '‚ö†Ô∏è',
    'idea': 'üí°',
    'insight': 'üîç'
  };
  
  levels.forEach(level => {
    const container = document.getElementById(`${level}Items`);
    const countEl = document.getElementById(`${level}Count`);
    const items = dikwData[level] || [];
    
    countEl.textContent = items.length;
    
    if (items.length === 0) {
      container.innerHTML = '<div class="dikw-empty">No items yet</div>';
      return;
    }
    
    container.innerHTML = items.map(item => {
      // Confidence is stored as 0-100, normalize for display
      const confidenceValue = item.confidence > 1 ? item.confidence : (item.confidence || 0.5) * 100;
      
      // Parse tags for display
      const tagsHtml = item.tags ? 
        item.tags.split(',').map(t => t.trim()).filter(t => t)
          .slice(0, 3).map(tag => `<span class="dikw-tag">${escapeHtml(tag)}</span>`).join('') : '';
      
      // Normalize signal type for display
      const signalType = normalizeSignalType(item.original_signal_type);
      const categoryIcon = categoryIcons[signalType] || '';
      
      return `
        <div class="dikw-item ${selectedItems.has(item.id) ? 'selected' : ''}" 
             data-id="${item.id}" 
             data-level="${level}"
             onclick="handleItemClick(event, ${item.id})">
          <div class="dikw-item-content">${renderSimpleMarkdown(item.content)}</div>
          ${tagsHtml ? `<div class="dikw-item-tags">${tagsHtml}</div>` : ''}
          <div class="dikw-item-meta">
            <div class="dikw-item-confidence">
              <div class="confidence-bar">
                <div class="confidence-fill" style="width: ${confidenceValue}%"></div>
              </div>
              <span>${Math.round(confidenceValue)}%</span>
            </div>
            ${signalType ? `<span class="dikw-item-type ${signalType}">${categoryIcon} ${signalType.replace('_', ' ')}</span>` : ''}
          </div>
        </div>
      `;
    }).join('');
  });
}

// Handle item click (select or edit)
function handleItemClick(event, itemId) {
  if (event.ctrlKey || event.metaKey) {
    // Multi-select mode
    toggleItemSelection(itemId);
  } else {
    // Edit mode
    openEditModal(itemId);
  }
}

// Toggle item selection
function toggleItemSelection(itemId) {
  if (selectedItems.has(itemId)) {
    selectedItems.delete(itemId);
  } else {
    selectedItems.add(itemId);
  }
  updateBulkActionsBar();
  renderPyramid();
}

// Update bulk actions bar
function updateBulkActionsBar() {
  const bar = document.getElementById('bulkActionsBar');
  const countEl = document.getElementById('selectedCount');
  
  if (selectedItems.size > 0) {
    bar.classList.add('active');
    countEl.textContent = selectedItems.size;
  } else {
    bar.classList.remove('active');
  }
}

// Clear selection
function clearSelection() {
  selectedItems.clear();
  updateBulkActionsBar();
  renderPyramid();
}

// Merge selected items
async function mergeSelected() {
  if (selectedItems.size < 2) {
    showToast('Select at least 2 items to merge', true);
    return;
  }
  
  try {
    const response = await fetch('/api/dikw/merge', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ item_ids: Array.from(selectedItems) })
    });
    
    const data = await response.json();
    
    if (response.ok) {
      showToast(`Merged ${data.merged_count} items into ${data.to_level}`);
      selectedItems.clear();
      updateBulkActionsBar();
      loadDIKWItems();
    } else {
      showToast(data.error || 'Failed to merge', true);
    }
  } catch (err) {
    showToast('Failed to merge items', true);
  }
}

// Open add modal
function openAddModal() {
  document.getElementById('modalTitle').textContent = 'Add New Nugget';
  document.getElementById('editItemId').value = '';
  document.getElementById('editLevel').value = 'data';
  document.getElementById('editContent').value = '';
  document.getElementById('editSummary').value = '';
  document.getElementById('editTags').value = '';
  document.getElementById('deleteBtn').style.display = 'none';
  document.getElementById('historySection').style.display = 'none';
  document.getElementById('dikwModal').classList.add('active');
}

// Open edit modal
function openEditModal(itemId) {
  // Find the item
  let item = null;
  for (const level of ['data', 'information', 'knowledge', 'wisdom']) {
    item = dikwData[level].find(i => i.id === itemId);
    if (item) break;
  }
  
  if (!item) return;
  
  document.getElementById('modalTitle').textContent = 'Edit Nugget';
  document.getElementById('editItemId').value = item.id;
  document.getElementById('editLevel').value = item.level;
  document.getElementById('editContent').value = item.content || '';
  document.getElementById('editSummary').value = item.summary || '';
  document.getElementById('editTags').value = item.tags || '';
  document.getElementById('deleteBtn').style.display = 'block';
  
  // Show and load history
  document.getElementById('historySection').style.display = 'block';
  loadItemHistory(itemId);
  
  document.getElementById('dikwModal').classList.add('active');
}

// Load item history
async function loadItemHistory(itemId) {
  const container = document.getElementById('historyContainer');
  container.innerHTML = '<div class="dikw-history-loading">Loading history...</div>';
  
  try {
    const response = await fetch(`/api/dikw/${itemId}/history`, { credentials: 'same-origin' });
    if (!response.ok) throw new Error('Failed to load history');
    
    const data = await response.json();
    renderHistory(data);
  } catch (err) {
    container.innerHTML = '<div class="dikw-history-loading">Unable to load history</div>';
  }
}

// Render history timeline
function renderHistory(data) {
  const container = document.getElementById('historyContainer');
  const timeline = data.timeline || [];
  
  if (timeline.length === 0) {
    container.innerHTML = '<div class="dikw-history-loading">No history recorded yet</div>';
    return;
  }
  
  const levelIcons = {
    'data': 'üìä',
    'information': '‚ÑπÔ∏è',
    'knowledge': 'üí°',
    'wisdom': 'üåü'
  };
  
  const eventLabels = {
    'created': 'Created',
    'promoted': 'Promoted',
    'merged': 'Merged',
    'edited': 'Edited'
  };
  
  let html = '<div class="dikw-history-timeline">';
  
  // Add source information if available
  if (data.meeting) {
    html += `
      <div class="history-event created">
        <div class="history-event-title">üìç Source</div>
        <div class="history-event-meta">
          <span class="history-event-source">üìÖ ${escapeHtml(data.meeting.meeting_name)}</span>
          ${data.meeting.meeting_date ? `<span style="margin-left:0.5rem;color:#9ca3af;">${data.meeting.meeting_date}</span>` : ''}
        </div>
      </div>
    `;
  }
  
  // Add timeline events
  timeline.forEach(event => {
    const eventClass = event.event || 'created';
    const label = eventLabels[event.event] || event.event;
    const date = event.date ? new Date(event.date).toLocaleDateString() : '';
    
    html += `
      <div class="history-event ${eventClass}">
        <div class="history-event-title">
          ${label}
          ${event.from_level ? `<span class="history-level-badge ${event.from_level}">${levelIcons[event.from_level] || ''} ${event.from_level}</span>` : ''}
          ${event.from_level && event.to_level ? ' ‚Üí ' : ''}
          ${event.to_level && event.to_level !== 'next' ? `<span class="history-level-badge ${event.to_level}">${levelIcons[event.to_level] || ''} ${event.to_level}</span>` : ''}
        </div>
        <div class="history-event-meta">
          ${date ? `<span style="color:#9ca3af;">${date}</span>` : ''}
          ${event.source ? `<span class="history-event-source">${escapeHtml(event.source)}</span>` : ''}
        </div>
        ${event.content_snapshot ? `
          <div class="history-content-snapshot" style="margin-top: 0.5rem; padding: 0.5rem; background: #f8fafc; border-radius: 6px; font-size: 0.8rem; color: #64748b; border-left: 3px solid #e2e8f0;">
            <span style="font-weight: 500; color: #94a3b8;">Previous:</span> ${escapeHtml(event.content_snapshot.substring(0, 200))}${event.content_snapshot.length > 200 ? '...' : ''}
          </div>
        ` : ''}
      </div>
    `;
  });
  
  // Show source items if this was synthesized
  if (data.source_items && data.source_items.length > 0) {
    html += `
      <div class="history-event merged">
        <div class="history-event-title">üîó Synthesized from ${data.source_items.length} item(s)</div>
        <div class="history-event-meta">
          ${data.source_items.map(s => `<span class="history-level-badge ${s.level}">${s.level}</span>`).join(' ')}
        </div>
      </div>
    `;
  }
  
  html += '</div>';
  container.innerHTML = html;
}

// Close modal
function closeModal() {
  document.getElementById('dikwModal').classList.remove('active');
}

// Save item
async function saveItem() {
  const itemId = document.getElementById('editItemId').value;
  const level = document.getElementById('editLevel').value;
  const content = document.getElementById('editContent').value.trim();
  const summary = document.getElementById('editSummary').value.trim();
  const tags = document.getElementById('editTags').value.trim();
  
  if (!content) {
    showToast('Content is required', true);
    return;
  }
  
  try {
    const endpoint = itemId ? `/api/dikw/${itemId}` : '/api/dikw';
    const method = itemId ? 'PUT' : 'POST';
    
    const response = await fetch(endpoint, {
      method,
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ level, content, summary, tags })
    });
    
    if (response.ok) {
      showToast(itemId ? 'Item updated' : 'Item created');
      closeModal();
      loadDIKWItems();
    } else {
      const data = await response.json();
      showToast(data.error || 'Failed to save', true);
    }
  } catch (err) {
    showToast('Failed to save item', true);
  }
}

// Delete item
async function deleteItem() {
  const itemId = document.getElementById('editItemId').value;
  if (!itemId) return;
  
  if (!confirm('Are you sure you want to delete this item?')) return;
  
  try {
    const response = await fetch(`/api/dikw/${itemId}`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin'
    });
    
    if (response.ok) {
      showToast('Item deleted');
      closeModal();
      loadDIKWItems();
    } else {
      const data = await response.json();
      showToast(data.error || 'Failed to delete item', true);
    }
  } catch (err) {
    console.error('Delete error:', err);
    showToast('Failed to delete item', true);
  }
}

// AI Refine content
async function aiRefine(action) {
  const contentEl = document.getElementById('editContent');
  const content = contentEl.value.trim();
  
  if (!content) {
    showToast('Enter content first', true);
    return;
  }
  
  const btn = event.target.closest('.dikw-ai-btn');
  const btnText = btn.querySelector('.btn-text');
  const originalText = btnText.textContent;
  btnText.innerHTML = '<span class="spinner"></span>';
  btn.classList.add('loading');
  
  try {
    const prompts = {
      clarify: `Clarify and make this statement more precise and unambiguous. Keep it concise:\n\n"${content}"`,
      expand: `Expand on this with relevant context and details, but keep it focused:\n\n"${content}"`,
      simplify: `Simplify this to its core essence in one clear sentence:\n\n"${content}"`,
      actionable: `Rewrite this as an actionable insight or recommendation:\n\n"${content}"`
    };
    
    const response = await fetch('/api/dikw/ai-refine', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ content, action, prompt: prompts[action] })
    });
    
    const data = await response.json();
    
    if (response.ok && data.refined) {
      contentEl.value = data.refined;
      showToast('Content refined');
    } else {
      showToast(data.error || 'AI refinement failed', true);
    }
  } catch (err) {
    showToast('Failed to refine content', true);
  } finally {
    btnText.textContent = originalText;
    btn.classList.remove('loading');
  }
}

// AI Generate Summary
async function aiGenerateSummary() {
  const content = document.getElementById('editContent').value.trim();
  const level = document.getElementById('editLevel').value;
  const summaryEl = document.getElementById('editSummary');
  
  if (!content) {
    showToast('Enter content first', true);
    return;
  }
  
  const btn = event.target.closest('.dikw-ai-btn');
  const btnText = btn.querySelector('.btn-text');
  const originalText = btnText.textContent;
  btnText.innerHTML = '<span class="spinner"></span>';
  btn.classList.add('loading');
  
  try {
    const response = await fetch('/api/dikw/ai-summarize', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ content, level })
    });
    
    const data = await response.json();
    
    if (response.ok && data.summary) {
      summaryEl.value = data.summary;
      showToast('Summary generated');
    } else {
      showToast(data.error || 'Failed to generate summary', true);
    }
  } catch (err) {
    showToast('Failed to generate summary', true);
  } finally {
    btnText.textContent = originalText;
    btn.classList.remove('loading');
  }
}

// AI Generate Tags
async function aiGenerateTags() {
  const content = document.getElementById('editContent').value.trim();
  const level = document.getElementById('editLevel').value;
  const tagsEl = document.getElementById('editTags');
  
  if (!content) {
    showToast('Enter content first', true);
    return;
  }
  
  const btn = event.target.closest('.dikw-ai-btn');
  const btnText = btn.querySelector('.btn-text');
  const originalText = btnText.textContent;
  btnText.innerHTML = '<span class="spinner"></span>';
  btn.classList.add('loading');
  
  try {
    const response = await fetch('/api/dikw/generate-tags', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ 
        content, 
        level,
        existing_tags: tagsEl.value.trim()
      })
    });
    
    const data = await response.json();
    
    if (response.ok && data.tags) {
      // Merge with existing tags if any
      const existingTags = tagsEl.value.trim();
      if (existingTags) {
        const combined = new Set([
          ...existingTags.split(',').map(t => t.trim()).filter(t => t),
          ...data.tags.split(',').map(t => t.trim()).filter(t => t)
        ]);
        tagsEl.value = Array.from(combined).join(', ');
      } else {
        tagsEl.value = data.tags;
      }
      showToast('Tags generated');
    } else {
      showToast(data.error || 'Failed to generate tags', true);
    }
  } catch (err) {
    showToast('Failed to generate tags', true);
  } finally {
    btnText.textContent = originalText;
    btn.classList.remove('loading');
  }
}

// AI Promote to next level
async function aiPromoteLevel() {
  const itemId = document.getElementById('editItemId').value;
  const content = document.getElementById('editContent').value.trim();
  const currentLevel = document.getElementById('editLevel').value;
  
  if (currentLevel === 'wisdom') {
    showToast('Already at highest level', true);
    return;
  }
  
  if (!content) {
    showToast('Enter content first', true);
    return;
  }
  
  const btn = event.target.closest('.dikw-ai-btn');
  const btnText = btn.querySelector('.btn-text');
  const originalText = btnText.textContent;
  btnText.innerHTML = '<span class="spinner"></span>';
  btn.classList.add('loading');
  
  const nextLevel = { data: 'information', information: 'knowledge', knowledge: 'wisdom' };
  
  try {
    const response = await fetch('/api/dikw/ai-promote', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ content, from_level: currentLevel, to_level: nextLevel[currentLevel] })
    });
    
    const data = await response.json();
    
    if (response.ok && data.promoted_content) {
      document.getElementById('editLevel').value = nextLevel[currentLevel];
      document.getElementById('editContent').value = data.promoted_content;
      document.getElementById('editSummary').value = data.summary || '';
      showToast(`Promoted to ${nextLevel[currentLevel]}`);
    } else {
      showToast(data.error || 'Failed to promote', true);
    }
  } catch (err) {
    showToast('Failed to promote item', true);
  } finally {
    btnText.textContent = originalText;
    btn.classList.remove('loading');
  }
}

// Toggle signals panel
function toggleSignalsPanel() {
  const panel = document.getElementById('signalsPanel');
  const isVisible = panel.style.display !== 'none';
  panel.style.display = isVisible ? 'none' : 'block';
  
  if (!isVisible) {
    loadSignals();
  }
}

// Load unprocessed signals
async function loadSignals() {
  const container = document.getElementById('signalsList');
  container.innerHTML = '<div class="dikw-empty">Loading signals...</div>';
  
  try {
    const response = await fetch('/api/signals/unprocessed', { credentials: 'same-origin' });
    const signals = await response.json();
    
    if (signals.length === 0) {
      container.innerHTML = '<div class="dikw-empty">No unprocessed signals found</div>';
      return;
    }
    
    window.allSignals = signals;
    renderSignals(signals);
  } catch (err) {
    container.innerHTML = '<div class="dikw-empty">Failed to load signals</div>';
  }
}

// Render signals
function renderSignals(signals) {
  const container = document.getElementById('signalsList');
  
  const filtered = currentFilter === 'all' 
    ? signals 
    : signals.filter(s => s.signal_type === currentFilter);
  
  if (filtered.length === 0) {
    container.innerHTML = '<div class="dikw-empty">No signals match this filter</div>';
    return;
  }
  
  container.innerHTML = filtered.map(signal => `
    <div class="signal-item" data-type="${signal.signal_type}">
      <input type="checkbox" class="signal-checkbox" data-signal='${JSON.stringify(signal).replace(/'/g, "\\'")}'>
      <div class="signal-content">
        <div class="signal-text">${escapeHtml(signal.text)}</div>
        <div class="signal-source">
          <span class="dikw-item-type ${signal.signal_type}">${signal.signal_type.replace('_', ' ')}</span>
          from ${escapeHtml(signal.meeting_name || 'Unknown meeting')}
        </div>
      </div>
      <button class="signal-promote-btn" onclick="promoteSignal(${signal.meeting_id}, '${signal.signal_type}', '${escapeJs(signal.text)}')">
        ‚¨ÜÔ∏è Promote
      </button>
    </div>
  `).join('');
}

// Filter signals
function filterSignals(type) {
  currentFilter = type;
  document.querySelectorAll('.signal-filter').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.type === type);
  });
  
  if (window.allSignals) {
    renderSignals(window.allSignals);
  }
}

// Promote a signal to DIKW
async function promoteSignal(meetingId, signalType, signalText) {
  try {
    const response = await fetch('/api/dikw/promote-signal', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({
        meeting_id: meetingId,
        signal_type: signalType,
        signal_text: signalText,
        level: 'data'
      })
    });
    
    const data = await response.json();
    
    if (response.ok) {
      showToast(`Signal promoted to ${data.level}`);
      loadSignals();
      loadDIKWItems();
    } else {
      showToast(data.error || 'Failed to promote signal', true);
    }
  } catch (err) {
    showToast('Failed to promote signal', true);
  }
}

// Utility functions
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text || '';
  return div.innerHTML;
}

function escapeJs(text) {
  return (text || '').replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n');
}

// Simple markdown renderer for brief content
function renderSimpleMarkdown(text) {
  if (!text) return '';
  let html = escapeHtml(text);
  // Bold
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');
  // Italic
  html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
  html = html.replace(/_(.+?)_/g, '<em>$1</em>');
  // Inline code
  html = html.replace(/`(.+?)`/g, '<code style="background:#f1f5f9;padding:0.1rem 0.3rem;border-radius:3px;font-size:0.85em;">$1</code>');
  // Line breaks
  html = html.replace(/\n/g, '<br>');
  return html;
}

// Normalize signal type for consistency
function normalizeSignalType(signalType) {
  if (!signalType) return '';
  const normalized = signalType.toLowerCase().trim();
  const mapping = {
    'action': 'action_item',
    'action_items': 'action_item',
    'actions': 'action_item',
    'decisions': 'decision',
    'blockers': 'blocker',
    'risks': 'risk',
    'ideas': 'idea',
    'insights': 'insight'
  };
  return mapping[normalized] || normalized;
}

function showToast(message, isError = false) {
  const toast = document.createElement('div');
  toast.className = `dikw-toast ${isError ? 'error' : ''}`;
  toast.innerHTML = `${isError ? '‚ùå' : '‚úÖ'} ${message}`;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateY(20px)';
    toast.style.transition = 'all 0.3s';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Close modal on outside click
document.getElementById('dikwModal').addEventListener('click', (e) => {
  if (e.target.classList.contains('dikw-modal')) {
    closeModal();
  }
});

// Compress and dedupe items
async function compressDedupe() {
  const btn = document.getElementById('compressDedupeToolBtn');
  const originalHtml = btn.innerHTML;
  btn.innerHTML = '<div class="spinner-small"></div>';
  btn.classList.add('processing');
  
  try {
    const response = await fetch('/api/dikw/compress-dedupe', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin'
    });
    
    const result = await response.json();
    
    if (response.ok) {
      showToast(result.message || `Compressed: ${result.merged} items merged, ${result.normalized} normalized`);
      await loadDIKWItems(); // Reload to show changes
    } else {
      showToast(result.error || 'Failed to compress items', true);
    }
  } catch (err) {
    console.error('Compress error:', err);
    showToast('Error compressing items', true);
  } finally {
    btn.innerHTML = originalHtml;
    btn.classList.remove('processing');
  }
}

// Backfill tags for existing items without tags
async function backfillTags() {
  const btn = document.getElementById('backfillTagsToolBtn');
  const originalHtml = btn.innerHTML;
  btn.innerHTML = '<div class="spinner-small"></div>';
  btn.classList.add('processing');
  
  try {
    const response = await fetch('/api/dikw/backfill-tags', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin'
    });
    
    const result = await response.json();
    
    if (response.ok) {
      showToast(`Tags backfilled: ${result.updated} of ${result.total_without_tags} items updated`);
      await loadDIKWItems(); // Reload to show new tags
    } else {
      showToast(result.error || 'Failed to backfill tags', true);
    }
  } catch (err) {
    console.error('Backfill error:', err);
    showToast('Error backfilling tags', true);
  } finally {
    btn.innerHTML = originalHtml;
    btn.classList.remove('processing');
  }
}

// AI Review: Review and update nugget names and summaries
async function aiReviewNuggets() {
  const btn = document.getElementById('aiReviewToolBtn');
  const originalHtml = btn.innerHTML;
  btn.innerHTML = '<div class="spinner-small"></div>';
  btn.classList.add('processing');
  
  try {
    const response = await fetch('/api/dikw/ai-review', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ pyramid: dikwData })
    });
    
    const data = await response.json();
    
    if (response.ok) {
      if (data.reviews && data.reviews.length > 0) {
        showReviewResults(data.reviews);
        showToast(`Found ${data.reviews.length} improvement suggestions`);
      } else {
        showToast('All nuggets look good! No improvements suggested.');
      }
    } else {
      showToast(data.error || 'Failed to review', true);
    }
  } catch (err) {
    console.error('Review error:', err);
    showToast('Failed to review items', true);
  } finally {
    btn.innerHTML = originalHtml;
    btn.classList.remove('processing');
  }
}

function showReviewResults(reviews) {
  window._reviewItems = reviews;
  
  let modal = document.getElementById('reviewModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'reviewModal';
    modal.className = 'dikw-modal';
    modal.innerHTML = `
      <div class="dikw-modal-content auto-process-results" style="max-width: 700px;">
        <div class="dikw-modal-header">
          <h3>üìù AI Review Results</h3>
          <button class="dikw-modal-close" onclick="closeReviewModal()">√ó</button>
        </div>
        <div class="dikw-modal-body" id="reviewModalBody"></div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  const body = document.getElementById('reviewModalBody');
  let html = '<div class="auto-process-results-content">';
  html += '<p style="font-size:0.85rem;color:#6b7280;margin-bottom:1rem;">Review suggested improvements to nugget names and summaries. Apply changes individually.</p>';
  
  reviews.forEach((review, idx) => {
    html += `
      <div class="auto-process-item" id="review-${idx}" style="border-left:3px solid #3b82f6;">
        <div class="item-level">${review.level} (ID: ${review.id})</div>
        <div style="margin:0.5rem 0;">
          <div style="font-size:0.75rem;color:#6b7280;">Current content:</div>
          <div style="color:#64748b;text-decoration:line-through;">${escapeHtml(review.current_content)}</div>
          <div style="font-size:0.75rem;color:#6b7280;margin-top:0.5rem;">Improved content:</div>
          <div style="color:#059669;font-weight:500;">${escapeHtml(review.improved_content)}</div>
        </div>
        ${review.improved_summary ? `
          <div style="margin:0.5rem 0;">
            <div style="font-size:0.75rem;color:#6b7280;">Improved summary:</div>
            <div style="font-size:0.85rem;color:#374151;font-style:italic;">${escapeHtml(review.improved_summary)}</div>
          </div>
        ` : ''}
        <div style="font-size:0.75rem;color:#6b7280;margin-top:0.5rem;">Reason: ${escapeHtml(review.reason)}</div>
        <div class="item-action">
          <button class="skip" onclick="skipReview(${idx})">Skip</button>
          <button class="accept" onclick="applyReview(${idx})">‚úì Apply</button>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  body.innerHTML = html;
  modal.classList.add('active');
}

function closeReviewModal() {
  const modal = document.getElementById('reviewModal');
  if (modal) modal.classList.remove('active');
}

function skipReview(idx) {
  document.getElementById(`review-${idx}`).style.display = 'none';
}

async function applyReview(idx) {
  const review = window._reviewItems?.[idx];
  if (!review) {
    showToast('Review data not found', true);
    return;
  }
  
  try {
    const response = await fetch(`/api/dikw/${review.id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({
        content: review.improved_content,
        summary: review.improved_summary
      })
    });
    
    if (response.ok) {
      document.getElementById(`review-${idx}`).style.display = 'none';
      showToast('Nugget updated');
      loadDIKWItems();
    } else {
      showToast('Failed to update nugget', true);
    }
  } catch (err) {
    showToast('Failed to update nugget', true);
  }
}

// AI Auto-Process: suggest new items, promote existing, adjust confidence
async function aiAutoProcess() {
  const btn = document.getElementById('aiAutoProcessToolBtn');
  const originalHtml = btn.innerHTML;
  btn.innerHTML = '<div class="spinner-small"></div>';
  btn.classList.add('processing');
  
  try {
    const response = await fetch('/api/dikw/auto-process', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({
        pyramid: dikwData
      })
    });
    
    const data = await response.json();
    
    if (response.ok) {
      showAutoProcessResults(data);
      const total = (data.suggested?.length || 0) + (data.promoted?.length || 0) + 
                    (data.confidence_updates?.length || 0) + (data.wisdom_candidates?.length || 0);
      showToast(`Found ${total} recommendations`);
    } else {
      showToast(data.error || 'Failed to auto-process', true);
    }
  } catch (err) {
    console.error('Auto-process error:', err);
    showToast('Failed to auto-process items', true);
  } finally {
    btn.innerHTML = originalHtml;
    btn.classList.remove('processing');
  }
}

function showAutoProcessResults(data) {
  // Create or reuse results modal
  let modal = document.getElementById('autoProcessModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'autoProcessModal';
    modal.className = 'dikw-modal';
    modal.innerHTML = `
      <div class="dikw-modal-content" style="max-width: 800px;">
        <div class="dikw-modal-header">
          <h3>ü§ñ AI Auto-Process Results</h3>
          <button class="dikw-modal-close" onclick="closeAutoProcessModal()">&times;</button>
        </div>
        <div class="dikw-modal-body" id="autoProcessBody"></div>
        <div class="dikw-modal-footer">
          <div></div>
          <button class="dikw-btn dikw-btn-primary" onclick="closeAutoProcessModal()">Done</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeAutoProcessModal();
    });
  }
  
  const body = document.getElementById('autoProcessBody');
  let html = '<div class="auto-process-results">';
  
  // Suggested new items
  if (data.suggested && data.suggested.length > 0) {
    html += `
      <div class="auto-process-section">
        <h4>‚ú® Suggested New Items (${data.suggested.length})</h4>
        ${data.suggested.map((item, idx) => `
          <div class="auto-process-item" id="suggested-${idx}">
            <div class="item-level">${item.level}</div>
            <div class="item-content">${escapeHtml(item.content)}</div>
            <div class="item-action">
              <button class="skip" onclick="skipSuggestion(${idx})">Skip</button>
              <button class="accept" onclick="acceptSuggestion(${idx}, '${item.level}', '${escapeJs(item.content)}', '${escapeJs(item.summary || '')}')">‚úì Add</button>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }
  
  // Promoted items - store data in global for button handlers
  if (data.promoted && data.promoted.length > 0) {
    window._promotedItems = data.promoted;
    html += `
      <div class="auto-process-section">
        <h4>‚¨ÜÔ∏è Promoted Items (${data.promoted.length})</h4>
        ${data.promoted.map((item, idx) => `
          <div class="auto-process-item" id="promoted-${idx}">
            <div class="item-level">${escapeHtml(item.from_level)} ‚Üí ${escapeHtml(item.to_level)}</div>
            <div class="item-content">${renderSimpleMarkdown(item.promoted_content.substring(0, 200))}${item.promoted_content.length > 200 ? '...' : ''}</div>
            ${item.summary ? `<div style="font-size:0.75rem;color:#6b7280;margin-top:0.5rem;font-style:italic;">${renderSimpleMarkdown(item.summary.substring(0, 100))}${item.summary.length > 100 ? '...' : ''}</div>` : ''}
            <div class="item-action">
              <button class="skip" onclick="skipPromotion(${idx})">Skip</button>
              <button class="accept" onclick="applyPromotion(${idx})">‚úì Apply</button>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }
  
  // Confidence updates
  if (data.confidence_updates && data.confidence_updates.length > 0) {
    html += `
      <div class="auto-process-section">
        <h4>üìä Confidence Adjustments (${data.confidence_updates.length})</h4>
        ${data.confidence_updates.map((item, idx) => `
          <div class="auto-process-item" id="confidence-${idx}">
            <div class="item-level">${item.level} ‚Ä¢ ${item.old_confidence}% ‚Üí ${item.new_confidence}%</div>
            <div class="item-content">${escapeHtml(item.content.substring(0, 150))}${item.content.length > 150 ? '...' : ''}</div>
            <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">Reason: ${escapeHtml(item.reason)}</div>
            <div class="item-action">
              <button class="skip" onclick="skipConfidence(${idx})">Skip</button>
              <button class="accept" onclick="acceptConfidence(${idx}, ${item.id}, ${item.new_confidence})">‚úì Apply</button>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }
  
  // Wisdom candidates - store data in global for button handlers
  if (data.wisdom_candidates && data.wisdom_candidates.length > 0) {
    window._wisdomCandidates = data.wisdom_candidates;
    html += `
      <div class="auto-process-section">
        <h4>üåü Wisdom Candidates (${data.wisdom_candidates.length})</h4>
        <p style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.75rem;">These knowledge items show potential to become timeless wisdom principles.</p>
        ${data.wisdom_candidates.map((item, idx) => `
          <div class="auto-process-item" id="wisdom-${idx}" style="border-left: 3px solid #8b5cf6;">
            <div class="item-level">Knowledge ‚Üí Wisdom ‚Ä¢ Readiness: ${item.readiness_score}/10</div>
            <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem;">Original: ${renderSimpleMarkdown(item.original_content.substring(0, 100))}${item.original_content.length > 100 ? '...' : ''}</div>
            <div class="item-content" style="background: #f5f3ff; padding: 0.75rem; border-radius: 6px; font-style: italic; color: #5b21b6;">
              "${renderSimpleMarkdown(item.potential_wisdom)}"
            </div>
            <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">Why: ${escapeHtml(item.reason)}</div>
            <div class="item-action">
              <button class="skip" onclick="skipWisdom(${idx})">Skip</button>
              <button class="accept" style="background: #8b5cf6; border-color: #8b5cf6;" onclick="applyWisdom(${idx})">üåü Promote to Wisdom</button>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }
  
  if (!data.suggested?.length && !data.promoted?.length && !data.confidence_updates?.length && !data.wisdom_candidates?.length) {
    html += '<div class="dikw-empty">No suggestions at this time. Your DIKW pyramid is well-organized! üéâ</div>';
  }
  
  html += '</div>';
  body.innerHTML = html;
  modal.classList.add('active');
}

function closeAutoProcessModal() {
  const modal = document.getElementById('autoProcessModal');
  if (modal) modal.classList.remove('active');
}

async function acceptSuggestion(idx, level, content, summary) {
  try {
    const response = await fetch('/api/dikw', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ level, content, summary, confidence: 70 })
    });
    
    if (response.ok) {
      document.getElementById(`suggested-${idx}`).style.display = 'none';
      showToast('Item added successfully');
      loadDIKWItems();
    } else {
      showToast('Failed to add item', true);
    }
  } catch (err) {
    showToast('Failed to add item', true);
  }
}

function skipSuggestion(idx) {
  document.getElementById(`suggested-${idx}`).style.display = 'none';
}

// New promotion handler using stored data
async function applyPromotion(idx) {
  const item = window._promotedItems?.[idx];
  if (!item) {
    showToast('Promotion data not found', true);
    return;
  }
  
  try {
    const response = await fetch('/api/dikw/promote', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ 
        item_id: item.id, 
        to_level: item.to_level, 
        promoted_content: item.promoted_content, 
        summary: item.summary || '' 
      })
    });
    
    if (response.ok) {
      document.getElementById(`promoted-${idx}`).style.display = 'none';
      showToast('Item promoted successfully');
      loadDIKWItems();
    } else {
      const data = await response.json();
      showToast(data.error || 'Failed to promote item', true);
    }
  } catch (err) {
    console.error('Promotion error:', err);
    showToast('Failed to promote item', true);
  }
}

function skipPromotion(idx) {
  document.getElementById(`promoted-${idx}`).style.display = 'none';
}

async function acceptConfidence(idx, itemId, newConfidence) {
  try {
    const response = await fetch(`/api/dikw/${itemId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ confidence: newConfidence })
    });
    
    if (response.ok) {
      document.getElementById(`confidence-${idx}`).style.display = 'none';
      showToast('Confidence updated');
      loadDIKWItems();
    } else {
      showToast('Failed to update confidence', true);
    }
  } catch (err) {
    showToast('Failed to update confidence', true);
  }
}

function skipConfidence(idx) {
  document.getElementById(`confidence-${idx}`).style.display = 'none';
}

// Wisdom candidate handlers
function skipWisdom(idx) {
  document.getElementById(`wisdom-${idx}`).style.display = 'none';
}

// New wisdom handler using stored data
async function applyWisdom(idx) {
  const item = window._wisdomCandidates?.[idx];
  if (!item) {
    showToast('Wisdom data not found', true);
    return;
  }
  
  try {
    const response = await fetch('/api/dikw/promote', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ 
        item_id: item.id, 
        to_level: 'wisdom', 
        promoted_content: item.potential_wisdom,
        summary: item.potential_wisdom.substring(0, 100)
      })
    });
    
    if (response.ok) {
      document.getElementById(`wisdom-${idx}`).style.display = 'none';
      showToast('üåü Promoted to Wisdom!');
      loadDIKWItems();
    } else {
      const data = await response.json();
      showToast(data.error || 'Failed to promote to wisdom', true);
    }
  } catch (err) {
    console.error('Wisdom promotion error:', err);
    showToast('Failed to promote to wisdom', true);
  }
}
</script>
{% endblock %}
