{% extends "base.html" %}
{% block title %}Chat{% endblock %}
{% block content %}

<style>
  .chat-container {
    display: flex;
    position: fixed;
    top: 56px; /* Below header */
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--sf-bg, #f5f5f5);
    padding-right: 80px; /* Space for floating shortcuts */
    transition: left 0.2s ease;
  }

  body.drawer-pinned .chat-container {
    left: 260px;
  }

  /* Early drawer pinned state (before body class is applied) */
  html.drawer-pinned-early .chat-container {
    left: 260px;
  }

  /* Sidebar - Chat History - Docked Left */
  .chat-sidebar {
    width: 260px;
    min-width: 260px;
    background: var(--sf-card-bg, white);
    border-right: 1px solid var(--sf-border, #e0e0e0);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    flex-shrink: 0;
  }

  /* Right Context Panel */
  .context-panel {
    width: 300px;
    min-width: 300px;
    background: var(--sf-card-bg, white);
    border-left: 1px solid var(--sf-border, #e0e0e0);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    flex-shrink: 0;
  }

  .context-panel-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--sf-border, #eee);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .context-panel-header h3 {
    margin: 0;
    font-size: 1rem;
    color: var(--sf-text, #2c3e50);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .context-panel-body {
    flex: 1;
    overflow-y: auto;
    padding: 0.75rem;
  }

  .context-section {
    margin-bottom: 1.25rem;
  }

  .context-section-title {
    font-size: 0.7rem;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.5rem;
    padding: 0 0.25rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  /* Sprint Phase Selector */
  .sprint-phase-selector {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin-bottom: 0.5rem;
  }

  .phase-chip {
    padding: 0.4rem 0.7rem;
    background: #f5f5f5;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
    color: #666;
  }

  .phase-chip:hover {
    background: #e8f4fc;
    border-color: #3498db;
    color: #3498db;
  }

  .phase-chip.active {
    background: #3498db;
    border-color: #3498db;
    color: white;
  }

  .mode-stats-mini {
    display: flex;
    gap: 1rem;
    font-size: 0.7rem;
    color: #888;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid #eee;
  }

  .mode-stats-mini .stat-item {
    display: flex;
    gap: 4px;
  }

  .mode-stats-mini .stat-item span:last-child {
    font-weight: 600;
    color: #555;
  }

  /* User Status Input */
  .status-input-container {
    display: flex;
    gap: 6px;
    margin-bottom: 0.5rem;
  }

  .status-input {
    flex: 1;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.8rem;
    font-family: inherit;
  }

  .status-input:focus {
    outline: none;
    border-color: #3498db;
  }

  .status-update-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: #3498db;
    color: white;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  }

  .status-update-btn:hover {
    background: #2980b9;
  }

  .current-status-display {
    font-size: 0.75rem;
    color: #666;
    padding: 0.4rem;
    background: #f8f9fa;
    border-radius: 4px;
    margin-bottom: 0.5rem;
    display: none;
  }

  .current-status-display.visible {
    display: block;
  }

  .current-status-display strong {
    color: #27ae60;
  }

  /* Tech Stack Tags */
  .tech-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
  }

  .tech-tag {
    padding: 0.35rem 0.6rem;
    background: #f8f9fa;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
    color: #555;
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }

  .tech-tag:hover {
    border-color: #667eea;
    background: #f0e8fc;
  }

  .tech-tag.active {
    background: #667eea;
    border-color: #667eea;
    color: white;
  }

  .tech-tag .tag-icon {
    font-size: 0.7rem;
  }

  /* Quick Prompts */
  .quick-prompts {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }

  .quick-prompt {
    padding: 0.6rem 0.75rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #f0f4f8 100%);
    border: 1px solid #e8e8e8;
    border-radius: 8px;
    font-size: 0.82rem;
    cursor: pointer;
    transition: all 0.2s;
    color: #444;
    text-align: left;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .quick-prompt:hover {
    background: linear-gradient(135deg, #e8f4fc 0%, #dbeafe 100%);
    border-color: #3498db;
    transform: translateX(2px);
  }

  .quick-prompt .prompt-icon {
    font-size: 0.9rem;
    width: 20px;
    text-align: center;
  }

  /* Related Signals */
  .related-signals {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }

  .related-signal {
    padding: 0.6rem 0.75rem;
    background: #fafafa;
    border-left: 3px solid #ddd;
    border-radius: 0 6px 6px 0;
    font-size: 0.8rem;
    line-height: 1.4;
    color: #555;
    cursor: pointer;
    transition: all 0.2s;
  }

  .related-signal:hover {
    background: #f5f5f5;
  }

  .related-signal.decision { border-left-color: #3498db; }
  .related-signal.action { border-left-color: #f39c12; }
  .related-signal.blocker { border-left-color: #e74c3c; }
  .related-signal.idea { border-left-color: #27ae60; }
  .related-signal.risk { border-left-color: #9b59b6; }

  .related-signal-type {
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    color: #888;
    margin-bottom: 0.2rem;
  }

  .related-signal-text {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .related-signal-source {
    font-size: 0.7rem;
    color: #aaa;
    margin-top: 0.25rem;
  }

  /* Sprint Stats */
  .sprint-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
  }

  .sprint-stat {
    background: #f8f9fa;
    padding: 0.6rem;
    border-radius: 8px;
    text-align: center;
  }

  .sprint-stat-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: #2c3e50;
  }

  .sprint-stat-label {
    font-size: 0.7rem;
    color: #888;
    text-transform: uppercase;
  }

  .sprint-stat.blockers .sprint-stat-value { color: #e74c3c; }
  .sprint-stat.actions .sprint-stat-value { color: #f39c12; }

  .sprint-stat.clickable {
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .sprint-stat.clickable:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  /* Modal large variant */
  .modal.modal-lg {
    max-width: 600px;
    max-height: 80vh;
  }

  .modal.modal-lg .modal-body {
    max-height: 60vh;
    overflow-y: auto;
  }

  /* Signal items list in modals */
  .signal-items-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .signal-item-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 12px;
    border-left: 3px solid #3498db;
  }

  .signal-item-card.blocker { border-left-color: #e74c3c; }
  .signal-item-card.action_items { border-left-color: #f39c12; }
  .signal-item-card.handled { opacity: 0.5; background: #e9ecef; }

  .signal-item-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
  }

  .signal-item-source {
    font-size: 0.75rem;
    color: #666;
  }

  .signal-item-date {
    font-size: 0.7rem;
    color: #999;
  }

  .signal-item-text {
    font-size: 0.9rem;
    color: #2c3e50;
    line-height: 1.5;
    margin-bottom: 10px;
  }

  .signal-item-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }

  .signal-action-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .signal-action-btn.approve {
    background: #27ae60;
    color: white;
  }

  .signal-action-btn.approve:hover {
    background: #219a52;
  }

  .signal-action-btn.reject {
    background: #e74c3c;
    color: white;
  }

  .signal-action-btn.reject:hover {
    background: #c0392b;
  }

  .signal-action-btn.ask {
    background: #3498db;
    color: white;
  }

  .signal-action-btn.ask:hover {
    background: #2980b9;
  }

  .loading-state {
    text-align: center;
    padding: 2rem;
    color: #888;
  }

  .empty-signals {
    text-align: center;
    padding: 2rem;
    color: #888;
  }

  /* Empty state for context panel */
  .context-empty {
    text-align: center;
    color: #aaa;
    font-size: 0.85rem;
    padding: 1rem;
  }

  /* Collapse button for context panel */
  .collapse-panel-btn {
    background: none;
    border: none;
    padding: 0.25rem;
    cursor: pointer;
    color: #888;
    transition: color 0.2s;
  }

  .collapse-panel-btn:hover {
    color: #333;
  }

  .context-panel.collapsed {
    width: 40px;
    min-width: 40px;
  }

  .context-panel.collapsed .context-panel-body,
  .context-panel.collapsed .context-panel-header h3 span {
    display: none;
  }

  .context-panel.collapsed .context-panel-header {
    justify-content: center;
    padding: 1rem 0.5rem;
  }

  .sidebar-header {
    padding: 1.25rem;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .sidebar-header h3 {
    margin: 0;
    font-size: 1.1rem;
    color: #2c3e50;
  }

  /* Small pencil button for sidebar header */
  .sidebar-new-btn {
    background: #3498db;
    color: white;
    border: none;
    width: 32px;
    height: 32px;
    padding: 0;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
  }

  .sidebar-new-btn:hover {
    background: #2980b9;
    transform: translateY(-1px);
  }

  .sidebar-new-btn svg {
    width: 16px;
    height: 16px;
  }

  /* Full "New Chat" button for empty states */
  .new-chat-btn {
    background: #3498db;
    color: white;
    border: none;
    padding: 0.6rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    text-decoration: none;
  }

  .new-chat-btn:hover {
    background: #2980b9;
    transform: translateY(-1px);
  }

  .conversation-list {
    flex: 1;
    overflow-y: auto;
    padding: 0.5rem;
  }

  .conversation-item {
    padding: 0.9rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 0.4rem;
    border: 1px solid transparent;
    position: relative;
  }

  .conversation-item:hover {
    background: #f8f9fa;
  }
  
  .conversation-item:hover .conversation-actions {
    opacity: 1;
  }

  .conversation-item.active {
    background: #e8f4fc;
    border-color: #3498db;
  }

  .conversation-item a {
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .conversation-actions {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    display: flex;
    gap: 0.25rem;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 10;
  }
  
  .conversation-action-btn {
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 0.25rem 0.4rem;
    cursor: pointer;
    font-size: 0.7rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    position: relative;
    z-index: 11;
  }
  
  .conversation-action-btn:hover {
    background: var(--sf-primary, #667eea);
    color: white;
    border-color: var(--sf-primary, #667eea);
  }
  
  .conversation-action-btn.delete:hover {
    background: #ef4444;
    border-color: #ef4444;
  }

  .conversation-title {
    font-weight: 500;
    color: #2c3e50;
    font-size: 0.95rem;
    margin-bottom: 0.3rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .conversation-meta {
    font-size: 0.8rem;
    color: #7f8c8d;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .conversation-preview {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.3rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .message-count {
    background: #ecf0f1;
    padding: 0.15rem 0.5rem;
    border-radius: 10px;
    font-size: 0.75rem;
  }

  /* Main Chat Area */
  .chat-main {
    flex: 1;
    background: white;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    margin: 1rem;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  }

  .chat-header {
    padding: 1.25rem;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .chat-header h3 {
    margin: 0;
    font-size: 1.1rem;
    color: #2c3e50;
  }

  .chat-header-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }

  .model-selector-btn {
    padding: 0.4rem 0.8rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.85rem;
    background: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }
  .model-selector-btn:hover {
    background: #f9fafb;
    border-color: #bbb;
  }
  .model-cost-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }
  .model-cost-dot.cost-low { background: #16a34a; }
  .model-cost-dot.cost-medium { background: #ca8a04; }
  .model-cost-dot.cost-high { background: #ea580c; }
  .model-cost-dot.cost-premium { background: #dc2626; }

  /* Model Panel (Collapsible) */
  .model-panel {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 0.5rem;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    z-index: 100;
    width: 280px;
    display: none;
  }
  .model-panel.open {
    display: block;
  }
  .model-panel-header {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e5e7eb;
    font-weight: 600;
    font-size: 0.9rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .model-panel-body {
    padding: 0.5rem;
    max-height: 400px;
    overflow-y: auto;
  }
  .model-group-label {
    font-size: 0.7rem;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.5rem 0.75rem 0.25rem;
  }
  .model-option-chat {
    display: flex;
    align-items: center;
    padding: 0.6rem 0.75rem;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.15s;
  }
  .model-option-chat:hover {
    background: #f3f4f6;
  }
  .model-option-chat.selected {
    background: #ede9fe;
  }
  .model-option-chat input[type="radio"] {
    width: 14px;
    height: 14px;
    accent-color: #8b5cf6;
  }
  .model-option-chat .model-info-row {
    margin-left: 0.6rem;
    display: flex;
    align-items: center;
    flex: 1;
  }
  .model-option-chat .model-name {
    font-size: 0.85rem;
    font-weight: 500;
    color: #111827;
  }
  .model-option-chat .model-cost {
    margin-left: auto;
    font-size: 0.7rem;
    font-weight: 500;
  }
  .cost-low { color: #16a34a; }
  .cost-medium { color: #ca8a04; }
  .cost-high { color: #ea580c; }
  .cost-premium { color: #dc2626; }

  .icon-btn {
    background: none;
    border: 1px solid #ddd;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    cursor: pointer;
    color: #666;
    transition: all 0.2s;
    font-size: 0.85rem;
  }

  .icon-btn:hover {
    background: #f8f9fa;
    border-color: #bbb;
  }

  .icon-btn.danger:hover {
    background: #fee;
    border-color: #e74c3c;
    color: #e74c3c;
  }

  .messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #95a5a6;
  }

  .empty-state svg {
    width: 64px;
    height: 64px;
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  .empty-state p {
    background: none;
    box-shadow: none;
    font-size: 1rem;
  }

  .message {
    padding: 1rem;
    border-radius: 12px;
    max-width: 80%;
  }

  .message.user {
    background: #3498db;
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 4px;
  }

  .message.assistant {
    background: #f8f9fa;
    color: #2c3e50;
    margin-right: auto;
    border-bottom-left-radius: 4px;
    border: 1px solid #eee;
  }

  /* Typing indicator animation */
  .typing-indicator .typing-dots span {
    animation: typingDot 1.4s infinite;
    animation-fill-mode: both;
  }
  .typing-indicator .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
  .typing-indicator .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes typingDot {
    0%, 80%, 100% { opacity: 0.3; }
    40% { opacity: 1; }
  }

  .message-role {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.4rem;
    opacity: 0.7;
  }

  .message-content {
    line-height: 1.6;
    word-wrap: break-word;
    white-space: pre-wrap;
  }

  /* Markdown rendering in assistant messages */
  .message.assistant .message-content h1,
  .message.assistant .message-content h2,
  .message.assistant .message-content h3,
  .message.assistant .message-content h4 {
    margin: 0.8rem 0 0.4rem 0;
    font-weight: 600;
    color: #2c3e50;
  }

  .message.assistant .message-content h1:first-child,
  .message.assistant .message-content h2:first-child,
  .message.assistant .message-content h3:first-child {
    margin-top: 0;
  }

  .message.assistant .message-content h1 { font-size: 1.3rem; }
  .message.assistant .message-content h2 { font-size: 1.15rem; }
  .message.assistant .message-content h3 { font-size: 1.05rem; }

  .message.assistant .message-content p {
    margin: 0.5rem 0;
    background: none;
    box-shadow: none;
    padding: 0;
  }

  .message.assistant .message-content ul,
  .message.assistant .message-content ol {
    margin: 0.5rem 0;
    padding-left: 1.5rem;
    list-style-position: outside;
  }

  .message.assistant .message-content li {
    margin: 0.3rem 0;
    padding: 0;
    border: none;
    background: none;
  }

  .message.assistant .message-content ul li {
    list-style-type: disc;
  }

  .message.assistant .message-content strong {
    font-weight: 600;
    color: #2c3e50;
  }

  .message.assistant .message-content em {
    font-style: italic;
  }

  .message.assistant .message-content code {
    background: #e8e8e8;
    padding: 0.15rem 0.4rem;
    border-radius: 3px;
    font-family: 'SF Mono', Monaco, monospace;
    font-size: 0.9em;
  }

  .message.assistant .message-content pre {
    background: #2c3e50;
    color: #ecf0f1;
    padding: 1rem;
    border-radius: 6px;
    overflow-x: auto;
    margin: 0.5rem 0;
  }

  .message.assistant .message-content pre code {
    background: none;
    padding: 0;
    color: inherit;
  }

  .message.assistant .message-content blockquote {
    border-left: 3px solid #3498db;
    padding-left: 1rem;
    margin: 0.5rem 0;
    color: #555;
    font-style: italic;
  }

  /* Choice Chips - Contextual Suggestions */
  .choice-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid #e9ecef;
  }

  .choice-chip {
    padding: 0.5rem 0.9rem;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: 1.5px solid #e1e4e8;
    border-radius: 20px;
    font-size: 0.85rem;
    color: #495057;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-weight: 500;
  }

  .choice-chip:hover {
    background: linear-gradient(135deg, #e8f4fc 0%, #dbeafe 100%);
    border-color: #3498db;
    color: #2980b9;
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(52, 152, 219, 0.15);
  }

  .choice-chip .chip-icon {
    font-size: 0.85rem;
  }

  .choice-chip.used {
    opacity: 0.4;
    pointer-events: none;
  }

  /* Choice Chips - Contextual Suggestions */
  .choice-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid #e9ecef;
  }

  .choice-chip {
    padding: 0.5rem 0.9rem;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: 1.5px solid #e1e4e8;
    border-radius: 20px;
    font-size: 0.85rem;
    color: #495057;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-weight: 500;
  }

  .choice-chip:hover {
    background: linear-gradient(135deg, #e8f4fc 0%, #dbeafe 100%);
    border-color: #3498db;
    color: #2980b9;
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(52, 152, 219, 0.15);
  }

  .choice-chip .chip-icon {
    font-size: 0.85rem;
  }

  .choice-chip.used {
    opacity: 0.4;
    pointer-events: none;
  }

  /* Choice Chips - Contextual Suggestions */
  .choice-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid #e9ecef;
  }

  .choice-chip {
    padding: 0.5rem 0.9rem;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: 1.5px solid #e1e4e8;
    border-radius: 20px;
    font-size: 0.85rem;
    color: #495057;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-weight: 500;
  }

  .choice-chip:hover {
    background: linear-gradient(135deg, #e8f4fc 0%, #dbeafe 100%);
    border-color: #3498db;
    color: #2980b9;
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(52, 152, 219, 0.15);
  }

  .choice-chip .chip-icon {
    font-size: 0.85rem;
  }

  .choice-chip.used {
    opacity: 0.4;
    pointer-events: none;
  }

  .chat-input-area {
    padding: 1.25rem;
    border-top: 1px solid #eee;
    background: #fafbfc;
  }

  .chat-form {
    display: flex;
    gap: 0.75rem;
    background: white;
    padding: 0;
    box-shadow: none;
    border-radius: 0;
  }

  .chat-textarea {
    flex: 1;
    padding: 0.9rem 1rem;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 0.95rem;
    resize: none;
    min-height: 48px;
    max-height: 150px;
    font-family: inherit;
  }

  .chat-textarea:focus {
    outline: none;
    border-color: #3498db;
  }

  .send-btn {
    padding: 0.9rem 1.5rem;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
  }

  .send-btn:hover {
    background: #2980b9;
  }

  /* Context Selector Styles */
  .chat-context-selector {
    padding: 0.75rem 1.25rem;
    border-top: 1px solid #eee;
    background: #f8fafc;
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .context-label {
    font-size: 0.8rem;
    color: #64748b;
    font-weight: 500;
  }
  
  .context-select {
    padding: 0.4rem 0.75rem;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 0.85rem;
    background: white;
    color: #334155;
    max-width: 200px;
    cursor: pointer;
  }
  
  .context-select:focus {
    outline: none;
    border-color: #3b82f6;
  }
  
  .context-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.3rem 0.6rem;
    background: #dbeafe;
    color: #1d4ed8;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
  }
  
  .context-badge.document {
    background: #dcfce7;
    color: #166534;
  }
  
  .context-badge button {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    color: inherit;
    opacity: 0.7;
    font-size: 0.9rem;
    line-height: 1;
  }
  
  .context-badge button:hover {
    opacity: 1;
  }

  /* Signal Search Button */
  .signal-search-btn {
    background: #9b59b6;
    color: white;
  }

  .signal-search-btn:hover {
    background: #8e44ad;
  }

  /* Modal Styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .modal-overlay.active {
    display: flex;
  }

  .modal {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 700px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  }

  .modal-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header h3 {
    margin: 0;
    color: #2c3e50;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #7f8c8d;
    padding: 0;
    line-height: 1;
  }

  .modal-close:hover {
    color: #2c3e50;
  }

  .modal-body {
    padding: 1.5rem;
    overflow-y: auto;
    flex: 1;
  }

  .signal-search-form {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .signal-search-form input {
    flex: 1;
    min-width: 200px;
  }

  .signal-search-form select {
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.95rem;
    background: white;
  }

  .signal-results {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .signal-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    border-left: 4px solid #3498db;
  }

  .signal-card.decision { border-left-color: #27ae60; }
  .signal-card.action { border-left-color: #e67e22; }
  .signal-card.blocker { border-left-color: #e74c3c; }
  .signal-card.risk { border-left-color: #f39c12; }
  .signal-card.idea { border-left-color: #9b59b6; }

  .signal-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
  }

  .signal-meeting-name {
    font-weight: 600;
    color: #2c3e50;
    font-size: 0.95rem;
  }

  .signal-date {
    font-size: 0.8rem;
    color: #7f8c8d;
  }

  .signal-items {
    list-style: none;
    padding: 0;
    margin: 0.5rem 0 0 0;
  }

  .signal-items li {
    padding: 0.5rem 0;
    border-bottom: 1px solid #e9ecef;
    font-size: 0.9rem;
    color: #333;
  }

  .signal-items li:last-child {
    border-bottom: none;
  }

  .signal-type-badge {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    background: #ecf0f1;
    color: #7f8c8d;
    margin-right: 0.5rem;
  }

  .no-results {
    text-align: center;
    color: #7f8c8d;
    padding: 2rem;
  }

  /* Floating Action Buttons */
  .fab-container {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    z-index: 100;
  }

  .fab {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    font-size: 1.5rem;
    text-decoration: none;
  }

  .fab:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    text-decoration: none;
  }

  .fab.primary {
    background: #3498db;
    color: white;
  }

  .fab.secondary {
    background: #9b59b6;
    color: white;
  }

  .fab-tooltip {
    position: absolute;
    right: 70px;
    background: #2c3e50;
    color: white;
    padding: 0.5rem 0.75rem;
    border-radius: 4px;
    font-size: 0.85rem;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }

  .fab:hover .fab-tooltip {
    opacity: 1;
  }

  @media (max-width: 1200px) {
    .context-panel {
      display: none;
    }
  }

  @media (max-width: 768px) {
    .chat-container {
      flex-direction: column;
      position: relative;
      top: auto;
      left: auto;
      right: auto;
      bottom: auto;
      height: auto;
    }

    .chat-sidebar {
      width: 100%;
      min-width: 100%;
      max-height: 300px;
      border-right: none;
      border-bottom: 1px solid #e0e0e0;
    }

    .chat-main {
      margin: 0;
      border-radius: 0;
      min-height: calc(100vh - 360px);
    }

    .context-panel {
      display: none;
    }

    .fab-container {
      bottom: 1rem;
      right: 1rem;
    }
  }

  /* Toast animations */
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  @keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
  }

  /* ===== DARK MODE OVERRIDES ===== */
  [data-theme="dark"] .chat-container {
    background: var(--sf-bg, #0a0e1a);
  }

  [data-theme="dark"] .chat-sidebar {
    background: var(--sf-card-bg, #1a2234);
    border-right-color: var(--sf-border, #334155);
  }

  [data-theme="dark"] .context-panel {
    background: var(--sf-card-bg, #1a2234);
    border-left-color: var(--sf-border, #334155);
  }

  [data-theme="dark"] .context-panel-header {
    border-bottom-color: var(--sf-border, #334155);
  }

  [data-theme="dark"] .context-panel-header h3 {
    color: var(--sf-text, #f0f4f8);
  }

  [data-theme="dark"] .sidebar-header {
    background: var(--sf-surface, #1e293b);
    border-bottom-color: var(--sf-border, #334155);
    color: var(--sf-text, #f0f4f8);
  }

  [data-theme="dark"] .sidebar-header h3 {
    color: var(--sf-text, #f0f4f8);
  }

  [data-theme="dark"] .new-chat-btn {
    background: var(--sf-primary, #3b82f6);
  }

  [data-theme="dark"] .sidebar-new-btn {
    background: var(--sf-primary, #3b82f6);
  }

  [data-theme="dark"] .conversations-list {
    background: var(--sf-card-bg, #1a2234);
  }

  [data-theme="dark"] .conv-item {
    color: var(--sf-text, #f0f4f8);
    border-bottom-color: var(--sf-border, #334155);
  }

  [data-theme="dark"] .conv-item:hover {
    background: var(--sf-surface, #1e293b);
  }

  [data-theme="dark"] .conv-item.active {
    background: var(--sf-primary-soft, rgba(59, 130, 246, 0.15));
    border-left-color: var(--sf-primary, #3b82f6);
  }

  [data-theme="dark"] .conversation-title {
    color: #86efac !important; /* Lighter green */
  }

  [data-theme="dark"] .conversation-preview {
    color: #fef08a !important; /* Lighter yellow */
  }

  [data-theme="dark"] .conv-date {
    color: var(--sf-text-muted, #64748b);
  }

  [data-theme="dark"] .conv-badge {
    background: var(--sf-surface, #1e293b);
    color: var(--sf-text-muted, #94a3b8);
  }

  [data-theme="dark"] .chat-main {
    background: var(--sf-card-bg, #1a2234);
  }

  [data-theme="dark"] .chat-header {
    background: var(--sf-surface, #1e293b);
    border-bottom-color: var(--sf-border, #334155);
    color: var(--sf-text, #f0f4f8);
  }

  [data-theme="dark"] .chat-header h2 {
    color: var(--sf-text, #f0f4f8);
  }

  [data-theme="dark"] .messages-container {
    background: var(--sf-card-bg, #1a2234);
  }

  [data-theme="dark"] .message-bubble.user {
    background: var(--sf-primary, #3b82f6);
    color: white;
  }

  [data-theme="dark"] .message-bubble.assistant {
    background: var(--sf-surface, #1e293b);
    color: var(--sf-text, #f0f4f8);
    border-color: var(--sf-border, #334155);
  }

  [data-theme="dark"] .message-time {
    color: var(--sf-text-muted, #64748b);
  }

  [data-theme="dark"] .input-container {
    background: var(--sf-surface, #1e293b);
    border-top-color: var(--sf-border, #334155);
  }

  [data-theme="dark"] .input-container textarea {
    background: var(--sf-bg, #0a0e1a);
    color: var(--sf-text, #f0f4f8);
    border-color: var(--sf-border, #334155);
  }

  [data-theme="dark"] .input-container textarea:focus {
    border-color: var(--sf-primary, #3b82f6);
  }

  [data-theme="dark"] .empty-state {
    color: var(--sf-text-muted, #64748b);
  }

  [data-theme="dark"] .empty-state h3 {
    color: var(--sf-text, #f0f4f8);
  }

  [data-theme="dark"] .quick-prompt {
    background: var(--sf-surface, #1e293b);
    border-color: var(--sf-border, #334155);
    color: var(--sf-text, #f0f4f8);
  }

  [data-theme="dark"] .quick-prompt:hover {
    background: var(--sf-primary-soft, rgba(59, 130, 246, 0.15));
    border-color: var(--sf-primary, #3b82f6);
  }

  [data-theme="dark"] .context-section-title {
    color: var(--sf-text-muted, #64748b);
  }

  [data-theme="dark"] .phase-chip {
    background: var(--sf-surface, #1e293b);
    border-color: var(--sf-border, #334155);
    color: var(--sf-text-muted, #94a3b8);
  }

  [data-theme="dark"] .phase-chip:hover {
    background: var(--sf-primary-soft, rgba(59, 130, 246, 0.15));
    border-color: var(--sf-primary, #3b82f6);
    color: var(--sf-primary, #3b82f6);
  }

  [data-theme="dark"] .phase-chip.active {
    background: var(--sf-primary, #3b82f6);
    color: white;
  }

  [data-theme="dark"] .tech-tag {
    background: var(--sf-surface, #1e293b);
    border-color: var(--sf-border, #334155);
    color: var(--sf-text-muted, #94a3b8);
  }

  [data-theme="dark"] .tech-tag:hover {
    border-color: var(--sf-primary, #667eea);
    background: rgba(102, 126, 234, 0.15);
  }

  [data-theme="dark"] .tech-tag.active {
    background: var(--sf-primary, #667eea);
    color: white;
  }

  [data-theme="dark"] .sprint-stat {
    background: var(--sf-surface, #1e293b);
  }

  [data-theme="dark"] .sprint-stat-value {
    color: var(--sf-text, #f0f4f8);
  }

  [data-theme="dark"] .sprint-stat-label {
    color: var(--sf-text-muted, #64748b);
  }

  [data-theme="dark"] .related-signal {
    background: var(--sf-surface, #1e293b);
    color: var(--sf-text, #f0f4f8);
  }

  [data-theme="dark"] .related-signal:hover {
    background: rgba(59, 130, 246, 0.1);
  }

  [data-theme="dark"] .related-signal-type {
    color: var(--sf-text-muted, #64748b);
  }

  [data-theme="dark"] .related-signal-source {
    color: var(--sf-text-muted, #64748b);
  }

  [data-theme="dark"] .status-input {
    background: var(--sf-bg, #0a0e1a);
    border-color: var(--sf-border, #334155);
    color: var(--sf-text, #f0f4f8);
  }

  [data-theme="dark"] .mode-stats-mini {
    border-top-color: var(--sf-border, #334155);
    color: var(--sf-text-muted, #64748b);
  }

  [data-theme="dark"] .mode-stats-mini .stat-item span:last-child {
    color: var(--sf-text, #f0f4f8);
  }

  [data-theme="dark"] .current-status-display {
    background: var(--sf-surface, #1e293b);
    color: var(--sf-text-muted, #94a3b8);
  }

  [data-theme="dark"] .fab-btn {
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
  }

  /* Message wrapper for feedback positioning */
  .message-wrapper {
    display: flex;
    align-items: flex-start;
    margin-bottom: 0.5rem;
  }
  
  .message-wrapper.user {
    justify-content: flex-end;
  }
  
  .message-wrapper.assistant {
    justify-content: flex-start;
  }
  
  .message-wrapper .message {
    margin-bottom: 0;
  }

  /* Small inline feedback buttons at bottom of assistant message (like ChatGPT) */
  .message-actions {
    display: flex;
    gap: 0.25rem;
    margin-top: 0.5rem;
    padding-top: 0.4rem;
    border-top: 1px solid rgba(0,0,0,0.05);
    opacity: 0;
    transition: opacity 0.15s;
  }
  
  .message:hover .message-actions,
  .message-actions:focus-within,
  .message-actions.has-selection {
    opacity: 1;
  }

  .feedback-btn-mini {
    background: transparent;
    border: none;
    padding: 0.15rem 0.3rem;
    cursor: pointer;
    font-size: 0.7rem;
    opacity: 0.5;
    transition: all 0.1s;
    border-radius: 3px;
  }

  .feedback-btn-mini:hover {
    opacity: 1;
    background: rgba(0,0,0,0.05);
  }

  .feedback-btn-mini.selected {
    opacity: 1 !important;
    transform: scale(1.1);
  }

  .feedback-btn-mini.selected.thumbs-up {
    color: #22c55e;
  }

  .feedback-btn-mini.selected.thumbs-down {
    color: #ef4444;
  }

  .feedback-btn-mini:disabled:not(.selected) {
    opacity: 0.2;
    cursor: default;
  }

  /* Typing indicator animation */
  .typing-dots {
    display: inline-flex;
    align-items: center;
    gap: 2px;
  }
  
  .typing-dots span {
    width: 6px;
    height: 6px;
    background: #3498db;
    border-radius: 50%;
    display: inline-block;
    animation: typingBounce 1.4s infinite ease-in-out both;
  }
  
  .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
  .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
  .typing-dots span:nth-child(3) { animation-delay: 0s; }
  
  @keyframes typingBounce {
    0%, 80%, 100% {
      transform: scale(0.6);
      opacity: 0.5;
    }
    40% {
      transform: scale(1);
      opacity: 1;
    }
  }

  .feedback-btn-inline {
    background: transparent;
    border: 1px solid transparent;
    border-radius: 4px;
    padding: 0.15rem 0.25rem;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.15s;
    opacity: 0.7;
  }

  .feedback-btn-inline:hover {
    opacity: 1;
    transform: scale(1.15);
    border-color: #ddd;
  }

  .feedback-btn-inline:active {
    transform: scale(0.85);
  }

  .feedback-btn-inline.thumbs-up:hover {
    background: #e8f5e9;
    border-color: #4caf50;
  }

  .feedback-btn-inline.thumbs-down:hover {
    background: #ffebee;
    border-color: #f44336;
  }

  .feedback-btn-inline.selected {
    opacity: 1;
    transform: scale(1.1);
  }

  .feedback-btn-inline.selected.thumbs-up {
    background: #4caf50;
    border-color: #4caf50;
    color: white;
  }

  .feedback-btn-inline.selected.thumbs-down {
    background: #f44336;
    border-color: #f44336;
    color: white;
  }

  .feedback-btn-inline:disabled {
    cursor: default;
  }

  /* Old feedback buttons (deprecated, kept for backward compat) */
  .feedback-buttons {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
  }

  .feedback-btn {
    background: transparent;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    padding: 0.25rem 0.5rem;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s;
    opacity: 0.7;
  }

  .feedback-btn:hover {
    opacity: 1;
    transform: scale(1.1);
  }

  .feedback-btn.thumbs-up:hover {
    background: #e8f5e9;
    border-color: #4caf50;
  }

  .feedback-btn.thumbs-down:hover {
    background: #ffebee;
    border-color: #f44336;
  }

  .feedback-btn.selected {
    opacity: 1;
    transform: scale(1.15);
  }

  .feedback-btn.selected.thumbs-up {
    background: #4caf50;
    border-color: #4caf50;
    color: white;
  }

  .feedback-btn.selected.thumbs-down {
    background: #f44336;
    border-color: #f44336;
    color: white;
  }

  .feedback-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .feedback-btn:active {
    transform: scale(0.9);
    opacity: 1;
  }

  .feedback-btn.thumbs-up:active {
    background: #c8e6c9;
    border-color: #388e3c;
  }

  .feedback-btn.thumbs-down:active {
    background: #ffcdd2;
    border-color: #d32f2f;
  }
</style>

<div class="chat-container">
  <!-- Sidebar - Conversation History -->
  <div class="chat-sidebar">
    <div class="sidebar-header">
      <h3>üí¨ Conversations</h3>
      <a href="/chat/new" class="sidebar-new-btn" title="New Chat">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
        </svg>
      </a>
    </div>
    <div class="conversation-list">
      {% if conversations %}
        {% for conv in conversations %}
          <div class="conversation-item {% if active_conversation and active_conversation.id == conv.id %}active{% endif %}" data-id="{{ conv.id }}">
            <div class="conversation-actions">
              <button class="conversation-action-btn archive" onclick="event.preventDefault(); event.stopPropagation(); archiveConversation({{ conv.id }})" title="Archive">
                üì¶
              </button>
              <button class="conversation-action-btn delete" onclick="event.preventDefault(); event.stopPropagation(); confirmDeleteConversation({{ conv.id }})" title="Delete permanently">
                üóëÔ∏è
              </button>
            </div>
            <a href="/chat/{{ conv.id }}">
              <div class="conversation-title">
                {{ conv.title or "New conversation" }}
              </div>
              <div class="conversation-meta">
                <span>{{ conv.created_at[:10] if conv.created_at else "Unknown" }}</span>
                <span class="message-count">{{ conv.message_count or 0 }} msgs</span>
              </div>
              {% if conv.first_message %}
                <div class="conversation-preview">{{ conv.first_message[:60] }}{% if conv.first_message|length > 60 %}...{% endif %}</div>
              {% endif %}
            </a>
          </div>
        {% endfor %}
      {% else %}
        <div class="empty-state" style="padding: 2rem;">
          <p>No conversations yet</p>
          <a href="/chat/new" class="new-chat-btn" style="margin-top: 1rem;">Start your first chat</a>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Main Chat Area -->
  <div class="chat-main">
    {% if active_conversation %}
      <div class="chat-header">
        <h3>{{ active_conversation.title or "New conversation" }}</h3>
        <div class="chat-header-actions" style="position: relative;">
          <button class="model-selector-btn" onclick="toggleModelPanel()" id="modelSelectorBtn">
            <span class="model-cost-dot cost-low" id="modelCostDot"></span>
            <span id="currentModelName">GPT-4o Mini</span>
            <span style="font-size: 0.7rem;">‚ñº</span>
          </button>
          
          <!-- Model Panel (Collapsible) -->
          <div class="model-panel" id="modelPanel">
            <div class="model-panel-header">
              <span>ü§ñ Select Model</span>
              <button onclick="toggleModelPanel()" style="background: none; border: none; cursor: pointer; font-size: 1rem;">‚úï</button>
            </div>
            <div class="model-panel-body">
              <div class="model-group-label">OpenAI</div>
              <label class="model-option-chat" data-model="gpt-4o-mini" data-cost="low">
                <input type="radio" name="chat_model" value="gpt-4o-mini">
                <div class="model-info-row">
                  <span class="model-name">GPT-4o Mini</span>
                  <span class="model-cost cost-low">$ Fast</span>
                </div>
              </label>
              <label class="model-option-chat" data-model="gpt-4.1-mini" data-cost="low">
                <input type="radio" name="chat_model" value="gpt-4.1-mini">
                <div class="model-info-row">
                  <span class="model-name">GPT-4.1 Mini</span>
                  <span class="model-cost cost-low">$ Fast</span>
                </div>
              </label>
              <label class="model-option-chat" data-model="gpt-4o" data-cost="medium">
                <input type="radio" name="chat_model" value="gpt-4o">
                <div class="model-info-row">
                  <span class="model-name">GPT-4o</span>
                  <span class="model-cost cost-medium">$$ Balanced</span>
                </div>
              </label>
              <label class="model-option-chat" data-model="gpt-4.1" data-cost="medium">
                <input type="radio" name="chat_model" value="gpt-4.1">
                <div class="model-info-row">
                  <span class="model-name">GPT-4.1</span>
                  <span class="model-cost cost-medium">$$ Balanced</span>
                </div>
              </label>
              <label class="model-option-chat" data-model="o1-mini" data-cost="high">
                <input type="radio" name="chat_model" value="o1-mini">
                <div class="model-info-row">
                  <span class="model-name">o1 Mini</span>
                  <span class="model-cost cost-high">$$$ Reasoning</span>
                </div>
              </label>
              
              <div class="model-group-label" style="margin-top: 0.5rem;">Anthropic</div>
              <label class="model-option-chat" data-model="claude-3-5-haiku-20241022" data-cost="low">
                <input type="radio" name="chat_model" value="claude-3-5-haiku-20241022">
                <div class="model-info-row">
                  <span class="model-name">Claude 3.5 Haiku</span>
                  <span class="model-cost cost-low">$ Fast</span>
                </div>
              </label>
              <label class="model-option-chat" data-model="claude-sonnet-4-20250514" data-cost="medium">
                <input type="radio" name="chat_model" value="claude-sonnet-4-20250514">
                <div class="model-info-row">
                  <span class="model-name">Claude Sonnet 4</span>
                  <span class="model-cost cost-medium">$$ Balanced</span>
                </div>
              </label>
              <label class="model-option-chat" data-model="claude-opus-4-20250514" data-cost="premium">
                <input type="radio" name="chat_model" value="claude-opus-4-20250514">
                <div class="model-info-row">
                  <span class="model-name">Claude Opus 4</span>
                  <span class="model-cost cost-premium">$$$$ Premium</span>
                </div>
              </label>
            </div>
          </div>
          
          <a href="/signals" class="icon-btn" title="Search Signals" style="text-decoration: none;">üîç Signals</a>
          <button class="icon-btn" onclick="archiveConversation({{ active_conversation.id }})" title="Archive">üì¶</button>
          <button class="icon-btn danger" onclick="deleteConversation({{ active_conversation.id }})" title="Delete">üóëÔ∏è</button>
        </div>
      </div>

      <div class="messages-container">
        {% if messages %}
          {% for m in messages %}
            <div class="message-wrapper {{ m.role }}">
              <div class="message {{ m.role }}">
                <div class="message-role">{{ m.role }}</div>
                <div class="message-content">{{ m.content }}</div>
                {% if m.role == 'assistant' %}
                <div class="message-actions">
                  {% if loop.last and last_run_id %}
                  <button class="feedback-btn-mini thumbs-up" onclick="submitChatFeedback('{{ last_run_id }}', 1, this)" title="Good response">üëç</button>
                  <button class="feedback-btn-mini thumbs-down" onclick="submitChatFeedback('{{ last_run_id }}', 0, this)" title="Bad response">üëé</button>
                  {% endif %}
                </div>
                {% endif %}
                {% if m.role == 'assistant' and loop.last %}
                  <div class="choice-chips" id="choice-chips">
                    <!-- Choice chips will be dynamically inserted here -->
                  </div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
            <p>Start the conversation by sending a message</p>
          </div>
        {% endif %}
      </div>

      <!-- Context Selector -->
      <div class="chat-context-selector">
        <span class="context-label">üìç Focus on:</span>
        <select id="meetingSelect" class="context-select" onchange="updateChatContext()">
          <option value="">All meetings</option>
          {% for m in meetings_list %}
          <option value="{{ m.id }}" {% if selected_meeting and selected_meeting.id == m.id %}selected{% endif %}>
            {{ m.meeting_name[:40] }}{% if m.meeting_name|length > 40 %}...{% endif %}
          </option>
          {% endfor %}
        </select>
        <select id="documentSelect" class="context-select" onchange="updateChatContext()">
          <option value="">All documents</option>
          {% for d in documents_list %}
          <option value="{{ d.id }}" {% if selected_document and selected_document.id == d.id %}selected{% endif %}>
            {{ d.source[:40] }}{% if d.source|length > 40 %}...{% endif %}
          </option>
          {% endfor %}
        </select>
        {% if selected_meeting or selected_document %}
        <div style="display: flex; gap: 0.5rem; margin-left: 0.5rem;">
          {% if selected_meeting %}
          <span class="context-badge">
            üìÖ {{ selected_meeting.name[:25] }}{% if selected_meeting.name|length > 25 %}...{% endif %}
            <button onclick="clearContext('meeting')" title="Clear">&times;</button>
          </span>
          {% endif %}
          {% if selected_document %}
          <span class="context-badge document">
            üìÑ {{ selected_document.name[:25] }}{% if selected_document.name|length > 25 %}...{% endif %}
            <button onclick="clearContext('document')" title="Clear">&times;</button>
          </span>
          {% endif %}
        </div>
        {% endif %}
      </div>

      <div class="chat-input-area">
        <form method="post" action="/chat/{{ active_conversation.id }}" class="chat-form" id="chatForm" onsubmit="return handleChatSubmit(event)">
          <textarea 
            name="message" 
            id="chatTextarea"
            class="chat-textarea" 
            placeholder="Ask a question about your meetings and documents... (e.g., 'Where was {{ env.USER_NAME }} mentioned?')"
            rows="1"
            onkeydown="handleKeyDown(event)"
          >{{ prefill_prompt or '' }}</textarea>
          <button type="submit" class="send-btn" id="sendBtn">Send</button>
        </form>
      </div>

    {% else %}
      <!-- No conversation selected -->
      <div class="empty-state" style="height: 100%;">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 80px; height: 80px;">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
        <h3 style="color: #2c3e50; margin: 1rem 0;">Memory Chat</h3>
        <p>Select a conversation or start a new one</p>
        <a href="/chat/new" class="new-chat-btn" style="margin-top: 1.5rem;">
          <span>+</span> New Chat
        </a>
      </div>
    {% endif %}
  </div>

  <!-- Right Context Panel -->
  <div class="context-panel" id="contextPanel">
    <div class="context-panel-header">
      <h3>üéØ <span>Sprint Context</span></h3>
      <button class="collapse-panel-btn" onclick="toggleContextPanel()" title="Collapse">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
        </svg>
      </button>
    </div>
    <div class="context-panel-body">
      <!-- User Status (AI-Interpreted) -->
      <div class="context-section">
        <div class="context-section-title">What are you working on?</div>
        <div class="status-input-container">
          <input 
            type="text" 
            id="userStatusInput" 
            class="status-input" 
            placeholder="e.g., Refactoring the airflow DAG..."
            onkeydown="if(event.key==='Enter') updateUserStatus()"
          />
          <button class="status-update-btn" onclick="updateUserStatus()" title="Update Status">‚Üí</button>
        </div>
        <div id="currentStatusDisplay" class="current-status-display"></div>
      </div>

      <!-- Sprint Phase -->
      <div class="context-section">
        <div class="context-section-title">
          Sprint Phase
        </div>
        <div class="sprint-phase-selector">
          <button class="phase-chip" data-phase="grooming" onclick="setPhase('grooming')">üìã Grooming</button>
          <button class="phase-chip" data-phase="planning" onclick="setPhase('planning')">üéØ Planning</button>
          <button class="phase-chip" data-phase="standup" onclick="setPhase('standup')">üó£Ô∏è Standup</button>
          <button class="phase-chip active" data-phase="implementation" onclick="setPhase('implementation')">üíª Impl</button>
        </div>
        <div class="mode-stats-mini" id="modeStatsMini">
          <span class="stat-item">Today: <span id="todayTime">-</span></span>
          <span class="stat-item">Avg: <span id="avgTime">-</span></span>
        </div>
      </div>

      <!-- Tech Stack Tags -->
      <div class="context-section">
        <div class="context-section-title">
          Tech Focus
          <span style="font-size: 0.65rem; color: #aaa;">click to filter</span>
        </div>
        <div class="tech-tags">
          <button class="tech-tag" data-tech="airflow" onclick="toggleTech('airflow')">
            <span class="tag-icon">üîÑ</span> Airflow
          </button>
          <button class="tech-tag" data-tech="python" onclick="toggleTech('python')">
            <span class="tag-icon">üêç</span> Python
          </button>
          <button class="tech-tag" data-tech="gitlab" onclick="toggleTech('gitlab')">
            <span class="tag-icon">ü¶ä</span> GitLab
          </button>
          <button class="tech-tag" data-tech="aws" onclick="toggleTech('aws')">
            <span class="tag-icon">‚òÅÔ∏è</span> AWS
          </button>
          <button class="tech-tag" data-tech="jira" onclick="toggleTech('jira')">
            <span class="tag-icon">üìù</span> Jira
          </button>
          <button class="tech-tag" data-tech="sql" onclick="toggleTech('sql')">
            <span class="tag-icon">üóÉÔ∏è</span> SQL
          </button>
        </div>
      </div>

      <!-- Sprint Quick Stats -->
      <div class="context-section">
        <div class="context-section-title">This Sprint</div>
        <div class="sprint-stats">
          <div class="sprint-stat blockers clickable" onclick="openBlockersModal()">
            <div class="sprint-stat-value" id="blockerCount">{{ sprint_stats.blockers if sprint_stats else 0 }}</div>
            <div class="sprint-stat-label">Blockers</div>
          </div>
          <div class="sprint-stat actions clickable" onclick="openActionsModal()">
            <div class="sprint-stat-value" id="actionCount">{{ sprint_stats.actions if sprint_stats else 0 }}</div>
            <div class="sprint-stat-label">Actions</div>
          </div>
        </div>
      </div>

      <!-- Quick Prompts -->
      <div class="context-section">
        <div class="context-section-title">Quick Ask</div>
        <div class="quick-prompts">
          <button class="quick-prompt" onclick="insertPrompt('For my 1-on-1: What are my top 3 things I am currently working on? Where do I need help? What are my recent observations and feedback I should discuss?')">
            <span class="prompt-icon">üë•</span> 1-on-1 prep
          </button>
          <button class="quick-prompt" onclick="insertPrompt('For standup (9:30 AM CST): What did I complete yesterday? What am I working on today? Is anything blocking my progress? Any parking lot items to address after standup?')">
            <span class="prompt-icon">üó£Ô∏è</span> Standup prep
          </button>
          <button class="quick-prompt" onclick="insertPrompt('What blockers are blocking my tickets this sprint?')">
            <span class="prompt-icon">üöß</span> What's blocking me?
          </button>
          <button class="quick-prompt" onclick="insertPrompt('Summarize decisions made this sprint that affect my work')">
            <span class="prompt-icon">‚úÖ</span> Sprint decisions
          </button>
          <button class="quick-prompt" onclick="insertPrompt('What action items are assigned to me or my team?')">
            <span class="prompt-icon">üìã</span> My action items
          </button>
          <button class="quick-prompt" onclick="insertPrompt('Create a sprint implementation plan based on my tickets and recent meetings')">
            <span class="prompt-icon">üìù</span> Sprint plan
          </button>
        </div>
      </div>

      <!-- Related Signals -->
      <div class="context-section">
        <div class="context-section-title">
          Recent Signals
          <a href="/signals" style="font-size: 0.65rem; color: #3498db; text-decoration: none;">View all ‚Üí</a>
        </div>
        <div class="related-signals" id="relatedSignals">
          {% if recent_signals %}
            {% for signal in recent_signals[:4] %}
            <div class="related-signal {{ signal.type }}" onclick="insertPrompt('Tell me more about: {{ signal.text[:50] }}')">
              <div class="related-signal-type">{{ signal.type_label }}</div>
              <div class="related-signal-text">{{ signal.text[:80] }}{% if signal.text|length > 80 %}...{% endif %}</div>
              <div class="related-signal-source">{{ signal.source }}</div>
            </div>
            {% endfor %}
          {% else %}
            <div class="context-empty">No recent signals</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Floating Action Buttons removed - using AI agent button instead -->

<!-- Blockers Modal -->
<div class="modal-overlay" id="blockersModal">
  <div class="modal modal-lg">
    <div class="modal-header">
      <h3>üöß Active Blockers</h3>
      <button class="modal-close" onclick="closeBlockersModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="signal-items-list" id="blockersList">
        <div class="loading-state">Loading blockers...</div>
      </div>
    </div>
  </div>
</div>

<!-- Actions Modal -->
<div class="modal-overlay" id="actionsModal">
  <div class="modal modal-lg">
    <div class="modal-header">
      <h3>üìã Action Items</h3>
      <button class="modal-close" onclick="closeActionsModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="signal-items-list" id="actionsList">
        <div class="loading-state">Loading action items...</div>
      </div>
    </div>
  </div>
</div>

<script>
  // ========================================
  // EARLY GLOBAL FUNCTIONS (needed for onclick handlers)
  // These must be defined before the HTML parses onclick attributes
  // ========================================
  
  // Get current conversation ID from URL or data attribute
  function getCurrentConversationId() {
    const match = window.location.pathname.match(/\/chat\/(\d+)/);
    return match ? match[1] : 'new';
  }
  
  // Get context preferences for a conversation
  function getConversationContext(convId) {
    const stored = localStorage.getItem(`chatContext_${convId}`);
    return stored ? JSON.parse(stored) : { phase: 'implementation', techs: [] };
  }
  
  // Save context preferences for a conversation  
  function saveConversationContext(convId, context) {
    localStorage.setItem(`chatContext_${convId}`, JSON.stringify(context));
  }
  
  // Sprint Phase - per conversation
  const convId = getCurrentConversationId();
  const savedContext = getConversationContext(convId);
  let currentPhase = savedContext.phase || 'implementation';
  
  function setPhase(phase) {
    console.log('setPhase called with:', phase);
    currentPhase = phase;
    const convId = getCurrentConversationId();
    const context = getConversationContext(convId);
    context.phase = phase;
    saveConversationContext(convId, context);
    document.querySelectorAll('.phase-chip').forEach(chip => {
      chip.classList.toggle('active', chip.dataset.phase === phase);
    });
    if (typeof updateQuickPrompts === 'function') {
      updateQuickPrompts();
    }
  }
  window.setPhase = setPhase;
  
  // Tech Stack Tags - per conversation
  let activeTechs = savedContext.techs || [];
  
  function toggleTech(tech) {
    console.log('toggleTech called with:', tech);
    const idx = activeTechs.indexOf(tech);
    if (idx > -1) {
      activeTechs.splice(idx, 1);
    } else {
      activeTechs.push(tech);
    }
    const convId = getCurrentConversationId();
    const context = getConversationContext(convId);
    context.techs = activeTechs;
    saveConversationContext(convId, context);
    updateTechTags();
  }
  window.toggleTech = toggleTech;
  
  function updateTechTags() {
    document.querySelectorAll('.tech-tag').forEach(tag => {
      tag.classList.toggle('active', activeTechs.includes(tag.dataset.tech));
    });
  }
  window.updateTechTags = updateTechTags;
  
  // Insert prompt into chat textarea
  function insertPrompt(prompt) {
    const textarea = document.querySelector('.chat-textarea');
    if (textarea) {
      let contextPrefix = '';
      if (activeTechs.length > 0) {
        contextPrefix = `[Focus: ${activeTechs.join(', ')}] `;
      }
      textarea.value = contextPrefix + prompt;
      textarea.focus();
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
    } else {
      const encoded = encodeURIComponent(prompt);
      window.location.href = `/chat/new?prompt=${encoded}`;
    }
  }
  window.insertPrompt = insertPrompt;
  
  // User Status Management
  async function updateUserStatus() {
    const input = document.getElementById('userStatusInput');
    if (!input) return;
    const statusText = input.value.trim();
    if (!statusText) return;
    
    try {
      const resp = await fetch('/api/user-status/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ status: statusText })
      });
      
      const data = await resp.json();
      
      if (data.status === 'ok') {
        const interpreted = data.interpreted;
        const display = document.getElementById('currentStatusDisplay');
        if (display) {
          display.innerHTML = `<strong>${interpreted.mode}</strong>: ${interpreted.activity}`;
          display.classList.add('visible');
        }
        input.value = '';
        if (interpreted.mode) {
          currentPhase = interpreted.mode;
          localStorage.setItem('sprintPhase', interpreted.mode);
          document.querySelectorAll('.phase-chip').forEach(chip => {
            chip.classList.toggle('active', chip.dataset.phase === interpreted.mode);
          });
        }
      }
    } catch (err) {
      console.error('Failed to update status:', err);
    }
  }
  window.updateUserStatus = updateUserStatus;
  
  // Blockers Modal
  function openBlockersModal() {
    const modal = document.getElementById('blockersModal');
    if (modal) {
      modal.classList.add('active');
      loadBlockers();
    }
  }
  window.openBlockersModal = openBlockersModal;
  
  function closeBlockersModal() {
    const modal = document.getElementById('blockersModal');
    if (modal) modal.classList.remove('active');
  }
  window.closeBlockersModal = closeBlockersModal;
  
  async function loadBlockers() {
    const listDiv = document.getElementById('blockersList');
    if (!listDiv) return;
    listDiv.innerHTML = '<div class="loading-state">Loading blockers...</div>';
    try {
      const response = await fetch('/api/sprint-signals/blockers', { credentials: 'same-origin' });
      const data = await response.json();
      if (data.signals && data.signals.length > 0) {
        listDiv.innerHTML = data.signals.map(signal => renderSignalCard(signal, 'blocker')).join('');
      } else {
        listDiv.innerHTML = '<div class="empty-signals">‚ú® No blockers right now!</div>';
      }
    } catch (err) {
      console.error('Error loading blockers:', err);
      listDiv.innerHTML = '<div class="empty-signals">Failed to load blockers</div>';
    }
  }
  window.loadBlockers = loadBlockers;
  
  // Actions Modal
  function openActionsModal() {
    const modal = document.getElementById('actionsModal');
    if (modal) {
      modal.classList.add('active');
      loadActions();
    }
  }
  window.openActionsModal = openActionsModal;
  
  function closeActionsModal() {
    const modal = document.getElementById('actionsModal');
    if (modal) modal.classList.remove('active');
  }
  window.closeActionsModal = closeActionsModal;
  
  async function loadActions() {
    const listDiv = document.getElementById('actionsList');
    if (!listDiv) return;
    listDiv.innerHTML = '<div class="loading-state">Loading action items...</div>';
    try {
      const response = await fetch('/api/sprint-signals/action_items', { credentials: 'same-origin' });
      const data = await response.json();
      if (data.signals && data.signals.length > 0) {
        listDiv.innerHTML = data.signals.map(signal => renderSignalCard(signal, 'action_items')).join('');
      } else {
        listDiv.innerHTML = '<div class="empty-signals">‚ú® No pending action items!</div>';
      }
    } catch (err) {
      console.error('Error loading actions:', err);
      listDiv.innerHTML = '<div class="empty-signals">Failed to load action items</div>';
    }
  }
  window.loadActions = loadActions;
  
  // Signal card renderer (needed by loadBlockers/loadActions)
  function renderSignalCard(signal, type) {
    const handleClass = localStorage.getItem(`signal-handled-${signal.id}`) ? 'handled' : '';
    return `
      <div class="signal-item-card ${type} ${handleClass}" id="signal-${signal.id}">
        <div class="signal-item-header">
          <div class="signal-item-source">üìÑ ${escapeHtmlEarly(signal.meeting_name || 'Unknown Meeting')}</div>
          <div class="signal-item-date">${signal.meeting_date || 'No date'}</div>
        </div>
        <div class="signal-item-text">${escapeHtmlEarly(signal.text)}</div>
        <div class="signal-item-actions">
          <button class="signal-action-btn ask" onclick="askAboutSignal('${escapeHtmlEarly(signal.text.substring(0, 100))}')">
            üí¨ Ask
          </button>
          <button class="signal-action-btn approve" onclick="handleSignal('${signal.id}', 'approve')">
            ‚úì Done
          </button>
          <button class="signal-action-btn reject" onclick="handleSignal('${signal.id}', 'reject')">
            ‚úó Not relevant
          </button>
        </div>
      </div>
    `;
  }
  window.renderSignalCard = renderSignalCard;
  
  // Early escapeHtml for signal cards
  function escapeHtmlEarly(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
  }
  window.escapeHtmlEarly = escapeHtmlEarly;
  
  // Signal actions
  function askAboutSignal(signalText) {
    const prompt = `Tell me more about this signal: "${signalText}"`;
    insertPrompt(prompt);
  }
  window.askAboutSignal = askAboutSignal;
  
  async function handleSignal(signalId, action) {
    const card = document.getElementById(`signal-${signalId}`);
    try {
      const formData = new FormData();
      formData.append('signal_id', signalId);
      formData.append('action', action);
      
      await fetch('/api/signal-action', {
        method: 'POST',
        body: formData,
        credentials: 'same-origin'
      });
      
      localStorage.setItem(`signal-handled-${signalId}`, action);
      if (card) {
        card.classList.add('handled');
        setTimeout(() => card.remove(), 300);
      }
    } catch (err) {
      console.error('Failed to handle signal:', err);
    }
  }
  window.handleSignal = handleSignal;
  
  // Context Panel
  function toggleContextPanel() {
    const panel = document.getElementById('contextPanel');
    if (panel) {
      panel.classList.toggle('collapsed');
      localStorage.setItem('contextPanelCollapsed', panel.classList.contains('collapsed'));
    }
  }
  window.toggleContextPanel = toggleContextPanel;
  
  // Signal search modal
  function openSignalModal() {
    const modal = document.getElementById('signalModal');
    if (modal) {
      modal.classList.add('active');
      document.getElementById('signalSearchQuery')?.focus();
    }
  }
  window.openSignalModal = openSignalModal;
  
  function closeSignalModal() {
    const modal = document.getElementById('signalModal');
    if (modal) modal.classList.remove('active');
  }
  window.closeSignalModal = closeSignalModal;
  
  // ========================================
  // MAIN SCRIPT
  // ========================================

  // Markdown Parser - use marked.js library for proper rendering
  function parseMarkdown(text) {
    if (!text) return '';
    
    // Use marked.js for proper markdown parsing
    if (typeof marked !== 'undefined' && typeof marked.parse === 'function') {
      try {
        // Configure marked for safe rendering
        marked.setOptions({
          breaks: true,  // Convert \n to <br>
          gfm: true,     // GitHub Flavored Markdown
          sanitize: false // We trust our AI output
        });
        return marked.parse(text);
      } catch (e) {
        console.error('marked.js error:', e);
      }
    }
    
    // Fallback to basic parsing if marked.js not loaded
    let html = text
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
    
    // Code blocks
    html = html.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
    html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
    
    // Headers
    html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
    html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
    html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
    
    // Bold and italic
    html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
    
    // Lists
    html = html.replace(/^[-*] (.+)$/gm, '<li>$1</li>');
    html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
    html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
    
    // Paragraphs
    html = html.replace(/\n\n+/g, '</p><p>');
    html = '<p>' + html + '</p>';
    html = html.replace(/<p>\s*<\/p>/g, '');
    
    return html;
  }

  // Apply markdown parsing to all assistant messages
  function applyMarkdownToMessages() {
    document.querySelectorAll('.message.assistant .message-content').forEach(function(el) {
      // Skip if already processed
      if (el.dataset.markdownApplied === 'true') return;
      
      const rawText = el.textContent;
      if (rawText && rawText.trim()) {
        el.innerHTML = parseMarkdown(rawText);
        el.dataset.markdownApplied = 'true';
      }
    });
  }

  // Apply markdown on page load - wait for marked.js to be available
  document.addEventListener('DOMContentLoaded', function() {
    // Try to apply markdown immediately
    applyMarkdownToMessages();
    
    // If marked wasn't loaded yet, try again after a short delay
    if (typeof marked === 'undefined') {
      setTimeout(applyMarkdownToMessages, 100);
      setTimeout(applyMarkdownToMessages, 500);
    }
    
    // Restore saved context for this conversation
    const convId = getCurrentConversationId();
    const savedCtx = getConversationContext(convId);
    
    // Restore phase selection
    if (savedCtx.phase) {
      currentPhase = savedCtx.phase;
      document.querySelectorAll('.phase-chip').forEach(chip => {
        chip.classList.toggle('active', chip.dataset.phase === savedCtx.phase);
      });
    }
    
    // Restore tech tag selection
    if (savedCtx.techs && savedCtx.techs.length > 0) {
      activeTechs = savedCtx.techs;
      updateTechTags();
    }
  });

  // Auto-resize textarea
  const textarea = document.querySelector('.chat-textarea');
  if (textarea) {
    textarea.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 150) + 'px';
    });
    
    // Auto-focus and resize if pre-filled
    if (textarea.value.trim()) {
      textarea.focus();
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
      // Move cursor to end
      textarea.setSelectionRange(textarea.value.length, textarea.value.length);
    }
  }

  // Handle Enter key for send
  function handleKeyDown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      const form = event.target.form;
      if (form) {
        handleChatSubmit(new Event('submit'));
      }
    }
  }

  // Submit chat feedback to LangSmith
  async function submitChatFeedback(runId, score, buttonEl) {
    if (!runId) return;
    
    // Get container and sibling buttons
    const container = buttonEl.parentElement;
    const buttons = container.querySelectorAll('.feedback-btn-mini, .feedback-btn-inline, .feedback-btn');
    
    // Mark selected button immediately and keep container visible
    buttonEl.classList.add('selected');
    container.classList.add('has-selection');
    
    // Disable all buttons after selection
    buttons.forEach(btn => {
      btn.disabled = true;
    });
    
    try {
      const response = await fetch('/api/evaluations/thumbs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({
          run_id: runId,
          score: score,
          key: 'helpfulness',
          comment: score === 1 ? 'User marked as helpful' : 'User marked as not helpful'
        })
      });
      
      if (response.ok) {
        showToast(score === 1 ? 'Thanks! üëç' : 'Thanks for the feedback üìù', 'success');
      }
    } catch (err) {
      console.error('Failed to submit feedback:', err);
      // Keep selection even on error
    }
  }

  // Handle form submit - AJAX version (no page reload)
  async function handleChatSubmit(event) {
    event.preventDefault();
    const textarea = document.getElementById('chatTextarea');
    const sendBtn = document.getElementById('sendBtn');
    const messagesContainer = document.querySelector('.messages-container');
    const message = textarea.value.trim();
    const conversationId = {{ active_conversation.id if active_conversation else 'null' }};
    
    if (!message || !conversationId) return false;
    
    // Immediately show user message in the chat window
    const userMessageDiv = document.createElement('div');
    userMessageDiv.className = 'message-wrapper user';
    userMessageDiv.innerHTML = `
      <div class="message user">
        <div class="message-role">user</div>
        <div class="message-content">${escapeHtml(message)}</div>
      </div>
    `;
    messagesContainer.appendChild(userMessageDiv);
    
    // Show typing indicator for AI with animated dots
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message-wrapper assistant';
    typingDiv.id = 'typingIndicator';
    typingDiv.innerHTML = `
      <div class="message assistant typing-indicator">
        <div class="message-role">assistant</div>
        <div class="message-content"><span class="typing-dots"><span></span><span></span><span></span></span></div>
      </div>
    `;
    messagesContainer.appendChild(typingDiv);
    
    // Scroll to bottom
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Disable form while submitting
    textarea.disabled = true;
    textarea.value = '';
    sendBtn.disabled = true;
    sendBtn.textContent = 'Sending...';
    sendBtn.style.opacity = '0.6';
    
    try {
      const response = await fetch(`/api/chat/${conversationId}/send`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ message: message })
      });
      
      const data = await response.json();
      
      // Remove typing indicator
      const typingEl = document.getElementById('typingIndicator');
      if (typingEl) typingEl.remove();
      
      if (data.success) {
        // Add assistant response with feedback buttons
        const assistantDiv = document.createElement('div');
        assistantDiv.className = 'message-wrapper assistant';
        
        // Format response - escape HTML but preserve structure
        // white-space: pre-wrap in CSS will handle newlines
        let formattedResponse = escapeHtml(data.response)
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        assistantDiv.innerHTML = `
          <div class="message assistant">
            <div class="message-role">assistant</div>
            <div class="message-content">${formattedResponse}</div>
            ${data.run_id ? `
            <div class="message-actions">
              <button class="feedback-btn-mini thumbs-up" onclick="submitChatFeedback('${data.run_id}', 1, this)" title="Good response">üëç</button>
              <button class="feedback-btn-mini thumbs-down" onclick="submitChatFeedback('${data.run_id}', 0, this)" title="Bad response">üëé</button>
            </div>
            ` : ''}
            <div class="choice-chips" id="choice-chips"></div>
          </div>
        `;
        messagesContainer.appendChild(assistantDiv);
        
        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      } else {
        showToast(data.error || 'Failed to send message', 'error');
      }
      
    } catch (err) {
      console.error('Chat error:', err);
      // Remove typing indicator
      const typingEl = document.getElementById('typingIndicator');
      if (typingEl) typingEl.remove();
      
      // Show error
      const errorDiv = document.createElement('div');
      errorDiv.className = 'message-wrapper assistant';
      errorDiv.innerHTML = `
        <div class="message assistant error">
          <div class="message-role">assistant</div>
          <div class="message-content" style="color: #c0392b;">Sorry, an error occurred. Please try again.</div>
        </div>
      `;
      messagesContainer.appendChild(errorDiv);
    }
    
    // Re-enable form
    textarea.disabled = false;
    textarea.focus();
    sendBtn.disabled = false;
    sendBtn.textContent = 'Send';
    sendBtn.style.opacity = '1';
    
    return false;
  }
  
  // Helper to escape HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Update chat context (meeting/document focus)
  async function updateChatContext() {
    const conversationId = {{ active_conversation.id if active_conversation else 'null' }};
    if (!conversationId) return;
    
    const meetingId = document.getElementById('meetingSelect')?.value || null;
    const documentId = document.getElementById('documentSelect')?.value || null;
    
    try {
      const response = await fetch(`/api/chat/${conversationId}/context`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ meeting_id: meetingId, document_id: documentId })
      });
      
      if (response.ok) {
        showToast('Context updated - chat will now focus on selected meeting/document', 'success');
        // Reload to show updated context badges
        window.location.reload();
      }
    } catch (err) {
      console.error('Failed to update context:', err);
    }
  }

  // Clear specific context
  function clearContext(type) {
    const conversationId = {{ active_conversation.id if active_conversation else 'null' }};
    if (!conversationId) return;
    
    const meetingSelect = document.getElementById('meetingSelect');
    const documentSelect = document.getElementById('documentSelect');
    
    if (type === 'meeting' && meetingSelect) {
      meetingSelect.value = '';
    } else if (type === 'document' && documentSelect) {
      documentSelect.value = '';
    }
    
    updateChatContext();
  }

  // Scroll to bottom of messages
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ meeting_id: meetingId, document_id: documentId })
      });
      
      if (response.ok) {
        showToast('Context updated - chat will now focus on selected meeting/document', 'success');
        // Reload to show updated context badges
        window.location.reload();
      }
    } catch (err) {
      console.error('Failed to update context:', err);
    }
  }

  // Clear specific context
  function clearContext(type) {
    const conversationId = {{ active_conversation.id if active_conversation else 'null' }};
    if (!conversationId) return;
    
    const meetingSelect = document.getElementById('meetingSelect');
    const documentSelect = document.getElementById('documentSelect');
    
    if (type === 'meeting' && meetingSelect) {
      meetingSelect.value = '';
    } else if (type === 'document' && documentSelect) {
      documentSelect.value = '';
    }
    
    updateChatContext();
  }

  // Scroll to bottom of messages
  const messagesContainer = document.querySelector('.messages-container');
  if (messagesContainer && messagesContainer.children.length > 0) {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  // Delete conversation
  function deleteConversation(id) {
    if (confirm('Delete this conversation? This cannot be undone.')) {
      fetch(`/chat/${id}`, { method: 'DELETE', credentials: 'same-origin' })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'ok') {
            window.location.href = '/chat';
          }
        });
    }
  }

  // Confirm delete from sidebar
  function confirmDeleteConversation(id) {
    if (confirm('Delete this conversation permanently? This cannot be undone.')) {
      fetch(`/chat/${id}`, { method: 'DELETE', credentials: 'same-origin' })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'ok') {
            showToast('Conversation deleted', 'success');
            // Remove the conversation item from sidebar
            const convItem = document.querySelector(`.conversation-item[href="/chat/${id}"]`);
            if (convItem) {
              convItem.remove();
            }
            // If we deleted the active conversation, redirect
            if (window.location.pathname === `/chat/${id}`) {
              window.location.href = '/chat';
            }
          } else {
            showToast('Failed to delete conversation', 'error');
          }
        })
        .catch(err => {
          console.error('Delete error:', err);
          showToast('Failed to delete conversation', 'error');
        });
    }
  }

  // Archive conversation
  function archiveConversation(id) {
    console.log('archiveConversation called with:', id);
    fetch(`/chat/${id}/archive`, { method: 'POST', credentials: 'same-origin' })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'ok') {
          showToast('Conversation archived', 'success');
          // Remove the conversation item from sidebar
          const convItem = document.querySelector(`.conversation-item[data-id="${id}"]`);
          if (convItem) {
            convItem.remove();
          }
          // If we archived the active conversation, redirect
          if (window.location.pathname === `/chat/${id}`) {
            window.location.href = '/chat';
          }
        } else {
          showToast('Failed to archive conversation', 'error');
        }
      })
      .catch(err => {
        console.error('Archive error:', err);
        showToast('Failed to archive conversation', 'error');
      });
  }

  // Toast notification helper
  function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    toast.style.cssText = `
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 10000;
      animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
      background: ${type === 'success' ? 'var(--accent-color)' : type === 'error' ? '#dc3545' : 'var(--secondary-color)'};
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  // Close modal on overlay click
  document.getElementById('signalModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeSignalModal();
  });

  // Close modal on Escape
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeSignalModal();
      closeBlockersModal();
      closeActionsModal();
    }
  });

  // Close modals on overlay click
  document.getElementById('blockersModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeBlockersModal();
  });

  document.getElementById('actionsModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeActionsModal();
  });

  // Search signals via API
  async function searchSignals() {
    const query = document.getElementById('signalSearchQuery').value.trim();
    const signalType = document.getElementById('signalTypeFilter').value;
    const resultsDiv = document.getElementById('signalResults');

    if (!query) {
      resultsDiv.innerHTML = '<div class="no-results"><p>Enter a search term</p></div>';
      return;
    }

    resultsDiv.innerHTML = '<div class="no-results"><p>Searching...</p></div>';

    try {
      const response = await fetch('/api/signals/search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query, signal_type: signalType })
      });

      const data = await response.json();

      if (data.results && data.results.length > 0) {
        resultsDiv.innerHTML = data.results.map(meeting => {
          const signals = meeting.matching_signals || [];
          const signalItems = signals.map(s => 
            `<li><span class="signal-type-badge">${s.type}</span>${escapeHtml(s.text)}</li>`
          ).join('');

          return `
            <div class="signal-card ${getSignalClass(signals[0]?.type)}">
              <div class="signal-card-header">
                <span class="signal-meeting-name">${escapeHtml(meeting.meeting_name)}</span>
                <span class="signal-date">${meeting.meeting_date || 'No date'}</span>
              </div>
              <ul class="signal-items">${signalItems}</ul>
            </div>
          `;
        }).join('');
      } else {
        resultsDiv.innerHTML = `<div class="no-results"><p>No signals found matching "${escapeHtml(query)}"</p></div>`;
      }
    } catch (err) {
      console.error('Search error:', err);
      resultsDiv.innerHTML = '<div class="no-results"><p>Error searching signals. Try again.</p></div>';
    }
  }

  function getSignalClass(type) {
    const classes = {
      'decisions': 'decision',
      'action_items': 'action',
      'blockers': 'blocker',
      'risks': 'risk',
      'ideas': 'idea'
    };
    return classes[type] || '';
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Restore collapsed state
  if (localStorage.getItem('contextPanelCollapsed') === 'true') {
    document.getElementById('contextPanel')?.classList.add('collapsed');
  }

  // Initialize phase chips on load (setPhase defined at top of script)
  document.querySelectorAll('.phase-chip').forEach(chip => {
    chip.classList.toggle('active', chip.dataset.phase === currentPhase);
  });
  
  // Initialize tech tags on load
  updateTechTags();

  // Mode Timer
  let timerInterval = null;
  let timerStartTime = null;
  let isTimerRunning = false;

  async function toggleModeTimer() {
    const btn = document.getElementById('timerPlayBtn');
    const timeDisplay = document.getElementById('timerTime');
    
    if (isTimerRunning) {
      // Stop timer
      try {
        await fetch('/api/mode-timer/stop', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ mode: currentPhase })
        });
        clearInterval(timerInterval);
        timerInterval = null;
        isTimerRunning = false;
        btn.textContent = '‚ñ∂';
        btn.classList.remove('stop');
        btn.classList.add('play');
        btn.title = 'Start Timer';
        timeDisplay.classList.remove('running');
        loadModeStats();
      } catch (e) {
        console.error('Error stopping timer:', e);
      }
    } else {
      // Start timer
      try {
        await fetch('/api/mode-timer/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ mode: currentPhase })
        });
        timerStartTime = Date.now();
        isTimerRunning = true;
        btn.textContent = '‚èπ';
        btn.classList.remove('play');
        btn.classList.add('stop');
        btn.title = 'Stop Timer';
        timeDisplay.classList.add('running');
        
        timerInterval = setInterval(updateTimerDisplay, 1000);
        updateTimerDisplay();
      } catch (e) {
        console.error('Error starting timer:', e);
      }
    }
  }

  function updateTimerDisplay() {
    if (!timerStartTime) return;
    const elapsed = Math.floor((Date.now() - timerStartTime) / 1000);
    const h = Math.floor(elapsed / 3600);
    const m = Math.floor((elapsed % 3600) / 60);
    const s = elapsed % 60;
    const timeStr = h > 0 
      ? `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`
      : `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    document.getElementById('timerTime').textContent = timeStr;
  }

  async function loadModeStats() {
    try {
      const resp = await fetch('/api/mode-timer/stats', { credentials: 'same-origin' });
      const data = await resp.json();
      
      // Get today's stats for current mode
      const todayStats = data.today?.[currentPhase];
      const modeStats = data.modes?.[currentPhase];
      
      if (todayStats) {
        document.getElementById('todayTime').textContent = todayStats.total_formatted || '-';
      } else {
        document.getElementById('todayTime').textContent = '0m';
      }
      
      if (modeStats) {
        document.getElementById('avgTime').textContent = modeStats.avg_formatted || '-';
      } else {
        document.getElementById('avgTime').textContent = '-';
      }
    } catch (e) {
      console.error('Error loading mode stats:', e);
      document.getElementById('todayTime').textContent = '-';
      document.getElementById('avgTime').textContent = '-';
    }
  }

  async function checkActiveTimer() {
    try {
      const resp = await fetch('/api/mode-timer/status', { credentials: 'same-origin' });
      const data = await resp.json();
      
      // Check if there's an active session for current phase
      const activeSessions = data.active_sessions || {};
      const activeSession = activeSessions[currentPhase];
      
      if (activeSession) {
        timerStartTime = Date.now() - (activeSession.elapsed_seconds * 1000);
        isTimerRunning = true;
        const btn = document.getElementById('timerPlayBtn');
        btn.textContent = '‚èπ';
        btn.classList.remove('play');
        btn.classList.add('stop');
        btn.title = 'Stop Timer';
        document.getElementById('timerTime').classList.add('running');
        timerInterval = setInterval(updateTimerDisplay, 1000);
        updateTimerDisplay();
      }
    } catch (e) {
      console.error('Error checking active timer:', e);
    }
  }

  // Initialize timer state on load
  checkActiveTimer();
  loadModeStats();
  loadCurrentStatus();

  // Update timer when phase changes - wrap the global setPhase
  const originalSetPhase = window.setPhase;
  window.setPhase = function(phase) {
    // If timer running for old phase, stop it
    if (isTimerRunning) {
      toggleModeTimer().then(() => {
        originalSetPhase(phase);
        loadModeStats();
      });
    } else {
      originalSetPhase(phase);
      loadModeStats();
    }
  };

  async function loadCurrentStatus() {
    try {
      const resp = await fetch('/api/user-status/current', {
        credentials: 'same-origin'
      });
      const data = await resp.json();
      
      if (data.status) {
        const display = document.getElementById('currentStatusDisplay');
        display.innerHTML = `<strong>${data.status.mode}</strong>: ${data.status.activity}`;
        display.classList.add('visible');
        
        // Sync phase
        currentPhase = data.status.mode;
        document.querySelectorAll('.phase-chip').forEach(chip => {
          chip.classList.toggle('active', chip.dataset.phase === data.status.mode);
        });
      }
    } catch (e) {
      console.error('Error loading status:', e);
    }
  }

  // Model Panel - mapping for display names and costs
  const MODEL_INFO = {
    'gpt-4o-mini': { name: 'GPT-4o Mini', cost: 'low' },
    'gpt-4.1-mini': { name: 'GPT-4.1 Mini', cost: 'low' },
    'gpt-4o': { name: 'GPT-4o', cost: 'medium' },
    'gpt-4.1': { name: 'GPT-4.1', cost: 'medium' },
    'o1-mini': { name: 'o1 Mini', cost: 'high' },
    'claude-3-5-haiku-20241022': { name: 'Claude 3.5 Haiku', cost: 'low' },
    'claude-sonnet-4-20250514': { name: 'Claude Sonnet 4', cost: 'medium' },
    'claude-opus-4-20250514': { name: 'Claude Opus 4', cost: 'premium' },
  };

  function toggleModelPanel() {
    const panel = document.getElementById('modelPanel');
    panel.classList.toggle('open');
  }

  // Close panel when clicking outside
  document.addEventListener('click', function(e) {
    const panel = document.getElementById('modelPanel');
    const btn = document.getElementById('modelSelectorBtn');
    if (panel && !panel.contains(e.target) && !btn.contains(e.target)) {
      panel.classList.remove('open');
    }
  });

  // Handle model selection in chat
  document.querySelectorAll('input[name="chat_model"]').forEach(radio => {
    radio.addEventListener('change', async (e) => {
      const model = e.target.value;
      const info = MODEL_INFO[model] || { name: model, cost: 'medium' };
      
      // Update visual state
      document.querySelectorAll('.model-option-chat').forEach(opt => {
        opt.classList.remove('selected');
      });
      e.target.closest('.model-option-chat').classList.add('selected');
      
      // Update button display
      document.getElementById('currentModelName').textContent = info.name;
      const dot = document.getElementById('modelCostDot');
      dot.className = 'model-cost-dot cost-' + info.cost;
      
      // Save to server
      try {
        const response = await fetch('/api/settings/ai-model', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ model })
        });
        if (response.ok) {
          showToast('Model: ' + info.name, 'success');
          toggleModelPanel(); // Close panel after selection
        }
      } catch (err) {
        console.error('Failed to update model:', err);
      }
    });
  });

  // Load current model setting
  async function loadCurrentModel() {
    try {
      const response = await fetch('/api/settings/ai-model', { credentials: 'same-origin' });
      if (response.ok) {
        const data = await response.json();
        const model = data.model || 'gpt-4o-mini';
        const info = MODEL_INFO[model] || { name: model, cost: 'medium' };
        
        // Update button display
        document.getElementById('currentModelName').textContent = info.name;
        const dot = document.getElementById('modelCostDot');
        dot.className = 'model-cost-dot cost-' + info.cost;
        
        // Select the radio
        const radio = document.querySelector(`input[name="chat_model"][value="${model}"]`);
        if (radio) {
          radio.checked = true;
          radio.closest('.model-option-chat').classList.add('selected');
        }
      }
    } catch (err) {
      console.error('Failed to load model:', err);
    }
  }

  // Load model on page load
  loadCurrentModel();

  // Update quick prompts based on phase
  function updateQuickPrompts() {
    const prompts = {
      grooming: [
        { icon: 'üìã', text: 'What's blocking me?', prompt: 'What blockers were mentioned in backlog grooming?' },
        { icon: 'üéØ', text: 'Ticket priorities', prompt: 'What are the priority tickets discussed in grooming?' },
        { icon: 'üìä', text: 'Estimates needed', prompt: 'What tickets need estimation from grooming?' },
      ],
      planning: [
        { icon: 'üéØ', text: 'Sprint goals', prompt: 'What are the sprint goals from planning?' },
        { icon: 'üìã', text: 'My assignments', prompt: 'What tickets are assigned to me this sprint?' },
        { icon: '‚ö°', text: 'Dependencies', prompt: 'What dependencies were identified in sprint planning?' },
      ],
      standup: [
        { icon: 'üöß', text: 'What's blocking me?', prompt: 'What blockers were mentioned in recent standups?' },
        { icon: 'üìù', text: 'Yesterday updates', prompt: 'Summarize what was completed yesterday from standups' },
        { icon: 'üéØ', text: 'Today focus', prompt: 'What did the team commit to doing today?' },
      ],
      implementation: [
        { icon: 'üöß', text: 'What's blocking me?', prompt: 'What blockers are blocking my tickets this sprint?' },
        { icon: '‚úÖ', text: 'Sprint decisions', prompt: 'Summarize decisions made this sprint that affect my work' },
        { icon: 'üìã', text: 'My action items', prompt: 'What action items are assigned to me or my team?' },
        { icon: 'üìù', text: 'Sprint plan', prompt: 'Create a sprint implementation plan based on my tickets and recent meetings' },
        { icon: 'üó£Ô∏è', text: 'Standup updates', prompt: 'What was discussed in recent standups that I should know about?' },
      ],
    };
    // Could dynamically update the quick prompts section here if needed
  }

  // Load sprint stats
  async function loadSprintStats() {
    try {
      const response = await fetch('/api/sprint-stats', { credentials: 'same-origin' });
      const data = await response.json();
      if (data.blockers !== undefined) {
        document.getElementById('blockerCount').textContent = data.blockers;
      }
      if (data.actions !== undefined) {
        document.getElementById('actionCount').textContent = data.actions;
      }
    } catch (err) {
      console.log('Could not load sprint stats');
    }
  }
  loadSprintStats();

  // ===== CHOICE CHIPS - Contextual Follow-up Suggestions =====
  
  function generateChoiceChips(assistantMessage, userMessage) {
    const chips = [];
    const msg = assistantMessage.toLowerCase();
    const userMsg = userMessage.toLowerCase();

    // Analyze response content to suggest relevant follow-ups
    if (msg.includes('blocker') || msg.includes('blocked') || msg.includes('issue')) {
      chips.push({ icon: 'üîç', text: 'Tell me more', prompt: 'Can you provide more details about the blockers mentioned?' });
      chips.push({ icon: 'üí°', text: 'How to resolve?', prompt: 'What are some ways to resolve these blockers?' });
    }

    if (msg.includes('action item') || msg.includes('task') || msg.includes('to-do') || msg.includes('todo')) {
      chips.push({ icon: 'üìã', text: 'Prioritize these', prompt: 'Can you prioritize these action items by urgency?' });
      chips.push({ icon: 'üë•', text: 'Who owns what?', prompt: 'Who should be responsible for each of these action items?' });
    }

    if (msg.includes('decision') || msg.includes('decided')) {
      chips.push({ icon: 'ü§î', text: 'Rationale?', prompt: 'What was the reasoning behind these decisions?' });
      chips.push({ icon: 'üìä', text: 'Impact analysis', prompt: 'How do these decisions impact my current work?' });
    }

    if (msg.includes('meeting') || msg.includes('standup') || msg.includes('discussed')) {
      chips.push({ icon: 'üìù', text: 'Stakeholder summary', prompt: 'Create a summary of this for stakeholders' });
      chips.push({ icon: '‚è≠Ô∏è', text: 'Next steps', prompt: 'What are the next steps based on this discussion?' });
    }

    if (msg.includes('ticket') || msg.includes('jira') || msg.includes('sprint')) {
      chips.push({ icon: 'üéØ', text: 'Implementation plan', prompt: 'Create an implementation plan for this ticket' });
      chips.push({ icon: '‚è±Ô∏è', text: 'Estimate effort', prompt: 'What is a realistic time estimate for this work?' });
    }

    if (msg.includes('data') || msg.includes('pipeline') || msg.includes('airflow')) {
      chips.push({ icon: 'üîÑ', text: 'DAG structure', prompt: 'What should the DAG structure look like for this?' });
      chips.push({ icon: 'üß™', text: 'Testing strategy', prompt: 'How should I test this data pipeline?' });
    }

    if (msg.includes('aws') || msg.includes('cloud') || msg.includes('infrastructure')) {
      chips.push({ icon: '‚òÅÔ∏è', text: 'Cost analysis', prompt: 'What are the cost implications of this AWS setup?' });
      chips.push({ icon: 'üîí', text: 'Security review', prompt: 'What security considerations should I keep in mind?' });
    }

    if (msg.includes('error') || msg.includes('bug') || msg.includes('failure') || msg.includes('failed')) {
      chips.push({ icon: 'üêõ', text: 'Root cause', prompt: 'What might be the root cause of this error?' });
      chips.push({ icon: 'üõ†Ô∏è', text: 'Debug steps', prompt: 'What debugging steps should I take?' });
    }

    // Generic follow-ups if no specific context detected
    if (chips.length === 0) {
      chips.push({ icon: 'üí¨', text: 'Explain further', prompt: 'Can you explain that in more detail?' });
      chips.push({ icon: 'üìå', text: 'Give examples', prompt: 'Can you give me specific examples?' });
      chips.push({ icon: 'üéØ', text: 'Action items', prompt: 'What action items should I take based on this?' });
    }

    // Always add a "What else" option if not already asked
    if (!userMsg.includes('what else') && chips.length < 4) {
      chips.push({ icon: 'ü™∑', text: 'What else?', prompt: 'What else should I know about this topic?' });
    }

    return chips.slice(0, 4); // Limit to 4 chips
  }

  function displayChoiceChips() {
    const container = document.getElementById('choice-chips');
    if (!container) return;

    const messagesData = {{ messages | tojson | safe if messages else '[]' }};
    if (messagesData.length < 2) return;

    const lastAssistant = messagesData[messagesData.length - 1];
    const lastUser = messagesData.length > 1 ? messagesData[messagesData.length - 2] : null;

    if (lastAssistant.role !== 'assistant' || !lastUser) return;

    const chips = generateChoiceChips(lastAssistant.content, lastUser.content);
    
    container.innerHTML = '';
    chips.forEach(chip => {
      const button = document.createElement('button');
      button.className = 'choice-chip';
      button.innerHTML = `<span class="chip-icon">${chip.icon}</span> ${chip.text}`;
      button.onclick = () => {
        insertPrompt(chip.prompt);
        button.classList.add('used');
      };
      container.appendChild(button);
    });
  }

  // Initialize choice chips on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', displayChoiceChips);
  } else {
    displayChoiceChips();
  }
</script>

{% endblock %}
