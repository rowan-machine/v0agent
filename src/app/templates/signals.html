{% extends "base.html" %}
{% block content %}

<style>
  .signals-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .signals-header h2 {
    margin: 0;
  }

  .date-filter {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .date-filter label {
    font-size: 0.9rem;
    color: #666;
    margin: 0;
  }

  .date-filter select {
    padding: 0.5rem 1rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.9rem;
    background: white;
    cursor: pointer;
  }

  .date-filter select:focus {
    outline: none;
    border-color: #3498db;
  }

  .signal-type-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .signal-type-tabs a {
    padding: 0.6rem 1.2rem;
    background: #ecf0f1;
    color: #7f8c8d;
    text-decoration: none;
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.2s;
  }

  .signal-type-tabs a:hover {
    background: #dfe6e9;
  }

  .signal-type-tabs a.active {
    background: #3498db;
    color: white;
  }

  .signal-type-tabs a.decisions.active { background: #27ae60; }
  .signal-type-tabs a.action_items.active { background: #e67e22; }
  .signal-type-tabs a.blockers.active { background: #e74c3c; }
  .signal-type-tabs a.risks.active { background: #f39c12; }
  .signal-type-tabs a.ideas.active { background: #9b59b6; }

  .signals-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .signal-card {
    background: white;
    border-radius: 8px;
    padding: 1.25rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border-left: 4px solid #3498db;
  }

  .signal-card.decisions { border-left-color: #27ae60; }
  .signal-card.action_items { border-left-color: #e67e22; }
  .signal-card.blockers { border-left-color: #e74c3c; }
  .signal-card.risks { border-left-color: #f39c12; }
  .signal-card.ideas { border-left-color: #9b59b6; }

  .signal-meeting-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #ecf0f1;
  }

  .signal-meeting-name {
    font-weight: 600;
    color: #2c3e50;
    font-size: 1rem;
  }

  .signal-meeting-name a {
    color: #2c3e50;
    text-decoration: none;
  }

  .signal-meeting-name a:hover {
    color: #3498db;
  }

  .signal-meeting-date {
    font-size: 0.85rem;
    color: #7f8c8d;
  }

  .signal-items {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .signal-items li {
    padding: 0.6rem 0;
    border-bottom: 1px solid #f5f5f5;
    font-size: 0.95rem;
    line-height: 1.5;
    color: #333;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
  }

  .signal-items li:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }

  .signal-items li::before {
    content: none;
  }
  
  .signal-text-content {
    flex: 1;
  }
  
  .signal-text-content::before {
    content: "‚Ä¢";
    color: #3498db;
    font-weight: bold;
    margin-right: 0.5rem;
  }

  .signal-card.decisions .signal-text-content::before { color: #27ae60; }
  .signal-card.action_items .signal-text-content::before { color: #e67e22; }
  .signal-card.blockers .signal-text-content::before { color: #e74c3c; }
  .signal-card.risks .signal-text-content::before { color: #f39c12; }
  .signal-card.ideas .signal-text-content::before { color: #9b59b6; }

  /* Signal action buttons */
  .signal-actions-inline {
    display: flex;
    gap: 0.25rem;
    opacity: 0;
    transition: opacity 0.2s;
    flex-shrink: 0;
  }
  
  .signal-items li:hover .signal-actions-inline {
    opacity: 1;
  }
  
  .sig-btn {
    background: none;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 0.35rem;
    cursor: pointer;
    color: #9ca3af;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .sig-btn:hover {
    background: #f3f4f6;
  }
  
  .sig-btn.approve:hover, .sig-btn.approve.active {
    background: #d1fae5;
    border-color: #10b981;
    color: #10b981;
  }
  
  .sig-btn.reject:hover, .sig-btn.reject.active {
    background: #fee2e2;
    border-color: #ef4444;
    color: #ef4444;
  }
  
  .sig-btn.archive:hover, .sig-btn.archive.active {
    background: #f3f4f6;
    border-color: #6b7280;
    color: #6b7280;
  }
  
  .sig-btn.ticket:hover {
    background: #dbeafe;
    border-color: #3b82f6;
    color: #3b82f6;
  }

  .sig-btn.waiting:hover {
    background: #fef3c7;
    border-color: #f59e0b;
    color: #92400e;
  }

  .sig-btn svg {
    width: 14px;
    height: 14px;
  }
  
  .signal-status-badge {
    font-size: 0.65rem;
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    text-transform: uppercase;
    font-weight: 600;
    margin-left: 0.5rem;
    white-space: nowrap;
  }
  
  .signal-status-badge.approved {
    background: #d1fae5;
    color: #059669;
  }
  
  .signal-status-badge.rejected {
    background: #fee2e2;
    color: #dc2626;
  }
  
  .signal-status-badge.archived {
    background: #f3f4f6;
    color: #6b7280;
  }

  .signal-status-badge.waiting {
    background: #fef3c7;
    color: #d97706;
  }
  
  .signal-status-badge.completed {
    background: #dbeafe;
    color: #2563eb;
  }
  
  .signal-items li.status-rejected {
    opacity: 0.5;
    text-decoration: line-through;
    background: #fee2e2;
  }
  
  .signal-items li.status-approved {
    background: #d1fae5;
    border-left: 3px solid #059669;
  }
  
  .signal-items li.status-completed {
    background: #dbeafe;
    border-left: 3px solid #2563eb;
  }
  
  .signal-items li.status-archived {
    opacity: 0.6;
  }

  .signal-items li.status-waiting {
    background: #fffbeb;
    border-left: 3px solid #f59e0b;
  }

  /* Dismissed signals */
  .signal-items li.dismissed {
    display: none;
  }
  
  .signal-items.show-dismissed li.dismissed {
    display: flex;
    opacity: 0.5;
    background: #f9fafb;
  }
  
  .sig-btn.dismiss:hover {
    background: #fef2f2;
    border-color: #fca5a5;
    color: #ef4444;
  }

  /* Collapsible meeting cards */
  .signal-card.collapsed .signal-items {
    display: none;
  }
  
  .signal-meeting-header {
    cursor: pointer;
    user-select: none;
  }
  
  .collapse-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .collapse-icon {
    transition: transform 0.2s;
    color: #9ca3af;
  }
  
  .signal-card.collapsed .collapse-icon {
    transform: rotate(-90deg);
  }
  
  .signal-count-badge {
    font-size: 0.75rem;
    background: #e5e7eb;
    color: #6b7280;
    padding: 0.15rem 0.5rem;
    border-radius: 10px;
  }

  /* Signals toolbar */
  .signals-toolbar {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .toolbar-btn {
    padding: 0.4rem 0.8rem;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    background: white;
    color: #6b7280;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.35rem;
  }
  
  .toolbar-btn:hover {
    background: #f9fafb;
    border-color: #d1d5db;
  }
  
  .toolbar-btn.active {
    background: #eff6ff;
    border-color: #3b82f6;
    color: #3b82f6;
  }
  
  .toolbar-btn svg {
    width: 14px;
    height: 14px;
  }
  
  .dismissed-count {
    font-size: 0.75rem;
    background: #fee2e2;
    color: #dc2626;
    padding: 0.1rem 0.4rem;
    border-radius: 8px;
    margin-left: 0.25rem;
  }

  /* Markdown rendering in signals */
  .signal-items li strong {
    font-weight: 600;
    color: #2c3e50;
  }

  .signal-items li em {
    font-style: italic;
  }

  .signal-items li code {
    background: #f0f0f0;
    padding: 0.1rem 0.3rem;
    border-radius: 3px;
    font-family: monospace;
    font-size: 0.9em;
  }

  .empty-state {
    text-align: center;
    padding: 3rem;
    color: #7f8c8d;
  }

  .empty-state h3 {
    margin-bottom: 0.5rem;
    color: #95a5a6;
  }

  .stats-bar {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .stat-badge {
    background: #f8f9fa;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.85rem;
    color: #555;
  }

  .stat-badge strong {
    color: #2c3e50;
  }

  /* Modal styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10000;
  }
  
  .modal {
    background: white;
    border-radius: 8px;
    padding: 2rem;
    max-width: 500px;
    width: 100%;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    animation: slideIn 0.3s ease;
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }
  
  .modal-header h3 {
    margin: 0;
    font-size: 1.25rem;
    color: #2c3e50;
  }
  
  .modal-close {
    background: none;
    border: none;
    color: #666;
    font-size: 1.5rem;
    cursor: pointer;
    transition: color 0.2s;
  }
  
  .modal-close:hover {
    color: #3498db;
  }
  
  .signal-search-form {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }
  
  .signal-search-form input {
    flex: 1;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s;
  }
  
  .signal-search-form input:focus {
    border-color: #3498db;
  }
  
  .signal-search-form select {
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.9rem;
    background: white;
    cursor: pointer;
  }
  
  .signal-search-form select:focus {
    outline: none;
    border-color: #3498db;
  }
  
  .signal-search-form .send-btn {
    padding: 0.75rem 1.5rem;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .signal-search-form .send-btn:hover {
    background: #2980b9;
  }
  
  .signal-results {
    max-height: 300px;
    overflow-y: auto;
    margin-top: 1rem;
  }
  
  .signal-result-item {
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    margin-bottom: 0.5rem;
    background: #f9f9f9;
    transition: background 0.2s;
  }
  
  .signal-result-item:hover {
    background: #f1f1f1;
  }
  
  .signal-result-item .signal-text {
    font-size: 0.95rem;
    color: #333;
  }
  
  .signal-result-item .signal-meta {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.25rem;
  }
</style>

<div class="signals-header">
  <h2>üìä Meeting Signals</h2>
  <div class="date-filter">
    <label for="daysFilter">Show:</label>
    <select id="daysFilter" onchange="filterByDays(this.value)">
      <option value="all" {% if selected_days == 'all' %}selected{% endif %}>All Time</option>
      <option value="7" {% if selected_days == '7' %}selected{% endif %}>Past Week</option>
      <option value="14" {% if selected_days == '14' %}selected{% endif %}>This Sprint (2 weeks)</option>
      <option value="30" {% if selected_days == '30' %}selected{% endif %}>Past Month</option>
      <option value="42" {% if selected_days == '42' %}selected{% endif %}>Last 3 Sprints (6 weeks)</option>
      <option value="90" {% if selected_days == '90' %}selected{% endif %}>Past Quarter</option>
    </select>
  </div>
</div>

<div class="signal-type-tabs">
  <a href="/signals/decisions" class="decisions {% if signal_type == 'decisions' %}active{% endif %}">‚úÖ Decisions</a>
  <a href="/signals/action_items" class="action_items {% if signal_type == 'action_items' %}active{% endif %}">üìã Action Items</a>
  <a href="/signals/blockers" class="blockers {% if signal_type == 'blockers' %}active{% endif %}">üö´ Blockers</a>
  <a href="/signals/risks" class="risks {% if signal_type == 'risks' %}active{% endif %}">‚ö†Ô∏è Risks</a>
  <a href="/signals/ideas" class="ideas {% if signal_type == 'ideas' %}active{% endif %}">üí° Ideas</a>
  <a href="/signals/all" class="{% if signal_type == 'all' %}active{% endif %}">All</a>
</div>

<div class="stats-bar">
  <span class="stat-badge"><strong>{{ total_signals }}</strong> signals</span>
  <span class="stat-badge"><strong>{{ meetings|length }}</strong> meetings</span>
</div>

<div class="signals-toolbar">
  <button class="toolbar-btn" onclick="toggleShowDismissed()" id="showDismissedBtn">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
    <span id="dismissedToggleText">Show dismissed</span>
    <span class="dismissed-count" id="dismissedCount" style="display: none;">0</span>
  </button>
  <button class="toolbar-btn" onclick="clearAllDismissed()">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
    Reset dismissed
  </button>
  <button class="toolbar-btn" onclick="collapseAllMeetings()">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/></svg>
    Collapse all
  </button>
  <button class="toolbar-btn" onclick="expandAllMeetings()">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"/></svg>
    Expand all
  </button>
  <button class="toolbar-btn" onclick="openSignalModal()">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h18v18H3z"/></svg>
    Search signals
  </button>
</div>

{% if meetings %}
  <div class="signals-list">
    {% for meeting in meetings %}
      <div class="signal-card {{ signal_type }}" data-meeting-card-id="{{ meeting.meeting_id }}">
        <div class="signal-meeting-header" onclick="toggleMeetingCollapse(this)">
          <div class="collapse-indicator">
            <svg class="collapse-icon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            <span class="signal-meeting-name">
              <a href="/meetings/{{ meeting.meeting_id }}/edit" onclick="event.stopPropagation()">{{ meeting.meeting_name }}</a>
            </span>
            <span class="signal-count-badge">{{ meeting.signals|length }}</span>
          </div>
          <span class="signal-meeting-date">{{ meeting.meeting_date or 'No date' }}</span>
        </div>
        <ul class="signal-items">
          {% for item in meeting.signals %}
            <li data-meeting-id="{{ meeting.meeting_id }}" data-signal-type="{{ item.type }}" data-signal-text="{{ item.text }}" class="{% if item.status and item.status != 'pending' %}status-{{ item.status }}{% endif %}">
              <span class="signal-text-content">{{ item.text }}{% if item.status and item.status != 'pending' %}<span class="signal-status-badge {{ item.status }}">{{ item.status }}</span>{% endif %}</span>
              <div class="signal-actions-inline">
                <button class="sig-btn approve" onclick="updateSignalStatus(this, 'approved')" title="Approve">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                </button>
                <button class="sig-btn reject" onclick="updateSignalStatus(this, 'rejected')" title="Reject">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
                <button class="sig-btn archive" onclick="updateSignalStatus(this, 'archived')" title="Archive">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
                </button>
                <button class="sig-btn ticket" onclick="convertSignalToTicket(this)" title="Create Task">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                </button>
                <button class="sig-btn waiting" onclick="convertToAccountability(this)" title="Add to Waiting For">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </button>
                <button class="sig-btn dismiss" onclick="dismissSignal(this)" title="Dismiss (hide from view)">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/></svg>
                </button>
              </div>
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="empty-state">
    <h3>No {{ signal_type.replace('_', ' ') }} found</h3>
    <p>Signals are extracted from meeting summaries automatically.</p>
  </div>
{% endif %}

<!-- Search Meeting Signals Modal -->
<div class="modal-overlay" id="signalModal">
  <div class="modal">
    <div class="modal-header">
      <h3>üîç Search Meeting Signals</h3>
      <button class="modal-close" onclick="closeSignalModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="signal-search-form">
        <input 
          type="text" 
          id="signalSearchQuery" 
          placeholder='Search signals (e.g., "rx claims", "budget", "deadline")...'
          onkeydown="if(event.key === 'Enter') searchSignals()"
        />
        <select id="signalTypeFilter">
          <option value="all">All Signals</option>
          <option value="decisions">Decisions</option>
          <option value="action_items">Action Items</option>
          <option value="blockers">Blockers</option>
          <option value="risks">Risks</option>
          <option value="ideas">Ideas</option>
        </select>
        <button onclick="searchSignals()" class="send-btn">Search</button>
      </div>
      <div class="signal-results" id="signalResults">
        <div class="no-results">
          <p>Enter a search term to find signals across all meetings</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Storage keys
  const DISMISSED_SIGNALS_KEY = 'signals-dismissed';
  const COLLAPSED_MEETINGS_KEY = 'signals-collapsed-meetings';
  const SHOW_DISMISSED_KEY = 'signals-show-dismissed';
  
  // Get unique signal ID
  function getSignalId(li) {
    const meetingId = li.dataset.meetingId;
    const signalType = li.dataset.signalType;
    const signalText = li.dataset.signalText;
    return `${meetingId}:${signalType}:${signalText.substring(0, 50)}`;
  }
  
  // Dismiss a signal
  function dismissSignal(btn) {
    const li = btn.closest('li');
    const signalId = getSignalId(li);
    
    const dismissed = JSON.parse(localStorage.getItem(DISMISSED_SIGNALS_KEY) || '[]');
    if (!dismissed.includes(signalId)) {
      dismissed.push(signalId);
      localStorage.setItem(DISMISSED_SIGNALS_KEY, JSON.stringify(dismissed));
    }
    
    li.classList.add('dismissed');
    updateDismissedCount();
    showToast('Dismissed', 'Signal hidden from view', 'success');
  }
  
  // Toggle show/hide dismissed signals
  function toggleShowDismissed() {
    const showDismissed = localStorage.getItem(SHOW_DISMISSED_KEY) === 'true';
    const newValue = !showDismissed;
    localStorage.setItem(SHOW_DISMISSED_KEY, String(newValue));
    
    document.querySelectorAll('.signal-items').forEach(ul => {
      ul.classList.toggle('show-dismissed', newValue);
    });
    
    const btn = document.getElementById('showDismissedBtn');
    const text = document.getElementById('dismissedToggleText');
    if (btn) btn.classList.toggle('active', newValue);
    if (text) text.textContent = newValue ? 'Hide dismissed' : 'Show dismissed';
  }
  
  // Clear all dismissed signals
  function clearAllDismissed() {
    if (!confirm('Reset all dismissed signals? They will reappear in the list.')) return;
    
    localStorage.removeItem(DISMISSED_SIGNALS_KEY);
    document.querySelectorAll('.signal-items li.dismissed').forEach(li => {
      li.classList.remove('dismissed');
    });
    updateDismissedCount();
    showToast('Reset', 'All dismissed signals restored', 'success');
  }
  
  // Update dismissed count badge
  function updateDismissedCount() {
    const dismissed = JSON.parse(localStorage.getItem(DISMISSED_SIGNALS_KEY) || '[]');
    const countEl = document.getElementById('dismissedCount');
    if (countEl) {
      countEl.textContent = dismissed.length;
      countEl.style.display = dismissed.length > 0 ? 'inline' : 'none';
    }
  }
  
  // Toggle meeting collapse
  function toggleMeetingCollapse(header) {
    const card = header.closest('.signal-card');
    const meetingId = card.dataset.meetingCardId;
    card.classList.toggle('collapsed');
    
    const collapsed = JSON.parse(localStorage.getItem(COLLAPSED_MEETINGS_KEY) || '[]');
    if (card.classList.contains('collapsed')) {
      if (!collapsed.includes(meetingId)) {
        collapsed.push(meetingId);
      }
    } else {
      const idx = collapsed.indexOf(meetingId);
      if (idx > -1) collapsed.splice(idx, 1);
    }
    localStorage.setItem(COLLAPSED_MEETINGS_KEY, JSON.stringify(collapsed));
  }
  
  // Collapse all meetings
  function collapseAllMeetings() {
    const meetingIds = [];
    document.querySelectorAll('.signal-card').forEach(card => {
      card.classList.add('collapsed');
      meetingIds.push(card.dataset.meetingCardId);
    });
    localStorage.setItem(COLLAPSED_MEETINGS_KEY, JSON.stringify(meetingIds));
  }
  
  // Expand all meetings
  function expandAllMeetings() {
    document.querySelectorAll('.signal-card').forEach(card => {
      card.classList.remove('collapsed');
    });
    localStorage.setItem(COLLAPSED_MEETINGS_KEY, JSON.stringify([]));
  }
  
  // Restore state on page load
  function restoreSignalsState() {
    // Restore dismissed signals
    const dismissed = JSON.parse(localStorage.getItem(DISMISSED_SIGNALS_KEY) || '[]');
    document.querySelectorAll('.signal-items li').forEach(li => {
      const signalId = getSignalId(li);
      if (dismissed.includes(signalId)) {
        li.classList.add('dismissed');
      }
    });
    updateDismissedCount();
    
    // Restore show dismissed state
    const showDismissed = localStorage.getItem(SHOW_DISMISSED_KEY) === 'true';
    if (showDismissed) {
      document.querySelectorAll('.signal-items').forEach(ul => ul.classList.add('show-dismissed'));
      const btn = document.getElementById('showDismissedBtn');
      const text = document.getElementById('dismissedToggleText');
      if (btn) btn.classList.add('active');
      if (text) text.textContent = 'Hide dismissed';
    }
    
    // Restore collapsed meetings
    const collapsed = JSON.parse(localStorage.getItem(COLLAPSED_MEETINGS_KEY) || '[]');
    collapsed.forEach(meetingId => {
      const card = document.querySelector(`.signal-card[data-meeting-card-id="${meetingId}"]`);
      if (card) card.classList.add('collapsed');
    });
  }

  // Filter by days - preserves current signal type
  function filterByDays(days) {
    const url = new URL(window.location.href);
    url.searchParams.set('days', days);
    window.location.href = url.toString();
  }
  
  // Toast notification
  function showToast(title, message, type = 'info') {
    // Create toast container if not exists
    let container = document.getElementById('toastContainer');
    if (!container) {
      container = document.createElement('div');
      container.id = 'toastContainer';
      container.style.cssText = 'position:fixed;top:70px;right:1rem;z-index:9999;display:flex;flex-direction:column;gap:0.5rem;';
      document.body.appendChild(container);
    }
    
    const toast = document.createElement('div');
    toast.style.cssText = `background:white;border-radius:10px;padding:1rem 1.25rem;box-shadow:0 4px 20px rgba(0,0,0,0.15);display:flex;align-items:center;gap:0.75rem;min-width:300px;max-width:450px;animation:slideIn 0.3s ease;border-left:4px solid ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#667eea'};`;
    toast.innerHTML = `
      <span style="font-weight:600;font-size:0.9rem;color:#1f2937;">${title}</span>
      <span style="font-size:0.85rem;color:#6b7280;">${message}</span>
    `;
    container.appendChild(toast);
    
    setTimeout(() => toast.remove(), 4000);
  }
  
  // Update signal status
  async function updateSignalStatus(btn, status) {
    const li = btn.closest('li');
    const meetingId = li.dataset.meetingId;
    const signalType = li.dataset.signalType;
    const signalText = li.dataset.signalText;
    
    // Add visual class immediately
    li.classList.add(`status-${status}`);
    
    const isActive = btn.classList.contains('active');
    li.querySelectorAll('.sig-btn').forEach(b => b.classList.remove('active'));
    
    const newStatus = isActive ? 'pending' : status;
    if (!isActive) {
      btn.classList.add('active');
    }
    
    li.className = li.className.replace(/status-\w+/g, '');
    if (newStatus !== 'pending') {
      li.classList.add(`status-${newStatus}`);
    }
    
    try {
      const response = await fetch('/api/signals/status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          meeting_id: meetingId,
          signal_type: signalType,
          signal_text: signalText,
          status: newStatus
        })
      });
      
      if (response.ok) {
        const labels = { approved: 'approved', rejected: 'rejected', archived: 'archived', waiting: 'waiting', pending: 'cleared' };
        showToast('Updated', `Signal ${labels[newStatus]}`, 'success');
        
        // Add status badge
        const textEl = li.querySelector('.signal-text-content');
        if (textEl && newStatus !== 'pending') {
          // Remove existing badge if any
          const existingBadge = textEl.querySelector('.signal-status-badge');
          if (existingBadge) existingBadge.remove();
          
          // Add new badge
          if (newStatus === 'approved' || newStatus === 'rejected' || newStatus === 'archived' || newStatus === 'waiting') {
            const statusBadge = document.createElement('span');
            statusBadge.className = `signal-status-badge ${newStatus}`;
            statusBadge.textContent = newStatus === 'approved'
              ? '\u2713 approved'
              : newStatus === 'rejected'
                ? '\u2717 rejected'
                : newStatus === 'waiting'
                  ? '\u23F3 waiting'
                  : `\u{1F4E6} ${newStatus}`;
            textEl.appendChild(statusBadge);
          }
        }
      }
    } catch (err) {
      showToast('Error', 'Could not update', 'error');
      btn.classList.remove('active');
    }
  }
  
  // Convert signal to ticket
  async function convertSignalToTicket(btn) {
    const li = btn.closest('li');
    const meetingId = li.dataset.meetingId;
    const signalType = li.dataset.signalType;
    const signalText = li.dataset.signalText;
    
    try {
      const response = await fetch('/api/signals/convert-to-ticket', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          meeting_id: meetingId,
          signal_type: signalType,
          signal_text: signalText
        })
      });
      
      if (response.ok) {
        const data = await response.json();
        showToast('Task Created', `Created ${data.ticket_id}`, 'success');
        li.classList.add('status-completed');
        
        const textEl = li.querySelector('.signal-text-content');
        if (textEl && !textEl.querySelector('.signal-status-badge')) {
          const taskBadge = document.createElement('a');
          taskBadge.href = `/tickets/${data.ticket_db_id}/edit`;
          taskBadge.className = 'signal-status-badge completed';
          taskBadge.style.cssText = 'cursor: pointer; text-decoration: none;';
          taskBadge.textContent = `‚Üí ${data.ticket_id}`;
          textEl.appendChild(taskBadge);
        }
      }
    } catch (err) {
      showToast('Error', 'Could not create ticket', 'error');
    }
  }

  // Simple markdown parser for signal items
  function parseSignalMarkdown(text) {
    if (!text) return '';
    
    // Escape HTML
    let html = text
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
    
    // Bold (**text** or __text__)
    html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/__([^_]+)__/g, '<strong>$1</strong>');
    
    // Italic (*text* or _text_)
    html = html.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em>$1</em>');
    html = html.replace(/(?<!_)_([^_]+)_(?!_)/g, '<em>$1</em>');
    
    // Inline code
    html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
    
    return html;
  }

  // Apply markdown parsing to all signal items on page load
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.signal-text-content').forEach(function(el) {
      const rawText = el.textContent;
      el.innerHTML = parseSignalMarkdown(rawText);
    });
    
    // Restore signals state (dismissed, collapsed meetings)
    restoreSignalsState();
  });

  // Convert signal to accountability item
  async function convertToAccountability(btn) {
    const li = btn.closest('li');
    const signalText = li.querySelector('.signal-text-content').textContent.trim();
    
    const description = prompt('Add to Waiting For:\n\nWhat are you waiting for?', signalText);
    if (!description) return;
    
    const responsibleParty = prompt('Who is responsible for this?', '');
    
    try {
      const formData = new FormData();
      formData.append('description', description);
      if (responsibleParty) formData.append('responsible_party', responsibleParty);
      formData.append('source_type', 'signal');
      
      const response = await fetch('/api/accountability/create', {
        method: 'POST',
        credentials: 'same-origin',
        body: formData
      });
      
      if (response.ok) {
        showToast('Added to Waiting For', 'success');
        updateSignalStatus(btn, 'waiting');
      } else {
        throw new Error('Failed');
      }
    } catch (err) {
      showToast('Could not add accountability item', 'error');
    }
  }

  // Open search signals modal
  function openSignalModal() {
    document.getElementById('signalModal').style.display = 'flex';
  }
  
  // Close search signals modal
  function closeSignalModal() {
    document.getElementById('signalModal').style.display = 'none';
  }
  
  // Search signals
  async function searchSignals() {
    const query = document.getElementById('signalSearchQuery').value.trim();
    const type = document.getElementById('signalTypeFilter').value;
    
    if (!query) {
      document.getElementById('signalResults').innerHTML = '<div class="no-results"><p>Enter a search term to find signals across all meetings</p></div>';
      return;
    }
    
    try {
      const response = await fetch('/api/signals/search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query, type })
      });
      
      if (response.ok) {
        const results = await response.json();
        const resultsContainer = document.getElementById('signalResults');
        resultsContainer.innerHTML = '';
        
        if (results.length === 0) {
          resultsContainer.innerHTML = '<div class="no-results"><p>No signals found matching your search</p></div>';
          return;
        }
        
        results.forEach(signal => {
          const item = document.createElement('div');
          item.className = 'signal-result-item';
          item.innerHTML = `
            <div class="signal-text">${signal.text}</div>
            <div class="signal-meta">
              <span class="signal-meeting-name">${signal.meeting_name}</span> ‚Ä¢ 
              <span class="signal-meeting-date">${signal.meeting_date}</span>
            </div>
          `;
          resultsContainer.appendChild(item);
        });
      } else {
        throw new Error('Search failed');
      }
    } catch (err) {
      document.getElementById('signalResults').innerHTML = '<div class="no-results"><p>Error performing search</p></div>';
    }
  }
</script>

{% endblock %}
