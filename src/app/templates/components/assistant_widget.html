<!-- Assistant Chatbot Widget -->
<style>
  .assistant-widget {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 2000;
  }

  .assistant-toggle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    transition: all 0.3s;
  }

  .assistant-toggle:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
  }

  .assistant-toggle.active {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  }

  .assistant-chat {
    position: fixed;
    bottom: 100px;
    right: 20px;
    width: 480px;
    max-height: 700px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    display: none;
    flex-direction: column;
    overflow: hidden;
    z-index: 1999;
  }

  .assistant-chat.active {
    display: flex;
  }

  .assistant-header {
    padding: 1rem 1.25rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .assistant-header h3 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
  }

  .assistant-header-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .assistant-collapse-btn {
    background: rgba(255,255,255,0.15);
    border: none;
    border-radius: 999px;
    width: 22px;
    height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 0.85rem;
    color: white;
    transition: background 0.15s ease;
  }

  .assistant-collapse-btn:hover {
    background: rgba(255,255,255,0.3);
  }

  .assistant-badge {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.25rem 0.6rem;
    border-radius: 12px;
    font-size: 0.75rem;
  }

  .assistant-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    max-height: 400px;
  }

  .assistant-message {
    padding: 0.75rem 1rem;
    border-radius: 12px;
    max-width: 85%;
    line-height: 1.5;
    font-size: 0.9rem;
  }

  .assistant-message.user {
    background: #667eea;
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
  }

  .assistant-message.assistant {
    background: #f3f4f6;
    color: #1f2937;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
  }

  .assistant-message.assistant strong {
    color: #667eea;
  }

  .assistant-clarifications {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: 8px;
    padding: 0.75rem;
    margin-top: 0.5rem;
  }

  .assistant-clarifications p {
    margin: 0 0 0.5rem 0;
    font-weight: 600;
    color: #92400e;
  }

  .assistant-clarifications ul {
    margin: 0;
    padding-left: 1.25rem;
    color: #78350f;
  }

  .assistant-input-area {
    padding: 1rem;
    border-top: 1px solid #e5e7eb;
    background: #f9fafb;
  }

  .assistant-input-wrapper {
    display: flex;
    gap: 0.5rem;
  }

  .assistant-input {
    flex: 1;
    padding: 0.7rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 0.9rem;
    resize: none;
    min-height: 40px;
    max-height: 100px;
  }

  .assistant-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .assistant-send {
    padding: 0.7rem 1rem;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 600;
  }

  .assistant-send:hover {
    background: #5568d3;
  }

  .assistant-send:disabled {
    background: #9ca3af;
    cursor: not-allowed;
  }

  .assistant-thinking {
    display: flex;
    gap: 0.25rem;
    padding: 0.5rem 1rem;
  }

  .assistant-thinking span {
    width: 8px;
    height: 8px;
    background: #667eea;
    border-radius: 50%;
    animation: bounce 1.4s infinite;
  }

  .assistant-thinking span:nth-child(2) {
    animation-delay: 0.2s;
  }

  .assistant-thinking span:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes bounce {
    0%, 80%, 100% { transform: translateY(0); opacity: 0.5; }
    40% { transform: translateY(-8px); opacity: 1; }
  }

  .assistant-suggestions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    padding: 0.5rem 0;
  }

  .assistant-suggestion {
    padding: 0.5rem 0.9rem;
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    border-radius: 16px;
    font-size: 0.8rem;
    color: #374151;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
  }

  .assistant-suggestion:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
  }

  .assistant-suggestion[title]:hover::after {
    content: attr(title);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #1f2937;
    color: white;
    padding: 0.35rem 0.6rem;
    border-radius: 6px;
    font-size: 0.7rem;
    white-space: nowrap;
    z-index: 100;
    margin-bottom: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }

  .assistant-suggestion[title]:hover::before {
    content: '';
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent;
    border-top-color: #1f2937;
    margin-bottom: -6px;
    z-index: 100;
  }

  /* Welcome chips - clickable action buttons */
  .welcome-chips {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
    padding: 0.75rem 0;
  }

  .welcome-chip {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.6rem 0.75rem;
    background: var(--sf-surface, #f9fafb);
    border: 1px solid var(--sf-border, #e5e7eb);
    border-radius: 10px;
    font-size: 0.8rem;
    color: var(--sf-text, #374151);
    cursor: pointer;
    transition: all 0.15s ease;
    text-align: left;
  }

  .welcome-chip:hover {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: transparent;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
  }

  .chip-emoji {
    font-size: 1rem;
  }

  .chip-label {
    font-weight: 500;
  }

  [data-theme="dark"] .welcome-chip {
    background: var(--sf-surface, #2d2d2d);
    border-color: var(--sf-border, #3a3a3a);
    color: var(--sf-text, #e0e0e0);
  }

  [data-theme="dark"] .welcome-chip:hover {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: transparent;
  }

  /* Dark mode for assistant widget */
  [data-theme="dark"] .assistant-chat {
    background: #1e1e1e;
    border: 1px solid #3a3a3a;
  }

  [data-theme="dark"] .assistant-messages {
    background: #1e1e1e;
  }

  [data-theme="dark"] .assistant-message.assistant {
    background: #2d2d2d;
    color: #e0e0e0;
  }

  [data-theme="dark"] .assistant-message.assistant strong {
    color: #c7d2fe;
  }

  [data-theme="dark"] .assistant-message.assistant ul {
    color: #d1d5db;
  }

  [data-theme="dark"] .assistant-message.assistant em {
    color: #9ca3af !important;
  }

  [data-theme="dark"] .assistant-input-area {
    background: #252525;
    border-top-color: #3a3a3a;
  }

  [data-theme="dark"] .assistant-input {
    background: #1e1e1e;
    border-color: #4a4a4a;
    color: #e0e0e0;
  }

  [data-theme="dark"] .assistant-input::placeholder {
    color: #888;
  }

  [data-theme="dark"] .assistant-suggestion {
    background: #3a3a3a;
    border-color: #5a5a5a;
    color: #f0f0f0;
  }

  [data-theme="dark"] .assistant-suggestion:hover {
    background: #8b5cf6;
    color: white;
    border-color: #8b5cf6;
  }

  [data-theme="dark"] .assistant-clarifications {
    background: #3d3419;
    border-color: #92400e;
  }

  [data-theme="dark"] .assistant-clarifications p {
    color: #fbbf24;
  }

  [data-theme="dark"] .assistant-clarifications ul {
    color: #fcd34d;
  }

  /* Navigation links in assistant */
  [data-theme="dark"] .assistant-message a {
    background: #3730a3 !important;
    color: #c7d2fe !important;
  }

  [data-theme="dark"] .assistant-message a:hover {
    background: #4f46e5 !important;
  }
</style>

<div class="assistant-widget">
  <button class="assistant-toggle" id="assistantToggle" onclick="toggleAssistant()">
    üèπ
  </button>

  <div class="assistant-chat" id="assistantChat">
    <div class="assistant-header">
      <div class="assistant-header-title">
        <button class="assistant-collapse-btn" onclick="collapseAssistantChat()" title="Collapse chat">‚àí</button>
        <h3>üèπ Arjuna</h3>
      </div>
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <span class="assistant-badge">AI Assistant</span>
        <button onclick="clearArjunaChat()" title="Start fresh conversation" style="background: none; border: none; cursor: pointer; font-size: 0.75rem; color: var(--sf-text-muted, #6b7280); padding: 0.25rem 0.5rem; border-radius: 4px; transition: all 0.15s;" onmouseover="this.style.background='var(--sf-surface, #f3f4f6)'" onmouseout="this.style.background='none'">üóëÔ∏è Clear</button>
      </div>
    </div>

    <div class="assistant-messages" id="assistantMessages">
      <!-- Messages are loaded from localStorage or show welcome -->
      <div class="assistant-suggestions" id="assistantSuggestions">
        <!-- Suggestions are dynamically populated -->
      </div>
    </div>

    <div class="assistant-input-area">
      <div class="assistant-input-wrapper">
        <textarea 
          id="assistantInput" 
          class="assistant-input" 
          placeholder="Ask anything or tell me what to do..."
          rows="1"
          onkeydown="handleAssistantKeydown(event)"
        ></textarea>
        <button class="assistant-send" onclick="sendAssistantMessage()" id="assistantSendBtn">
          Send
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  let assistantHistory = [];
  
  // All available suggestion sets - will cycle through these
  const suggestionSets = [
    [
      { emoji: 'ü§ñ', text: 'GPT-4o', message: 'Switch to GPT-4o', tooltip: 'Switch AI model to GPT-4o' },
      { emoji: 'üß†', text: 'Claude', message: 'Switch to Claude Sonnet', tooltip: 'Switch AI model to Claude' },
      { emoji: 'üö´', text: 'Blocked', message: 'What are my blocked tickets?', tooltip: 'View blocked tickets' },
      { emoji: '‚ûï', text: 'New Task', message: 'Create a task for ', tooltip: 'Create a new task' },
    ],
    [
      { emoji: 'üìã', text: 'Tickets', message: 'What are my open tickets?', tooltip: 'List all open tickets' },
      { emoji: 'üéØ', text: 'Focus', message: 'What should I focus on today?', tooltip: 'Get focus recommendations' },
      { emoji: 'üìÖ', text: 'Meetings', message: 'Search meetings for ', tooltip: 'Search meeting notes' },
      { emoji: '‚è≥', text: 'Waiting', message: 'Add waiting-for: ', tooltip: 'Add accountability item' },
    ],
    [
      { emoji: 'üìù', text: 'Standup', message: 'Log standup: Yesterday I ', tooltip: 'Log daily standup' },
      { emoji: 'üîç', text: 'Search', message: 'Search for ', tooltip: 'Search everything' },
      { emoji: 'üìä', text: 'Sprint', message: 'What is the sprint status?', tooltip: 'View sprint progress' },
      { emoji: '‚úÖ', text: 'Done', message: 'What tickets are done?', tooltip: 'View completed tickets' },
    ],
    [
      { emoji: 'üèÉ', text: 'Active', message: 'What tickets are in progress?', tooltip: 'View in-progress work' },
      { emoji: 'üé´', text: 'Priority', message: 'What are my high priority tickets?', tooltip: 'View high priority items' },
      { emoji: 'üìà', text: 'Sprint', message: 'Update sprint name to ', tooltip: 'Update sprint settings' },
      { emoji: 'üí°', text: 'Help', message: 'What can you help me with?', tooltip: 'Show capabilities' },
    ],
  ];

  const WELCOME_MESSAGE = `<div style="text-align: center; padding: 0.5rem 0;">
<strong style="font-size: 1.1rem;">Hare Krishna! üôè</strong>
<br><span style="color: var(--sf-text-muted, #6b7280); font-size: 0.85rem;">I'm Arjuna, your SignalFlow assistant</span>
</div>`;

  // Static chips - always shown (complete sentences that Arjuna will execute)
  const STATIC_CHIPS = [
    { emoji: 'üéØ', label: 'What to focus on', message: 'What should I focus on today?' },
    { emoji: 'üìã', label: 'My open tickets', message: 'What are my open tickets?' },
    { emoji: '‚ûï', label: 'Create a task', message: 'I want to create a new task. What should I call it and what are the details?' },
  ];

  // Random chips pool - 3 picked randomly each session (Arjuna asks for input before acting)
  const RANDOM_CHIPS_POOL = [
    { emoji: 'üö´', label: 'Blocked items', message: 'What are my blocked tickets?' },
    { emoji: 'üìù', label: 'Log standup', message: 'I want to log my standup. What did you work on yesterday, what are you doing today, and any blockers?' },
    { emoji: 'üîç', label: 'Search everything', message: 'I want to search for something. What would you like me to find?' },
    { emoji: 'ü§ñ', label: 'Switch to GPT-4o', message: 'Switch to GPT-4o' },
    { emoji: 'üß†', label: 'Switch to Claude', message: 'Switch to Claude Sonnet' },
    { emoji: 'üìä', label: 'Sprint status', message: 'What is the sprint status?' },
    { emoji: '‚úÖ', label: 'Done tickets', message: 'What tickets are done?' },
    { emoji: 'üèÉ', label: 'In progress', message: 'What tickets are in progress?' },
    { emoji: 'üìÖ', label: 'New meeting', message: 'I want to create a new meeting. What should the meeting be called and do you have any notes to include?' },
    { emoji: '‚è≥', label: 'Add waiting-for', message: 'I want to add a waiting-for item. Who are you waiting on and for what?' },
    { emoji: 'üé´', label: 'High priority', message: 'What are my high priority tickets?' },
    { emoji: 'üí°', label: 'What can you do?', message: 'What can you help me with?' },
  ];

  // Get random chips for this session (cached in sessionStorage)
  function getRandomChips() {
    const cacheKey = 'arjuna-random-chips';
    const cached = sessionStorage.getItem(cacheKey);
    if (cached) {
      try {
        return JSON.parse(cached);
      } catch (e) {}
    }
    
    // Shuffle and pick 3 random chips
    const shuffled = [...RANDOM_CHIPS_POOL].sort(() => Math.random() - 0.5);
    const picked = shuffled.slice(0, 3);
    sessionStorage.setItem(cacheKey, JSON.stringify(picked));
    return picked;
  }

  function createWelcomeChips() {
    const randomChips = getRandomChips();
    const allChips = [...STATIC_CHIPS, ...randomChips];
    return allChips.map(c => 
      `<button class="welcome-chip" onclick="sendQuickMessage('${c.message.replace(/'/g, "\\'")}')">
        <span class="chip-emoji">${c.emoji}</span>
        <span class="chip-label">${c.label}</span>
      </button>`
    ).join('');
  }

  // Get suggestion set index from sessionStorage, cycling on each page load
  function getAndCycleSuggestionIndex() {
    let idx = parseInt(sessionStorage.getItem('arjuna-suggestion-set') || '0');
    // Cycle to next set for next time
    const nextIdx = (idx + 1) % suggestionSets.length;
    sessionStorage.setItem('arjuna-suggestion-set', nextIdx.toString());
    return idx;
  }
  
  let currentSuggestionSet = getAndCycleSuggestionIndex();

  // === CONVERSATION PERSISTENCE ===
  function saveConversation() {
    const data = {
      history: assistantHistory,
      timestamp: Date.now()
    };
    localStorage.setItem('arjuna-conversation', JSON.stringify(data));
  }

  function loadConversation() {
    const stored = localStorage.getItem('arjuna-conversation');
    if (!stored) return null;
    
    try {
      const data = JSON.parse(stored);
      // Only restore if less than 24 hours old
      if (Date.now() - data.timestamp > 24 * 60 * 60 * 1000) {
        localStorage.removeItem('arjuna-conversation');
        return null;
      }
      return data;
    } catch {
      return null;
    }
  }

  function restoreConversation() {
    const container = document.getElementById('assistantMessages');
    if (!container) return;
    
    const saved = loadConversation();
    
    // Show welcome message with clickable chips
    container.innerHTML = `<div class="assistant-message assistant">${WELCOME_MESSAGE}<div class="welcome-chips">${createWelcomeChips()}</div></div>`;
    
    if (saved && saved.history && saved.history.length > 0) {
      // Restore the conversation history
      assistantHistory = saved.history;
      
      // Render each message
      for (const msg of saved.history) {
        const div = document.createElement('div');
        div.className = `assistant-message ${msg.role}`;
        let content = msg.content;
        // Format assistant messages
        if (msg.role === 'assistant') {
          content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        }
        div.innerHTML = content;
        container.appendChild(div);
      }
      
      // Add quick suggestions after conversation history
      const suggestionsEl = createSuggestionsElement(suggestionSets[currentSuggestionSet]);
      container.appendChild(suggestionsEl);
    }
    
    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
  }

  function clearArjunaChat() {
    if (!confirm('Start a fresh conversation? Your current chat will be cleared.')) return;
    
    assistantHistory = [];
    localStorage.removeItem('arjuna-conversation');
    
    const container = document.getElementById('assistantMessages');
    if (container) {
      container.innerHTML = `<div class="assistant-message assistant">${WELCOME_MESSAGE}<div class="welcome-chips">${createWelcomeChips()}</div></div>`;
    }
  }

  function renderSuggestions(customSuggestions = null, container = null) {
    const targetContainer = container || document.getElementById('assistantSuggestions');
    if (!targetContainer) return;
    
    const suggestions = customSuggestions || suggestionSets[currentSuggestionSet];
    targetContainer.innerHTML = suggestions.map(s => 
      `<button class="assistant-suggestion" title="${s.tooltip || s.message}" onclick="sendQuickMessage('${s.message.replace(/'/g, "\\'")}')"> ${s.emoji} ${s.text}</button>`
    ).join('');
  }
  
  function createSuggestionsElement(suggestions) {
    const div = document.createElement('div');
    div.className = 'assistant-suggestions';
    div.innerHTML = suggestions.map(s => 
      `<button class="assistant-suggestion" title="${s.tooltip || s.message}" onclick="sendQuickMessage('${s.message.replace(/'/g, "\\'")}')"> ${s.emoji} ${s.text}</button>`
    ).join('');
    return div;
  }

  // Save user's recent commands to localStorage
  function saveRecentCommand(message) {
    if (!message || message.length < 5) return;
    let recent = JSON.parse(localStorage.getItem('arjuna-recent-commands') || '[]');
    if (message.endsWith(' ')) return; // Skip partial messages
    
    // Extract emoji and short text from message
    let emoji = 'üí¨';
    let shortText = message.slice(0, 20);
    if (message.toLowerCase().includes('ticket')) emoji = 'üé´';
    else if (message.toLowerCase().includes('search')) emoji = 'üîç';
    else if (message.toLowerCase().includes('switch') || message.toLowerCase().includes('model')) emoji = 'ü§ñ';
    else if (message.toLowerCase().includes('sprint')) emoji = 'üìä';
    else if (message.toLowerCase().includes('meeting')) emoji = 'üìÖ';
    else if (message.toLowerCase().includes('task') || message.toLowerCase().includes('create')) emoji = '‚ûï';
    else if (message.toLowerCase().includes('block')) emoji = 'üö´';
    else if (message.toLowerCase().includes('done') || message.toLowerCase().includes('complete')) emoji = '‚úÖ';
    else if (message.toLowerCase().includes('focus')) emoji = 'üéØ';
    else if (message.toLowerCase().includes('waiting')) emoji = '‚è≥';
    
    const existingIndex = recent.findIndex(r => r.message === message);
    const now = Date.now();
    if (existingIndex !== -1) {
      const existing = recent[existingIndex];
      const count = (existing.count || 1) + 1;
      const updated = { ...existing, count, timestamp: now };
      recent.splice(existingIndex, 1);
      recent.unshift(updated);
    } else {
      recent.unshift({ emoji, text: shortText, message, tooltip: message, timestamp: now, count: 1 });
    }

    // Sort by frequency (desc), then recency
    recent.sort((a, b) => {
      const ac = a.count || 1;
      const bc = b.count || 1;
      if (bc !== ac) return bc - ac;
      return (b.timestamp || 0) - (a.timestamp || 0);
    });

    recent = recent.slice(0, 10); // Keep last 10
    localStorage.setItem('arjuna-recent-commands', JSON.stringify(recent));
    
    // Dispatch event for shortcuts panel to update
    window.dispatchEvent(new CustomEvent('arjuna-command-saved'));
  }
  
  function getRecentCommands() {
    return JSON.parse(localStorage.getItem('arjuna-recent-commands') || '[]');
  }

  function toggleAssistant() {
    const chat = document.getElementById('assistantChat');
    const toggle = document.getElementById('assistantToggle');
    chat.classList.toggle('active');
    toggle.classList.toggle('active');
    
    if (chat.classList.contains('active')) {
      document.getElementById('assistantInput').focus();
      // Render fresh suggestions each time chat opens
      renderSuggestions();
    }
  }

  function collapseAssistantChat() {
    const chat = document.getElementById('assistantChat');
    const toggle = document.getElementById('assistantToggle');
    if (chat) chat.classList.remove('active');
    if (toggle) toggle.classList.remove('active');
  }
  
  // Initialize on page load - restore conversation
  document.addEventListener('DOMContentLoaded', restoreConversation);

  function addAssistantMessage(content, role = 'assistant', followUps = null) {
    const container = document.getElementById('assistantMessages');
    const msg = document.createElement('div');
    msg.className = `assistant-message ${role}`;
    msg.innerHTML = content;
    container.appendChild(msg);
    
    // Remove any existing suggestion chips first
    const existingSuggestions = container.querySelectorAll('.assistant-suggestions');
    existingSuggestions.forEach(s => s.remove());
    
    // Add contextual follow-up suggestions after assistant messages
    if (role === 'assistant') {
      const suggestions = followUps || suggestionSets[currentSuggestionSet];
      const suggestionsEl = createSuggestionsElement(suggestions);
      container.appendChild(suggestionsEl);
    }
    
    container.scrollTop = container.scrollHeight;
  }

  function showThinking() {
    const container = document.getElementById('assistantMessages');
    const thinking = document.createElement('div');
    thinking.className = 'assistant-thinking';
    thinking.id = 'thinkingIndicator';
    thinking.innerHTML = '<span></span><span></span><span></span>';
    container.appendChild(thinking);
    container.scrollTop = container.scrollHeight;
  }

  function hideThinking() {
    const thinking = document.getElementById('thinkingIndicator');
    if (thinking) thinking.remove();
  }

  async function sendAssistantMessage() {
    const input = document.getElementById('assistantInput');
    const sendBtn = document.getElementById('assistantSendBtn');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Save to recent commands
    saveRecentCommand(message);
    
    // Add user message
    addAssistantMessage(message, 'user');
    assistantHistory.push({ role: 'user', content: message });
    saveConversation(); // Persist after user message
    
    // Clear input and disable
    input.value = '';
    sendBtn.disabled = true;
    
    // Show thinking
    showThinking();
    
    try {
      const response = await fetch('/api/assistant/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({
          message: message,
          history: assistantHistory
        })
      });
      
      const data = await response.json();
      hideThinking();
      
      if (data.response) {
        // Format markdown-style bold text
        let responseHtml = data.response
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\n/g, '<br>');
        
        // Add clarifications if any
        if (data.clarifications && data.clarifications.length > 0) {
          responseHtml += '<div class="assistant-clarifications">';
          responseHtml += '<p>I need to know:</p><ul>';
          data.clarifications.forEach(q => {
            responseHtml += `<li>${q}</li>`;
          });
          responseHtml += '</ul></div>';
        }
        
        // Add suggested page button if present
        if (data.suggested_page) {
          responseHtml += `<div style="margin-top: 8px;"><a href="${data.suggested_page}" class="assistant-suggestion" style="display: inline-block; text-decoration: none;">üìç Go to ${data.suggested_page}</a></div>`;
        }
        
        // Use API-provided follow-ups if available, otherwise use rotating set
        const followUps = data.follow_ups || null;
        addAssistantMessage(responseHtml, 'assistant', followUps);
        assistantHistory.push({ role: 'assistant', content: data.response });
        saveConversation(); // Persist after assistant response
      }
    } catch (err) {
      hideThinking();
      addAssistantMessage('Sorry, I encountered an error. Please try again.', 'assistant');
      console.error('Assistant error:', err);
    } finally {
      sendBtn.disabled = false;
      input.focus();
    }
  }

  function sendQuickMessage(message) {
    document.getElementById('assistantInput').value = message;
    sendAssistantMessage();
  }

  function handleAssistantKeydown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      sendAssistantMessage();
    }
  }

  // Auto-resize textarea
  document.getElementById('assistantInput').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 100) + 'px';
  });
</script>
