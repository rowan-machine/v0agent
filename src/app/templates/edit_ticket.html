{% extends "base.html" %}
{% block title %}{{ 'Edit' if ticket else 'New' }} Ticket{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center gap-2 text-sm text-gray-500 mb-2">
            <a href="/tickets" class="hover:text-violet-600">Tickets</a>
            <span>/</span>
            <span>{{ ticket.ticket_id if ticket else 'New Ticket' }}</span>
        </div>
        <h1 class="text-2xl font-bold text-gray-900">
            {{ 'Edit Ticket' if ticket else 'Add New Ticket' }}
        </h1>
    </div>

    <form method="POST" class="space-y-8">
        <!-- Basic Info -->
        <div class="bg-white border border-gray-200 rounded-xl p-6 space-y-5">
            <h2 class="text-lg font-semibold text-gray-900">Ticket Details</h2>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Ticket ID <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="ticket_id" required
                           value="{{ ticket.ticket_id if ticket else '' }}"
                           placeholder="e.g., DATA-1234"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg text-base font-mono
                                  focus:ring-2 focus:ring-violet-500 focus:border-violet-500"
                           style="min-height: 48px;">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <select name="status"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg text-base cursor-pointer
                                   focus:ring-2 focus:ring-violet-500 focus:border-violet-500"
                            style="min-height: 48px;">
                        <option value="backlog" {{ 'selected' if (not ticket) or (ticket and ticket.status == 'backlog') else '' }}>Backlog</option>
                        <option value="todo" {{ 'selected' if ticket and ticket.status == 'todo' else '' }}>To Do</option>
                        <option value="in_progress" {{ 'selected' if ticket and ticket.status == 'in_progress' else '' }}>In Progress</option>
                        <option value="in_review" {{ 'selected' if ticket and ticket.status == 'in_review' else '' }}>In Review</option>
                        <option value="done" {{ 'selected' if ticket and ticket.status == 'done' else '' }}>Done</option>
                        <option value="complete" {{ 'selected' if ticket and ticket.status == 'complete' else '' }}>Complete</option>
                        <option value="blocked" {{ 'selected' if ticket and ticket.status == 'blocked' else '' }}>Blocked</option>
                    </select>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Title <span class="text-red-500">*</span>
                </label>
                <input type="text" name="title" required
                       value="{{ ticket.title if ticket else '' }}"
                       placeholder="Ticket title"
                       class="w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm
                              focus:ring-2 focus:ring-violet-500 focus:border-violet-500">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                <textarea name="description" rows="6"
                          placeholder="Paste the full ticket description from Jira here..."
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm font-mono
                                 focus:ring-2 focus:ring-violet-500 focus:border-violet-500">{{ ticket.description if ticket else '' }}</textarea>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                    <select name="priority"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg text-base cursor-pointer
                                   focus:ring-2 focus:ring-violet-500 focus:border-violet-500"
                            style="min-height: 48px;">
                        <option value="">Not set</option>
                        <option value="low" {{ 'selected' if ticket and ticket.priority == 'low' else '' }}>Low</option>
                        <option value="medium" {{ 'selected' if ticket and ticket.priority == 'medium' else '' }}>Medium</option>
                        <option value="high" {{ 'selected' if ticket and ticket.priority == 'high' else '' }}>High</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sprint Points</label>
                    <input type="number" name="sprint_points" min="0" max="21"
                           value="{{ ticket.sprint_points if ticket and ticket.sprint_points else '0' }}"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg text-base
                                  focus:ring-2 focus:ring-violet-500 focus:border-violet-500"
                           style="min-height: 48px;">
                    <p class="text-xs text-gray-500 mt-1">Story points (1-21)</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sprint Assignment</label>
                    <select name="in_sprint"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg text-base cursor-pointer
                                   focus:ring-2 focus:ring-violet-500 focus:border-violet-500"
                            style="min-height: 48px;">
                        <option value="1" {{ 'selected' if not ticket or (ticket and ticket.in_sprint != 0) else '' }}>In Current Sprint</option>
                        <option value="0" {{ 'selected' if ticket and ticket.in_sprint == 0 else '' }}>Backlog (Not in Sprint)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Affects burndown</p>
                </div>
            </div>
            
            <!-- Deployment Flag -->
            <div class="flex items-center gap-3 p-4 bg-cyan-50 border border-cyan-200 rounded-lg">
                <input type="checkbox" name="requires_deployment" value="1" id="requires-deployment"
                       {{ 'checked' if ticket and ticket.requires_deployment else '' }}
                       class="w-5 h-5 text-cyan-600 border-gray-300 rounded focus:ring-cyan-500 cursor-pointer">
                <label for="requires-deployment" class="flex-1 cursor-pointer">
                    <div class="font-medium text-gray-900">Requires Deployment</div>
                    <div class="text-sm text-gray-500">Include in Mode F (Controlled Ingress/Egress) for code push, PR, and deployment tracking</div>
                </label>
                <span class="text-cyan-600 text-xl">üöÄ</span>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Tags</label>
                <input type="text" name="tags"
                       value="{{ ticket.tags if ticket else '' }}"
                       placeholder="e.g., airflow, pipeline, aws"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg text-base
                              focus:ring-2 focus:ring-violet-500 focus:border-violet-500"
                       style="min-height: 48px;">
                <p class="text-xs text-gray-500 mt-1">Comma-separated tags</p>
            </div>
        </div>

        {% if ticket %}
        <!-- AI Summary Section -->
        <div class="bg-white border border-gray-200 rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-900">AI Summary</h2>
                <div class="flex items-center gap-2">
                    <button type="button" id="generate-summary-btn"
                            class="px-4 py-2 text-sm font-medium bg-violet-50 text-violet-700 rounded-lg
                                   hover:bg-violet-100 transition-colors flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        {{ 'Regenerate' if ticket.ai_summary else 'Generate with AI' }}
                    </button>
                </div>
            </div>
            
            <!-- Format hint input -->
            <div class="mb-3 p-3 bg-violet-50 rounded-lg border border-violet-100">
                <label class="block text-xs font-medium text-violet-700 mb-1">Formatting hint (optional):</label>
                <input type="text" id="format-hint-input" 
                       class="w-full px-3 py-2 text-sm border border-violet-200 rounded-lg focus:ring-2 focus:ring-violet-400 bg-white"
                       placeholder="e.g., 'Focus on data pipeline aspects' or 'Keep under 100 words'">
                <p class="text-xs text-violet-600 mt-1">
                    üí° Add tags like <code class="bg-white px-1 rounded border">brief</code>, <code class="bg-white px-1 rounded border">detailed</code>, <code class="bg-white px-1 rounded border">technical</code>, <code class="bg-white px-1 rounded border">bullet</code> for automatic formatting.
                </p>
            </div>
            
            <textarea name="ai_summary" id="ai-summary" rows="6"
                      placeholder="Click 'Generate with AI' to create a concise summary, or write your own..."
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm
                             focus:ring-2 focus:ring-violet-500 focus:border-violet-500">{{ ticket.ai_summary if ticket else '' }}</textarea>
            <p class="text-xs text-gray-500 mt-1">Supports markdown: **bold**, `code`, - bullet lists</p>
        </div>

        <!-- Implementation Plan Section -->
        <div class="bg-white border border-gray-200 rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-900">Implementation Plan</h2>
                <button type="button" id="generate-plan-btn"
                        class="px-4 py-2 text-sm font-medium bg-green-50 text-green-700 rounded-lg
                               hover:bg-green-100 transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                    </svg>
                    Generate Plan
                </button>
            </div>
            <textarea name="implementation_plan" id="implementation-plan" rows="10"
                      placeholder="Click 'Generate Plan' to create an implementation plan, or write your own..."
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm font-mono
                             focus:ring-2 focus:ring-violet-500 focus:border-violet-500">{{ ticket.implementation_plan if ticket else '' }}</textarea>
        </div>

        <!-- Test Plan Section -->
        <div class="bg-white border border-gray-200 rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                    <svg class="w-5 h-5 text-cyan-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Test Plan / Acceptance Criteria
                </h2>
                <button type="button" id="generate-tasks-from-testplan-btn"
                        class="px-4 py-2 text-sm font-medium bg-cyan-50 text-cyan-700 rounded-lg
                               hover:bg-cyan-100 transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                    Generate Tasks from Test Plan
                </button>
            </div>
            <p class="text-sm text-gray-500 mb-3">
                Define the acceptance criteria and test cases. Use these to generate implementation tasks that ensure all criteria are met.
            </p>
            <textarea name="test_plan" id="test-plan" rows="8"
                      placeholder="Enter acceptance criteria and test cases:

Example:
‚úì User can submit form with valid email
‚úì Error shows for invalid email format  
‚úì Success message appears after submission
‚úì Form data is saved to database
‚úì Email confirmation is sent within 5 minutes"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm
                             focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">{{ ticket.test_plan if ticket else '' }}</textarea>
            <p class="text-xs text-gray-500 mt-1">üí° Tip: Well-defined acceptance criteria lead to better task generation</p>
        </div>

        <!-- Task Decomposition Section -->
        <div class="bg-white border border-gray-200 rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-900">Task Breakdown</h2>
                <div class="flex items-center gap-2">
                    <button type="button" id="generate-decomposition-btn"
                            class="px-4 py-2 text-sm font-medium bg-orange-50 text-orange-700 rounded-lg
                                   hover:bg-orange-100 transition-colors flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
                        </svg>
                        Auto-Generate Tasks
                    </button>
                </div>
            </div>
            
            <!-- Tasks Container -->
            <div id="tasks-container" class="space-y-3 mb-4">
                {% if ticket.task_decomposition %}
                {% set tasks = ticket.task_decomposition | tojson | safe if ticket.task_decomposition else '[]' %}
                {% else %}
                <p class="text-gray-500 text-sm py-4 text-center" id="no-tasks-msg">
                    Click "Auto-Generate Tasks" to break down this ticket into subtasks based on the description.
                </p>
                {% endif %}
            </div>
            
            <!-- Hidden input for tasks JSON -->
            <input type="hidden" name="task_decomposition" id="task-decomposition-input" 
                   value="{{ ticket.task_decomposition if ticket else '' }}">
            
            <!-- Add Task Manually -->
            <div class="flex gap-2 pt-3 border-t border-gray-100">
                <input type="text" id="new-task-input" placeholder="Add a task manually..."
                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm
                              focus:ring-2 focus:ring-violet-500 focus:border-violet-500">
                <button type="button" onclick="addTask()"
                        class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm">
                    + Add
                </button>
            </div>
        </div>

        <!-- Attachments Section -->
        <div class="bg-white border border-gray-200 rounded-xl p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Screenshots & Files</h2>
            
            <!-- Drop Zone -->
            <div id="drop-zone" 
                 class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center
                        hover:border-violet-400 hover:bg-violet-50/50 transition-colors cursor-pointer">
                <input type="file" id="file-input" multiple accept="image/*,.pdf,.txt,.md" class="hidden">
                <svg class="w-12 h-12 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                </svg>
                <p class="text-gray-600 mb-1">Drag & drop screenshots here</p>
                <p class="text-sm text-gray-500">or click to browse</p>
            </div>

            <!-- Existing Attachments -->
            {% if attachments %}
            <div class="mt-4 space-y-2">
                <h3 class="text-sm font-medium text-gray-700">Uploaded Files</h3>
                <div class="grid gap-2" id="attachments-list">
                    {% for att in attachments %}
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg" data-id="{{ att.id }}">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <span class="text-sm text-gray-700">{{ att.filename }}</span>
                        </div>
                        <button type="button" onclick="deleteAttachment({{ att.id }}, this)"
                                class="text-red-500 hover:text-red-700 text-sm">
                            Remove
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Upload Progress -->
            <div id="upload-progress" class="mt-4 hidden">
                <div class="flex items-center gap-2">
                    <div class="animate-spin w-4 h-4 border-2 border-violet-500 border-t-transparent rounded-full"></div>
                    <span class="text-sm text-gray-600">Uploading...</span>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Code Files Section (Available for both new and existing tickets) -->
        <div class="bg-white border border-gray-200 rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                    <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                    </svg>
                    Code Files
                </h2>
                <button type="button" onclick="showAddCodeFileModal()"
                        class="px-3 py-1.5 text-sm font-medium bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors">
                    + Add File
                </button>
            </div>
            
            <p class="text-sm text-gray-500 mb-4">
                Add files that need to be created or modified for this ticket. Base content is used for diff comparisons in standups.
            </p>
            
            <!-- Code Files List -->
            <div id="code-files-list" class="space-y-2">
                <div class="text-gray-400 text-sm py-4 text-center" id="no-code-files-msg">
                    {% if ticket %}Loading files...{% else %}No files added yet. Add files after creating the ticket, or add them now and they'll be saved with the ticket.{% endif %}
                </div>
            </div>
            
            <!-- Pending files for new tickets (stored in JS until ticket is created) -->
            <input type="hidden" name="pending_code_files" id="pending-code-files-input" value="[]">
        </div>

        <!-- Add Code File Modal -->
        <div id="addCodeFileModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50" onclick="if(event.target === this) closeAddCodeFileModal()">
            <div class="bg-white rounded-xl p-6 w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
                <h3 class="text-lg font-semibold mb-4">Add Code File</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">File Path <span class="text-red-500">*</span></label>
                        <input type="text" id="codeFileNameInput" placeholder="src/app/example.py" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">File Type</label>
                        <div class="flex gap-4">
                            <label class="flex items-center gap-2 cursor-pointer p-3 border rounded-lg hover:bg-gray-50 flex-1">
                                <input type="radio" name="codeFileType" value="update" checked class="text-blue-600">
                                <div>
                                    <span class="font-medium text-sm">üìù Update Existing</span>
                                    <p class="text-xs text-gray-500">Modify an existing file (paste original below)</p>
                                </div>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer p-3 border rounded-lg hover:bg-gray-50 flex-1">
                                <input type="radio" name="codeFileType" value="new" class="text-blue-600">
                                <div>
                                    <span class="font-medium text-sm">‚ú® Create New</span>
                                    <p class="text-xs text-gray-500">New file that doesn't exist yet</p>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div id="baseContentSection">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Base/Original Content
                            <span class="text-gray-400 font-normal">(for update files - used for diff)</span>
                        </label>
                        <textarea id="codeFileBaseContent" rows="12" placeholder="Paste the original file content here..."
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg font-mono text-sm focus:ring-2 focus:ring-blue-500"></textarea>
                        <p class="text-xs text-gray-500 mt-1">This will be stored as v1 in the code locker for comparison</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description <span class="text-gray-400 font-normal">(optional)</span></label>
                        <input type="text" id="codeFileDescription" placeholder="Brief description of changes needed"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeAddCodeFileModal()" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800">Cancel</button>
                    <button type="button" onclick="saveCodeFile()" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add File</button>
                </div>
            </div>
        </div>

        <!-- Edit Code File Modal -->
        <div id="editCodeFileModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50" onclick="if(event.target === this) closeEditCodeFileModal()">
            <div class="bg-white rounded-xl p-6 w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
                <h3 class="text-lg font-semibold mb-4">Edit Code File</h3>
                <input type="hidden" id="editCodeFileId">
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">File Path</label>
                        <input type="text" id="editCodeFileName" disabled
                               class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-600">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">File Type</label>
                        <div class="flex gap-4">
                            <label class="flex items-center gap-2 cursor-pointer p-3 border rounded-lg hover:bg-gray-50 flex-1">
                                <input type="radio" name="editCodeFileType" value="update" class="text-blue-600">
                                <div>
                                    <span class="font-medium text-sm">üìù Update Existing</span>
                                </div>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer p-3 border rounded-lg hover:bg-gray-50 flex-1">
                                <input type="radio" name="editCodeFileType" value="new" class="text-blue-600">
                                <div>
                                    <span class="font-medium text-sm">‚ú® Create New</span>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div id="editBaseContentSection">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Base/Original Content
                        </label>
                        <textarea id="editCodeFileBaseContent" rows="12" placeholder="Paste the original file content here..."
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg font-mono text-sm focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <input type="text" id="editCodeFileDescription" placeholder="Brief description of changes needed"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeEditCodeFileModal()" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800">Cancel</button>
                    <button type="button" onclick="updateCodeFile()" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Changes</button>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex items-center justify-between">
            <a href="/tickets" class="text-gray-500 hover:text-gray-700">Cancel</a>
            <div class="flex items-center gap-3">
                {% if ticket %}
                <button type="button" onclick="confirmDelete()"
                        class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                    Delete Ticket
                </button>
                {% endif %}
                <button type="submit"
                        class="px-6 py-2.5 bg-violet-600 text-white font-medium rounded-lg
                               hover:bg-violet-700 transition-colors">
                    {{ 'Save Changes' if ticket else 'Create Ticket' }}
                </button>
            </div>
        </div>
    </form>

    {% if ticket %}
    <!-- Hidden delete form -->
    <form id="delete-form" method="POST" action="/tickets/{{ ticket.id }}/delete" class="hidden"></form>
    {% endif %}
</div>

{% if ticket %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
const ticketId = {{ ticket.id }};

// AI Summary Generation
document.getElementById('generate-summary-btn').addEventListener('click', async () => {
    const btn = document.getElementById('generate-summary-btn');
    const textarea = document.getElementById('ai-summary');
    const formatHint = document.getElementById('format-hint-input')?.value || '';
    
    btn.disabled = true;
    btn.innerHTML = '<span class="animate-spin w-4 h-4 border-2 border-violet-500 border-t-transparent rounded-full"></span> Generating...';
    
    try {
        const resp = await fetch(`/api/tickets/${ticketId}/generate-summary`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ format_hint: formatHint })
        });
        const data = await resp.json();
        
        if (data.summary) {
            textarea.value = data.summary;
            // Show saved indicator if auto-saved
            if (data.saved) {
                const savedBadge = document.createElement('span');
                savedBadge.className = 'text-xs text-green-600 ml-2';
                savedBadge.textContent = '‚úì Auto-saved';
                btn.insertAdjacentElement('afterend', savedBadge);
                setTimeout(() => savedBadge.remove(), 2000);
            }
        } else {
            alert(data.error || 'Failed to generate summary');
        }
    } catch (err) {
        alert('Error generating summary: ' + err.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> Regenerate';
    }
});

// Implementation Plan Generation
document.getElementById('generate-plan-btn').addEventListener('click', async () => {
    const btn = document.getElementById('generate-plan-btn');
    const textarea = document.getElementById('implementation-plan');
    
    btn.disabled = true;
    btn.innerHTML = '<span class="animate-spin w-4 h-4 border-2 border-green-500 border-t-transparent rounded-full"></span> Generating...';
    
    try {
        const resp = await fetch(`/api/tickets/${ticketId}/generate-plan`, { method: 'POST' });
        const data = await resp.json();
        
        if (data.plan) {
            textarea.value = data.plan;
        } else {
            alert(data.error || 'Failed to generate plan');
        }
    } catch (err) {
        alert('Error generating plan: ' + err.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg> Generate Plan';
    }
});

// Task Decomposition
let tasks = [];
try {
    const saved = document.getElementById('task-decomposition-input').value;
    if (saved) tasks = JSON.parse(saved);
} catch (e) {}

function renderTasks() {
    const container = document.getElementById('tasks-container');
    const noTasksMsg = document.getElementById('no-tasks-msg');
    
    if (tasks.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm py-4 text-center" id="no-tasks-msg">Click "Auto-Generate Tasks" to break down this ticket into subtasks based on the description.</p>';
        return;
    }
    
    container.innerHTML = tasks.map((task, i) => `
        <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg group task-item" data-idx="${i}" draggable="true">
            <div class="drag-handle cursor-grab text-gray-300 hover:text-gray-500 mt-1" title="Drag to reorder">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"/>
                </svg>
            </div>
            <input type="checkbox" ${task.done ? 'checked' : ''} 
                   onchange="toggleTask(${i})"
                   class="mt-1 h-5 w-5 rounded border-gray-300 text-violet-600 cursor-pointer">
            <div class="flex-1 min-w-0">
                <p class="text-sm ${task.done ? 'line-through text-gray-400' : 'text-gray-700'}">${escapeHtml(task.text)}</p>
                <div class="flex flex-wrap items-center gap-2 mt-1">
                    ${task.estimate ? `<span class="text-xs text-gray-400 bg-gray-200 px-1.5 py-0.5 rounded">‚è±Ô∏è ${escapeHtml(task.estimate)}</span>` : ''}
                    ${task.test_case ? `<span class="text-xs text-cyan-600 bg-cyan-50 px-1.5 py-0.5 rounded">‚úì ${escapeHtml(task.test_case)}</span>` : ''}
                </div>
            </div>
            <button type="button" onclick="removeTask(${i})"
                    class="text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
    `).join('');
    
    updateTasksInput();
    initTaskDragDrop();
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function initTaskDragDrop() {
    const container = document.getElementById('tasks-container');
    const items = container.querySelectorAll('.task-item');
    let draggedItem = null;
    
    items.forEach(item => {
        item.addEventListener('dragstart', (e) => {
            draggedItem = item;
            item.classList.add('opacity-50');
            e.dataTransfer.effectAllowed = 'move';
        });
        
        item.addEventListener('dragend', () => {
            item.classList.remove('opacity-50');
            draggedItem = null;
            // Remove all drag-over styles
            items.forEach(i => i.classList.remove('border-t-2', 'border-violet-500'));
        });
        
        item.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            if (draggedItem && draggedItem !== item) {
                item.classList.add('border-t-2', 'border-violet-500');
            }
        });
        
        item.addEventListener('dragleave', () => {
            item.classList.remove('border-t-2', 'border-violet-500');
        });
        
        item.addEventListener('drop', (e) => {
            e.preventDefault();
            if (draggedItem && draggedItem !== item) {
                const fromIdx = parseInt(draggedItem.dataset.idx);
                const toIdx = parseInt(item.dataset.idx);
                
                // Reorder tasks array
                const [movedTask] = tasks.splice(fromIdx, 1);
                tasks.splice(toIdx, 0, movedTask);
                
                renderTasks();
            }
        });
    });
}

function updateTasksInput() {
    document.getElementById('task-decomposition-input').value = JSON.stringify(tasks);
}

function toggleTask(idx) {
    tasks[idx].done = !tasks[idx].done;
    renderTasks();
}

function removeTask(idx) {
    tasks.splice(idx, 1);
    renderTasks();
}

function addTask() {
    const input = document.getElementById('new-task-input');
    const text = input.value.trim();
    if (!text) return;
    
    tasks.push({ text, done: false });
    input.value = '';
    renderTasks();
}

document.getElementById('new-task-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        addTask();
    }
});

document.getElementById('generate-decomposition-btn').addEventListener('click', async () => {
    const btn = document.getElementById('generate-decomposition-btn');
    
    btn.disabled = true;
    btn.innerHTML = '<span class="animate-spin w-4 h-4 border-2 border-orange-500 border-t-transparent rounded-full"></span> Analyzing...';
    
    try {
        const resp = await fetch(`/api/tickets/${ticketId}/generate-decomposition`, { method: 'POST' });
        const data = await resp.json();
        
        if (data.tasks && data.tasks.length > 0) {
            tasks = data.tasks.map(t => typeof t === 'string' ? { text: t, done: false } : { text: t.text, estimate: t.estimate, done: false });
            renderTasks();
        } else {
            alert(data.error || 'Could not generate task breakdown');
        }
    } catch (err) {
        alert('Error generating decomposition: ' + err.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/></svg> Auto-Generate Tasks';
    }
});

// Generate Tasks from Test Plan
document.getElementById('generate-tasks-from-testplan-btn').addEventListener('click', async () => {
    const btn = document.getElementById('generate-tasks-from-testplan-btn');
    const testPlan = document.getElementById('test-plan').value.trim();
    
    if (!testPlan) {
        alert('Please enter a test plan or acceptance criteria first.');
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<span class="animate-spin w-4 h-4 border-2 border-cyan-500 border-t-transparent rounded-full"></span> Generating...';
    
    try {
        const resp = await fetch(`/api/tickets/${ticketId}/generate-tasks-from-testplan`, { method: 'POST' });
        const data = await resp.json();
        
        if (data.tasks && data.tasks.length > 0) {
            tasks = data.tasks.map(t => ({
                text: t.text || t,
                estimate: t.estimate,
                test_case: t.test_case,
                done: false
            }));
            renderTasks();
            // Scroll to tasks section
            document.getElementById('tasks-container').scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
            alert(data.error || 'Could not generate tasks from test plan');
        }
    } catch (err) {
        alert('Error generating tasks: ' + err.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg> Generate Tasks from Test Plan';
    }
});

// Initial render
renderTasks();

// File Upload
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
const progressDiv = document.getElementById('upload-progress');

dropZone.addEventListener('click', () => fileInput.click());

dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('border-violet-500', 'bg-violet-50');
});

dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('border-violet-500', 'bg-violet-50');
});

dropZone.addEventListener('drop', async (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-violet-500', 'bg-violet-50');
    await uploadFiles(e.dataTransfer.files);
});

fileInput.addEventListener('change', async () => {
    await uploadFiles(fileInput.files);
});

async function uploadFiles(files) {
    if (!files.length) return;
    
    progressDiv.classList.remove('hidden');
    
    const formData = new FormData();
    for (const file of files) {
        formData.append('files', file);
    }
    
    try {
        const resp = await fetch(`/api/upload/ticket/${ticketId}`, {
            method: 'POST',
            body: formData
        });
        const data = await resp.json();
        
        if (data.uploaded) {
            // Refresh to show new attachments
            location.reload();
        } else {
            alert(data.error || 'Upload failed');
        }
    } catch (err) {
        alert('Error uploading: ' + err.message);
    } finally {
        progressDiv.classList.add('hidden');
    }
}

async function deleteAttachment(id, btn) {
    if (!confirm('Delete this attachment?')) return;
    
    try {
        await fetch(`/api/attachments/${id}`, { method: 'DELETE' });
        btn.closest('[data-id]').remove();
    } catch (err) {
        alert('Error deleting: ' + err.message);
    }
}

function confirmDelete() {
    if (confirm('Are you sure you want to delete this ticket? This cannot be undone.')) {
        document.getElementById('delete-form').submit();
    }
}

// =====================
// Code Files Management
// =====================

let codeFiles = [];

// Load code files for existing ticket
async function loadCodeFiles() {
    try {
        const res = await fetch(`/api/career/ticket-files/${ticketId}`);
        codeFiles = await res.json();
        renderCodeFiles();
    } catch (err) {
        console.error('Failed to load code files:', err);
        document.getElementById('code-files-list').innerHTML = 
            '<div class="text-red-500 text-sm py-4 text-center">Failed to load files</div>';
    }
}

function renderCodeFiles() {
    const container = document.getElementById('code-files-list');
    const noFilesMsg = document.getElementById('no-code-files-msg');
    
    if (codeFiles.length === 0) {
        if (noFilesMsg) noFilesMsg.style.display = 'block';
        container.innerHTML = '<div class="text-gray-400 text-sm py-4 text-center">No files added yet</div>';
        return;
    }
    
    if (noFilesMsg) noFilesMsg.style.display = 'none';
    
    const updateFiles = codeFiles.filter(f => f.file_type === 'update');
    const newFiles = codeFiles.filter(f => f.file_type === 'new');
    
    let html = '';
    
    if (updateFiles.length > 0) {
        html += `<div class="mb-3"><div class="text-xs font-medium text-gray-500 mb-2">üìù Files to Update</div>`;
        html += updateFiles.map(f => renderCodeFileItem(f)).join('');
        html += '</div>';
    }
    
    if (newFiles.length > 0) {
        html += `<div><div class="text-xs font-medium text-gray-500 mb-2">‚ú® New Files to Create</div>`;
        html += newFiles.map(f => renderCodeFileItem(f)).join('');
        html += '</div>';
    }
    
    container.innerHTML = html;
}

function renderCodeFileItem(file) {
    const hasBase = file.base_content && file.base_content.length > 0;
    const versionInfo = file.locker_version ? `v${file.locker_version}` : (hasBase ? 'base set' : 'no base');
    const versionClass = file.locker_version ? 'bg-green-100 text-green-700' : (hasBase ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-500');
    
    return `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 mb-2">
            <div class="flex items-center gap-3 min-w-0 flex-1">
                <span class="text-lg">${file.file_type === 'new' ? '‚ú®' : 'üìÑ'}</span>
                <div class="min-w-0 flex-1">
                    <div class="font-mono text-sm text-gray-800 truncate">${file.filename}</div>
                    ${file.description ? `<div class="text-xs text-gray-500 truncate">${file.description}</div>` : ''}
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span class="px-2 py-0.5 text-xs ${versionClass} rounded">${versionInfo}</span>
                <button type="button" onclick="editCodeFile(${file.id})" 
                        class="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200" title="Edit">
                    ‚úèÔ∏è
                </button>
                <button type="button" onclick="deleteCodeFile(${file.id})" 
                        class="px-2 py-1 text-xs text-red-600 hover:text-red-800" title="Remove">
                    ‚úï
                </button>
            </div>
        </div>
    `;
}

function showAddCodeFileModal() {
    document.getElementById('addCodeFileModal').classList.remove('hidden');
    document.getElementById('addCodeFileModal').classList.add('flex');
    document.getElementById('codeFileNameInput').focus();
}

function closeAddCodeFileModal() {
    document.getElementById('addCodeFileModal').classList.add('hidden');
    document.getElementById('addCodeFileModal').classList.remove('flex');
    // Reset form
    document.getElementById('codeFileNameInput').value = '';
    document.getElementById('codeFileBaseContent').value = '';
    document.getElementById('codeFileDescription').value = '';
    document.querySelector('input[name="codeFileType"][value="update"]').checked = true;
    document.getElementById('baseContentSection').style.display = 'block';
}

// Toggle base content visibility based on file type
document.querySelectorAll('input[name="codeFileType"]').forEach(radio => {
    radio.addEventListener('change', function() {
        document.getElementById('baseContentSection').style.display = 
            this.value === 'update' ? 'block' : 'none';
    });
});

async function saveCodeFile() {
    const filename = document.getElementById('codeFileNameInput').value.trim();
    const fileType = document.querySelector('input[name="codeFileType"]:checked').value;
    const baseContent = document.getElementById('codeFileBaseContent').value;
    const description = document.getElementById('codeFileDescription').value.trim();
    
    if (!filename) {
        alert('Please enter a filename');
        return;
    }
    
    try {
        const res = await fetch(`/api/career/ticket-files/${ticketId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                filename,
                file_type: fileType,
                base_content: baseContent,
                description
            })
        });
        
        const data = await res.json();
        
        if (data.status === 'ok') {
            closeAddCodeFileModal();
            loadCodeFiles();
        } else {
            alert(data.error || 'Failed to add file');
        }
    } catch (err) {
        console.error('Error adding file:', err);
        alert('Failed to add file');
    }
}

async function editCodeFile(fileId) {
    const file = codeFiles.find(f => f.id === fileId);
    if (!file) return;
    
    document.getElementById('editCodeFileId').value = fileId;
    document.getElementById('editCodeFileName').value = file.filename;
    document.getElementById('editCodeFileBaseContent').value = file.base_content || '';
    document.getElementById('editCodeFileDescription').value = file.description || '';
    document.querySelector(`input[name="editCodeFileType"][value="${file.file_type}"]`).checked = true;
    
    document.getElementById('editBaseContentSection').style.display = 
        file.file_type === 'update' ? 'block' : 'none';
    
    document.getElementById('editCodeFileModal').classList.remove('hidden');
    document.getElementById('editCodeFileModal').classList.add('flex');
}

function closeEditCodeFileModal() {
    document.getElementById('editCodeFileModal').classList.add('hidden');
    document.getElementById('editCodeFileModal').classList.remove('flex');
}

// Toggle base content in edit modal
document.querySelectorAll('input[name="editCodeFileType"]').forEach(radio => {
    radio.addEventListener('change', function() {
        document.getElementById('editBaseContentSection').style.display = 
            this.value === 'update' ? 'block' : 'none';
    });
});

async function updateCodeFile() {
    const fileId = document.getElementById('editCodeFileId').value;
    const fileType = document.querySelector('input[name="editCodeFileType"]:checked').value;
    const baseContent = document.getElementById('editCodeFileBaseContent').value;
    const description = document.getElementById('editCodeFileDescription').value.trim();
    
    try {
        // Update file type and description
        const res = await fetch(`/api/career/ticket-files/${fileId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                file_type: fileType,
                base_content: baseContent,
                description
            })
        });
        
        const data = await res.json();
        
        if (data.status === 'ok') {
            closeEditCodeFileModal();
            loadCodeFiles();
        } else {
            alert(data.error || 'Failed to update file');
        }
    } catch (err) {
        console.error('Error updating file:', err);
        alert('Failed to update file');
    }
}

async function deleteCodeFile(fileId) {
    if (!confirm('Remove this file from the ticket?')) return;
    
    try {
        await fetch(`/api/career/ticket-files/${fileId}`, { method: 'DELETE' });
        loadCodeFiles();
    } catch (err) {
        console.error('Error deleting file:', err);
        alert('Failed to delete file');
    }
}

// Load code files on page load
loadCodeFiles();
</script>
{% endif %}

<!-- Code files JS for new tickets (no ticketId yet) -->
{% if not ticket %}
<script>
// For new tickets, store pending files in memory until ticket is created
let pendingCodeFiles = [];

function renderCodeFiles() {
    const container = document.getElementById('code-files-list');
    
    if (pendingCodeFiles.length === 0) {
        container.innerHTML = '<div class="text-gray-400 text-sm py-4 text-center">No files added yet. Files will be saved when you create the ticket.</div>';
        return;
    }
    
    const updateFiles = pendingCodeFiles.filter(f => f.file_type === 'update');
    const newFiles = pendingCodeFiles.filter(f => f.file_type === 'new');
    
    let html = '';
    
    if (updateFiles.length > 0) {
        html += `<div class="mb-3"><div class="text-xs font-medium text-gray-500 mb-2">üìù Files to Update</div>`;
        html += updateFiles.map((f, i) => renderPendingFileItem(f, i)).join('');
        html += '</div>';
    }
    
    if (newFiles.length > 0) {
        html += `<div><div class="text-xs font-medium text-gray-500 mb-2">‚ú® New Files to Create</div>`;
        html += newFiles.map((f, i) => renderPendingFileItem(f, i)).join('');
        html += '</div>';
    }
    
    container.innerHTML = html;
    
    // Update hidden input
    document.getElementById('pending-code-files-input').value = JSON.stringify(pendingCodeFiles);
}

function renderPendingFileItem(file, index) {
    const hasBase = file.base_content && file.base_content.length > 0;
    
    return `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 mb-2">
            <div class="flex items-center gap-3 min-w-0 flex-1">
                <span class="text-lg">${file.file_type === 'new' ? '‚ú®' : 'üìÑ'}</span>
                <div class="min-w-0 flex-1">
                    <div class="font-mono text-sm text-gray-800 truncate">${file.filename}</div>
                    ${file.description ? `<div class="text-xs text-gray-500 truncate">${file.description}</div>` : ''}
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span class="px-2 py-0.5 text-xs bg-yellow-100 text-yellow-700 rounded">pending</span>
                <button type="button" onclick="removePendingFile(${index})" 
                        class="px-2 py-1 text-xs text-red-600 hover:text-red-800" title="Remove">
                    ‚úï
                </button>
            </div>
        </div>
    `;
}

function showAddCodeFileModal() {
    document.getElementById('addCodeFileModal').classList.remove('hidden');
    document.getElementById('addCodeFileModal').classList.add('flex');
    document.getElementById('codeFileNameInput').focus();
}

function closeAddCodeFileModal() {
    document.getElementById('addCodeFileModal').classList.add('hidden');
    document.getElementById('addCodeFileModal').classList.remove('flex');
    document.getElementById('codeFileNameInput').value = '';
    document.getElementById('codeFileBaseContent').value = '';
    document.getElementById('codeFileDescription').value = '';
    document.querySelector('input[name="codeFileType"][value="update"]').checked = true;
    document.getElementById('baseContentSection').style.display = 'block';
}

document.querySelectorAll('input[name="codeFileType"]').forEach(radio => {
    radio.addEventListener('change', function() {
        document.getElementById('baseContentSection').style.display = 
            this.value === 'update' ? 'block' : 'none';
    });
});

function saveCodeFile() {
    const filename = document.getElementById('codeFileNameInput').value.trim();
    const fileType = document.querySelector('input[name="codeFileType"]:checked').value;
    const baseContent = document.getElementById('codeFileBaseContent').value;
    const description = document.getElementById('codeFileDescription').value.trim();
    
    if (!filename) {
        alert('Please enter a filename');
        return;
    }
    
    // Check for duplicate
    if (pendingCodeFiles.some(f => f.filename === filename)) {
        alert('A file with this name already exists');
        return;
    }
    
    pendingCodeFiles.push({
        filename,
        file_type: fileType,
        base_content: baseContent,
        description
    });
    
    closeAddCodeFileModal();
    renderCodeFiles();
}

function removePendingFile(index) {
    pendingCodeFiles.splice(index, 1);
    renderCodeFiles();
}

// Initial render
renderCodeFiles();
</script>
{% endif %}
{% endblock %}
