{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<style>
  /* Toast Notifications */
  .toast-container {
    position: fixed;
    top: 70px;
    right: 1rem;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .toast {
    background: var(--sf-card-bg, white);
    border-radius: 10px;
    padding: 1rem 1.25rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    min-width: 300px;
    max-width: 450px;
    animation: slideIn 0.3s ease;
    border-left: 4px solid var(--sf-primary, #667eea);
  }
  
  .toast.success { border-left-color: #10b981; }
  .toast.error { border-left-color: #ef4444; }
  .toast.warning { border-left-color: #f59e0b; }
  
  .toast-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 0.9rem;
  }
  
  .toast.success .toast-icon { background: #d1fae5; }
  .toast.error .toast-icon { background: #fee2e2; }
  .toast.warning .toast-icon { background: #fef3c7; }
  
  .toast-content { flex: 1; }
  .toast-title { font-weight: 600; font-size: 0.9rem; color: var(--sf-text, #1f2937); }
  .toast-message { font-size: 0.85rem; color: var(--sf-text-muted, #6b7280); margin-top: 0.125rem; }
  
  .toast-close {
    background: none;
    border: none;
    color: var(--sf-text-muted, #9ca3af);
    cursor: pointer;
    padding: 0.25rem;
    font-size: 1.25rem;
    line-height: 1;
  }
  
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }

  /* Collapsible Box Styles */
  .collapsible-box {
    transition: all 0.3s ease;
  }
  
  .collapsible-box .collapse-icon {
    transition: transform 0.3s ease;
    font-size: 0.75rem;
    color: var(--sf-text-muted);
  }
  
  .collapsible-box.collapsed .collapse-icon {
    transform: rotate(-90deg);
  }
  
  .collapsible-box.collapsed .collapsible-content {
    display: none !important;
  }
  
  .collapsible-box .section-header {
    user-select: none;
  }
  
  .collapsible-box .section-header:hover {
    background: var(--sf-surface, #f9fafb);
  }

  /* Attention Section Styles */
  .attention-badge {
    background: #ef4444;
    color: white;
    font-size: 0.7rem;
    font-weight: 600;
    padding: 0.2rem 0.5rem;
    border-radius: 10px;
    min-width: 20px;
    text-align: center;
  }
  
  .refresh-btn, .toggle-seen-btn {
    background: var(--sf-surface, #f3f4f6);
    border: 1px solid var(--sf-border, #e5e7eb);
    border-radius: 6px;
    padding: 0.4rem 0.6rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.3rem;
    font-size: 0.75rem;
    color: var(--sf-text-muted);
    transition: all 0.2s;
  }
  
  .refresh-btn:hover, .toggle-seen-btn:hover {
    background: var(--sf-primary, #667eea);
    color: white;
    border-color: var(--sf-primary, #667eea);
  }
  
  .refresh-btn.spinning svg {
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* Highlight Item - Coaching Cards */
  .highlight-item {
    position: relative;
    transition: all 0.2s ease;
    cursor: pointer;
    border-radius: 12px;
    padding: 1rem;
    background: var(--sf-card-bg, white);
    border: 1px solid var(--sf-border, #e5e7eb);
  }
  
  .highlight-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: var(--sf-primary, #667eea);
  }
  
  .highlight-item.blocker {
    border-left: 4px solid #ef4444;
    background: linear-gradient(135deg, #fef2f2 0%, var(--sf-card-bg, white) 100%);
  }
  
  .highlight-item.risk {
    border-left: 4px solid #f59e0b;
    background: linear-gradient(135deg, #fffbeb 0%, var(--sf-card-bg, white) 100%);
  }
  
  .highlight-item.action {
    border-left: 4px solid #3b82f6;
    background: linear-gradient(135deg, #eff6ff 0%, var(--sf-card-bg, white) 100%);
  }
  
  .highlight-item.waiting {
    border-left: 4px solid #8b5cf6;
    background: linear-gradient(135deg, #f5f3ff 0%, var(--sf-card-bg, white) 100%);
  }
  
  .highlight-item.idea {
    border-left: 4px solid #10b981;
    background: linear-gradient(135deg, #ecfdf5 0%, var(--sf-card-bg, white) 100%);
  }
  
  .highlight-item.decision {
    border-left: 4px solid #06b6d4;
    background: linear-gradient(135deg, #ecfeff 0%, var(--sf-card-bg, white) 100%);
  }
  
  .highlight-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
  }
  
  .highlight-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--sf-text-muted, #6b7280);
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }
  
  .highlight-text {
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--sf-text, #1f2937);
    line-height: 1.4;
    margin-bottom: 0.5rem;
  }
  
  .highlight-action-hint {
    font-size: 0.8rem;
    color: var(--sf-text-muted, #6b7280);
    font-style: italic;
    margin-bottom: 0.75rem;
  }
  
  .highlight-cta {
    display: flex;
    justify-content: flex-end;
  }
  
  .highlight-link {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--sf-primary, #667eea);
  }
  
  .highlight-item:hover .highlight-link {
    text-decoration: underline;
  }
  
  .highlight-actions {
    display: flex;
    gap: 0.25rem;
  }
  
  .highlight-action-btn {
    width: 26px;
    height: 26px;
    border-radius: 6px;
    border: none;
    background: rgba(255,255,255,0.8);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--sf-text-muted, #9ca3af);
    transition: all 0.2s;
  }
  
  .highlight-action-btn:hover {
    background: var(--sf-primary, #667eea);
    color: white;
  }
  
  .highlight-action-btn.dismiss-btn:hover {
    background: #10b981;
    color: white;
  }
  
  /* Dark mode for coaching cards */
  [data-theme="dark"] .highlight-item {
    background: #1e1e1e;
    border-color: #3a3a3a;
  }
  
  [data-theme="dark"] .highlight-item.blocker {
    background: linear-gradient(135deg, #2d1f1f 0%, #1e1e1e 100%);
  }
  
  [data-theme="dark"] .highlight-item.risk {
    background: linear-gradient(135deg, #2d2a1f 0%, #1e1e1e 100%);
  }
  
  [data-theme="dark"] .highlight-item.action {
    background: linear-gradient(135deg, #1f2433 0%, #1e1e1e 100%);
  }
  
  [data-theme="dark"] .highlight-item.waiting {
    background: linear-gradient(135deg, #251f33 0%, #1e1e1e 100%);
  }
  
  [data-theme="dark"] .highlight-item.idea {
    background: linear-gradient(135deg, #1f2d24 0%, #1e1e1e 100%);
  }
  
  [data-theme="dark"] .highlight-item:hover {
    border-color: #8b5cf6;
  }
  
  [data-theme="dark"] .highlight-action-btn {
    background: rgba(0,0,0,0.3);
  }
  
  /* Mode G Task Styles */
  .mode-g-expand-btn {
    background: none;
    border: none;
    padding: 0.15rem;
    cursor: pointer;
    color: #9ca3af;
    border-radius: 4px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
  }
  
  .mode-g-expand-btn:hover {
    background: #f3f4f6;
    color: #6366f1;
  }
  
  .mode-g-expand-btn.expanded svg {
    transform: rotate(180deg);
  }
  
  .mode-g-task.completed .workflow-checklist-title span {
    text-decoration: line-through;
    opacity: 0.6;
  }
  
  .mode-g-tasks .workflow-checklist-item {
    padding: 0.5rem 0;
    padding-left: 0.75rem;
    border-bottom: 1px solid #f3f4f6;
  }
  
  .mode-g-tasks .workflow-checklist-item:last-child {
    border-bottom: none;
  }

  /* Add left padding to all workflow checklist items */
  .workflow-checklist-item {
    padding-left: 0.75rem;
  }
  
  /* Mode G Sprint Ticket Cards */
  .mode-g-ticket-card {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    margin-bottom: 0.75rem;
    overflow: hidden;
    transition: all 0.2s;
  }
  
  .mode-g-ticket-card:hover {
    border-color: #6366f1;
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
  }
  
  .mode-g-ticket-header {
    padding: 0.75rem 1rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    border-bottom: 1px solid transparent;
    transition: all 0.2s;
  }
  
  .mode-g-ticket-header:hover {
    background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
  }
  
  .mode-g-ticket-header.expanded {
    border-bottom-color: #e5e7eb;
  }
  
  .mode-g-ticket-toggle {
    width: 20px;
    height: 20px;
    color: #6366f1;
    transition: transform 0.2s;
  }
  
  .mode-g-ticket-header.expanded .mode-g-ticket-toggle {
    transform: rotate(180deg);
  }
  
  .mode-g-ticket-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .mode-g-ticket-id {
    font-size: 0.75rem;
    font-family: monospace;
    color: #6366f1;
    font-weight: 600;
  }
  
  .mode-g-ticket-title {
    font-size: 0.9rem;
    font-weight: 500;
    color: #1f2937;
  }
  
  .mode-g-ticket-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-shrink: 0;
  }
  
  .mode-g-points-badge {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    font-size: 0.7rem;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
    border-radius: 8px;
    min-width: 24px;
    text-align: center;
  }
  
  .mode-g-progress-mini {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    color: #6b7280;
  }
  
  .mode-g-progress-bar-mini {
    width: 60px;
    height: 6px;
    background: #e5e7eb;
    border-radius: 3px;
    overflow: hidden;
  }
  
  .mode-g-progress-fill-mini {
    height: 100%;
    background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
    border-radius: 3px;
    transition: width 0.3s;
  }
  
  .mode-g-ticket-body {
    display: none;
    padding: 0.75rem 1rem;
    background: #fff;
  }
  
  .mode-g-ticket-card.expanded .mode-g-ticket-body {
    display: block;
  }
  
  .mode-g-status-badge {
    font-size: 0.65rem;
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    text-transform: uppercase;
    font-weight: 600;
  }
  
  .mode-g-status-badge.in_progress {
    background: #dbeafe;
    color: #1d4ed8;
  }
  
  .mode-g-status-badge.todo {
    background: #f3f4f6;
    color: #6b7280;
  }
  
  .mode-g-status-badge.in_review {
    background: #fef3c7;
    color: #d97706;
  }
  
  .mode-g-status-badge.blocked {
    background: #fee2e2;
    color: #dc2626;
  }
  
  .mode-g-status-badge.done {
    background: #dcfce7;
    color: #15803d;
  }

  .mode-g-status-badge.complete {
    background: #a7f3d0;
    color: #047857;
  }
  
  .mode-g-edit-link {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    background: #f3f4f6;
    border-radius: 6px;
    text-decoration: none;
    font-size: 0.8rem;
    transition: all 0.2s;
    flex-shrink: 0;
  }
  
  .mode-g-edit-link:hover {
    background: #6366f1;
    color: white;
    transform: scale(1.1);
  }
  
  .mode-g-global-task:hover .remove-global-task {
    opacity: 1 !important;
  }
  
  /* Sprint Burndown Summary */
  .sprint-burndown-summary {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.75rem;
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 10px;
    border: 1px solid #e5e7eb;
  }
  
  .burndown-stat {
    text-align: center;
    padding: 0.5rem;
  }
  
  .burndown-stat-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1f2937;
  }
  
  .burndown-stat-label {
    font-size: 0.7rem;
    color: #6b7280;
    text-transform: uppercase;
  }
  
  .burndown-stat.completed .burndown-stat-value {
    color: #10b981;
  }
  
  .burndown-stat.in-progress .burndown-stat-value {
    color: #3b82f6;
  }
  
  .burndown-stat.remaining .burndown-stat-value {
    color: #f59e0b;
  }

  .highlight-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
  }
  
  .highlight-actions {
    display: flex;
    gap: 0.25rem;
    opacity: 0;
    transition: opacity 0.2s;
  }
  
  .highlight-item:hover .highlight-actions {
    opacity: 1;
  }
  
  .highlight-action-btn {
    background: rgba(255,255,255,0.8);
    border: 1px solid var(--sf-border, #e5e7eb);
    border-radius: 4px;
    padding: 0.25rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  
  .highlight-action-btn:hover {
    background: var(--sf-primary, #667eea);
    color: white;
    border-color: var(--sf-primary, #667eea);
  }
  
  .highlight-action-btn.drill-btn.active {
    background: var(--sf-primary, #667eea);
    color: white;
  }
  
  .highlight-action-btn.drill-btn.active svg {
    transform: rotate(180deg);
  }

  /* Drilldown Styles */
  .highlight-drilldown {
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px dashed var(--sf-border, #e5e7eb);
    animation: expandDown 0.3s ease;
  }
  
  @keyframes expandDown {
    from { opacity: 0; max-height: 0; }
    to { opacity: 1; max-height: 500px; }
  }
  
  .drilldown-loading {
    text-align: center;
    padding: 1rem;
    color: var(--sf-text-muted);
    font-size: 0.85rem;
  }
  
  .drilldown-content {
    font-size: 0.85rem;
  }
  
  .drilldown-level {
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    border-radius: 6px;
    background: rgba(0,0,0,0.03);
  }
  
  .drilldown-level-header {
    font-weight: 600;
    font-size: 0.75rem;
    color: var(--sf-text-muted);
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
  }
  
  .drilldown-level-header:hover {
    color: var(--sf-primary);
  }
  
  .drilldown-level-content {
    color: var(--sf-text);
    line-height: 1.5;
  }
  
  .drilldown-level.collapsed .drilldown-level-content {
    display: none;
  }
  
  .drilldown-transcript {
    max-height: 200px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 0.8rem;
    white-space: pre-wrap;
    background: var(--sf-surface, #f9fafb);
    padding: 0.75rem;
    border-radius: 4px;
    border: 1px solid var(--sf-border);
  }

  /* Responsive Dashboard */
  .dashboard {
    max-width: 100%;
    margin: 0 auto;
    padding: 0 1rem 120px 1rem;
    transition: max-width 0.3s ease;
  }
  
  .dashboard.compact {
    max-width: 1600px;
  }

  .dashboard-header {
    margin-bottom: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .dashboard-header h1 {
    font-size: 1.75rem;
    color: var(--sf-text) !important;
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .dashboard-header p {
    color: var(--sf-text-muted, #7f8c8d);
    font-size: 1rem;
    margin: 0;
  }

  /* AI Quick Actions */
  .quick-actions {
    background: none;
    border: none;
    border-radius: 0;
    padding: 0.75rem 1rem;
    margin-bottom: 1.5rem;
    color: var(--sf-text);
  }

  .quick-actions-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .quick-actions-header h2 {
    font-size: 1.1rem;
    color: var(--sf-text);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .chips-container {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .chip {
    background: transparent;
    border: 1px solid var(--sf-border);
    color: var(--sf-text);
    padding: 0.6rem 1.1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .chip:hover {
    background: var(--sf-surface);
    transform: translateY(-1px);
    border-color: var(--sf-primary);
  }

  .chip.active {
    background: var(--sf-primary);
    color: white;
    border-color: var(--sf-primary);
  }

  .chip svg {
    width: 16px;
    height: 16px;
  }

  .custom-query {
    display: flex;
    gap: 0.5rem;
  }

  .custom-query input {
    flex: 1;
    padding: 0.85rem 1.1rem;
    border: 1px solid var(--sf-border);
    border-radius: 10px;
    font-size: 0.95rem;
    background: var(--sf-surface);
    color: var(--sf-text);
  }

  .custom-query input:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    border-color: var(--sf-primary);
  }

  .custom-query button {
    padding: 0.85rem 1.5rem;
    background: var(--sf-primary);
    border: 1px solid var(--sf-primary);
    color: white;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
  }

  .custom-query button:hover {
    opacity: 0.9;
  }

  /* Dark mode: Quick Actions - no background */
  [data-theme="dark"] .quick-actions {
    background: none;
    border: none;
  }

  /* AI Response Card */
  .ai-response {
    background: var(--sf-card-bg, white);
    border-radius: 12px;
    padding: 1.25rem;
    margin-top: 1rem;
    display: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  [data-theme="dark"] .ai-response {
    background: #1a2234 !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }

  .ai-response.visible {
    display: block;
    animation: fadeIn 0.3s ease;
  }

  .ai-response-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .ai-response-header h4 {
    color: var(--sf-primary, #667eea);
    font-size: 0.9rem;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .ai-response-close {
    background: none;
    border: none;
    color: var(--sf-text-muted, #aaa);
    cursor: pointer;
    padding: 0.25rem;
    font-size: 1.1rem;
  }

  .ai-response-content {
    color: var(--sf-text, #333);
    line-height: 1.7;
    font-size: 0.95rem;
  }

  .ai-update-item {
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--sf-border, #f0f0f0);
  }

  .ai-update-item:last-child {
    border-bottom: none;
  }

  .ai-update-text {
    margin-bottom: 0.75rem;
  }

  .ai-update-text ol,
  .ai-update-text ul {
    padding-left: 1.5rem;
    margin: 0.5rem 0;
  }

  .ai-update-text ol li,
  .ai-update-text ul li {
    margin-bottom: 0.4rem;
    line-height: 1.5;
  }

  .ai-update-text p {
    margin: 0.5rem 0;
  }

  .ai-update-text h1, .ai-update-text h2, .ai-update-text h3, .ai-update-text h4 {
    margin: 0.75rem 0 0.5rem 0;
    font-size: 1rem;
    font-weight: 600;
  }

  /* Clickable reference citations */
  .ai-reference {
    display: inline-block;
    background: #e0e7ff;
    color: #4338ca;
    padding: 0.1rem 0.4rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    position: relative;
    margin: 0 0.1rem;
    transition: all 0.2s;
  }

  .ai-reference:hover {
    background: #4338ca;
    color: white;
  }

  .ai-reference-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #1f2937;
    color: white;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    font-size: 0.75rem;
    white-space: nowrap;
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
    margin-bottom: 4px;
  }

  .ai-reference:hover .ai-reference-tooltip {
    opacity: 1;
  }

  .ai-update-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  
  /* AI Response Action Buttons */
  .ai-response-actions {
    display: none;
  }
  
  .ai-action-btn {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid;
  }
  
  .ai-action-btn svg {
    width: 16px;
    height: 16px;
  }
  
  .ai-action-btn.approve {
    background: #d1fae5;
    border-color: #10b981;
    color: #059669;
  }
  
  .ai-action-btn.approve:hover {
    background: #10b981;
    color: white;
  }
  
  .ai-action-btn.archive {
    background: #f3e8ff;
    border-color: #a855f7;
    color: #9333ea;
  }
  
  .ai-action-btn.archive:hover {
    background: #a855f7;
    color: white;
  }
  
  .ai-action-btn.reject {
    background: #fee2e2;
    border-color: #ef4444;
    color: #dc2626;
  }
  
  .ai-action-btn.reject:hover {
    background: #ef4444;
    color: white;
  }
  
  .ai-action-btn.action {
    background: #dbeafe;
    border-color: #3b82f6;
    color: #2563eb;
  }
  
  .ai-action-btn.action:hover {
    background: #3b82f6;
    color: white;
  }
  
  .ai-action-btn.waiting {
    background: #fef3c7;
    border-color: #f59e0b;
    color: #d97706;
  }
  
  .ai-action-btn.waiting:hover {
    background: #f59e0b;
    color: white;
  }
  
  .ai-action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  /* Markdown rendering in AI response */
  .ai-response-content h1, .ai-response-content h2, .ai-response-content h3 {
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #1f2937;
  }
  
  .ai-response-content ul, .ai-response-content ol {
    margin: 0.5rem 0;
    padding-left: 1.5rem;
  }
  
  .ai-response-content li {
    margin-bottom: 0.25rem;
  }
  
  .ai-response-content code {
    background: #f3f4f6;
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.875em;
  }
  
  .ai-response-content pre {
    background: #1f2937;
    color: #e5e7eb;
    padding: 1rem;
    border-radius: 8px;
    overflow-x: auto;
    margin: 0.75rem 0;
  }
  
  .ai-response-content pre code {
    background: none;
    padding: 0;
    color: inherit;
  }

  .ai-response-loading {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: #666;
  }

  .spinner {
    width: 20px;
    height: 20px;
    border: 2px solid #eee;
    border-top-color: #667eea;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Stats Grid - Responsive */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .stat-card {
    background: var(--sf-card-bg, white);
    border-radius: 12px;
    padding: 1.25rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    text-align: center;
    transition: transform 0.2s, box-shadow 0.2s;
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .stat-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 0.75rem;
    font-size: 1.25rem;
  }

  .stat-icon.blue { background: #e8f4fc; }
  .stat-icon.green { background: #e8f8f0; }
  .stat-icon.purple { background: #f0e8fc; }
  .stat-icon.orange { background: #fef3e8; }

  .stat-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--sf-text) !important;
    line-height: 1;
    margin-bottom: 0.25rem;
  }

  .stat-label {
    font-size: 0.85rem;
    color: var(--sf-text-muted, #7f8c8d);
  }

  /* Main Grid - Responsive for wide monitors */
  .main-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }
  
  .main-grid.three-col {
    grid-template-columns: repeat(3, 1fr);
  }

  .section-card {
    background: var(--sf-card-bg, white);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    overflow: hidden;
  }
  
  .section-card.full-width {
    grid-column: 1 / -1;
  }

  .section-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--sf-border, #f0f0f0);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .section-header h3 {
    font-size: 1rem;
    color: var(--sf-text, #2c3e50);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .section-header a {
    font-size: 0.85rem;
    color: #3498db;
    text-decoration: none;
  }

  .section-header a:hover {
    text-decoration: underline;
  }

  .section-content {
    padding: 0.75rem;
    max-height: 400px;
    overflow-y: auto;
  }

  /* Signal Items with Thumbs */
  .signal-item {
    padding: 0.75rem;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    transition: background 0.2s;
    display: flex;
    gap: 0.75rem;
    align-items: flex-start;
    border: 1px solid transparent;
  }

  .signal-item:hover {
    background: var(--sf-surface, #f8f9fa);
    border-color: var(--sf-border, #e5e7eb);
  }

  .signal-icon {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.85rem;
    flex-shrink: 0;
  }

  .signal-icon.decision { background: #dbeafe; color: #2563eb; }
  .signal-icon.action { background: #fef3c7; color: #d97706; }
  .signal-icon.blocker { background: #fee2e2; color: #dc2626; }
  .signal-icon.idea { background: #d1fae5; color: #059669; }
  .signal-icon.risk { background: #fce7f3; color: #db2777; }
  .signal-icon.mention { background: #e0e7ff; color: #4f46e5; }
  .signal-icon.announcement { background: #f3e8ff; color: #7c3aed; }

  .signal-body {
    flex: 1;
    min-width: 0;
  }

  .signal-text {
    font-size: 0.9rem;
    color: var(--sf-text, #374151);
    line-height: 1.5;
  }
  
  .signal-text strong { font-weight: 600; }
  .signal-text em { font-style: italic; }
  .signal-text code {
    background: var(--sf-surface, #f3f4f6);
    padding: 0.1rem 0.3rem;
    border-radius: 3px;
    font-family: monospace;
    font-size: 0.85em;
  }

  .signal-source {
    font-size: 0.75rem;
    color: var(--sf-text-muted, #9ca3af);
    margin-top: 0.25rem;
  }

  .signal-actions {
    display: flex;
    gap: 0.25rem;
    flex-shrink: 0;
    opacity: 0;
    transition: opacity 0.2s;
  }
  
  .signal-item:hover .signal-actions {
    opacity: 1;
  }

  .thumb-btn {
    background: none;
    border: 1px solid var(--sf-border, #e5e7eb);
    border-radius: 6px;
    padding: 0.35rem;
    cursor: pointer;
    color: var(--sf-text-muted, #9ca3af);
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .thumb-btn:hover {
    background: var(--sf-surface, #f3f4f6);
  }

  .thumb-btn.up:hover, .thumb-btn.up.active {
    background: #d1fae5;
    border-color: #10b981;
    color: #10b981;
  }

  .thumb-btn.down:hover, .thumb-btn.down.active {
    background: #fee2e2;
    border-color: #ef4444;
    color: #ef4444;
  }
  
  .thumb-btn.archive:hover, .thumb-btn.archive.active {
    background: #f3f4f6;
    border-color: #6b7280;
    color: #6b7280;
  }
  
  .thumb-btn.ticket:hover {
    background: #dbeafe;
    border-color: #3b82f6;
    color: #3b82f6;
  }
  
  .thumb-btn svg {
    width: 14px;
    height: 14px;
  }
  
  /* Signal status badges */
  .signal-status-badge {
    font-size: 0.65rem;
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    text-transform: uppercase;
    font-weight: 600;
    margin-left: 0.5rem;
  }
  
  .signal-status-badge.approved {
    background: #d1fae5;
    color: #059669;
  }
  
  .signal-status-badge.rejected {
    background: #fee2e2;
    color: #dc2626;
  }
  
  .signal-status-badge.archived {
    background: #f3f4f6;
    color: #6b7280;
  }
  
  .signal-status-badge.completed {
    background: #dbeafe;
    color: #2563eb;
  }

  .signal-status-badge.waiting {
    background: #fef3c7;
    color: #d97706;
  }
  
  .signal-item.status-rejected {
    opacity: 0.5;
  }
  
  .signal-item.status-archived {
    opacity: 0.6;
  }

  /* Color coding for validated signals */
  .signal-item.status-approved {
    background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
    border-left: 3px solid #10b981;
  }
  
  .signal-item.status-completed {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border-left: 3px solid #3b82f6;
  }
  
  [data-theme="dark"] .signal-item.status-approved {
    background: linear-gradient(135deg, #1a3329 0%, #0f2620 100%) !important;
    border-left: 3px solid #10b981;
  }
  
  [data-theme="dark"] .signal-item.status-completed {
    background: linear-gradient(135deg, #1a2633 0%, #0f1a26 100%) !important;
    border-left: 3px solid #3b82f6;
  }

  /* Status indicator below actions */
  .signal-status-indicator {
    grid-column: 1 / -1;
    padding: 0.5rem 1rem;
    border-top: 1px solid var(--sf-border, #e5e7eb);
    margin-top: 0.5rem;
    font-size: 0.75rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .signal-status-indicator.approved {
    color: #059669;
    background: rgba(16, 185, 129, 0.1);
  }
  
  .signal-status-indicator.rejected {
    color: #dc2626;
    background: rgba(220, 38, 38, 0.1);
  }
  
  .signal-status-indicator.archived {
    color: #6b7280;
    background: rgba(107, 114, 128, 0.1);
  }
  
  .signal-status-indicator.completed {
    color: #2563eb;
    background: rgba(37, 99, 235, 0.1);
  }
  
  .signal-status-indicator.waiting {
    color: #d97706;
    background: rgba(217, 119, 6, 0.1);
  }

  /* Markdown in highlight-text */
  .highlight-text p {
    margin: 0 0 0.5rem 0;
  }
  .highlight-text p:last-child {
    margin-bottom: 0;
  }
  .highlight-text code {
    background: rgba(0,0,0,0.1);
    padding: 0.1rem 0.3rem;
    border-radius: 3px;
    font-size: 0.85em;
  }
  .highlight-text ul, .highlight-text ol {
    margin: 0.25rem 0;
    padding-left: 1.25rem;
  }
  .highlight-text strong {
    font-weight: 600;
  }
  [data-theme="dark"] .highlight-text code {
    background: rgba(255,255,255,0.15);
  }

  .empty-section {
    padding: 2rem;
    text-align: center;
    color: #9ca3af;
    font-size: 0.9rem;
  }

  /* Activity Items */
  .activity-item {
    padding: 0.75rem 1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    border-bottom: 1px solid #f5f5f5;
    transition: background 0.2s;
  }

  .activity-item:last-child {
    border-bottom: none;
  }

  .activity-item:hover {
    background: #f8f9fa;
  }

  .activity-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    flex-shrink: 0;
  }

  .activity-icon.meeting { background: #e8f4fc; }
  .activity-icon.doc { background: #e8f8f0; }

  .activity-info {
    flex: 1;
    min-width: 0;
  }

  .activity-title {
    font-size: 0.9rem;
    color: #333;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .activity-meta {
    font-size: 0.8rem;
    color: #999;
  }

  .activity-link {
    color: #3498db;
    text-decoration: none;
    font-size: 0.85rem;
  }

  .activity-link:hover {
    text-decoration: underline;
  }

  /* Overview Highlights */
  .highlight-item {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 0.75rem;
  }
  
  .highlight-item.blocker {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
  }
  
  .highlight-item.proposal {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
  }
  
  .highlight-item.mention {
    background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
  }
  
  .highlight-item.announcement {
    background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
  }

  .highlight-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    font-weight: 600;
    margin-bottom: 0.25rem;
    opacity: 0.7;
  }

  .highlight-text {
    font-size: 0.9rem;
    line-height: 1.4;
    color: #1e293b; /* Dark text for readability on colored backgrounds */
  }

  /* Dark mode overrides for highlight items */
  [data-theme="dark"] .highlight-item {
    background: linear-gradient(135deg, #4a3728 0%, #3d2d1f 100%) !important;
  }
  [data-theme="dark"] .highlight-item.blocker {
    background: linear-gradient(135deg, #4a2828 0%, #3d1f1f 100%) !important;
  }
  [data-theme="dark"] .highlight-item.proposal {
    background: linear-gradient(135deg, #283a4a 0%, #1f2d3d 100%) !important;
  }
  [data-theme="dark"] .highlight-item.mention {
    background: linear-gradient(135deg, #2d3348 0%, #232838 100%) !important;
  }
  [data-theme="dark"] .highlight-item.announcement {
    background: linear-gradient(135deg, #3d2d48 0%, #2d2338 100%) !important;
  }
  [data-theme="dark"] .highlight-text,
  [data-theme="dark"] .highlight-label,
  [data-theme="dark"] .highlight-source {
    color: #faf6f1 !important;
  }
  [data-theme="dark"] .drilldown-content,
  [data-theme="dark"] .drilldown-level-header,
  [data-theme="dark"] .drilldown-level-content {
    color: #faf6f1 !important;
    background: #2d2d2d !important;
  }

  /* Dark mode for activity items and tickets */
  [data-theme="dark"] .activity-item,
  [data-theme="dark"] .signal-item {
    border-color: #4a4a4a !important;
  }
  [data-theme="dark"] .activity-title,
  [data-theme="dark"] .activity-meta,
  [data-theme="dark"] .activity-link,
  [data-theme="dark"] .signal-text,
  [data-theme="dark"] .signal-source {
    color: #faf6f1 !important;
  }
  [data-theme="dark"] .activity-meta,
  [data-theme="dark"] .signal-source {
    color: #a0a0a0 !important;
  }
  [data-theme="dark"] .ticket-id-badge {
    background: #3a3a3a !important;
    color: #c9b99a !important;
  }
  [data-theme="dark"] .stat-label {
    color: #c9b99a !important;
  }
  [data-theme="dark"] .stat-value {
    color: #faf6f1 !important;
  }
  [data-theme="dark"] .empty-section {
    color: #a0a0a0 !important;
  }

  /* Light borders on panel objects for visibility */
  .signal-item,
  .activity-item {
    border: 1px solid var(--sf-border, #e5e7eb);
    border-radius: 8px;
    margin-bottom: 0.5rem;
    padding: 0.75rem !important;
  }
  [data-theme="dark"] .signal-item,
  [data-theme="dark"] .activity-item {
    border-color: #4a4a4a !important;
  }

  /* Standup and code locker item borders */
  #standupDisplay > div,
  #codeLockerFiles > div:not(.empty-section) {
    border: 1px solid var(--sf-border, #e5e7eb);
    border-radius: 8px;
    margin-bottom: 0.5rem;
    padding: 0.75rem;
  }
  [data-theme="dark"] #standupDisplay > div,
  [data-theme="dark"] #codeLockerFiles > div:not(.empty-section) {
    border-color: #4a4a4a !important;
  }

  .highlight-source {
    font-size: 0.75rem;
    margin-top: 0.5rem;
    opacity: 0.7;
  }

  /* Form Select Fixes - Larger dropdowns */
  select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.75rem center;
    background-repeat: no-repeat;
    background-size: 1.25em 1.25em;
    padding-right: 2.5rem;
    min-height: 44px;
    font-size: 1rem !important;
  }

  /* Responsive */
  @media (max-width: 900px) {
    .main-grid {
      grid-template-columns: 1fr;
    }
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 600px) {
    .stats-grid {
      grid-template-columns: 1fr;
    }
    .chips-container {
      overflow-x: auto;
      flex-wrap: nowrap;
      padding-bottom: 0.5rem;
    }
    .chip {
      flex-shrink: 0;
    }
  }

  /* DIKW Pyramid Styles */
  .dikw-pyramid-section {
    background: var(--sf-card-bg, white);
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  }

  .dikw-item {
    background: rgba(255,255,255,0.9);
    border-radius: 8px;
    padding: 0.5rem 0.75rem;
    font-size: 0.8rem;
    color: #1f2937;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
  }

  .dikw-item:hover {
    background: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .dikw-item-text {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .dikw-item-actions {
    display: none;
    position: absolute;
    top: 0.25rem;
    right: 0.25rem;
    gap: 0.25rem;
  }

  .dikw-item:hover .dikw-item-actions {
    display: flex;
  }

  .dikw-action-btn {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: none;
    background: rgba(0,0,0,0.1);
    color: #1f2937;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    transition: all 0.2s;
  }

  .dikw-action-btn:hover {
    background: rgba(0,0,0,0.2);
  }

  .dikw-action-btn.promote:hover {
    background: #3b82f6;
    color: white;
  }

  .dikw-action-btn.validate:hover {
    background: #22c55e;
    color: white;
  }

  .dikw-empty {
    color: rgba(255,255,255,0.6);
    font-size: 0.75rem;
    text-align: center;
    padding: 1rem;
  }

  .thumb-btn.dikw-promote {
    background: linear-gradient(135deg, #8b5cf6, #3b82f6);
    color: white;
  }

  .thumb-btn.dikw-promote:hover {
    background: linear-gradient(135deg, #7c3aed, #2563eb);
  }

  /* DIKW Promote Menu */
  .dikw-promote-menu {
    position: absolute;
    bottom: 100%;
    right: 0;
    background: var(--sf-card-bg, white);
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    padding: 0.5rem;
    z-index: 100;
    min-width: 150px;
    display: none;
  }

  .dikw-promote-menu.open {
    display: block;
  }

  .dikw-promote-option {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    color: var(--sf-text, inherit);
    transition: background 0.2s;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
  }

  .dikw-promote-option:hover {
    background: var(--sf-surface, #f3f4f6);
  }

  .dikw-promote-option .level-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .dikw-promote-option .level-dot.data { background: #64748b; }
  .dikw-promote-option .level-dot.information { background: #22c55e; }
  .dikw-promote-option .level-dot.knowledge { background: #3b82f6; }
  .dikw-promote-option .level-dot.wisdom { background: #8b5cf6; }

  /* Career Hub Styles */
  .career-hub-section {
    background: var(--sf-card-bg, white);
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  }

  .career-hub-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
  }

  @media (max-width: 900px) {
    .career-hub-grid {
      grid-template-columns: 1fr;
    }
  }

  .standup-btn {
    background: var(--sf-surface, #f3f4f6);
    border: 1px solid var(--sf-border, #e5e7eb);
    padding: 0.5rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
  }

  .standup-btn:hover {
    background: var(--sf-border, #e5e7eb);
  }

  .standup-btn.primary {
    background: var(--sf-primary, #667eea);
    color: white;
    border-color: var(--sf-primary, #667eea);
  }

  .standup-btn.primary:hover {
    background: #5a67d8;
  }

  .standup-item {
    padding: 0.75rem;
    border-radius: 8px;
    background: var(--sf-surface, #f9fafb);
    margin-bottom: 0.5rem;
  }

  .standup-item .date {
    font-size: 0.75rem;
    color: var(--sf-text-muted);
    margin-bottom: 0.25rem;
  }

  .standup-item .content {
    font-size: 0.85rem;
    color: var(--sf-text);
    line-height: 1.5;
  }

  .standup-item .sentiment {
    display: inline-block;
    padding: 0.125rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 500;
    margin-left: 0.5rem;
  }

  .standup-item .sentiment.positive { background: #d1fae5; color: #059669; }
  .standup-item .sentiment.neutral { background: #e0e7ff; color: #4f46e5; }
  .standup-item .sentiment.blocked { background: #fee2e2; color: #dc2626; }
  .standup-item .sentiment.struggling { background: #fef3c7; color: #d97706; }

  .standup-feedback {
    margin-top: 0.75rem;
    padding: 0.75rem;
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border-radius: 8px;
    border-left: 3px solid #0ea5e9;
    font-size: 0.85rem;
    color: #0369a1;
    line-height: 1.5;
  }

  .code-file-item {
    padding: 0.75rem;
    border-radius: 8px;
    background: var(--sf-surface, #f9fafb);
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
  }

  .code-file-item .file-info {
    flex: 1;
    min-width: 0;
  }

  .code-file-item .filename {
    font-family: monospace;
    font-size: 0.85rem;
    color: var(--sf-text);
    font-weight: 500;
  }

  .code-file-item .file-meta {
    font-size: 0.75rem;
    color: var(--sf-text-muted);
    display: flex;
    gap: 0.75rem;
    margin-top: 0.25rem;
  }

  .code-file-item .version-badge {
    background: var(--sf-primary, #667eea);
    color: white;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 600;
  }

  .code-file-actions {
    display: flex;
    gap: 0.25rem;
  }

  .code-file-actions button {
    background: none;
    border: none;
    padding: 0.25rem 0.5rem;
    cursor: pointer;
    font-size: 0.9rem;
    opacity: 0.6;
    transition: opacity 0.2s;
  }

  .code-file-actions button:hover {
    opacity: 1;
  }

  /* Ticket file selection hover */
  .ticket-file-option:hover {
    background: var(--sf-surface, #f9fafb);
  }
  
  .ticket-file-option:last-child {
    border-bottom: none;
  }

</style>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<div class="dashboard compact" id="dashboard" data-sprint-key="{% if sprint %}{{ sprint.name or 'Current Sprint' }}|{{ sprint.sprint_start_date }}|{{ sprint.sprint_length_days }}{% else %}no-sprint{% endif %}">
  <div class="dashboard-header">
    <div>
      <h1>ü™∑ Good {{ time_of_day }}, {{ greeting_context }}!</h1>
      <p>{{ today_formatted }} ¬∑ Hare Krishna</p>
    </div>
  </div>

  {% if sprint %}
  <!-- Sprint Progress Banner -->
  <div class="sprint-banner" style="background: linear-gradient(135deg, #a0522d 0%, #cd5c5c 100%); border-radius: 16px; padding: 1.25rem 1.5rem; margin-bottom: 1.5rem; color: white; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
    <div style="display: flex; align-items: center; gap: 1rem;">
      <div style="background: rgba(255,255,255,0.2); border-radius: 12px; padding: 0.75rem 1rem; text-align: center;">
        <div style="font-size: 1.75rem; font-weight: 700; line-height: 1;">{{ sprint.working_days_elapsed }}</div>
        <div style="font-size: 0.7rem; opacity: 0.9;">of {{ sprint.total_working_days }}</div>
      </div>
      <div>
        <div style="font-weight: 600; font-size: 1rem;">{{ sprint.name or 'Current Sprint' }}</div>
        <div style="font-size: 0.85rem; opacity: 0.9;">{{ sprint.working_days_remaining }} working day{{ 's' if sprint.working_days_remaining != 1 else '' }} remaining</div>
      </div>
    </div>
    <div style="flex: 1; min-width: 200px; max-width: 400px;">
      <div style="background: rgba(255,255,255,0.2); border-radius: 4px; height: 8px; overflow: hidden;">
        <div style="background: white; height: 100%; width: {{ sprint.progress }}%; transition: width 0.5s;"></div>
      </div>
    </div>
    <a href="/settings/sprint" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 0.5rem 1rem; border-radius: 8px; text-decoration: none; font-size: 0.85rem;">Settings</a>
  </div>
  {% else %}
  <a href="/settings/sprint" class="sprint-banner" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%); border-radius: 16px; padding: 1.25rem 1.5rem; margin-bottom: 1.5rem; color: white; display: flex; align-items: center; justify-content: space-between; text-decoration: none;">
    <div style="display: flex; align-items: center; gap: 0.75rem;">
      <span style="font-size: 1.5rem;">üìÖ</span>
      <div>
        <div style="font-weight: 600;">Set up your sprint</div>
        <div style="font-size: 0.85rem; opacity: 0.9;">Track your sprint progress</div>
      </div>
    </div>
    <span style="background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.85rem;">Configure ‚Üí</span>
  </a>
  {% endif %}

  <!-- Workflow Mode Panel -->
  <div class="workflow-panel" id="workflowPanel">
    <div class="workflow-panel-header">
      <div class="workflow-panel-title">
        <span id="workflowModeIcon">üéØ</span>
        <span id="workflowModeTitle">Current Workflow</span>
      </div>
      <div class="workflow-panel-actions">
        <button class="workflow-btn" onclick="toggleWorkflowPanel()">Collapse</button>
        <button class="workflow-btn" onclick="previousWorkflow()">‚Üê Prev</button>
        <button class="workflow-btn primary" onclick="advanceWorkflow()">Next ‚Üí</button>
      </div>
    </div>
    <div class="workflow-panel-content" id="workflowContent">
      <!-- Mode A: Context Distillation -->
      <div class="workflow-mode-content" data-mode="mode-a" style="display: none;">
        <ul class="workflow-checklist">
          <li class="workflow-checklist-item">
            <div class="workflow-checkbox" onclick="toggleCheckbox(this)"></div>
            <div class="workflow-checklist-content">
              <div class="workflow-checklist-title">Select 12‚Äì16 canonical files</div>
              <div class="workflow-checklist-desc">Choose the most relevant files from the repo snapshot</div>
            </div>
          </li>
          <li class="workflow-checklist-item">
            <div class="workflow-checkbox" onclick="toggleCheckbox(this)"></div>
            <div class="workflow-checklist-content">
              <div class="workflow-checklist-title">Zip + freeze context</div>
              <div class="workflow-checklist-desc">Create immutable context packet for this sprint</div>
            </div>
          </li>
          <li class="workflow-checklist-item">
            <div class="workflow-checkbox" onclick="toggleCheckbox(this)"></div>
            <div class="workflow-checklist-content">
              <div class="workflow-checklist-title">Seed PM / architect agents</div>
              <div class="workflow-checklist-desc">Initialize agents with canonical context</div>
            </div>
          </li>
          <li class="workflow-checklist-item">
            <div class="workflow-checkbox" onclick="toggleCheckbox(this)"></div>
            <div class="workflow-checklist-content">
              <div class="workflow-checklist-title">Load governing neurons (truths)</div>
              <div class="workflow-checklist-desc">Establish constraints and boundaries</div>
            </div>
          </li>
        </ul>
        <div class="workflow-progress">
          <div class="workflow-progress-bar"><div class="workflow-progress-fill" style="width: 0%;"></div></div>
          <span class="workflow-progress-text">0 of 4 complete</span>
        </div>
      </div>

      <!-- Mode B: Implementation Planning -->
      <div class="workflow-mode-content" data-mode="mode-b" style="display: none;">
        <ul class="workflow-checklist">
          <li class="workflow-checklist-item">
            <div class="workflow-checkbox" onclick="toggleCheckbox(this)"></div>
            <div class="workflow-checklist-content">
              <div class="workflow-checklist-title">Review canonical context only</div>
              <div class="workflow-checklist-desc">No repo-wide assumptions allowed</div>
            </div>
          </li>
          <li class="workflow-checklist-item">
            <div class="workflow-checkbox" onclick="toggleCheckbox(this)"></div>
            <div class="workflow-checklist-content">
              <div class="workflow-checklist-title">Define implementation scope</div>
              <div class="workflow-checklist-desc">No speculative scope expansion</div>
            </div>
          </li>
          <li class="workflow-checklist-item">
            <div class="workflow-checkbox" onclick="toggleCheckbox(this)"></div>
            <div class="workflow-checklist-content">
              <div class="workflow-checklist-title">Create step-by-step plan</div>
              <div class="workflow-checklist-desc">Break down into atomic tasks</div>
            </div>
          </li>
        </ul>
        <div class="workflow-progress">
          <div class="workflow-progress-bar"><div class="workflow-progress-fill" style="width: 0%;"></div></div>
          <span class="workflow-progress-text">0 of 3 complete</span>
        </div>
      </div>

      <!-- Mode C: Assisted Draft Intake -->
      <div class="workflow-mode-content" data-mode="mode-c" style="display: none;">
        <ul class="workflow-checklist">
          <li class="workflow-checklist-item">
            <div class="workflow-checkbox" onclick="toggleCheckbox(this)"></div>
            <div class="workflow-checklist-content">
              <div class="workflow-checklist-title">Generate code drafts</div>
              <div class="workflow-checklist-desc">Junior/architect AI produces initial code</div>
            </div>
          </li>
          <li class="workflow-checklist-item">
            <div class="workflow-checkbox" onclick="toggleCheckbox(this)"></div>
            <div class="workflow-checklist-content">
              <div class="workflow-checklist-title">Create documentation</div>
              <div class="workflow-checklist-desc">Generate docs alongside code</div>
            </div>
          </li>
          <li class="workflow-checklist-item">
            <div class="workflow-checkbox" onclick="toggleCheckbox(this)"></div>
            <div class="workflow-checklist-content">
              <div class="workflow-checklist-title">Write walkthroughs</div>
              <div class="workflow-checklist-desc">Explain implementation decisions</div>
            </div>
          </li>
          <li class="workflow-checklist-item">
            <div class="workflow-checkbox" onclick="toggleCheckbox(this)"></div>
            <div class="workflow-checklist-content">
              <div class="workflow-checklist-title">Buffer to Trello</div>
              <div class="workflow-checklist-desc">Stage in Trello (not system of record)</div>
            </div>
          </li>
        </ul>
        <div class="workflow-progress">
          <div class="workflow-progress-bar"><div class="workflow-progress-fill" style="width: 0%;"></div></div>
          <span class="workflow-progress-text">0 of 4 complete</span>
        </div>
      </div>

      <!-- Mode D: Deep Review & Validation -->
      <div class="workflow-mode-content" data-mode="mode-d" style="display: none;">
        <ul class="workflow-checklist">
          <li class="workflow-checklist-item">
            <div class="workflow-checkbox" onclick="toggleCheckbox(this)"></div>
            <div class="workflow-checklist-content">
              <div class="workflow-checklist-title">Full structured read-through</div>
              <div class="workflow-checklist-desc">Read every line of generated code</div>
            </div>
          </li>
          <li class="workflow-checklist-item">
            <div class="workflow-checkbox" onclick="toggleCheckbox(this)"></div>
            <div class="workflow-checklist-content">
              <div class="workflow-checklist-title">Line-by-line AI explanations</div>
              <div class="workflow-checklist-desc">Get AI walkthroughs of complex sections</div>
            </div>
          </li>
          <li class="workflow-checklist-item">
            <div class="workflow-checkbox" onclick="toggleCheckbox(this)"></div>
            <div class="workflow-checklist-content">
              <div class="workflow-checklist-title">Smoke testing</div>
              <div class="workflow-checklist-desc">Run basic functional tests</div>
            </div>
          </li>
          <li class="workflow-checklist-item">
            <div class="workflow-checkbox" onclick="toggleCheckbox(this)"></div>
            <div class="workflow-checklist-content">
              <div class="workflow-checklist-title">Break & fix learning loops</div>
              <div class="workflow-checklist-desc">Intentionally break, then fix to learn</div>
            </div>
          </li>
        </ul>
        <div class="workflow-progress">
          <div class="workflow-progress-bar"><div class="workflow-progress-fill" style="width: 0%;"></div></div>
          <span class="workflow-progress-text">0 of 4 complete</span>
        </div>
      </div>

      <!-- Mode E: Promotion Readiness -->
      <div class="workflow-mode-content" data-mode="mode-e" style="display: none;">
        <ul class="workflow-checklist">
          <li class="workflow-checklist-item">
            <div class="workflow-checkbox" onclick="toggleCheckbox(this)"></div>
            <div class="workflow-checklist-content">
              <div class="workflow-checklist-title">Apply promotion checklist</div>
              <div class="workflow-checklist-desc">Verify all criteria are met</div>
            </div>
          </li>
          <li class="workflow-checklist-item">
            <div class="workflow-checkbox" onclick="toggleCheckbox(this)"></div>
            <div class="workflow-checklist-content">
              <div class="workflow-checklist-title">Prepare code locker</div>
              <div class="workflow-checklist-desc">Stage finalized code in Trello code locker</div>
            </div>
          </li>
          <li class="workflow-checklist-item">
            <div class="workflow-checkbox" onclick="toggleCheckbox(this)"></div>
            <div class="workflow-checklist-content">
              <div class="workflow-checklist-title">Finalize transfer packet</div>
              <div class="workflow-checklist-desc">Package everything for work machine</div>
            </div>
          </li>
          <li class="workflow-checklist-item">
            <div class="workflow-checkbox" onclick="toggleCheckbox(this)"></div>
            <div class="workflow-checklist-content">
              <div class="workflow-checklist-title">Write narrative/standup notes</div>
              <div class="workflow-checklist-desc">Prepare 1:1s, PRs, standups</div>
            </div>
          </li>
        </ul>
        <div class="workflow-progress">
          <div class="workflow-progress-bar"><div class="workflow-progress-fill" style="width: 0%;"></div></div>
          <span class="workflow-progress-text">0 of 4 complete</span>
        </div>
      </div>

      <!-- Mode F: Controlled Ingress/Egress -->
      <div class="workflow-mode-content" data-mode="mode-f" style="display: none;">
        <!-- Deployment Summary Stats -->
        <div class="deployment-summary-stats" id="modeFDeploySummary" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; margin-bottom: 1rem;">
          <div style="background: linear-gradient(135deg, #f5f5f5 0%, #e5e5e5 100%); border: 1px solid #d4d4d4; border-radius: 8px; padding: 0.75rem; text-align: center;">
            <div id="deployTotal" style="font-size: 1.5rem; font-weight: 700; color: #525252;">‚Äî</div>
            <div style="font-size: 0.75rem; color: #737373;">Total</div>
          </div>
          <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 1px solid #93c5fd; border-radius: 8px; padding: 0.75rem; text-align: center;">
            <div id="deployInProgress" style="font-size: 1.5rem; font-weight: 700; color: #1d4ed8;">‚Äî</div>
            <div style="font-size: 0.75rem; color: #2563eb;">In Progress</div>
          </div>
          <div style="background: linear-gradient(135deg, #fefce8 0%, #fef08a 100%); border: 1px solid #fde047; border-radius: 8px; padding: 0.75rem; text-align: center;">
            <div id="deployPROpen" style="font-size: 1.5rem; font-weight: 700; color: #a16207;">‚Äî</div>
            <div style="font-size: 0.75rem; color: #ca8a04;">PR Open</div>
          </div>
          <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 1px solid #bbf7d0; border-radius: 8px; padding: 0.75rem; text-align: center;">
            <div id="deployComplete" style="font-size: 1.5rem; font-weight: 700; color: #166534;">‚Äî</div>
            <div style="font-size: 0.75rem; color: #15803d;">Deployed</div>
          </div>
        </div>
        
        <!-- Deployable Tickets List -->
        <div id="modeFTicketsList" style="max-height: 400px; overflow-y: auto;">
          <div style="padding: 1rem; text-align: center; color: #6b7280;">
            <div class="spinner" style="margin: 0 auto 0.5rem;"></div>
            Loading deployable tickets...
          </div>
        </div>
        
        <!-- Empty State (shown when no tickets) -->
        <div id="modeFEmptyState" style="display: none; padding: 1.5rem; text-align: center; background: #f9fafb; border-radius: 8px;">
          <div style="font-size: 2rem; margin-bottom: 0.5rem;">üöÄ</div>
          <div style="color: #374151; font-weight: 500; margin-bottom: 0.25rem;">No deployable tickets</div>
          <div style="color: #6b7280; font-size: 0.85rem;">Mark tickets with "Requires Deployment" to track them here</div>
        </div>
      </div>

      <!-- Mode G: Execution (Writing Code) -->
      <div class="workflow-mode-content" data-mode="mode-g" style="display: none;">
        <!-- Global Tasks (Fixed above sprint) -->
        <div class="mode-g-global-tasks" style="margin-bottom: 1rem; padding: 0.75rem; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 1px solid #bbf7d0; border-radius: 8px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <h4 style="margin: 0; font-size: 0.85rem; color: #166534;">üìå Global Tasks</h4>
            <button onclick="toggleGlobalTasksEdit()" style="background: none; border: none; color: #166534; cursor: pointer; font-size: 0.75rem;">‚úèÔ∏è Edit</button>
          </div>
          <ul class="workflow-checklist" id="modeGGlobalTasks" style="margin: 0; padding-left: 0; list-style: none;">
            <!-- Loaded dynamically -->
          </ul>
          <div id="globalTasksEditor" style="display: none; margin-top: 0.5rem;">
            <input type="text" id="newGlobalTaskInput" placeholder="Add a global task..." style="width: 100%; padding: 0.5rem; border: 1px solid #bbf7d0; border-radius: 6px; font-size: 0.85rem;" onkeypress="if(event.key==='Enter') addGlobalTask()">
          </div>
        </div>
        
        <!-- Sprint Jeopardy Warning -->
        <div id="modeGJeopardyWarning" style="display: none; margin-bottom: 0.75rem; padding: 0.75rem; border-radius: 8px; font-size: 0.9rem;">
        </div>
        
        <!-- Sprint Burndown Summary -->
        <div class="sprint-burndown-summary" id="modeGBurndownSummary">
          <div class="burndown-stat total">
            <div class="burndown-stat-value" id="burndownTotal">‚Äî</div>
            <div class="burndown-stat-label">Total Points</div>
          </div>
          <div class="burndown-stat completed">
            <div class="burndown-stat-value" id="burndownCompleted">‚Äî</div>
            <div class="burndown-stat-label">Completed</div>
          </div>
          <div class="burndown-stat in-progress">
            <div class="burndown-stat-value" id="burndownInProgress">‚Äî</div>
            <div class="burndown-stat-label">In Progress</div>
          </div>
          <div class="burndown-stat remaining">
            <div class="burndown-stat-value" id="burndownRemaining">‚Äî</div>
            <div class="burndown-stat-label">Remaining</div>
          </div>
        </div>
        
        <!-- Sprint Tickets List -->
        <div id="modeGTicketsList" style="max-height: 400px; overflow-y: auto;">
          <div style="padding: 1rem; text-align: center; color: #6b7280;">
            <div class="spinner" style="margin: 0 auto 0.5rem;"></div>
            Loading sprint tickets...
          </div>
        </div>
      </div>
      
      <!-- Mode H: Testing Mode - Test Plans Dashboard -->
      <div class="workflow-mode-content" data-mode="mode-h" style="display: none;">
        <!-- Test Summary Stats -->
        <div class="test-summary-stats" id="modeHTestSummary" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; margin-bottom: 1rem;">
          <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 1px solid #bbf7d0; border-radius: 8px; padding: 0.75rem; text-align: center;">
            <div id="testPassed" style="font-size: 1.5rem; font-weight: 700; color: #166534;">‚Äî</div>
            <div style="font-size: 0.75rem; color: #15803d;">Passed</div>
          </div>
          <div style="background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%); border: 1px solid #fca5a5; border-radius: 8px; padding: 0.75rem; text-align: center;">
            <div id="testFailed" style="font-size: 1.5rem; font-weight: 700; color: #b91c1c;">‚Äî</div>
            <div style="font-size: 0.75rem; color: #dc2626;">Failed</div>
          </div>
          <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 1px solid #93c5fd; border-radius: 8px; padding: 0.75rem; text-align: center;">
            <div id="testActive" style="font-size: 1.5rem; font-weight: 700; color: #1d4ed8;">‚Äî</div>
            <div style="font-size: 0.75rem; color: #2563eb;">Active</div>
          </div>
          <div style="background: linear-gradient(135deg, #f5f5f5 0%, #e5e5e5 100%); border: 1px solid #d4d4d4; border-radius: 8px; padding: 0.75rem; text-align: center;">
            <div id="testDraft" style="font-size: 1.5rem; font-weight: 700; color: #525252;">‚Äî</div>
            <div style="font-size: 0.75rem; color: #737373;">Draft</div>
          </div>
        </div>
        
        <!-- Quick Actions -->
        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; padding-right: 60px;">
          <a href="/test-plans/new" style="padding: 0.5rem 1rem; background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white; text-align: center; border-radius: 8px; font-size: 0.85rem; font-weight: 500; text-decoration: none; white-space: nowrap;">
            + New Test Plan
          </a>
          <a href="/test-plans" style="padding: 0.5rem 1rem; background: #f5f5f5; color: #525252; text-align: center; border-radius: 8px; font-size: 0.85rem; font-weight: 500; text-decoration: none; border: 1px solid #e5e5e5; white-space: nowrap;">
            View All
          </a>
        </div>
        
        <!-- Sprint Test Plans List -->
        <div id="modeHTestPlansList" style="max-height: 400px; overflow-y: auto;">
          <div style="padding: 1rem; text-align: center; color: #6b7280;">
            <div class="spinner" style="margin: 0 auto 0.5rem;"></div>
            Loading test plans...
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- DIKW Pyramid Section -->
  <div class="dikw-pyramid-section collapsible-box" data-box-id="dikw" style="margin-bottom: 1.5rem;">
    <div class="quick-actions-header" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleBoxCollapse(this.parentElement)">
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <span class="collapse-icon">‚ñº</span>
        <h2>üî∫ DIKW Pyramid</h2>
      </div>
      <span style="font-size: 0.8rem; color: #6b7280;">Data ‚Üí Information ‚Üí Knowledge ‚Üí Wisdom</span>
    </div>
    <div class="dikw-pyramid collapsible-content" id="dikwPyramid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; padding: 1rem; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; border: 1px solid #e2e8f0;">
      <!-- Data Level (Base) -->
      <div class="dikw-level data" data-level="data" style="background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%); border-radius: 12px; padding: 1rem; min-height: 120px;">
        <div class="dikw-level-header" style="color: white; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center;">
          <span style="font-weight: 600; font-size: 0.9rem;">üì¶ Data</span>
          <span class="dikw-count" id="dataCount" style="background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 10px; font-size: 0.75rem;">0</span>
        </div>
        <div class="dikw-items" id="dataItems" style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 200px; overflow-y: auto;"></div>
      </div>
      
      <!-- Information Level -->
      <div class="dikw-level information" data-level="information" style="background: linear-gradient(135deg, #22c55e 0%, #4ade80 100%); border-radius: 12px; padding: 1rem; min-height: 120px;">
        <div class="dikw-level-header" style="color: white; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center;">
          <span style="font-weight: 600; font-size: 0.9rem;">üìä Information</span>
          <span class="dikw-count" id="informationCount" style="background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 10px; font-size: 0.75rem;">0</span>
        </div>
        <div class="dikw-items" id="informationItems" style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 200px; overflow-y: auto;"></div>
      </div>
      
      <!-- Knowledge Level -->
      <div class="dikw-level knowledge" data-level="knowledge" style="background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); border-radius: 12px; padding: 1rem; min-height: 120px;">
        <div class="dikw-level-header" style="color: white; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center;">
          <span style="font-weight: 600; font-size: 0.9rem;">üìö Knowledge</span>
          <span class="dikw-count" id="knowledgeCount" style="background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 10px; font-size: 0.75rem;">0</span>
        </div>
        <div class="dikw-items" id="knowledgeItems" style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 200px; overflow-y: auto;"></div>
      </div>
      
      <!-- Wisdom Level (Top) -->
      <div class="dikw-level wisdom" data-level="wisdom" style="background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); border-radius: 12px; padding: 1rem; min-height: 120px;">
        <div class="dikw-level-header" style="color: white; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center;">
          <span style="font-weight: 600; font-size: 0.9rem;">ü™∑ Wisdom</span>
          <span class="dikw-count" id="wisdomCount" style="background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 10px; font-size: 0.75rem;">0</span>
        </div>
        <div class="dikw-items" id="wisdomItems" style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 200px; overflow-y: auto;"></div>
      </div>
    </div>
  </div>

  <!-- AI Quick Actions -->
  <div class="quick-actions">
    <div class="quick-actions-header">
      <h2>‚ú® Quick AI Updates</h2>
    </div>
    <div class="chips-container">
      <button class="chip" onclick="askAI('blockers')">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        Blockers
      </button>
      <button class="chip" onclick="askAI('decisions')">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        Decisions
      </button>
      <button class="chip" onclick="askAI('action_items')">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
        </svg>
        Action Items
      </button>
      <button class="chip" onclick="askAI('ideas')">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
        </svg>
        Ideas
      </button>
      <button class="chip" onclick="askAI('risks')">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
        </svg>
        Risks
      </button>
      <button class="chip" onclick="askAI('rowan_mentions')">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
        @{{ env.USER_NAME }}
      </button>
      <button class="chip" onclick="askAI('reach_outs')">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
        </svg>
        Reach Outs
      </button>
      <button class="chip" onclick="askAI('announcements')">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" />
        </svg>
        Announcements
      </button>
    </div>
    <div class="custom-query">
      <input type="text" id="customQuery" placeholder="Ask anything about your memory..." onkeypress="if(event.key==='Enter')askCustom()">
      <button onclick="askCustom()">Ask AI</button>
    </div>
    <div class="ai-response" id="aiResponse">
      <div class="ai-response-header">
        <h4>‚ú® AI Response</h4>
        <button class="ai-response-close" onclick="closeAIResponse()">‚úï</button>
      </div>
      <div class="ai-response-content" id="aiResponseContent"></div>
      <div class="ai-feedback" id="aiResponseFeedback" style="display: none;"></div>
    </div>
  </div>

  {% include 'components/feedback_buttons.html' %}


  <!-- Stats Grid -->
  <div class="stats-grid">
    <a href="/meetings" class="stat-card">
      <div class="stat-icon blue">üìÖ</div>
      <div class="stat-value">{{ stats.meetings }}</div>
      <div class="stat-label">Meetings</div>
    </a>
    <a href="/documents" class="stat-card">
      <div class="stat-icon green">üìÑ</div>
      <div class="stat-value">{{ stats.documents }}</div>
      <div class="stat-label">Documents</div>
    </a>
    <a href="/tickets" class="stat-card">
      <div class="stat-icon" style="background: #fef3e8;">üé´</div>
      <div class="stat-value">{{ stats.tickets or 0 }}</div>
      <div class="stat-label">Active Tickets</div>
    </a>
    <a href="/signals" class="stat-card">
      <div class="stat-icon purple">üìä</div>
      <div class="stat-value">{{ stats.signals }}</div>
      <div class="stat-label">Signals</div>
    </a>
    <a href="/chat" class="stat-card">
      <div class="stat-icon orange">üí¨</div>
      <div class="stat-value">{{ stats.conversations }}</div>
      <div class="stat-label">Chats</div>
    </a>
  </div>

  <!-- Coaching Highlights Section -->
  <div class="section-card full-width collapsible-box" data-box-id="attention" style="margin-bottom: 1.5rem;" id="attentionSection">
    <div class="section-header" style="cursor: pointer;" onclick="toggleBoxCollapse(this.parentElement)">
      <div style="display: flex; align-items: center; gap: 0.75rem;">
        <span class="collapse-icon">‚ñº</span>
        <h3>üéØ Your Coach</h3>
        <span class="attention-badge" id="attentionCount" style="opacity: 0.6;">...</span>
      </div>
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <span class="refresh-info" id="refreshInfo" style="font-size: 0.75rem; color: var(--sf-text-muted);">Click items to take action</span>
        <button class="refresh-btn" onclick="event.stopPropagation(); refreshAttention()" title="Check for new suggestions">
          <svg id="refreshIcon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
        </button>
        <button class="toggle-seen-btn" onclick="event.stopPropagation(); toggleSeenItems()" title="Reset dismissed items">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          <span id="seenToggleText">Reset</span>
        </button>
      </div>
    </div>
    <div class="section-content collapsible-content" id="attentionContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 0.75rem; padding: 1rem;">
      <div class="empty-attention" style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--sf-text-muted);">
        <p style="font-size: 1rem; margin-bottom: 0.5rem;">Loading coaching suggestions...</p>
      </div>
    </div>
  </div>

  <!-- Main Grid -->
  <div class="main-grid">
    <!-- Recent Signals with Thumbs -->
    <div class="section-card collapsible-box" data-box-id="signals">
      <div class="section-header" style="cursor: pointer;" onclick="toggleBoxCollapse(this.parentElement)">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <span class="collapse-icon">‚ñº</span>
          <h3>üéØ Recent Signals</h3>
          <div class="signal-legend" style="display: flex; gap: 0.6rem; margin-left: 0.75rem; font-size: 0.65rem; color: var(--sf-text-muted, #9ca3af);">
            <span title="Decisions made" style="display: flex; align-items: center; gap: 0.2rem;"><span style="color: #2563eb;">‚úì</span> Decision</span>
            <span title="Tasks to complete" style="display: flex; align-items: center; gap: 0.2rem;"><span style="color: #d97706;">‚òê</span> Action</span>
            <span title="Blockers stopping progress" style="display: flex; align-items: center; gap: 0.2rem;"><span style="color: #dc2626;">‚ö†</span> Blocker</span>
            <span title="Potential risks identified" style="display: flex; align-items: center; gap: 0.2rem;"><span style="color: #db2777;">‚ö°</span> Risk</span>
            <span title="Ideas and suggestions" style="display: flex; align-items: center; gap: 0.2rem;"><span style="color: #059669;">üí°</span> Idea</span>
          </div>
        </div>
        <a href="/signals" onclick="event.stopPropagation()">View all ‚Üí</a>
      </div>
      <div class="section-content collapsible-content">
        {% if recent_signals %}
          {% for signal in recent_signals %}
          <div class="signal-item {{ 'status-' + signal.status if signal.status else '' }}" data-signal-id="{{ signal.id }}" data-meeting-id="{{ signal.meeting_id }}" data-type="{{ signal.type }}">
            <div class="signal-icon {{ signal.type }}">
              {% if signal.type == 'decision' %}‚úì{% elif signal.type == 'action' %}‚òê{% elif signal.type == 'blocker' %}‚ö†{% elif signal.type == 'risk' %}‚ö°{% else %}üí°{% endif %}
            </div>
            <div class="signal-body">
              <div class="signal-text markdown-content">{{ signal.text }}</div>
              <div class="signal-source">{{ signal.source }}</div>
            </div>
            <div class="signal-actions">
              <button class="thumb-btn up {{ 'active' if signal.status == 'approved' else '' }}" onclick="promoteSignalToDIKW(this, 'data')" title="Validate & Promote">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
              </button>
              <button class="thumb-btn down {{ 'active' if signal.status == 'rejected' else '' }}" onclick="updateSignalStatus(this, 'rejected')" title="Reject">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
              <button class="thumb-btn archive {{ 'active' if signal.status == 'archived' else '' }}" onclick="updateSignalStatus(this, 'archived')" title="Archive">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
              </button>
              <button class="thumb-btn dikw-promote" onclick="showDIKWPromoteMenu(this)" title="Promote to DIKW Level">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>
              </button>
            </div>
            {% if signal.status and signal.status != 'pending' %}
            <div class="signal-status-indicator {{ signal.status }}">
              {% if signal.status == 'approved' %}‚úì Validated{% elif signal.status == 'rejected' %}‚úó Dismissed{% elif signal.status == 'archived' %}üìÅ Archived{% elif signal.status == 'completed' %}‚úì Done{% elif signal.status == 'waiting' %}‚è≥ Waiting{% else %}{{ signal.status }}{% endif %}
            </div>
            {% endif %}
          </div>
          {% endfor %}
        {% else %}
          <div class="empty-section">No signals yet. Add a meeting to extract signals.</div>
        {% endif %}
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="section-card collapsible-box" data-box-id="activity">
      <div class="section-header" style="cursor: pointer;" onclick="toggleBoxCollapse(this.parentElement)">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <span class="collapse-icon">‚ñº</span>
          <h3>üìù Recent Activity</h3>
        </div>
        <div style="display: flex; gap: 0.5rem; font-size: 0.85rem;">
          <a href="/meetings" onclick="event.stopPropagation()">Meetings ‚Üí</a>
          <a href="/documents" onclick="event.stopPropagation()">Documents ‚Üí</a>
        </div>
      </div>
      <div class="section-content collapsible-content" style="padding: 0;">
        {% if recent_items %}
          {% for item in recent_items %}
          <div class="activity-item">
            <div class="activity-icon {{ item.type }}">
              {% if item.type == 'meeting' %}üìÖ{% else %}üìÑ{% endif %}
            </div>
            <div class="activity-info">
              <div class="activity-title">{{ item.title }}</div>
              <div class="activity-meta">{{ item.date or 'No date' }}</div>
            </div>
            <a href="{{ item.url }}" class="activity-link">View</a>
          </div>
          {% endfor %}
        {% else %}
          <div class="empty-section">No recent activity</div>
        {% endif %}
      </div>
    </div>

    <!-- Active Tickets -->
    <div class="section-card collapsible-box" data-box-id="tickets">
      <div class="section-header" style="cursor: pointer;" onclick="toggleBoxCollapse(this.parentElement)">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <span class="collapse-icon">‚ñº</span>
          <h3>üé´ Active Tickets</h3>
        </div>
        <a href="/tickets" onclick="event.stopPropagation()">View all ‚Üí</a>
      </div>
      <div class="section-content collapsible-content" style="padding: 0;">
        {% if active_tickets %}
          {% for ticket in active_tickets %}
          <div class="activity-item" style="padding: 1rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0;">
              <span style="font-family: monospace; font-size: 0.8rem; background: #f3f4f6; padding: 0.25rem 0.5rem; border-radius: 4px; color: #374151;">{{ ticket.ticket_id }}</span>
              {% if ticket.status == 'in_progress' %}
              <span style="width: 8px; height: 8px; background: #3b82f6; border-radius: 50%;"></span>
              {% elif ticket.status == 'blocked' %}
              <span style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%;"></span>
              {% elif ticket.status == 'in_review' %}
              <span style="width: 8px; height: 8px; background: #8b5cf6; border-radius: 50%;"></span>
              {% elif ticket.status == 'complete' %}
              <span style="width: 8px; height: 8px; background: #10b981; border-radius: 50%;"></span>
              {% else %}
              <span style="width: 8px; height: 8px; background: #f59e0b; border-radius: 50%;"></span>
              {% endif %}
            </div>
            <div class="activity-info">
              <div class="activity-title">{{ ticket.title }}</div>
              {% if ticket.ai_summary %}
              <div class="activity-meta" style="color: #6b7280;">{{ ticket.ai_summary[:80] }}{% if ticket.ai_summary|length > 80 %}...{% endif %}</div>
              {% endif %}
            </div>
            <a href="/tickets/{{ ticket.id }}" class="activity-link">View</a>
          </div>
          {% endfor %}
        {% else %}
          <div class="empty-section">
            <p style="margin-bottom: 0.75rem;">No active tickets</p>
            <a href="/tickets/new" style="color: #6366f1; text-decoration: none; font-weight: 500;">Add a ticket ‚Üí</a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Career Hub Section -->
  <div class="career-hub-section" style="margin-top: 2rem;">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
      <h2 style="font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
        <span>üöÄ</span> Career Hub
      </h2>
      <a href="/career" style="color: var(--sf-primary, #667eea); text-decoration: none; font-size: 0.9rem;">Full Career Page ‚Üí</a>
      <a href="/career/standups" style="color: var(--sf-primary, #667eea); text-decoration: none; font-size: 0.9rem; margin-left: 1.5rem;">Standups ‚Üí</a>
    </div>
    
    <div class="career-hub-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
      <!-- Standup Updates -->
      <div class="section-card">
        <div class="section-header">
          <h3>üìã Daily Standup</h3>
          <button onclick="toggleStandupForm()" style="background: none; border: none; cursor: pointer; font-size: 1.25rem;" title="Add standup">‚ûï</button>
        </div>
        <div class="section-content">
          <!-- Standup Form (hidden by default) -->
          <div id="standupForm" style="display: none; margin-bottom: 1rem;">
            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;">
              <label style="font-size: 0.85rem; color: var(--sf-text-muted);">Date:</label>
              <input type="date" id="standupDate" style="padding: 0.4rem 0.75rem; border: 1px solid var(--sf-border, #e5e7eb); border-radius: 8px; font-size: 0.9rem;">
              <button onclick="setStandupDateToday()" style="background: none; border: 1px solid var(--sf-border); padding: 0.4rem 0.75rem; border-radius: 8px; font-size: 0.8rem; cursor: pointer;">Today</button>
            </div>
            <textarea id="standupContent" placeholder="What did you accomplish? What are you working on? Any blockers?" style="width: 100%; min-height: 120px; padding: 0.75rem; border: 1px solid var(--sf-border, #e5e7eb); border-radius: 8px; font-size: 0.9rem; resize: vertical;"></textarea>
            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
              <button id="submitStandupBtn" onclick="submitStandup()" class="standup-btn primary">Submit & Get Feedback</button>
              <button onclick="suggestStandup()" class="standup-btn">Generate Suggestion</button>
              <button onclick="toggleStandupForm()" class="standup-btn">Cancel</button>
              <a href="/career/standups" class="standup-btn" style="text-decoration: none; display: inline-flex; align-items: center;">View All</a>
            </div>
          </div>
          
          <!-- Today's standup or recent standups -->
          <div id="standupDisplay">
            <div class="empty-section" style="text-align: center; padding: 1.5rem;">
              <p style="color: var(--sf-text-muted); margin-bottom: 0.75rem;">No standup for today</p>
              <button onclick="toggleStandupForm()" style="background: var(--sf-primary, #667eea); color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer;">
                Add Today's Standup
              </button>
            </div>
          </div>
          
          <!-- Recent standups -->
          <div id="recentStandups" style="margin-top: 1rem; display: none;">
            <div style="font-weight: 500; font-size: 0.85rem; color: var(--sf-text-muted); margin-bottom: 0.5rem;">Previous Standups</div>
            <div id="recentStandupsList"></div>
          </div>
        </div>
      </div>
      
      <!-- Code Locker -->
      <div class="section-card">
        <div class="section-header">
          <h3>üîê Code Locker</h3>
          <button onclick="showCodeLockerSelector()" style="background: none; border: none; cursor: pointer; font-size: 1.25rem;" title="Add file">‚ûï</button>
        </div>
        <div class="section-content">
          <!-- Step 1: Ticket & File Selection -->
          <div id="codeLockerSelector" style="display: none; margin-bottom: 1rem;">
            <div style="font-weight: 500; margin-bottom: 0.5rem; font-size: 0.9rem;">Select Ticket & File</div>
            
            <!-- Ticket Selection -->
            <select id="selectorTicket" onchange="loadTicketFiles()" style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--sf-border, #e5e7eb); border-radius: 8px; font-size: 0.9rem; margin-bottom: 0.5rem;">
              <option value="">-- Select a ticket --</option>
            </select>
            <div id="lockerTicketLink" style="margin-bottom: 0.5rem; display: none;"></div>
            </select>
            
            <!-- File Selection (populated based on ticket) -->
            <div id="selectorFilesContainer" style="display: none; margin-bottom: 0.5rem;">
              <div style="font-size: 0.85rem; color: var(--sf-text-muted); margin-bottom: 0.25rem;">Or select from ticket files:</div>
              <div id="selectorFilesList" style="max-height: 150px; overflow-y: auto; border: 1px solid var(--sf-border); border-radius: 8px;"></div>
            </div>
            
            <!-- Manual filename entry -->
            <div style="font-size: 0.85rem; color: var(--sf-text-muted); margin: 0.5rem 0 0.25rem;">Or enter manually:</div>
            <input id="selectorFilename" placeholder="filename.py (or path/to/file.py)" style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--sf-border, #e5e7eb); border-radius: 8px; font-size: 0.9rem;">
            
            <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
              <button onclick="proceedToCodeEntry()" class="standup-btn primary">Continue ‚Üí</button>
              <button onclick="hideCodeLockerSelector()" class="standup-btn">Cancel</button>
            </div>
          </div>
          
          <!-- Step 2: Code Entry Form -->
          <div id="codeLockerForm" style="display: none; margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.5rem; background: var(--sf-surface); border-radius: 8px;">
              <span style="font-family: monospace; font-weight: 500;" id="selectedFileDisplay">-</span>
              <span id="versionSuggestion" style="margin-left: auto; font-size: 0.8rem; color: var(--sf-text-muted);"></span>
            </div>
            <input type="hidden" id="codeFilename">
            <input type="hidden" id="codeTicket">
            <textarea id="codeContent" placeholder="Paste your code here..." style="width: 100%; min-height: 150px; padding: 0.75rem; border: 1px solid var(--sf-border, #e5e7eb); border-radius: 8px; font-size: 0.85rem; font-family: monospace; resize: vertical;"></textarea>
            <input id="codeNotes" placeholder="Version notes (optional)" style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--sf-border, #e5e7eb); border-radius: 8px; font-size: 0.9rem; margin-top: 0.5rem;">
            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
              <button onclick="submitCodeLocker()" class="standup-btn primary">Save to Locker</button>
              <button onclick="backToSelector()" class="standup-btn">‚Üê Back</button>
              <button onclick="toggleCodeLockerForm()" class="standup-btn">Cancel</button>
            </div>
          </div>
          
          <!-- Code Locker Files -->
          <div id="codeLockerFiles">
            <div class="empty-section" style="text-align: center; padding: 1.5rem;">
              <p style="color: var(--sf-text-muted); margin-bottom: 0.75rem;">No files in locker</p>
              <button onclick="showCodeLockerSelector()" style="background: var(--sf-primary, #667eea); color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer;">
                Add First File
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Marked.js for markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
const chips = document.querySelectorAll('.chip');
const aiResponse = document.getElementById('aiResponse');
const aiResponseContent = document.getElementById('aiResponseContent');
const aiResponseActions = document.getElementById('aiResponseActions');
const dashboard = document.getElementById('dashboard');

// Store current AI response for actions
let currentAIQuery = '';
let currentAIResponse = '';
let currentAIItems = [];

// Toast notification system
function showToast(title, message, type = 'info') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  const icons = {
    success: '‚úì',
    error: '‚úï',
    warning: '‚ö†',
    info: '‚Ñπ'
  };
  
  toast.innerHTML = `
    <div class="toast-icon">${icons[type] || icons.info}</div>
    <div class="toast-content">
      <div class="toast-title">${title}</div>
      ${message ? `<div class="toast-message">${message}</div>` : ''}
    </div>
    <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
  `;
  
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease forwards';
    setTimeout(() => toast.remove(), 300);
  }, 5000);
}

// Single column layout (compact)
dashboard.className = 'dashboard compact';

// Markdown rendering for signal text and highlight text
document.querySelectorAll('.markdown-content, .highlight-text').forEach(el => {
  const text = el.textContent;
  el.innerHTML = marked.parse(text);
});

// Signal status update
async function updateSignalStatus(btn, status) {
  const item = btn.closest('.signal-item');
  const meetingId = item.dataset.meetingId;
  const signalType = item.dataset.type;
  const signalText = item.querySelector('.signal-text').textContent.replace(/approved|rejected|archived|completed/gi, '').trim();
  
  // Toggle active state
  const isActive = btn.classList.contains('active');
  item.querySelectorAll('.thumb-btn').forEach(b => b.classList.remove('active'));
  
  const newStatus = isActive ? 'pending' : status;
  if (!isActive) {
    btn.classList.add('active');
  }
  
  // Update visual class
  item.className = item.className.replace(/status-\w+/g, '');
  if (newStatus !== 'pending') {
    item.classList.add(`status-${newStatus}`);
  }
  
  try {
    const response = await fetch('/api/signals/status', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({
        meeting_id: meetingId,
        signal_type: signalType,
        signal_text: signalText,
        status: newStatus
      })
    });
    
    if (response.ok) {
      const statusLabels = {
        'approved': '‚úì Validated',
        'rejected': '‚úó Dismissed',
        'archived': 'üìÅ Archived',
        'completed': '‚úì Done',
        'pending': ''
      };
      const statusDisplayLabels = {
        'approved': 'Signal validated',
        'rejected': 'Signal dismissed',
        'archived': 'Signal archived',
        'completed': 'Signal marked complete',
        'pending': 'Status cleared'
      };
      showToast('Updated', statusDisplayLabels[newStatus], 'success');
      
      // Send feedback for learning (approved=up, rejected/archived=down)
      const feedback = newStatus === 'approved' ? 'up' : (newStatus === 'rejected' || newStatus === 'archived') ? 'down' : null;
      if (feedback) {
        fetch('/api/signals/feedback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({
            meeting_id: meetingId,
            signal_type: signalType,
            signal_text: signalText,
            feedback: feedback
          })
        }).catch(err => console.error('Failed to send feedback:', err));
      }
      
      // Remove from view if archived or rejected
      if (newStatus === 'archived' || newStatus === 'rejected') {
        item.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        item.style.opacity = '0';
        item.style.transform = 'translateX(20px)';
        setTimeout(() => item.remove(), 300);
      } else {
        // Update or remove status indicator
        let indicator = item.querySelector('.signal-status-indicator');
        if (newStatus !== 'pending') {
          if (!indicator) {
            indicator = document.createElement('div');
            item.appendChild(indicator);
          }
          indicator.className = `signal-status-indicator ${newStatus}`;
          indicator.textContent = statusLabels[newStatus];
        } else if (indicator) {
          indicator.remove();
        }
      }
    } else {
      throw new Error('Failed to update status');
    }
  } catch (err) {
    showToast('Error', 'Could not update signal status', 'error');
    btn.classList.remove('active');
  }
}

// Convert signal to ticket
async function convertSignalToTicket(btn) {
  const item = btn.closest('.signal-item');
  const meetingId = item.dataset.meetingId;
  const signalType = item.dataset.type;
  const signalText = item.querySelector('.signal-text').textContent.replace(/approved|rejected|archived|completed/gi, '').trim();
  
  try {
    const response = await fetch('/api/signals/convert-to-ticket', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({
        meeting_id: meetingId,
        signal_type: signalType,
        signal_text: signalText
      })
    });
    
    if (response.ok) {
      const data = await response.json();
      showToast('Task Created', `Created task ${data.ticket_id}`, 'success');
      
      // Update item to show completed status
      item.querySelectorAll('.thumb-btn').forEach(b => b.classList.remove('active'));
      item.className = item.className.replace(/status-\w+/g, '') + ' status-completed';
      
      // Add status indicator below actions if not present
      if (!item.querySelector('.signal-status-indicator')) {
        const indicator = document.createElement('div');
        indicator.className = 'signal-status-indicator completed';
        indicator.innerHTML = `<a href="/tickets/${data.ticket_id}/edit" style="color: inherit; text-decoration: underline;">‚úì Task ${data.ticket_id}</a>`;
        item.appendChild(indicator);
      }
    } else {
      throw new Error('Failed to create task');
    }
  } catch (err) {
    showToast('Error', 'Could not create task', 'error');
  }
}

// ============================================
// DIKW Pyramid Functions
// ============================================

const DIKW_LEVELS = ['data', 'information', 'knowledge', 'wisdom'];
const DIKW_COLORS = {
  data: '#64748b',
  information: '#22c55e',
  knowledge: '#3b82f6',
  wisdom: '#8b5cf6'
};
const DIKW_ICONS = {
  data: 'üì¶',
  information: 'üìä',
  knowledge: 'üìö',
  wisdom: 'ü™∑'
};

// Load DIKW pyramid on page load
async function loadDIKWPyramid() {
  try {
    const response = await fetch('/api/dikw', { credentials: 'same-origin' });
    if (!response.ok) throw new Error('Failed to load DIKW');
    
    const data = await response.json();
    
    // Update counts
    DIKW_LEVELS.forEach(level => {
      const countEl = document.getElementById(`${level}Count`);
      if (countEl) countEl.textContent = data.counts[level] || 0;
      
      const itemsEl = document.getElementById(`${level}Items`);
      if (itemsEl) {
        if (data.pyramid[level]?.length > 0) {
          itemsEl.innerHTML = data.pyramid[level].map(item => `
            <div class="dikw-item" data-id="${item.id}" onclick="showDIKWDetail(${item.id})">
              <div class="dikw-item-text">${item.summary || item.content.substring(0, 80)}...</div>
              <div class="dikw-item-actions">
                ${level !== 'wisdom' ? `
                  <button class="dikw-action-btn promote" onclick="event.stopPropagation(); promoteDIKWItem(${item.id})" title="Promote to next level">‚Üë</button>
                ` : ''}
                <button class="dikw-action-btn validate" onclick="event.stopPropagation(); validateDIKWItem(${item.id}, 'validate')" title="Validate">‚úì</button>
              </div>
            </div>
          `).join('');
        } else {
          itemsEl.innerHTML = `<div class="dikw-empty">No ${level} items yet</div>`;
        }
      }
    });
  } catch (err) {
    console.error('Failed to load DIKW pyramid:', err);
  }
}

// Promote a signal directly to DIKW (starts at Data level by default)
async function promoteSignalToDIKW(btn, level = 'data') {
  const item = btn.closest('.signal-item');
  const meetingId = item.dataset.meetingId;
  const signalType = item.dataset.type;
  const signalText = item.querySelector('.signal-text').textContent.replace(/approved|rejected|archived|completed/gi, '').trim();
  
  try {
    const response = await fetch('/api/dikw/promote-signal', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({
        signal_text: signalText,
        signal_type: signalType,
        meeting_id: meetingId,
        level: level
      })
    });
    
    if (response.ok) {
      const data = await response.json();
      const levelNames = { data: 'Data', information: 'Information', knowledge: 'Knowledge', wisdom: 'Wisdom' };
      showToast('Added to DIKW', `Signal promoted to ${levelNames[level]}`, 'success');
      
      // Update UI
      btn.classList.add('active');
      item.className = item.className.replace(/status-\w+/g, '') + ' status-approved';
      
      // Refresh DIKW pyramid
      loadDIKWPyramid();
    } else {
      throw new Error('Failed to promote signal');
    }
  } catch (err) {
    showToast('Error', 'Could not promote signal to DIKW', 'error');
  }
}

// Show DIKW promote menu for choosing level
function showDIKWPromoteMenu(btn) {
  // Close any existing menus
  document.querySelectorAll('.dikw-promote-menu').forEach(m => m.remove());
  
  const menu = document.createElement('div');
  menu.className = 'dikw-promote-menu open';
  menu.innerHTML = `
    <button class="dikw-promote-option" onclick="promoteFromMenu(this, 'data')">
      <span class="level-dot data"></span>
      üì¶ Data
    </button>
    <button class="dikw-promote-option" onclick="promoteFromMenu(this, 'information')">
      <span class="level-dot information"></span>
      üìä Information
    </button>
    <button class="dikw-promote-option" onclick="promoteFromMenu(this, 'knowledge')">
      <span class="level-dot knowledge"></span>
      üìö Knowledge
    </button>
    <button class="dikw-promote-option" onclick="promoteFromMenu(this, 'wisdom')">
      <span class="level-dot wisdom"></span>
      ü™∑ Wisdom
    </button>
  `;
  
  btn.style.position = 'relative';
  btn.appendChild(menu);
  
  // Close on outside click
  setTimeout(() => {
    document.addEventListener('click', function closeMenu(e) {
      if (!menu.contains(e.target) && e.target !== btn) {
        menu.remove();
        document.removeEventListener('click', closeMenu);
      }
    });
  }, 10);
}

function promoteFromMenu(option, level) {
  const menu = option.closest('.dikw-promote-menu');
  const btn = menu.parentElement;
  menu.remove();
  
  // Find the original approve button (first thumb-btn in the row)
  const item = btn.closest('.signal-item');
  const approveBtn = item.querySelector('.thumb-btn.up');
  promoteSignalToDIKW(approveBtn, level);
}

// Promote a DIKW item to the next level
async function promoteDIKWItem(itemId) {
  try {
    const response = await fetch('/api/dikw/promote', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ item_id: itemId })
    });
    
    if (response.ok) {
      const data = await response.json();
      showToast('Promoted!', `${data.from_level} ‚Üí ${data.to_level}`, 'success');
      loadDIKWPyramid();
    } else {
      const err = await response.json();
      showToast('Error', err.error || 'Could not promote item', 'error');
    }
  } catch (err) {
    showToast('Error', 'Could not promote item', 'error');
  }
}

// Validate/upvote a DIKW item
async function validateDIKWItem(itemId, action = 'validate') {
  try {
    const response = await fetch('/api/dikw/validate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ item_id: itemId, action: action })
    });
    
    if (response.ok) {
      showToast('Validated', 'Confidence increased', 'success');
    }
  } catch (err) {
    console.error('Validation failed:', err);
  }
}

// Show detail view for a DIKW item (for now just log it)
function showDIKWDetail(itemId) {
  console.log('Show detail for DIKW item:', itemId);
  // TODO: Implement detail modal
}

// Initialize DIKW on page load
document.addEventListener('DOMContentLoaded', () => {
  loadDIKWPyramid();
});

// AI Response Actions (per item)
function extractAIItems(response) {
  if (!response) return [];
  
  // Filter out preamble/intro text patterns that aren't actual items
  const preamblePatterns = [
    /^here are the/i,
    /^here is a/i,
    /^based on/i,
    /^from the meetings/i,
    /^the following/i,
    /^###?\s*(meetings?|items?|mentions?)/i,
    /^slack w\s/i,
    /^action items:$/i,
    /^items assigned to/i,
    /^mentions of \w+/i,
  ];
  
  const isJunkLine = (line) => {
    const trimmed = line.trim();
    if (!trimmed) return true;
    if (trimmed.length < 5) return true;
    // Check if line is just a header or preamble
    for (const pattern of preamblePatterns) {
      if (pattern.test(trimmed)) return true;
    }
    // Check if it's just a section header ending with colon
    if (/^[A-Za-z\s]+:$/.test(trimmed) && trimmed.length < 30) return true;
    return false;
  };
  
  const lines = response.split('\n').map(line => line.trim()).filter(Boolean);
  const items = [];
  let current = '';
  const isBullet = (line) => /^[-*‚Ä¢]\s+/.test(line) || /^\d+[.)]\s+/.test(line);
  const stripBullet = (line) => line.replace(/^([-*‚Ä¢]|\d+[.)])\s+/, '');

  for (const line of lines) {
    if (isBullet(line)) {
      if (current && !isJunkLine(current)) items.push(current.trim());
      current = stripBullet(line);
    } else if (current) {
      current += ' ' + line;
    } else if (!isJunkLine(line)) {
      current = line;
    }
  }
  if (current && !isJunkLine(current)) items.push(current.trim());
  
  // Filter out items that are too short or look like headers
  const validItems = items.filter(item => {
    if (item.length < 15) return false;
    if (/^###?\s/.test(item)) return false; // Markdown headers
    if (/^[A-Za-z\s]+:$/.test(item)) return false; // Section headers
    return true;
  });
  
  return validItems.length ? validItems : (items.length ? items : [response.trim()]);
}

// Add reference citation support for [1], [2] etc
function addReferenceTooltips(html, sources) {
  // Replace [N] patterns with clickable tooltips
  return html.replace(/\[(\d+)\]/g, (match, num) => {
    const source = sources && sources[parseInt(num) - 1];
    const tooltip = source ? `${source.name || source.meeting_name || 'Meeting'} - ${source.date || ''}` : `Reference ${num}`;
    return `<span class="ai-reference" onclick="scrollToReference(${num})">${match}<span class="ai-reference-tooltip">${escapeHtml(tooltip)}</span></span>`;
  });
}

function renderAIResponseItems(response, sources) {
  currentAIItems = extractAIItems(response);
  // Track processed status for each item
  if (!window.processedAIItems) window.processedAIItems = {};
  aiResponseContent.innerHTML = currentAIItems.map((item, index) => {
    if (window.processedAIItems[index]) return '';
    let renderedHtml = marked.parse(item);
    // Add clickable reference tooltips if sources available
    if (sources) {
      renderedHtml = addReferenceTooltips(renderedHtml, sources);
    }
    return `
      <div class="ai-update-item" data-ai-item-index="${index}">
        <div class="ai-update-text">${renderedHtml}</div>
        <div class="ai-update-actions">
          <button class="ai-action-btn approve" onclick="approveAIItem(${index})" title="Save to memory">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
            Approve
          </button>
          <button class="ai-action-btn reject" onclick="rejectAIItem(${index})" title="Dismiss">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            Reject
          </button>
          <button class="ai-action-btn archive" onclick="archiveAIItem(${index})" title="Archive">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
            Archive
          </button>
          <button class="ai-action-btn action" onclick="convertAIItemToTask(${index})" title="Create task">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
            Create Task
          </button>
          <button class="ai-action-btn waiting" onclick="convertAIItemToAccountability(${index})" title="Add to waiting-for list">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            Waiting For
          </button>
        </div>
      </div>
    `;
  }).join('');
}

function disableAIItemActions(index) {
  const itemEl = document.querySelector(`[data-ai-item-index="${index}"]`);
  if (!itemEl) return;
  itemEl.querySelectorAll('button').forEach(btn => btn.disabled = true);
}

async function approveAIItem(index) {
  const itemText = currentAIItems[index];
  if (!itemText) return;

  try {
    const response = await fetch('/api/ai-memory/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({
        source_type: 'quick_ask_item',
        query: currentAIQuery,
        content: itemText,
        importance: 7
      })
    });

    if (response.ok) {
      showToast('Saved to Memory', 'AI item saved for future context', 'success');
      window.processedAIItems[index] = 'approved';
      renderAIResponseItems(currentAIResponse);
      updateApprovedAIItems(itemText);
    } else {
      throw new Error('Failed to save');
    }
  } catch (err) {
    showToast('Error', 'Could not save to memory', 'error');
  }
}

async function rejectAIItem(index) {
  const itemText = currentAIItems[index];
  if (!itemText) return;

  try {
    await fetch('/api/ai-memory/reject', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({
        query: currentAIQuery,
        content: itemText
      })
    });

    showToast('Dismissed', 'Item will not be saved', 'info');
    window.processedAIItems[index] = 'rejected';
    renderAIResponseItems(currentAIResponse);
  } catch (err) {
    showToast('Error', 'Could not dismiss item', 'error');
  }
}

async function archiveAIItem(index) {
  const itemText = currentAIItems[index];
  if (!itemText) return;

  try {
    await fetch('/api/ai-memory/archive', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({
        query: currentAIQuery,
        content: itemText
      })
    });

    showToast('Archived', 'Item archived', 'info');
    window.processedAIItems[index] = 'archived';
    renderAIResponseItems(currentAIResponse);
  } catch (err) {
    showToast('Error', 'Could not archive item', 'error');
  }
// Section to show approved AI quick updates
function updateApprovedAIItems(itemText) {
  if (!window.approvedAIItems) window.approvedAIItems = [];
  window.approvedAIItems.push(itemText);
  renderApprovedAIItems();
}

function renderApprovedAIItems() {
  let container = document.getElementById('approvedAIItems');
  if (!container) {
    // Create the section if not present
    container = document.createElement('div');
    container.id = 'approvedAIItems';
    container.className = 'section-card';
    container.innerHTML = `<div class="section-header"><h3>‚úÖ Approved AI Updates</h3></div><div class="section-content" id="approvedAIItemsList"></div>`;
    dashboard.appendChild(container);
  }
  const list = container.querySelector('#approvedAIItemsList');
  if (window.approvedAIItems.length === 0) {
    list.innerHTML = '<div class="empty-section">No approved AI updates yet.</div>';
  } else {
    list.innerHTML = window.approvedAIItems.map(item => `<div class="ai-update-item"><div class="ai-update-text">${marked.parse(item)}</div></div>`).join('');
  }
}
}

async function convertAIItemToTask(index) {
  const itemText = currentAIItems[index];
  if (!itemText) return;

  try {
    const response = await fetch('/api/ai-memory/to-action', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({
        query: currentAIQuery,
        content: itemText
      })
    });

    if (response.ok) {
      const data = await response.json();
      showToast('Task Created', `Created task #${data.ticket_id}`, 'success');
      disableAIItemActions(index);
    } else {
      throw new Error('Failed to create task');
    }
  } catch (err) {
    showToast('Error', 'Could not create task', 'error');
  }
}

async function convertAIItemToAccountability(index) {
  const itemText = currentAIItems[index];
  if (!itemText) return;

  const description = prompt('What are you waiting for?', itemText.substring(0, 120));
  if (!description) return;

  const responsible_party = prompt('Who is responsible?', '');

  const context = `**Quick AI Update**\n\n${itemText}\n\n**Query:** ${currentAIQuery}`;

  try {
    const response = await fetch('/api/accountability/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({
        description: description,
        responsible_party: responsible_party,
        context: context,
        source_type: 'ai_update',
        source_ref_id: null
      })
    });

    const result = await response.json();
    if (result.status === 'ok') {
      showToast('Waiting Item Created', 'Added accountability item', 'success');
      disableAIItemActions(index);
    } else {
      throw new Error(result.error || 'Failed to create accountability item');
    }
  } catch (err) {
    showToast('Error', err.message || 'Could not create accountability item', 'error');
  }
}

async function convertAIToAction() {
  if (!currentAIResponse) return;
  
  try {
    const response = await fetch('/api/ai-memory/to-action', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({
        query: currentAIQuery,
        content: currentAIResponse
      })
    });
    
    if (response.ok) {
      const data = await response.json();
      showToast('Ticket Created', `Created ticket ${data.ticket_id}`, 'success');
      if (aiResponseActions) {
        aiResponseActions.querySelectorAll('button').forEach(b => b.disabled = true);
      }
    } else {
      throw new Error('Failed to create ticket');
    }
  } catch (err) {
    showToast('Error', 'Could not create ticket', 'error');
  }
}

// Track current AI run_id for feedback
let currentAIRunId = null;

function askAI(topic) {
  chips.forEach(c => c.classList.remove('active'));
  event.target.closest('.chip').classList.add('active');
  
  currentAIQuery = topic;
  currentAIResponse = '';
  currentAIRunId = null;
  
  // Hide feedback during loading
  document.getElementById('aiResponseFeedback').style.display = 'none';
  
  aiResponse.classList.add('visible');
  aiResponseContent.innerHTML = '<div class="ai-response-loading"><div class="spinner"></div>Thinking...</div>';
  
  fetch('/api/dashboard/quick-ask', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'same-origin',
    body: JSON.stringify({ topic: topic })
  })
  .then(res => {
    if (!res.ok) {
      return res.json().then(data => {
        throw new Error(data.error || data.response || `HTTP ${res.status}`);
      });
    }
    return res.json();
  })
  .then(data => {
    if (data.error) {
      showToast('Error', data.error, 'error');
      aiResponseContent.innerHTML = '<span style="color: #e74c3c;">Error: ' + data.error + '</span>';
    } else {
      currentAIResponse = data.response || '';
      currentAIRunId = data.run_id || null;
      renderAIResponseItems(currentAIResponse || 'No results found.');
      
      // Show feedback buttons if we have a run_id
      if (currentAIRunId) {
        renderFeedbackButtons('aiResponseFeedback', currentAIRunId, `Dashboard AI: ${topic}`);
        document.getElementById('aiResponseFeedback').style.display = 'flex';
      }
    }
  })
  .catch(err => {
    console.error('AI request failed:', err);
    showToast('Error', err.message || 'Could not connect to AI service', 'error');
    aiResponseContent.innerHTML = '<span style="color: #e74c3c;">Error: ' + (err.message || 'Could not connect') + '</span>';
  });
}

function askCustom() {
  const query = document.getElementById('customQuery').value.trim();
  if (!query) return;
  
  chips.forEach(c => c.classList.remove('active'));
  
  currentAIQuery = query;
  currentAIResponse = '';
  currentAIRunId = null;
  
  // Hide feedback during loading
  document.getElementById('aiResponseFeedback').style.display = 'none';
  
  aiResponse.classList.add('visible');
  aiResponseContent.innerHTML = '<div class="ai-response-loading"><div class="spinner"></div>Thinking...</div>';
  
  fetch('/api/dashboard/quick-ask', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'same-origin',
    body: JSON.stringify({ query: query })
  })
  .then(res => {
    if (!res.ok) {
      return res.json().then(data => {
        throw new Error(data.error || data.response || `HTTP ${res.status}`);
      });
    }
    return res.json();
  })
  .then(data => {
    if (data.error) {
      showToast('Error', data.error, 'error');
      aiResponseContent.innerHTML = '<span style="color: #e74c3c;">Error: ' + data.error + '</span>';
    } else {
      currentAIResponse = data.response || '';
      currentAIRunId = data.run_id || null;
      renderAIResponseItems(currentAIResponse || 'No results found.');
      
      // Show feedback buttons if we have a run_id
      if (currentAIRunId) {
        renderFeedbackButtons('aiResponseFeedback', currentAIRunId, `Dashboard AI: Custom Query`);
        document.getElementById('aiResponseFeedback').style.display = 'flex';
      }
    }
  })
  .catch(err => {
    console.error('AI request failed:', err);
    showToast('Error', err.message || 'Could not connect to AI service', 'error');
    aiResponseContent.innerHTML = '<span style="color: #e74c3c;">Error: ' + (err.message || 'Could not connect') + '</span>';
  });
}

function closeAIResponse() {
  aiResponse.classList.remove('visible');
  chips.forEach(c => c.classList.remove('active'));
  currentAIQuery = '';
  currentAIResponse = '';
  currentAIRunId = null;
}

// ============================================
// Workflow Panel Management
// ============================================

let workflowModes = {
  'mode-a': { 
    icon: 'üéØ', 
    title: 'Mode A: Context Distillation',
    subtitle: 'Select files, freeze context, seed agents',
    steps: []
  },
  'mode-b': { 
    icon: 'üìã', 
    title: 'Mode B: Implementation Planning',
    subtitle: 'Review context, define scope, create plan',
    steps: []
  },
  'mode-c': { 
    icon: '‚úèÔ∏è', 
    title: 'Mode C: Assisted Draft Intake',
    subtitle: 'Generate code, docs, and walkthroughs',
    steps: []
  },
  'mode-d': { 
    icon: 'üîç', 
    title: 'Mode D: Deep Review & Validation',
    subtitle: 'Line-by-line review, smoke test, fix loops',
    steps: []
  },
  'mode-e': { 
    icon: 'üöÄ', 
    title: 'Mode E: Promotion Readiness',
    subtitle: 'Checklist, code locker, transfer packet',
    steps: []
  },
  'mode-f': { 
    icon: 'üîÑ', 
    title: 'Mode F: Controlled Ingress/Egress',
    subtitle: 'Push/pull, commit, PR, merge (Online)',
    steps: []
  },
  'mode-g': {
    icon: 'üíª',
    title: 'Mode G: Execution (Writing Code)',
    subtitle: 'Implement the current ticket checklist',
    steps: []
  },
  'mode-h': {
    icon: 'üß™',
    title: 'Mode H: Test Planning',
    subtitle: 'Define acceptance criteria and test cases',
    steps: []
  }
};

// Load workflow modes from API and update display
async function loadWorkflowModesFromAPI() {
  try {
    const response = await fetch('/api/settings/workflow-modes', { credentials: 'same-origin' });
    if (!response.ok) return;
    
    const data = await response.json();
    const modes = data.modes || [];
    
    // Update workflowModes with API data
    modes.forEach(mode => {
      if (mode.mode_key) {
        workflowModes[mode.mode_key] = {
          icon: mode.icon || 'üéØ',
          title: mode.name || mode.mode_key,
          subtitle: mode.short_description || mode.description || '',
          steps: mode.steps_json || []
        };
      }
    });
    
    // Re-render ALL mode contents with API data, not just current
    Object.keys(workflowModes).forEach(modeKey => {
      renderModeContent(modeKey);
    });
    
    // Update panel display for current mode
    const currentMode = localStorage.getItem('signalflow-mode') || 'mode-a';
    updateWorkflowPanel(currentMode);
  } catch (err) {
    console.error('Failed to load workflow modes:', err);
  }
}

// Render mode content dynamically
function renderModeContent(mode) {
  const modeData = workflowModes[mode];
  if (!modeData || !modeData.steps || modeData.steps.length === 0) return;
  
  // Mode G is special - it uses tickets, not steps
  if (mode === 'mode-g') return;
  
  const modeContent = document.querySelector(`.workflow-mode-content[data-mode="${mode}"]`);
  if (!modeContent) return;
  
  const steps = modeData.steps;
  if (!steps || steps.length === 0) return;
  
  const checklist = modeContent.querySelector('.workflow-checklist');
  if (!checklist) return;
  
  // Always render steps from API to reflect custom settings
  checklist.innerHTML = steps.map((step, i) => `
    <li class="workflow-checklist-item">
      <div class="workflow-checkbox" onclick="toggleCheckbox(this)"></div>
      <div class="workflow-checklist-content">
        <div class="workflow-checklist-title">${escapeHtml(step.heading || step.title || step)}</div>
        <div class="workflow-checklist-desc">${escapeHtml(step.description || '')}</div>
      </div>
    </li>
  `).join('');
  
  // Update progress text
  const progressText = modeContent.querySelector('.workflow-progress-text');
  if (progressText) {
    progressText.textContent = `0 of ${steps.length} complete`;
  }
  
  // Re-apply saved progress after rendering
  loadWorkflowProgress(mode);
}

// Initialize workflow panel based on current mode
function initWorkflowPanel() {
  const currentMode = localStorage.getItem('signalflow-mode') || 'mode-a';
  // Set mode immediately before API call to avoid showing default text
  const modeInfo = workflowModes[currentMode] || workflowModes['mode-a'];
  const iconEl = document.getElementById('workflowModeIcon');
  const titleEl = document.getElementById('workflowModeTitle');
  if (iconEl) iconEl.textContent = modeInfo.icon;
  if (titleEl) titleEl.innerHTML = `${modeInfo.title}<span style="display: block; font-size: 0.8rem; font-weight: 400; color: var(--sf-text-muted); margin-top: 0.25rem;">${modeInfo.subtitle}</span>`;
  
  updateWorkflowPanel(currentMode);
  loadWorkflowProgress(currentMode);
}

function updateWorkflowPanel(mode) {
  const modeInfo = workflowModes[mode] || workflowModes['mode-a'];
  
  // Update panel header
  const iconEl = document.getElementById('workflowModeIcon');
  const titleEl = document.getElementById('workflowModeTitle');
  
  if (iconEl) iconEl.textContent = modeInfo.icon;
  if (titleEl) titleEl.innerHTML = `${modeInfo.title}<span style="display: block; font-size: 0.8rem; font-weight: 400; color: var(--sf-text-muted); margin-top: 0.25rem;">${modeInfo.subtitle}</span>`;
  
  // Show only the active mode's content
  document.querySelectorAll('.workflow-mode-content').forEach(el => {
    el.style.display = el.dataset.mode === mode ? 'block' : 'none';
  });
  
  // Update panel styling based on mode
  const panel = document.getElementById('workflowPanel');
  if (panel) {
    panel.className = 'workflow-panel ' + mode;
  }
}

function toggleWorkflowPanel() {
  const panel = document.getElementById('workflowPanel');
  const content = document.getElementById('workflowContent');
  const btn = panel.querySelector('.workflow-btn:first-child');
  
  if (content.style.display === 'none') {
    content.style.display = 'block';
    btn.textContent = 'Collapse';
    localStorage.setItem('workflow-panel-collapsed', 'false');
  } else {
    content.style.display = 'none';
    btn.textContent = 'Expand';
    localStorage.setItem('workflow-panel-collapsed', 'true');
  }
}

function toggleCheckbox(el) {
  el.classList.toggle('checked');
  
  const currentMode = localStorage.getItem('signalflow-mode') || 'mode-a';
  updateWorkflowProgress(currentMode);
  saveWorkflowProgress(currentMode);
}

// Toggle Mode G task checkbox and persist to server
async function toggleModeGTask(el) {
  el.classList.toggle('checked');
  
  const taskItem = el.closest('.mode-g-task');
  const taskIndex = taskItem.dataset.taskIndex;
  const ticketId = taskItem.dataset.ticketId;
  const isChecked = el.classList.contains('checked');
  
  taskItem.classList.toggle('completed', isChecked);
  
  // Update local progress displays
  updateModeGProgress();
  updateTicketProgress(ticketId);
  
  // Persist to server
  try {
    const response = await fetch(`/api/tickets/${ticketId}/task-status`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({
        task_index: parseInt(taskIndex),
        status: isChecked ? 'done' : 'pending'
      })
    });
    
    if (response.ok) {
      // Refresh burndown stats after successful save
      refreshBurndownStats();
    }
  } catch (err) {
    console.error('Failed to update task status:', err);
  }
}

// Update the progress bar for a specific ticket
function updateTicketProgress(ticketId) {
  const card = document.querySelector(`.mode-g-ticket-card[data-ticket-id="${ticketId}"]`);
  if (!card) return;
  
  const tasks = card.querySelectorAll('.mode-g-task');
  const completed = card.querySelectorAll('.mode-g-task.completed').length;
  const total = tasks.length;
  const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
  
  // Update the mini progress in the header
  const progressFill = card.querySelector('.mode-g-progress-fill-mini');
  const progressText = card.querySelector('.mode-g-progress-mini span');
  
  if (progressFill) progressFill.style.width = percent + '%';
  if (progressText) progressText.textContent = `${completed}/${total}`;
}

// Refresh burndown stats from server
async function refreshBurndownStats() {
  try {
    const res = await fetch('/api/reports/sprint-burndown');
    const data = await res.json();
    
    document.getElementById('burndownTotal').textContent = data.total_points || 0;
    document.getElementById('burndownCompleted').textContent = Math.round(data.completed_points || 0);
    document.getElementById('burndownInProgress').textContent = Math.round(data.in_progress_points || 0);
    document.getElementById('burndownRemaining').textContent = Math.round(data.remaining_points || 0);
    
    // Update jeopardy warning
    const jeopardyEl = document.getElementById('modeGJeopardyWarning');
    if (jeopardyEl) {
      if (data.jeopardy_status && data.jeopardy_message) {
        jeopardyEl.style.display = 'block';
        if (data.jeopardy_status === 'critical') {
          jeopardyEl.style.background = '#fef2f2';
          jeopardyEl.style.border = '1px solid #fecaca';
          jeopardyEl.style.color = '#b91c1c';
        } else {
          jeopardyEl.style.background = '#fffbeb';
          jeopardyEl.style.border = '1px solid #fde68a';
          jeopardyEl.style.color = '#b45309';
        }
        jeopardyEl.innerHTML = `<strong>${data.jeopardy_message}</strong>
          ${data.working_days_remaining !== null ? `<div style="font-size: 0.8rem; margin-top: 0.25rem; opacity: 0.8;">Day ${data.sprint_day}/${data.sprint_total_days} ‚Ä¢ ${data.working_days_remaining} working days left ‚Ä¢ ${data.total_remaining_tasks} subtasks remaining</div>` : ''}`;
      } else {
        jeopardyEl.style.display = 'none';
      }
    }
  } catch (err) {
    console.error('Failed to refresh burndown stats:', err);
  }
}

// Update Mode G progress bar
function updateModeGProgress() {
  const tasks = document.querySelectorAll('.mode-g-tasks .mode-g-task');
  const completed = document.querySelectorAll('.mode-g-tasks .mode-g-task.completed').length;
  const total = tasks.length;
  const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
  
  const progressFill = document.getElementById('modeGProgressFill');
  const progressText = document.getElementById('modeGProgressText');
  
  if (progressFill) progressFill.style.width = percent + '%';
  if (progressText) progressText.textContent = `${completed} of ${total} complete`;
}

// Toggle task details visibility
function toggleTaskDetails(btn) {
  btn.classList.toggle('expanded');
  const taskItem = btn.closest('.mode-g-task');
  const details = taskItem.querySelector('.mode-g-task-details');
  if (details) {
    details.style.display = details.style.display === 'none' ? 'block' : 'none';
  }
}

// Toggle Mode G ticket card collapse
function toggleModeGTicket(header) {
  const card = header.closest('.mode-g-ticket-card');
  card.classList.toggle('expanded');
  header.classList.toggle('expanded');
}

// ========================================
// Global Tasks for Mode G
// ========================================

function loadGlobalTasks() {
  const container = document.getElementById('modeGGlobalTasks');
  if (!container) return;
  
  const tasks = JSON.parse(localStorage.getItem('mode-g-global-tasks') || '[]');
  
  if (tasks.length === 0) {
    container.innerHTML = '<li style="color: #6b7280; font-size: 0.85rem; padding: 0.25rem 0;">No global tasks. Click Edit to add some.</li>';
    return;
  }
  
  container.innerHTML = tasks.map((task, idx) => `
    <li class="workflow-checklist-item mode-g-global-task ${task.done ? 'completed' : ''}" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0;">
      <div class="workflow-checkbox ${task.done ? 'checked' : ''}" onclick="toggleGlobalTask(${idx})" style="flex-shrink: 0;"></div>
      <span style="flex: 1; font-size: 0.85rem; ${task.done ? 'text-decoration: line-through; opacity: 0.6;' : ''}">${escapeHtml(task.title)}</span>
      <button onclick="removeGlobalTask(${idx})" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 0.7rem; opacity: 0; transition: opacity 0.2s;" class="remove-global-task">&times;</button>
    </li>
  `).join('');
}

function toggleGlobalTasksEdit() {
  const editor = document.getElementById('globalTasksEditor');
  editor.style.display = editor.style.display === 'none' ? 'block' : 'none';
  if (editor.style.display === 'block') {
    document.getElementById('newGlobalTaskInput').focus();
  }
}

function addGlobalTask() {
  const input = document.getElementById('newGlobalTaskInput');
  const title = input.value.trim();
  if (!title) return;
  
  const tasks = JSON.parse(localStorage.getItem('mode-g-global-tasks') || '[]');
  tasks.push({ title: title, done: false });
  localStorage.setItem('mode-g-global-tasks', JSON.stringify(tasks));
  
  input.value = '';
  loadGlobalTasks();
}

function toggleGlobalTask(idx) {
  const tasks = JSON.parse(localStorage.getItem('mode-g-global-tasks') || '[]');
  if (tasks[idx]) {
    tasks[idx].done = !tasks[idx].done;
    localStorage.setItem('mode-g-global-tasks', JSON.stringify(tasks));
    loadGlobalTasks();
  }
}

function removeGlobalTask(idx) {
  const tasks = JSON.parse(localStorage.getItem('mode-g-global-tasks') || '[]');
  tasks.splice(idx, 1);
  localStorage.setItem('mode-g-global-tasks', JSON.stringify(tasks));
  loadGlobalTasks();
}

// Load global tasks on page load
document.addEventListener('DOMContentLoaded', loadGlobalTasks);

// Load Mode G sprint tickets
async function loadModeGSprintTickets() {
  const container = document.getElementById('modeGTicketsList');
  if (!container) return;
  
  try {
    const res = await fetch('/api/reports/sprint-burndown');
    const data = await res.json();
    
    // Update burndown summary
    document.getElementById('burndownTotal').textContent = data.total_points || 0;
    document.getElementById('burndownCompleted').textContent = Math.round(data.completed_points || 0);
    document.getElementById('burndownInProgress').textContent = Math.round(data.in_progress_points || 0);
    document.getElementById('burndownRemaining').textContent = Math.round(data.remaining_points || 0);
    
    // Show jeopardy warning if applicable
    const jeopardyEl = document.getElementById('modeGJeopardyWarning');
    if (jeopardyEl) {
      if (data.jeopardy_status && data.jeopardy_message) {
        jeopardyEl.style.display = 'block';
        if (data.jeopardy_status === 'critical') {
          jeopardyEl.style.background = '#fef2f2';
          jeopardyEl.style.border = '1px solid #fecaca';
          jeopardyEl.style.color = '#b91c1c';
        } else {
          jeopardyEl.style.background = '#fffbeb';
          jeopardyEl.style.border = '1px solid #fde68a';
          jeopardyEl.style.color = '#b45309';
        }
        jeopardyEl.innerHTML = `<strong>${data.jeopardy_message}</strong>
          ${data.working_days_remaining !== null ? `<div style="font-size: 0.8rem; margin-top: 0.25rem; opacity: 0.8;">Day ${data.sprint_day}/${data.sprint_total_days} ‚Ä¢ ${data.working_days_remaining} working days left ‚Ä¢ ${data.total_remaining_tasks} subtasks remaining</div>` : ''}`;
      } else {
        jeopardyEl.style.display = 'none';
      }
    }
    
    if (!data.tickets || data.tickets.length === 0) {
      container.innerHTML = `
        <div style="padding: 1rem; text-align: center; color: #6b7280; background: #f9fafb; border-radius: 8px;">
          <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üìã</div>
          <div>No active sprint tickets found.</div>
          <a href="/tickets/new" style="color: #6366f1; font-size: 0.85rem;">Add a ticket ‚Üí</a>
        </div>
      `;
      return;
    }
    
    let html = '';
    for (const ticket of data.tickets) {
      const progressPct = ticket.progress_pct || 0;
      const hasDecomposition = ticket.tasks && ticket.tasks.length > 0;
      
      html += `
        <div class="mode-g-ticket-card" data-ticket-id="${ticket.id}">
          <div class="mode-g-ticket-header">
            <svg class="mode-g-ticket-toggle" fill="none" stroke="currentColor" viewBox="0 0 24 24" onclick="toggleModeGTicket(this.parentElement)">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
            <div class="mode-g-ticket-info" onclick="toggleModeGTicket(this.parentElement)" style="cursor: pointer;">
              <div class="mode-g-ticket-id">${ticket.ticket_id}</div>
              <div class="mode-g-ticket-title">${escapeHtml(ticket.title)}</div>
            </div>
            <div class="mode-g-ticket-meta">
              <span class="mode-g-status-badge ${ticket.status}">${formatStatus(ticket.status)}</span>
              ${ticket.sprint_points > 0 ? `<span class="mode-g-points-badge">${ticket.sprint_points} pts</span>` : ''}
              ${hasDecomposition ? `
                <div class="mode-g-progress-mini">
                  <div class="mode-g-progress-bar-mini">
                    <div class="mode-g-progress-fill-mini" style="width: ${progressPct}%"></div>
                  </div>
                  <span>${ticket.completed_tasks}/${ticket.total_tasks}</span>
                </div>
              ` : ''}
              <a href="/tickets/${ticket.id}/edit" class="mode-g-edit-link" onclick="event.stopPropagation()" title="Edit ticket">‚úèÔ∏è</a>
            </div>
          </div>
          <div class="mode-g-ticket-body">
            ${hasDecomposition ? renderTicketTasks(ticket) : `
              <div style="padding: 0.75rem; background: #f9fafb; border-radius: 6px; color: #6b7280; font-size: 0.85rem; text-align: center;">
                No task breakdown yet. 
                <a href="/tickets/${ticket.id}/edit#task-breakdown" style="color: #6366f1;">Generate tasks ‚Üí</a>
              </div>
            `}
          </div>
        </div>
      `;
    }
    
    container.innerHTML = html;
    
  } catch (err) {
    console.error('Failed to load sprint tickets:', err);
    container.innerHTML = `
      <div style="padding: 1rem; text-align: center; color: #ef4444;">
        Failed to load sprint tickets. <button onclick="loadModeGSprintTickets()" style="color: #6366f1; background: none; border: none; cursor: pointer; text-decoration: underline;">Retry</button>
      </div>
    `;
  }
}

function formatStatus(status) {
  const map = {
    'todo': 'To Do',
    'in_progress': 'In Progress',
    'in_review': 'In Review',
    'blocked': 'Blocked',
    'done': 'Done',
    'complete': 'Complete'
  };
  return map[status] || status;
}

// Load Mode F deployable tickets
async function loadModeFDeployableTickets() {
  const container = document.getElementById('modeFTicketsList');
  const emptyState = document.getElementById('modeFEmptyState');
  if (!container) return;
  
  try {
    const res = await fetch('/api/tickets/deployable');
    const data = await res.json();
    
    // Calculate stats
    let total = 0, inProgress = 0, prOpen = 0, deployed = 0;
    if (data.tickets) {
      total = data.tickets.length;
      for (const t of data.tickets) {
        const ds = t.deployment_status || {};
        if (ds.deployed) deployed++;
        else if (ds.pr_created && !ds.merged) prOpen++;
        else if (ds.pushed) inProgress++;
      }
    }
    
    document.getElementById('deployTotal').textContent = total;
    document.getElementById('deployInProgress').textContent = inProgress;
    document.getElementById('deployPROpen').textContent = prOpen;
    document.getElementById('deployComplete').textContent = deployed;
    
    if (!data.tickets || data.tickets.length === 0) {
      container.style.display = 'none';
      if (emptyState) emptyState.style.display = 'block';
      return;
    }
    
    container.style.display = 'block';
    if (emptyState) emptyState.style.display = 'none';
    
    let html = '';
    for (const ticket of data.tickets) {
      const ds = ticket.deployment_status || {};
      const steps = [
        { key: 'pushed', label: 'Code Pushed', icon: 'üì§', done: ds.pushed },
        { key: 'pr_created', label: 'PR Created', icon: 'üìù', done: ds.pr_created },
        { key: 'pr_reviewed', label: 'PR Reviewed', icon: 'üëÄ', done: ds.pr_reviewed },
        { key: 'merged', label: 'Merged', icon: 'üîÄ', done: ds.merged },
        { key: 'deployed', label: 'Deployed', icon: 'üöÄ', done: ds.deployed }
      ];
      
      const completedSteps = steps.filter(s => s.done).length;
      const progressPct = Math.round((completedSteps / steps.length) * 100);
      
      html += `
        <div class="mode-f-ticket-card" data-ticket-id="${ticket.id}" style="margin-bottom: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; background: white; overflow: hidden;">
          <div class="mode-f-ticket-header" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; cursor: pointer; background: ${progressPct === 100 ? '#f0fdf4' : '#f9fafb'};" onclick="toggleModeFTicket(this.parentElement)">
            <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1; min-width: 0;">
              <svg style="width: 16px; height: 16px; color: #6b7280; transition: transform 0.2s;" class="mode-f-ticket-toggle" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
              </svg>
              <span style="font-size: 0.75rem; font-weight: 600; color: #6366f1; font-family: monospace;">${escapeHtml(ticket.ticket_id)}</span>
              <span style="font-size: 0.85rem; color: #374151; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(ticket.title)}</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div style="width: 60px; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                <div style="width: ${progressPct}%; height: 100%; background: ${progressPct === 100 ? '#22c55e' : '#06b6d4'}; transition: width 0.3s;"></div>
              </div>
              <span style="font-size: 0.7rem; color: #6b7280;">${completedSteps}/5</span>
              <a href="/tickets/${ticket.id}/edit" onclick="event.stopPropagation()" style="color: #6b7280; font-size: 0.8rem;">‚úèÔ∏è</a>
            </div>
          </div>
          <div class="mode-f-ticket-body" style="display: none; padding: 0.75rem; border-top: 1px solid #e5e7eb;">
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
              ${steps.map(step => `
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer; background: ${step.done ? '#f0fdf4' : '#f9fafb'}; border: 1px solid ${step.done ? '#bbf7d0' : '#e5e7eb'}; flex: 1; min-width: 140px;">
                  <input type="checkbox" ${step.done ? 'checked' : ''} 
                         onchange="updateDeploymentStep(${ticket.id}, '${step.key}', this.checked)"
                         style="width: 16px; height: 16px; cursor: pointer;">
                  <span style="font-size: 0.85rem; color: ${step.done ? '#166534' : '#374151'};">
                    ${step.icon} ${step.label}
                  </span>
                </label>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }
    
    container.innerHTML = html;
    
  } catch (err) {
    console.error('Failed to load deployable tickets:', err);
    container.innerHTML = `
      <div style="padding: 1rem; text-align: center; color: #ef4444;">
        Failed to load deployable tickets. <button onclick="loadModeFDeployableTickets()" style="color: #06b6d4; background: none; border: none; cursor: pointer; text-decoration: underline;">Retry</button>
      </div>
    `;
  }
}

function toggleModeFTicket(card) {
  const body = card.querySelector('.mode-f-ticket-body');
  const toggle = card.querySelector('.mode-f-ticket-toggle');
  if (body.style.display === 'none') {
    body.style.display = 'block';
    toggle.style.transform = 'rotate(180deg)';
  } else {
    body.style.display = 'none';
    toggle.style.transform = 'rotate(0deg)';
  }
}

async function updateDeploymentStep(ticketId, step, status) {
  try {
    const res = await fetch(`/api/tickets/${ticketId}/deployment-status`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ step, status })
    });
    
    if (res.ok) {
      // Refresh the list to update progress
      loadModeFDeployableTickets();
    }
  } catch (err) {
    console.error('Failed to update deployment status:', err);
  }
}

// Load Mode H test plans
async function loadModeHTestPlans() {
  const container = document.getElementById('modeHTestPlansList');
  if (!container) return;
  
  try {
    const res = await fetch('/api/test-plans/sprint');
    const data = await res.json();
    
    // Update test summary stats
    const stats = { passed: 0, failed: 0, active: 0, draft: 0 };
    if (data.test_plans) {
      for (const tp of data.test_plans) {
        if (tp.status === 'passed') stats.passed++;
        else if (tp.status === 'failed') stats.failed++;
        else if (tp.status === 'active') stats.active++;
        else if (tp.status === 'draft') stats.draft++;
      }
    }
    document.getElementById('testPassed').textContent = stats.passed;
    document.getElementById('testFailed').textContent = stats.failed;
    document.getElementById('testActive').textContent = stats.active;
    document.getElementById('testDraft').textContent = stats.draft;
    
    if (!data.test_plans || data.test_plans.length === 0) {
      container.innerHTML = `
        <div style="padding: 1rem; text-align: center; color: #6b7280; background: #f9fafb; border-radius: 8px;">
          <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üß™</div>
          <div>No test plans in current sprint.</div>
          <a href="/test-plans/new" style="color: #06b6d4; font-size: 0.85rem;">Create a test plan ‚Üí</a>
        </div>
      `;
      return;
    }
    
    let html = '';
    for (const tp of data.test_plans) {
      const tasks = tp.tasks || [];
      const totalTasks = tasks.length;
      const passedTasks = tasks.filter(t => t.status === 'passed').length;
      const failedTasks = tasks.filter(t => t.status === 'failed').length;
      const progressPct = totalTasks > 0 ? Math.round(((passedTasks + failedTasks) / totalTasks) * 100) : 0;
      
      const statusColors = {
        'draft': { bg: '#f5f5f5', border: '#d4d4d4', text: '#525252' },
        'active': { bg: '#eff6ff', border: '#93c5fd', text: '#1d4ed8' },
        'passed': { bg: '#f0fdf4', border: '#bbf7d0', text: '#166534' },
        'failed': { bg: '#fef2f2', border: '#fca5a5', text: '#b91c1c' },
        'blocked': { bg: '#fefce8', border: '#fde047', text: '#a16207' }
      };
      const statusStyle = statusColors[tp.status] || statusColors.draft;
      
      html += `
        <div class="mode-h-test-card" data-test-plan-id="${tp.id}" style="margin-bottom: 0.75rem; border: 1px solid ${statusStyle.border}; border-radius: 8px; background: ${statusStyle.bg}; overflow: hidden;">
          <div class="mode-h-test-header" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; cursor: pointer;" onclick="toggleModeHTestPlan(this.parentElement)">
            <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1; min-width: 0;">
              <svg style="width: 16px; height: 16px; color: ${statusStyle.text}; transition: transform 0.2s;" class="mode-h-test-toggle" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
              </svg>
              <span style="font-size: 0.75rem; font-weight: 600; color: ${statusStyle.text}; font-family: monospace;">${escapeHtml(tp.test_plan_id)}</span>
              <span style="font-size: 0.85rem; color: #374151; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(tp.title)}</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 4px; background: ${statusStyle.text}; color: white;">${tp.status}</span>
              ${totalTasks > 0 ? `
                <div style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; color: #6b7280;">
                  <span style="color: #16a34a;">‚úì${passedTasks}</span>
                  ${failedTasks > 0 ? `<span style="color: #dc2626;">‚úó${failedTasks}</span>` : ''}
                  <span>/${totalTasks}</span>
                </div>
              ` : ''}
              <a href="/test-plans/${tp.id}/edit" onclick="event.stopPropagation()" style="color: #6b7280; font-size: 0.8rem;">‚úèÔ∏è</a>
            </div>
          </div>
          <div class="mode-h-test-body" style="display: none; padding: 0 0.75rem 0.75rem; border-top: 1px solid ${statusStyle.border};">
            ${totalTasks > 0 ? `
              <div style="margin-top: 0.5rem; padding: 0.5rem; background: white; border-radius: 6px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                  <span style="font-size: 0.75rem; color: #6b7280;">Test Progress</span>
                  <span style="font-size: 0.75rem; font-weight: 600; color: ${statusStyle.text};">${progressPct}%</span>
                </div>
                <div style="width: 100%; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                  <div style="width: ${progressPct}%; height: 100%; background: ${statusStyle.text}; transition: width 0.3s;"></div>
                </div>
              </div>
              <ul style="list-style: none; padding: 0; margin: 0.5rem 0 0; display: flex; flex-direction: column; gap: 0.25rem; max-height: 200px; overflow-y: auto;">
                ${tasks.slice(0, 10).map((task, idx) => `
                  <li style="display: flex; align-items: start; gap: 0.5rem; padding: 0.25rem 0.5rem; background: ${task.status === 'passed' ? '#f0fdf4' : task.status === 'failed' ? '#fef2f2' : '#f9fafb'}; border-radius: 4px; font-size: 0.8rem;">
                    <span style="flex-shrink: 0;">${task.status === 'passed' ? '‚úÖ' : task.status === 'failed' ? '‚ùå' : task.status === 'skipped' ? '‚äò' : '‚è≥'}</span>
                    <span style="color: ${task.status === 'passed' ? '#166534' : task.status === 'failed' ? '#b91c1c' : '#4b5563'}; word-break: break-word;">${escapeHtml(task.text)}</span>
                  </li>
                `).join('')}
                ${tasks.length > 10 ? `<li style="text-align: center; color: #6b7280; font-size: 0.75rem; padding-top: 0.25rem;">+${tasks.length - 10} more tasks</li>` : ''}
              </ul>
            ` : `
              <div style="padding: 0.75rem; background: white; border-radius: 6px; color: #6b7280; font-size: 0.85rem; text-align: center; margin-top: 0.5rem;">
                No test tasks yet. 
                <a href="/test-plans/${tp.id}/edit" style="color: #06b6d4;">Generate test tasks ‚Üí</a>
              </div>
            `}
          </div>
        </div>
      `;
    }
    
    container.innerHTML = html;
    
  } catch (err) {
    console.error('Failed to load test plans:', err);
    container.innerHTML = `
      <div style="padding: 1rem; text-align: center; color: #ef4444;">
        Failed to load test plans. <button onclick="loadModeHTestPlans()" style="color: #06b6d4; background: none; border: none; cursor: pointer; text-decoration: underline;">Retry</button>
      </div>
    `;
  }
}

function toggleModeHTestPlan(card) {
  const body = card.querySelector('.mode-h-test-body');
  const toggle = card.querySelector('.mode-h-test-toggle');
  if (body.style.display === 'none') {
    body.style.display = 'block';
    toggle.style.transform = 'rotate(180deg)';
  } else {
    body.style.display = 'none';
    toggle.style.transform = 'rotate(0deg)';
  }
}

function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]);
}

function renderTicketTasks(ticket) {
  let html = '<ul class="workflow-checklist mode-g-tasks">';
  
  for (const task of ticket.tasks) {
    const isDone = task.done;
    html += `
      <li class="workflow-checklist-item mode-g-task ${isDone ? 'completed' : ''}" 
          data-task-index="${task.index}" data-ticket-id="${ticket.id}">
        <div class="workflow-checkbox ${isDone ? 'checked' : ''}" onclick="toggleModeGTask(this)"></div>
        <div class="workflow-checklist-content" style="flex: 1;">
          <div class="workflow-checklist-title" style="display: flex; align-items: center; gap: 0.5rem;">
            <span>${escapeHtml(task.title)}</span>
            ${task.description ? `
              <button class="mode-g-expand-btn" onclick="event.stopPropagation(); toggleTaskDetails(this)" title="Show details">
                <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </button>
            ` : ''}
          </div>
          ${task.description ? `
            <div class="mode-g-task-details" style="display: none;">
              <div class="workflow-checklist-desc" style="margin-top: 0.5rem; padding: 0.5rem; background: #f8fafc; border-radius: 6px; border-left: 3px solid #6366f1;">
                ${escapeHtml(task.description)}
              </div>
            </div>
          ` : ''}
        </div>
      </li>
    `;
  }
  
  html += '</ul>';
  html += `
    <div style="margin-top: 0.75rem; text-align: right;">
      <a href="/tickets/${ticket.id}/edit#task-breakdown" style="font-size: 0.8rem; color: #6366f1; text-decoration: none;">
        Edit tasks ‚Üí
      </a>
    </div>
  `;
  
  return html;
}

function updateWorkflowProgress(mode) {
  const modeContent = document.querySelector(`.workflow-mode-content[data-mode="${mode}"]`);
  if (!modeContent) return;
  
  const checkboxes = modeContent.querySelectorAll('.workflow-checkbox');
  const checked = modeContent.querySelectorAll('.workflow-checkbox.checked').length;
  const total = checkboxes.length;
  const percent = total > 0 ? Math.round((checked / total) * 100) : 0;
  
  const progressFill = modeContent.querySelector('.workflow-progress-fill');
  const progressText = modeContent.querySelector('.workflow-progress-text');
  
  if (progressFill) progressFill.style.width = percent + '%';
  if (progressText) progressText.textContent = `${checked} of ${total} complete`;
}

function saveWorkflowProgress(mode) {
  const modeContent = document.querySelector(`.workflow-mode-content[data-mode="${mode}"]`);
  if (!modeContent) return;
  
  const checkboxes = modeContent.querySelectorAll('.workflow-checkbox');
  const progress = [];
  checkboxes.forEach((cb, index) => {
    progress.push(cb.classList.contains('checked'));
  });
  
  localStorage.setItem(`workflow-progress-${mode}`, JSON.stringify(progress));
  
  // Sync to server
  fetch('/api/settings/workflow-progress', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'same-origin',
    body: JSON.stringify({ mode, progress })
  }).catch(() => {});
  
  // Check if all tasks are complete and trigger celebration
  if (progress.length > 0 && progress.every(Boolean)) {
    checkWorkflowCompletion(mode, progress);
  }
}

// Check if workflow is complete and celebrate if done early
async function checkWorkflowCompletion(mode, progress) {
  // Get elapsed time in this mode session from localStorage or tracking
  const trackingStart = localStorage.getItem('signalflow-tracking-start');
  const trackingMode = localStorage.getItem('signalflow-tracking-mode');
  
  let elapsedSeconds = 0;
  if (trackingStart && trackingMode === mode) {
    elapsedSeconds = Math.floor((Date.now() - parseInt(trackingStart)) / 1000);
  }
  
  // Don't celebrate if already celebrated for this mode in this sprint
  const celebratedKey = `celebrated-${mode}-${new Date().toISOString().slice(0, 10)}`;
  if (localStorage.getItem(celebratedKey)) {
    return;
  }
  
  try {
    const response = await fetch('/api/workflow/check-completion', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ mode, progress, elapsed_seconds: elapsedSeconds })
    });
    
    if (response.ok) {
      const data = await response.json();
      
      if (data.complete) {
        // Mark as celebrated to prevent repeat
        localStorage.setItem(celebratedKey, 'true');
        
        if (data.celebrate) {
          // Show confetti and celebration toast for early completion
          showCelebration(data.time_saved_minutes);
        } else {
          // Just show a subtle completion notice
          showCompletionNotice(mode);
        }
      }
    }
  } catch (err) {
    console.error('Failed to check workflow completion:', err);
  }
}

// Show confetti celebration for early completion
function showCelebration(timeSavedMinutes) {
  // Create confetti container
  const container = document.createElement('div');
  container.className = 'confetti-container';
  container.id = 'confettiContainer';
  
  // Create 100 confetti pieces
  for (let i = 0; i < 100; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = Math.random() * 100 + '%';
    confetti.style.animationDelay = Math.random() * 2 + 's';
    confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
    // Random shapes
    const shapes = ['circle', 'square', 'triangle'];
    const shape = shapes[Math.floor(Math.random() * shapes.length)];
    if (shape === 'circle') confetti.style.borderRadius = '50%';
    else if (shape === 'triangle') {
      confetti.style.width = '0';
      confetti.style.height = '0';
      confetti.style.borderLeft = '5px solid transparent';
      confetti.style.borderRight = '5px solid transparent';
      confetti.style.borderBottom = '10px solid ' + confetti.style.background;
      confetti.style.background = 'transparent';
    }
    container.appendChild(confetti);
  }
  document.body.appendChild(container);
  
  // Create celebration toast
  const toast = document.createElement('div');
  toast.className = 'celebration-toast';
  toast.innerHTML = `
    <h2>üéâ Amazing!</h2>
    <p>You crushed this mode!</p>
    ${timeSavedMinutes > 0 ? `<div class="time-saved">‚è±Ô∏è ${timeSavedMinutes} min ahead of schedule!</div>` : ''}
  `;
  document.body.appendChild(toast);
  
  // Play a subtle sound if available
  try {
    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleVl7e4Wfpq+yrKSalH1uX1pbZXWEk6Cora+toJaDcGA=');
    audio.volume = 0.3;
    audio.play().catch(() => {});
  } catch (e) {}
  
  // Remove after animation
  setTimeout(() => {
    toast.classList.add('fade-out');
    setTimeout(() => {
      container.remove();
      toast.remove();
    }, 500);
  }, 3500);
}

// Show subtle completion notice (not early)
function showCompletionNotice(mode) {
  const modeNames = {
    'mode-a': 'Context Distillation',
    'mode-b': 'Implementation Planning',
    'mode-c': 'Assisted Draft Intake',
    'mode-d': 'Deep Review',
    'mode-e': 'Promotion Readiness',
    'mode-f': 'Controlled Sync',
    'mode-g': 'Execution',
  };
  
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    z-index: 9999;
    animation: slideIn 0.3s ease-out;
  `;
  toast.innerHTML = `‚úÖ ${modeNames[mode] || mode} complete!`;
  
  // Add animation keyframes
  if (!document.getElementById('slideInStyle')) {
    const style = document.createElement('style');
    style.id = 'slideInStyle';
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
    `;
    document.head.appendChild(style);
  }
  
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

function loadWorkflowProgress(mode) {
  const stored = localStorage.getItem(`workflow-progress-${mode}`);
  if (!stored) return;
  
  try {
    const progress = JSON.parse(stored);
    const modeContent = document.querySelector(`.workflow-mode-content[data-mode="${mode}"]`);
    if (!modeContent) return;
    
    const checkboxes = modeContent.querySelectorAll('.workflow-checkbox');
    checkboxes.forEach((cb, index) => {
      if (progress[index]) cb.classList.add('checked');
    });
    
    updateWorkflowProgress(mode);
  } catch (e) {}
}

function resetAllModes() {
  if (!confirm('Reset all mode checkboxes for a new sprint? This will clear all progress for modes A-G.')) {
    return;
  }
  
  const modes = ['mode-a', 'mode-b', 'mode-c', 'mode-d', 'mode-e', 'mode-f', 'mode-g'];
  
  modes.forEach(mode => {
    // Clear localStorage
    localStorage.removeItem(`workflow-progress-${mode}`);
    
    // Uncheck all checkboxes in the UI
    const modeContent = document.querySelector(`.workflow-mode-content[data-mode="${mode}"]`);
    if (modeContent) {
      const checkboxes = modeContent.querySelectorAll('.workflow-checkbox');
      checkboxes.forEach(cb => cb.classList.remove('checked'));
    }
  });
  
  // Reset to Mode A
  localStorage.setItem('signalflow-mode', 'mode-a');
  document.body.setAttribute('data-mode', 'mode-a');
  
  // Update UI
  const currentMode = 'mode-a';
  updateWorkflowPanel(currentMode);
  updateWorkflowProgress(currentMode);
  
  if (typeof updateModeDisplay === 'function') {
    updateModeDisplay();
  }
  
  // Sync reset to server
  fetch('/api/settings/reset-workflow-progress', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'same-origin'
  }).catch(() => {});
  
  showToast('Sprint Reset', 'All mode checkboxes have been reset for the new sprint', 'success');
}

function advanceWorkflow() {
  const currentMode = localStorage.getItem('signalflow-mode') || 'mode-a';
  const modes = ['mode-a', 'mode-b', 'mode-c', 'mode-d', 'mode-e', 'mode-g', 'mode-h', 'mode-f'];
  const currentIndex = modes.indexOf(currentMode);
  const nextIndex = (currentIndex + 1) % modes.length;
  const nextMode = modes[nextIndex];
  
  // Update mode in localStorage and UI
  localStorage.setItem('signalflow-mode', nextMode);
  document.body.setAttribute('data-mode', nextMode);
  
  // Update mode indicator in header
  if (typeof updateModeDisplay === 'function') {
    updateModeDisplay();
  }
  
  // Dispatch custom event for mode change
  document.dispatchEvent(new CustomEvent('modeChanged', { detail: { mode: nextMode } }));
  
  // Update workflow panel
  updateWorkflowPanel(nextMode);
  loadWorkflowProgress(nextMode);
}

function previousWorkflow() {
  const currentMode = localStorage.getItem('signalflow-mode') || 'mode-a';
  const modes = ['mode-a', 'mode-b', 'mode-c', 'mode-d', 'mode-e', 'mode-g', 'mode-h', 'mode-f'];
  const currentIndex = modes.indexOf(currentMode);
  const prevIndex = currentIndex <= 0 ? modes.length - 1 : currentIndex - 1;
  const prevMode = modes[prevIndex];
  
  // Update mode in localStorage and UI
  localStorage.setItem('signalflow-mode', prevMode);
  document.body.setAttribute('data-mode', prevMode);
  
  // Update mode indicator in header
  if (typeof updateModeDisplay === 'function') {
    updateModeDisplay();
  }
  
  // Dispatch custom event for mode change
  document.dispatchEvent(new CustomEvent('modeChanged', { detail: { mode: prevMode } }));
  
  // Update workflow panel
  updateWorkflowPanel(prevMode);
  loadWorkflowProgress(prevMode);
}

// Listen for mode changes from the header
window.addEventListener('storage', (e) => {
  if (e.key === 'signalflow-mode') {
    updateWorkflowPanel(e.newValue);
    loadWorkflowProgress(e.newValue);
  }
});

// Also listen for custom mode change events
document.addEventListener('modeChanged', (e) => {
  const mode = e.detail?.mode || localStorage.getItem('signalflow-mode') || 'mode-a';
  updateWorkflowPanel(mode);
  loadWorkflowProgress(mode);
  
  // Load Mode F deployable tickets when switching to mode-f
  if (mode === 'mode-f') {
    loadModeFDeployableTickets();
  }
  
  // Load Mode G sprint tickets when switching to mode-g
  if (mode === 'mode-g') {
    loadModeGSprintTickets();
  }
  
  // Load Mode H test plans when switching to mode-h
  if (mode === 'mode-h') {
    loadModeHTestPlans();
  }
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
  // Load workflow modes from API first, then initialize panel
  loadWorkflowModesFromAPI().then(() => {
    initWorkflowPanel();
  });
  
  // Restore collapsed state - default to collapsed if no preference
  const workflowCollapsed = localStorage.getItem('workflow-panel-collapsed');
  if (workflowCollapsed === null || workflowCollapsed === 'true') {
    const content = document.getElementById('workflowContent');
    const panel = document.getElementById('workflowPanel');
    if (content) content.style.display = 'none';
    const btn = panel?.querySelector('.workflow-btn:first-child');
    if (btn) btn.textContent = 'Expand';
    // Save default preference
    if (workflowCollapsed === null) {
      localStorage.setItem('workflow-panel-collapsed', 'true');
    }
  }
  
  // Initialize attention section
  initAttentionSection();
  
  // Initialize Mode F/G/H progress based on current mode
  const currentMode = localStorage.getItem('signalflow-mode') || 'mode-a';
  if (currentMode === 'mode-f') {
    loadModeFDeployableTickets();
  }
  if (currentMode === 'mode-g') {
    loadModeGSprintTickets();
  }
  if (currentMode === 'mode-h') {
    loadModeHTestPlans();
  }
  
  // Load career suggestions
  const careerLimit = localStorage.getItem('career-suggestion-limit');
  const careerInput = document.getElementById('careerLimit');
  if (careerInput && careerLimit) {
    careerInput.value = careerLimit;
  }
  initCareerContextToggle();
  updateCareerLimitLabel();
  loadCareerSuggestions();
  loadCareerSummary();
});

// ============================================
// Career Development Functions
// ============================================

function getCareerLimit() {
  const stored = localStorage.getItem('career-suggestion-limit');
  const input = document.getElementById('careerLimit');
  const limit = Number(stored || (input ? input.value : 10));
  return Number.isFinite(limit) ? limit : 10;
}

function updateCareerLimitLabel() {
  const input = document.getElementById('careerLimit');
  const label = document.getElementById('careerLimitLabel');
  if (!input || !label) return;
  label.textContent = input.value;
  localStorage.setItem('career-suggestion-limit', input.value);
}

function initCareerContextToggle() {
  const toggle = document.getElementById('careerContextToggle');
  if (!toggle) return;
  const stored = localStorage.getItem('career-context-overlay');
  if (stored !== null) {
    toggle.checked = stored === 'true';
  }
  toggle.addEventListener('change', () => {
    localStorage.setItem('career-context-overlay', String(toggle.checked));
  });
}

async function loadCareerSuggestions() {
  const container = document.getElementById('careerSuggestions');
  if (!container) return;
  updateCareerLimitLabel();
  const limit = getCareerLimit();
  
  try {
    const response = await fetch(`/api/career/suggestions?limit=${limit}`, {
      credentials: 'same-origin'
    });
    
    if (!response.ok) throw new Error('Failed to load');
    
    const suggestions = await response.json();
    
    if (suggestions.length === 0) {
      container.innerHTML = '<div class="career-loading">No suggestions yet. Click "Generate New Ideas" to get started!</div>';
      return;
    }
    
    container.innerHTML = suggestions.map(s => `
      <div class="career-suggestion ${s.suggestion_type}" data-suggestion-id="${s.id}" data-suggestion-status="${s.status || 'suggested'}">
        <div class="career-suggestion-header">
          <span class="career-badge ${s.suggestion_type}">${formatSuggestionType(s.suggestion_type)}</span>
          <span class="career-status ${s.status || 'suggested'}">${(s.status || 'suggested').replace('_', ' ')}</span>
          ${s.suggestion_type === 'stretch' ? '<span style="font-size: 1.2rem;" title="Stretch / Growth Opportunity">üéØ</span>' : ''}
        </div>
        <div class="career-suggestion-title">${s.title}</div>
        <div class="career-suggestion-description">${s.description}</div>
        <div class="career-suggestion-meta">
          <div class="career-meta-item">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="14" height="14">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
            ${s.difficulty}
          </div>
          <div class="career-meta-item">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="14" height="14">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            ${s.time_estimate}
          </div>
        </div>
        ${s.rationale ? `<div style="font-size: 0.85rem; color: #4b5563; font-style: italic; margin-bottom: 0.5rem;">üí° ${s.rationale}</div>` : ''}
        <div class="career-suggestion-actions">
          <button class="career-action-btn accept" onclick="updateCareerStatus(${s.id}, 'accepted')" title="Accept this suggestion">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
            Accept
          </button>
          <button class="career-action-btn to-ticket" onclick="convertCareerToTicket(${s.id})" title="Create a task from this">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
            Create Task
          </button>
          <button class="career-action-btn dismiss" onclick="updateCareerStatus(${s.id}, 'dismissed')" title="Not interested">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            Dismiss
          </button>
        </div>
      </div>
    `).join('');
    
  } catch (err) {
    console.error('Failed to load career suggestions:', err);
    container.innerHTML = '<div class="career-loading">Failed to load suggestions. Try refreshing.</div>';
  }
}

async function loadCareerSummary() {
  const summaryEl = document.getElementById('careerSummary');
  if (!summaryEl) return;

  try {
    const response = await fetch('/api/career/chat/summary', { credentials: 'same-origin' });
    if (!response.ok) throw new Error('Failed to load summary');
    const data = await response.json();
    if (data.summary) {
      summaryEl.style.display = 'block';
      summaryEl.innerHTML = `<h4>Career Status Summary</h4>${marked.parse(data.summary)}`;
    } else {
      summaryEl.style.display = 'none';
      summaryEl.innerHTML = '';
    }
  } catch (err) {
    summaryEl.style.display = 'none';
  }
}

function openCareerChat() {
  const modal = document.getElementById('careerChatModal');
  if (!modal) return;
  modal.classList.add('active');
  loadCareerChatHistory();
}

function closeCareerChat() {
  const modal = document.getElementById('careerChatModal');
  if (!modal) return;
  modal.classList.remove('active');
}

async function loadCareerChatHistory() {
  const body = document.getElementById('careerChatBody');
  if (!body) return;
  body.innerHTML = '<div class="career-loading">Loading career status...</div>';

  try {
    const response = await fetch('/api/career/chat/history', { credentials: 'same-origin' });
    if (!response.ok) throw new Error('Failed to load history');
    const history = await response.json();
    if (!history.length) {
      body.innerHTML = '<div class="career-loading">No updates yet. Share a status to get started.</div>';
      return;
    }
    body.innerHTML = history.map(item => `
      <div class="career-chat-message user">${marked.parse(item.message)}</div>
      <div class="career-chat-message assistant">${marked.parse(item.response)}</div>
    `).join('');
    body.scrollTop = body.scrollHeight;
  } catch (err) {
    body.innerHTML = '<div class="career-loading">Failed to load updates.</div>';
  }
}

async function sendCareerChatMessage() {
  const input = document.getElementById('careerChatInput');
  const body = document.getElementById('careerChatBody');
  if (!input || !body) return;

  const message = input.value.trim();
  if (!message) return;
  input.value = '';

  body.innerHTML += `<div class="career-chat-message user">${marked.parse(message)}</div>`;
  const pending = document.createElement('div');
  pending.className = 'career-chat-message assistant';
  pending.textContent = 'Thinking...';
  body.appendChild(pending);
  body.scrollTop = body.scrollHeight;

  try {
    const includeContext = document.getElementById('careerContextToggle')?.checked !== false;
    const response = await fetch('/api/career/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ message, include_context: includeContext })
    });
    if (!response.ok) throw new Error('Failed to send');
    const data = await response.json();
    pending.innerHTML = marked.parse(data.response || '');
    body.scrollTop = body.scrollHeight;
    await loadCareerSummary();
  } catch (err) {
    pending.textContent = 'Failed to send update.';
  }
}

document.addEventListener('click', (event) => {
  const modal = document.getElementById('careerChatModal');
  if (modal && event.target === modal) {
    closeCareerChat();
  }
});

function formatSuggestionType(type) {
  const labels = {
    'stretch': 'Stretch Goal',
    'skill_building': 'Skill Building',
    'project': 'Project',
    'learning': 'Learning'
  };
  return labels[type] || type;
}

async function generateCareerSuggestions() {
  const container = document.getElementById('careerSuggestions');
  if (!container) return;
  const button = document.getElementById('careerGenerateBtn');
  if (button) {
    button.classList.add('loading');
    button.disabled = true;
    button.dataset.originalText = button.innerHTML;
    button.innerHTML = '<span class="spinner"></span> Generating...';
  }
  
  container.innerHTML = '<div class="career-loading">ü§ñ AI is generating personalized growth opportunities...</div>';
  
  try {
    const includeContext = document.getElementById('careerContextToggle')?.checked !== false;
    const response = await fetch('/api/career/generate-suggestions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ include_context: includeContext })
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Failed to generate suggestions');
    }
    
    const result = await response.json();
    showToast('Success', `Generated ${result.count} new career suggestions!`, 'success');
    
    // Reload suggestions
    await loadCareerSuggestions();
    
  } catch (err) {
    console.error('Failed to generate suggestions:', err);
    showToast('Error', err.message || 'Failed to generate suggestions', 'error');
    container.innerHTML = '<div class="career-loading">Failed to generate. Please try again.</div>';
  } finally {
    if (button) {
      button.classList.remove('loading');
      button.disabled = false;
      button.innerHTML = button.dataset.originalText || 'Generate New Ideas';
    }
  }
}

async function updateCareerStatus(suggestionId, status) {
  try {
    const response = await fetch(`/api/career/suggestions/${suggestionId}/status`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ status })
    });
    
    if (!response.ok) throw new Error('Failed to update');
    
    showToast('Updated', `Suggestion ${status}`, 'success');

    const element = document.querySelector(`[data-suggestion-id="${suggestionId}"]`);
    if (element) {
      element.dataset.suggestionStatus = status;
      const badge = element.querySelector('.career-status');
      if (badge) {
        badge.textContent = status.replace('_', ' ');
        badge.className = `career-status ${status}`;
      }
    }
    
  } catch (err) {
    showToast('Error', 'Failed to update suggestion', 'error');
  }
}

async function convertCareerToTicket(suggestionId) {
  try {
    const response = await fetch(`/api/career/suggestions/${suggestionId}/to-ticket`, {
      method: 'POST',
      credentials: 'same-origin'
    });
    
    if (!response.ok) throw new Error('Failed to convert');
    
    const result = await response.json();
    showToast('Task Created', `Created task ${result.ticket_id}`, 'success');
    
    // Update button to show it's converted
    const element = document.querySelector(`[data-suggestion-id="${suggestionId}"]`);
    if (element) {
      const actions = element.querySelector('.career-suggestion-actions');
      actions.innerHTML = `
        <a href="/tickets/${result.ticket_db_id}/edit" class="career-action-btn to-ticket" style="text-decoration: none;">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
          View Task
        </a>
      `;
      const badge = element.querySelector('.career-status');
      if (badge) {
        badge.textContent = 'accepted';
        badge.className = 'career-status accepted';
      }
    }
    
  } catch (err) {
    showToast('Error', 'Failed to create task', 'error');
  }
}

// ============================================
// Collapsible Box & Attention Section Functions
// ============================================

function toggleBoxCollapse(box) {
  const boxId = box.dataset.boxId;
  box.classList.toggle('collapsed');
  
  // Save collapsed state
  const collapsedBoxes = JSON.parse(localStorage.getItem('collapsed-boxes') || '{}');
  collapsedBoxes[boxId] = box.classList.contains('collapsed');
  localStorage.setItem('collapsed-boxes', JSON.stringify(collapsedBoxes));
}

// Initialize attention section on page load
function initAttentionSection() {
  // Restore collapsed boxes, with DIKW collapsed by default
  const collapsedBoxes = JSON.parse(localStorage.getItem('collapsed-boxes') || '{}');
  
  // Default DIKW to collapsed if no preference set
  if (collapsedBoxes['dikw'] === undefined) {
    collapsedBoxes['dikw'] = true;
    localStorage.setItem('collapsed-boxes', JSON.stringify(collapsedBoxes));
  }
  
  document.querySelectorAll('.collapsible-box').forEach(box => {
    if (collapsedBoxes[box.dataset.boxId]) {
      box.classList.add('collapsed');
    }
  });
  
  // Auto-refresh coaching suggestions on page load (silent, no toast)
  refreshAttention(true);
}

// Refresh the attention section
async function refreshAttention(suppressToast = false) {
  const btn = document.querySelector('#attentionSection .refresh-btn');
  const section = document.getElementById('attentionSection');
  const content = document.getElementById('attentionContent');
  
  if (btn) btn.classList.add('spinning');
  
  try {
    // Pass dismissed IDs to the API so it filters them out
    const dismissedItems = JSON.parse(localStorage.getItem('dismissed-highlights-v2') || '[]');
    const dismissedParam = dismissedItems.join(',');

    const response = await fetch(`/api/dashboard/highlights?dismissed=${encodeURIComponent(dismissedParam)}`, { credentials: 'same-origin' });
    if (!response.ok) {
      const errText = await response.text();
      throw new Error(`Failed to fetch highlights: ${response.status} - ${errText}`);
    }
    
    const data = await response.json();
    
    if (content) {
      if (data.highlights && data.highlights.length > 0) {
        // Filter out items snoozed for the current sprint
        const snoozedForSprint = getSnoozedHighlightsForCurrentSprint();
        const visibleHighlights = data.highlights.filter((h) => !snoozedForSprint.includes(String(h.id)));

        if (visibleHighlights.length === 0) {
          content.innerHTML = `
          <div class="empty-attention" style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--sf-text-muted);">
            <p style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚ú®</p>
            <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">You're all caught up for this sprint!</p>
            <p style="font-size: 0.85rem;">Snoozed suggestions will return next sprint.</p>
          </div>
        `;
        } else {
          content.innerHTML = visibleHighlights.map((h) => {
          // Ensure link is a string (in case it comes as object)
          const linkUrl = typeof h.link === 'string' ? h.link : (h.link ? JSON.stringify(h.link) : '');
          // Store link in data attribute to avoid onclick injection issues
          return `
            <div class="highlight-item ${h.type}" data-highlight-id="${h.id}" data-link="${linkUrl.replace(/"/g, '&quot;')}" onclick="navigateHighlight(event, this)">
              <div class="highlight-header">
                <div class="highlight-label">${h.label || ''}</div>
                <div class="highlight-actions">
                  <button class="highlight-action-btn snooze-btn" onclick="snoozeHighlight(event, this)" title="Snooze for this sprint">
                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m4-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  </button>
                  <button class="highlight-action-btn dismiss-btn" onclick="dismissHighlight(event, this)" title="Got it! Don't show again">
                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                  </button>
                </div>
              </div>
              <div class="highlight-text">${h.text || ''}</div>
              <div class="highlight-action-hint">${h.action || ''}</div>
              <div class="highlight-cta">
                <span class="highlight-link">${h.link_text || 'View'} ‚Üí</span>
              </div>
            </div>
          `;
        }).join('');
        }
        
        // Auto-expand section if it was collapsed and we found items
        if (section && section.classList.contains('collapsed')) {
          section.classList.remove('collapsed');
          const collapsedBoxes = JSON.parse(localStorage.getItem('collapsed-boxes') || '{}');
          collapsedBoxes['attention'] = false;
          localStorage.setItem('collapsed-boxes', JSON.stringify(collapsedBoxes));
        }
        
        const count = document.querySelectorAll('.highlight-item').length;
        if (!suppressToast) {
          showToast('Refreshed', `Found ${count} item(s) needing attention`, 'success');
        }
      } else {
        content.innerHTML = `
          <div class="empty-attention" style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--sf-text-muted);">
            <p style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚ú®</p>
            <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">You're all caught up!</p>
            <p style="font-size: 0.85rem;">No coaching suggestions right now. Keep up the great work!</p>
          </div>
        `;
      }
      updateAttentionCount();
    }
  } catch (err) {
    console.error('Failed to refresh attention:', err);
    // Show a more helpful error state
    const content = document.getElementById('attentionContent');
    if (content) {
      content.innerHTML = `
        <div class="empty-attention" style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--sf-text-muted);">
          <p style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚ö†Ô∏è</p>
          <p style="font-size: 0.9rem; margin-bottom: 0.5rem;">Could not load suggestions</p>
          <p style="font-size: 0.8rem;">${err.message || 'Click refresh to try again'}</p>
        </div>
      `;
    }
    updateAttentionCount();
  } finally {
    if (btn) btn.classList.remove('spinning');
  }
}

// Navigate when clicking a highlight card
function navigateHighlight(event, element) {
  // Don't navigate if clicking the dismiss button
  if (event.target.closest('.dismiss-btn') || event.target.closest('.snooze-btn')) return;
  const link = element.dataset.link;
  if (link) {
    window.location.href = link;
  }
}

// Toggle show/hide dismissed items (removed - dismissals are now permanent)
function toggleSeenItems() {
  // Clear all dismissed items to start fresh
  if (confirm('Clear all dismissed items and refresh?')) {
    localStorage.removeItem('dismissed-highlights-v2');
    refreshAttention();
    showToast('Reset', 'Dismissed items cleared', 'info');
  }
}

// Dismiss a highlight item (permanently by ID)
function dismissHighlight(event, btn) {
  event.stopPropagation();
  const item = btn.closest('.highlight-item');
  const id = item.dataset.highlightId;
  
  // Save to localStorage by unique ID
  const dismissedItems = JSON.parse(localStorage.getItem('dismissed-highlights-v2') || '[]');
  if (!dismissedItems.includes(id)) {
    dismissedItems.push(id);
    localStorage.setItem('dismissed-highlights-v2', JSON.stringify(dismissedItems));
  }
  
  // Animate out
  item.style.transition = 'all 0.3s ease';
  item.style.transform = 'scale(0.9)';
  item.style.opacity = '0';
  
  setTimeout(() => {
    item.remove();
    updateAttentionCount();
    
    // Check if we should show "all clear" message
    const remaining = document.querySelectorAll('.highlight-item').length;
    if (remaining === 0) {
      const content = document.getElementById('attentionContent');
      if (content) {
        content.innerHTML = `
          <div class="empty-attention" style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--sf-text-muted);">
            <p style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚ú®</p>
            <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">You're all caught up!</p>
            <p style="font-size: 0.85rem;">Click refresh to check for new suggestions.</p>
          </div>
        `;
      }
    }
  }, 300);
  
  showToast('Got it!', 'Suggestion dismissed', 'success');
}

// Helpers for sprint-based snoozing
function getCurrentSprintKey() {
  const dashboard = document.getElementById('dashboard');
  return (dashboard && dashboard.dataset.sprintKey) ? dashboard.dataset.sprintKey : 'no-sprint';
}

function getSnoozedHighlightsStore() {
  try {
    const raw = localStorage.getItem('snoozed-highlights-by-sprint-v1') || '{}';
    const parsed = JSON.parse(raw);
    return parsed && typeof parsed === 'object' ? parsed : {};
  } catch (e) {
    console.warn('Failed to parse snoozed highlights store', e);
    return {};
  }
}

function saveSnoozedHighlightsStore(store) {
  localStorage.setItem('snoozed-highlights-by-sprint-v1', JSON.stringify(store || {}));
}

function getSnoozedHighlightsForCurrentSprint() {
  const key = getCurrentSprintKey();
  const store = getSnoozedHighlightsStore();
  const list = store[key];
  return Array.isArray(list) ? list.map(String) : [];
}

function addSnoozedHighlightForCurrentSprint(id) {
  const key = getCurrentSprintKey();
  const store = getSnoozedHighlightsStore();
  const current = Array.isArray(store[key]) ? store[key].map(String) : [];
  const idStr = String(id);
  if (!current.includes(idStr)) {
    current.push(idStr);
    store[key] = current;
    saveSnoozedHighlightsStore(store);
  }
}

// Snooze a highlight for the current sprint only
function snoozeHighlight(event, btn) {
  event.stopPropagation();
  const item = btn.closest('.highlight-item');
  const id = item.dataset.highlightId;

  addSnoozedHighlightForCurrentSprint(id);

  item.style.transition = 'all 0.3s ease';
  item.style.transform = 'scale(0.9)';
  item.style.opacity = '0';

  setTimeout(() => {
    item.remove();
    updateAttentionCount();

    const remaining = document.querySelectorAll('.highlight-item').length;
    if (remaining === 0) {
      const content = document.getElementById('attentionContent');
      if (content) {
        content.innerHTML = `
          <div class="empty-attention" style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--sf-text-muted);">
            <p style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚ú®</p>
            <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">You're all caught up for this sprint!</p>
            <p style="font-size: 0.85rem;">Snoozed suggestions will return next sprint.</p>
          </div>
        `;
      }
    }
  }, 300);

  showToast('Snoozed', 'We will remind you next sprint', 'info');
}

// Update the attention count badge
function updateAttentionCount() {
  const badge = document.getElementById('attentionCount');
  if (!badge) return;
  
  const total = document.querySelectorAll('.highlight-item').length;
  const dismissed = document.querySelectorAll('.highlight-item.dismissed').length;
  const active = total - dismissed;
  
  badge.textContent = active;
  badge.style.opacity = '1';
  badge.style.background = active > 0 ? '#ef4444' : '#6b7280';
}

// Drill down into a highlight item to see more context
async function drillDown(btn) {
  const item = btn.closest('.highlight-item');
  const drilldown = item.querySelector('.highlight-drilldown');
  const content = drilldown.querySelector('.drilldown-content');
  const loading = drilldown.querySelector('.drilldown-loading');
  
  // Toggle visibility
  const isOpen = btn.classList.contains('active');
  
  if (isOpen) {
    btn.classList.remove('active');
    drilldown.style.display = 'none';
    return;
  }
  
  btn.classList.add('active');
  drilldown.style.display = 'block';
  loading.style.display = 'block';
  content.innerHTML = '';
  
  // Get meeting source and highlight text
  const meetingSource = item.dataset.meetingSource;
  const meetingId = item.dataset.meetingId;
  const highlightText = item.querySelector('.highlight-text').textContent;
  
  console.log('drillDown:', { meetingSource, meetingId, highlightText: highlightText.substring(0, 50) });
  
  try {
    // Fetch context for this highlight
    const response = await fetch('/api/dashboard/highlight-context', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({
        source: meetingSource,
        text: highlightText,
        meeting_id: meetingId || null
      })
    });
    
    console.log('Context response status:', response.status);
    
    if (!response.ok) throw new Error(`Failed to load context: ${response.status}`);
    
    const raw = await response.text();
    console.log('Context raw response:', raw.substring(0, 200));
    
    let data;
    try {
      data = JSON.parse(raw);
    } catch (e) {
      throw new Error('Invalid JSON response');
    }
    loading.style.display = 'none';
    
    // Build drilldown UI with progressive levels
    let html = '';
    
    if (data.summary) {
      html += `
        <div class="drilldown-level" onclick="toggleDrilldownLevel(this)">
          <div class="drilldown-level-header">
            <span>‚ñº</span> üìã Summary
          </div>
          <div class="drilldown-level-content">${data.summary}</div>
        </div>
      `;
    }
    
    if (data.context) {
      html += `
        <div class="drilldown-level collapsed" onclick="toggleDrilldownLevel(this)">
          <div class="drilldown-level-header">
            <span>‚ñ∂</span> üìù Full Context
          </div>
          <div class="drilldown-level-content">${data.context}</div>
        </div>
      `;
    }
    
    if (data.transcript) {
      html += `
        <div class="drilldown-level collapsed" onclick="toggleDrilldownLevel(this)">
          <div class="drilldown-level-header">
            <span>‚ñ∂</span> üéôÔ∏è Transcript Excerpt
          </div>
          <div class="drilldown-level-content">
            <div class="drilldown-transcript">${data.transcript}</div>
          </div>
        </div>
      `;
    }
    
    if (data.meeting_link) {
      html += `
        <div style="margin-top: 0.75rem;">
          <a href="${data.meeting_link}" style="font-size: 0.85rem; color: var(--sf-link);">
            View full meeting ‚Üí
          </a>
        </div>
      `;
    }
    
    content.innerHTML = html || '<div style="color: var(--sf-text-muted); padding: 0.5rem;">No additional context available.</div>';
    
  } catch (err) {
    loading.style.display = 'none';
    content.innerHTML = '<div style="color: var(--sf-error); padding: 0.5rem;">Could not load context.</div>';
    console.error('Failed to load context:', err);
  }
}

// Toggle drilldown level expand/collapse
function toggleDrilldownLevel(level) {
  event.stopPropagation();
  level.classList.toggle('collapsed');
  const arrow = level.querySelector('.drilldown-level-header span');
  if (arrow) {
    arrow.textContent = level.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
  }
}

// =====================
// Career Hub Functions
// =====================

// Standup Functions
function toggleStandupForm() {
  const form = document.getElementById('standupForm');
  const isHidden = form.style.display === 'none';
  form.style.display = isHidden ? 'block' : 'none';
  if (isHidden) {
    // Set default date to today when opening form
    setStandupDateToday();
  }
}

function setStandupDateToday() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('standupDate').value = today;
}

async function loadStandups() {
  try {
    // Load today's standup
    const todayRes = await fetch('/api/career/standups/today');
    const todayData = await todayRes.json();
    
    const display = document.getElementById('standupDisplay');
    
    if (todayData && todayData.id) {
      // Show today's standup
      display.innerHTML = `
        <div class="standup-item">
          <div class="date">
            Today
            <span class="sentiment ${todayData.sentiment || 'neutral'}">${todayData.sentiment || 'neutral'}</span>
          </div>
          <div class="content">${todayData.content}</div>
          ${todayData.feedback ? `<div class="standup-feedback">${todayData.feedback}</div>` : ''}
        </div>
      `;
    } else {
      display.innerHTML = `
        <div class="empty-section" style="text-align: center; padding: 1.5rem;">
          <p style="color: var(--sf-text-muted); margin-bottom: 0.75rem;">No standup for today</p>
          <button onclick="toggleStandupForm()" style="background: var(--sf-primary, #667eea); color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer;">
            Add Today's Standup
          </button>
        </div>
      `;
    }
    
    // Load recent standups
    const recentRes = await fetch('/api/career/standups?limit=5');
    const standups = await recentRes.json();
    
    const recentSection = document.getElementById('recentStandups');
    const recentList = document.getElementById('recentStandupsList');
    
    // Filter out today's standup
    const recentOnly = standups.filter(s => s.id !== todayData?.id).slice(0, 3);
    
    if (recentOnly.length > 0) {
      recentSection.style.display = 'block';
      recentList.innerHTML = recentOnly.map(s => `
        <div class="standup-item" style="padding: 0.5rem; font-size: 0.85rem;">
          <div class="date">${s.standup_date} <span class="sentiment ${s.sentiment || 'neutral'}">${s.sentiment || 'neutral'}</span></div>
          <div class="content" style="opacity: 0.8;">${s.content.substring(0, 100)}${s.content.length > 100 ? '...' : ''}</div>
        </div>
      `).join('');
    } else {
      recentSection.style.display = 'none';
    }
    
  } catch (err) {
    console.error('Failed to load standups:', err);
  }
}

async function submitStandup() {
  const content = document.getElementById('standupContent').value.trim();
  const dateInput = document.getElementById('standupDate').value;
  const btn = document.getElementById('submitStandupBtn');
  
  if (!content) {
    showToast('Missing Content', 'Please enter your standup update', 'warning');
    return;
  }
  
  // Disable button and show loading state
  btn.disabled = true;
  const originalText = btn.textContent;
  btn.innerHTML = '<span style="display: inline-flex; align-items: center; gap: 0.5rem;"><span class="spinner" style="width: 14px; height: 14px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite;"></span>Submitting...</span>';
  
  try {
    const res = await fetch('/api/career/standups', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content, date: dateInput || null })
    });
    
    const data = await res.json();
    
    if (data.status === 'ok') {
      showToast('Standup Saved', 'Your standup has been saved and feedback generated!', 'success');
      document.getElementById('standupContent').value = '';
      toggleStandupForm();
      loadStandups();
    } else {
      showToast('Error', data.error || 'Failed to save standup', 'error');
    }
  } catch (err) {
    showToast('Error', 'Failed to save standup', 'error');
    console.error('Standup error:', err);
  } finally {
    // Re-enable button
    btn.disabled = false;
    btn.textContent = originalText;
  }
}

async function suggestStandup() {
  const textarea = document.getElementById('standupContent');
  
  try {
    showToast('Generating...', 'Creating suggested standup based on your work', 'info');
    
    const res = await fetch('/api/career/standups/suggest', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    const data = await res.json();
    
    if (data.suggestion) {
      textarea.value = data.suggestion;
      showToast('Suggestion Ready', `Based on ${data.tickets_count} tickets and ${data.code_changes_count} code changes`, 'success');
    } else {
      showToast('Error', 'Could not generate suggestion', 'error');
    }
  } catch (err) {
    showToast('Error', 'Failed to generate suggestion', 'error');
    console.error('Suggest error:', err);
  }
}

// Code Locker Functions - Ticket/File Selection Flow
let ticketsWithFiles = [];

function lockerTicketLink(ticketId) {
  const linkDiv = document.getElementById('lockerTicketLink');
  if (ticketId) {
    linkDiv.innerHTML = `<a href="/tickets/${ticketId}" target="_blank" style="color: #6366f1; text-decoration: underline; font-size: 0.92rem;">View/Edit Ticket Details ‚Üí</a>`;
    linkDiv.style.display = 'block';
  } else {
    linkDiv.innerHTML = '';
    linkDiv.style.display = 'none';
  }
}

// Patch the ticket select to show the link on change
const selectorTicket = document.getElementById('selectorTicket');
if (selectorTicket) {
  selectorTicket.addEventListener('change', function() {
    lockerTicketLink(this.value);
  });
}

function toggleCodeLockerForm() {
  // Hide both selector and form
  document.getElementById('codeLockerSelector').style.display = 'none';
  document.getElementById('codeLockerForm').style.display = 'none';
}

async function showCodeLockerSelector() {
  // Load tickets with their files
  try {
    const res = await fetch('/api/career/tickets-with-files');
    ticketsWithFiles = await res.json();
    
    const select = document.getElementById('selectorTicket');
    select.innerHTML = '<option value="">-- Select a ticket --</option>' + 
      ticketsWithFiles.map(t => `<option value="${t.id}">${t.ticket_id}: ${t.title.substring(0, 40)}${t.title.length > 40 ? '...' : ''}</option>`).join('');
    
    // Check for URL params (pre-fill from ticket page)
    const urlParams = new URLSearchParams(window.location.search);
    const prefilledFile = urlParams.get('code_locker_file');
    const prefilledTicket = urlParams.get('ticket_id');
    
    if (prefilledTicket) {
      select.value = prefilledTicket;
      loadTicketFilesForSelector();
      if (prefilledFile) {
        document.getElementById('selectorFilename').value = prefilledFile;
      }
    }
    
  } catch (err) {
    console.error('Failed to load tickets:', err);
  }
  
  document.getElementById('codeLockerSelector').style.display = 'block';
  document.getElementById('codeLockerForm').style.display = 'none';
}

function hideCodeLockerSelector() {
  document.getElementById('codeLockerSelector').style.display = 'none';
  // Clear URL params
  if (window.location.search) {
    window.history.replaceState({}, '', window.location.pathname);
  }
}

async function loadTicketFilesForSelector() {
  const ticketId = document.getElementById('selectorTicket').value;
  const container = document.getElementById('selectorFilesContainer');
  const list = document.getElementById('selectorFilesList');
  
  if (!ticketId) {
    container.style.display = 'none';
    return;
  }
  
  const ticket = ticketsWithFiles.find(t => t.id == ticketId);
  if (!ticket || ticket.files.length === 0) {
    container.style.display = 'none';
    return;
  }
  
  list.innerHTML = ticket.files.map(f => `
    <div class="ticket-file-option" style="padding: 0.5rem 0.75rem; cursor: pointer; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--sf-border);">
      <div style="min-width: 0; flex: 1;">
        <div style="font-family: monospace; font-size: 0.85rem; color: var(--sf-text);">${f.filename}</div>
        <div style="font-size: 0.75rem; color: var(--sf-text-muted);">${f.file_type === 'new' ? '‚ú® New file' : 'üìù Update'} ${f.description ? '¬∑ ' + f.description : ''}</div>
      </div>
      <span style="font-size: 0.75rem; padding: 0.2rem 0.5rem; background: ${f.latest_version ? '#dcfce7' : '#f3f4f6'}; color: ${f.latest_version ? '#166534' : '#6b7280'}; border-radius: 4px;">
        ${f.latest_version ? 'v' + f.latest_version + ' ‚Üí v' + (f.latest_version + 1) : 'v1 (new)'}
      </span>
      <button onclick="drillToTicketFile('${ticket.id}', '${f.filename}')" style="margin-left: 0.5rem; background: #e0e7ff; color: #3730a3; border: none; border-radius: 4px; font-size: 0.8rem; padding: 0.2rem 0.6rem; cursor: pointer;">Drill ‚Üí</button>
    </div>
  `).join('');
  
  container.style.display = 'block';
}

// Alias for the onchange handler
function loadTicketFiles() {
  loadTicketFilesForSelector();
}


function selectTicketFile(filename, currentVersion) {
  document.getElementById('selectorFilename').value = filename;
  // Highlight selected
  document.querySelectorAll('.ticket-file-option').forEach(el => {
    el.style.background = el.querySelector('div').textContent.includes(filename) ? 'var(--sf-surface)' : '';
  });
}

// Drill directly to code entry for a ticket file
async function drillToTicketFile(ticketId, filename) {
  document.getElementById('selectorTicket').value = ticketId;
  await loadTicketFilesForSelector();
  document.getElementById('selectorFilename').value = filename;
  proceedToCodeEntry();
}

async function proceedToCodeEntry() {
  const ticketId = document.getElementById('selectorTicket').value;
  const filename = document.getElementById('selectorFilename').value.trim();
  
  if (!filename) {
    showToast('Missing Filename', 'Please select or enter a filename', 'warning');
    return;
  }
  
  // Set hidden fields
  document.getElementById('codeFilename').value = filename;
  document.getElementById('codeTicket').value = ticketId;
  document.getElementById('selectedFileDisplay').textContent = filename;
  
  // Get version suggestion
  try {
    const params = new URLSearchParams({ filename });
    if (ticketId) params.append('ticket_id', ticketId);
    
    const res = await fetch(`/api/career/code-locker/next-version?${params}`);
    const data = await res.json();
    
    document.getElementById('versionSuggestion').textContent = 
      data.is_new_file ? 'Will be saved as v1' : `Will be saved as v${data.next_version}`;
    
  } catch (err) {
    document.getElementById('versionSuggestion').textContent = '';
  }
  
  // Switch to code entry form
  document.getElementById('codeLockerSelector').style.display = 'none';
  document.getElementById('codeLockerForm').style.display = 'block';
  document.getElementById('codeContent').focus();
}

function backToSelector() {
  document.getElementById('codeLockerForm').style.display = 'none';
  document.getElementById('codeLockerSelector').style.display = 'block';
}

async function loadCodeLocker() {
  try {
    const res = await fetch('/api/career/code-locker/files');
    const files = await res.json();
    
    const container = document.getElementById('codeLockerFiles');
    
    if (files.length > 0) {
      container.innerHTML = files.map(f => `
        <div class="code-file-item">
          <div class="file-info">
            <div class="filename">${f.filename}</div>
            <div class="file-meta">
              <span>v${f.latest_version}</span>
              <span>${f.version_count} version${f.version_count > 1 ? 's' : ''}</span>
              <span>${formatTimeAgo(f.last_updated)}</span>
            </div>
          </div>
          <span class="version-badge">v${f.latest_version}</span>
          <div class="code-file-actions">
            <button onclick="viewCodeFile('${f.filename}')" title="View">üëÅÔ∏è</button>
            <button onclick="updateCodeFile('${f.filename}', ${f.ticket_id || 'null'})" title="Update">üìù</button>
          </div>
        </div>
      `).join('');
    } else {
      container.innerHTML = `
        <div class="empty-section" style="text-align: center; padding: 1.5rem;">
          <p style="color: var(--sf-text-muted); margin-bottom: 0.75rem;">No files in locker</p>
          <button onclick="showCodeLockerSelector()" style="background: var(--sf-primary, #667eea); color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer;">
            Add First File
          </button>
        </div>
      `;
    }
  } catch (err) {
    console.error('Failed to load code locker:', err);
  }
}

async function submitCodeLocker() {
  const filename = document.getElementById('codeFilename').value.trim();
  const content = document.getElementById('codeContent').value;
  const ticketId = document.getElementById('codeTicket').value;
  const notes = document.getElementById('codeNotes').value.trim();
  
  if (!filename) {
    showToast('Missing Filename', 'Please enter a filename', 'warning');
    return;
  }
  
  try {
    const res = await fetch('/api/career/code-locker', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        filename,
        content,
        ticket_id: ticketId || null,
        notes
      })
    });
    
    const data = await res.json();
    
    if (data.status === 'ok') {
      showToast('File Saved', `${filename} saved as v${data.version}`, 'success');
      document.getElementById('codeFilename').value = '';
      document.getElementById('codeContent').value = '';
      document.getElementById('codeTicket').value = '';
      document.getElementById('codeNotes').value = '';
      toggleCodeLockerForm();
      loadCodeLocker();
      // Clear URL params
      if (window.location.search) {
        window.history.replaceState({}, '', window.location.pathname);
      }
    } else {
      showToast('Error', data.error || 'Failed to save file', 'error');
    }
  } catch (err) {
    showToast('Error', 'Failed to save file', 'error');
    console.error('Code locker error:', err);
  }
}

function viewCodeFile(filename) {
  window.open(`/career?tab=code-locker&file=${encodeURIComponent(filename)}`, '_blank');
}

async function updateCodeFile(filename, ticketId) {
  // Pre-fill selector and go straight to code entry
  await showCodeLockerSelector();
  if (ticketId) {
    document.getElementById('selectorTicket').value = ticketId;
    await loadTicketFilesForSelector();
  }
  document.getElementById('selectorFilename').value = filename;
  proceedToCodeEntry();
}

function formatTimeAgo(dateStr) {
  const date = new Date(dateStr);
  const now = new Date();
  const diff = (now - date) / 1000; // seconds
  
  if (diff < 60) return 'just now';
  if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
  if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
  if (diff < 604800) return `${Math.floor(diff / 86400)}d ago`;
  return dateStr.split('T')[0];
}

// Initialize Career Hub on page load
document.addEventListener('DOMContentLoaded', () => {
  loadStandups();
  loadCodeLocker();
  
  // Check if we should open code locker from URL params
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('code_locker_file')) {
    showCodeLockerSelector();
  }
});
</script>

{% endblock %}
